<!DOCTYPE html>
<html lang="en" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cash Reconciliation - Lorenco Accounting</title>
  <script src="js/navigation.js"></script>
  <script src="js/ledger.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; }

    .content { padding: 20px; max-width: 1400px; margin: 0 auto; }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-header h1 { font-size: 24px; color: #333; }
    .page-header .sub { font-size: 13px; color: #666; margin-top: 4px; }

    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #0066cc 0%, #0099ff 100%); color: white; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-success { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
    .btn-success:hover { opacity: 0.9; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-sm { padding: 6px 14px; font-size: 12px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .stat-card .label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .value { font-size: 28px; font-weight: 700; color: #333; margin-top: 5px; font-family: 'Courier New', monospace; }
    .stat-card .sub { font-size: 12px; color: #888; margin-top: 5px; }
    .stat-card.highlight { background: linear-gradient(135deg, #0066cc 0%, #0099ff 100%); }
    .stat-card.highlight .label, .stat-card.highlight .value, .stat-card.highlight .sub { color: white; }
    .stat-card.warning { border-left: 4px solid #ffc107; }
    .stat-card.success { border-left: 4px solid #28a745; }
    .stat-card.danger { border-left: 4px solid #dc3545; }

    .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-header { padding: 15px 20px; border-bottom: 1px solid #e8eaed; display: flex; justify-content: space-between; align-items: center; }
    .card-header h2 { font-size: 16px; color: #333; }
    .card-body { padding: 20px; }

    .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .filters input, .filters select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
    .filters label { font-size: 13px; font-weight: 600; color: #555; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e8eaed; }
    th { background: #f8f9fa; font-weight: 600; color: #333; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    tr:hover { background: #f8f9fa; }

    .amount { font-family: 'Courier New', monospace; font-weight: 600; }
    .amount-positive { color: #28a745; }
    .amount-negative { color: #dc3545; }

    .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-settled { background: #d4edda; color: #155724; }
    .status-partial { background: #cce5ff; color: #004085; }
    .status-variance { background: #f8d7da; color: #721c24; }

    .method-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .method-cash { background: #d4edda; color: #155724; }
    .method-card { background: #cce5ff; color: #004085; }

    /* Reconciliation Panel */
    .recon-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .recon-section { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .recon-section-header { padding: 15px 20px; font-weight: 600; font-size: 14px; border-bottom: 1px solid #e8eaed; }
    .recon-section-header.cash-header { background: linear-gradient(135deg, #d4edda, #c3e6cb); color: #155724; }
    .recon-section-header.card-header { background: linear-gradient(135deg, #cce5ff, #b8daff); color: #004085; }
    .recon-section-body { padding: 20px; }

    .recon-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .recon-row:last-child { border-bottom: none; }
    .recon-row .recon-label { font-size: 13px; color: #555; }
    .recon-row .recon-value { font-size: 16px; font-weight: 700; font-family: 'Courier New', monospace; }
    .recon-row.total { background: #f8f9fa; margin: 10px -20px -20px; padding: 15px 20px; }
    .recon-row.variance { background: #fff3cd; margin: 0 -20px; padding: 10px 20px; }
    .recon-row.variance.zero { background: #d4edda; }

    .bank-match-select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; margin-top: 8px; }

    .settle-actions { padding: 15px 20px; background: #f8f9fa; display: flex; justify-content: flex-end; gap: 10px; }

    /* Day selector */
    .day-list { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .day-item { padding: 12px 20px; background: white; border: 2px solid #e8eaed; border-radius: 8px; cursor: pointer; transition: all 0.2s; min-width: 160px; }
    .day-item:hover { border-color: #0066cc; }
    .day-item.active { border-color: #0066cc; background: #e6f3ff; }
    .day-item.settled { border-color: #28a745; background: #d4edda; }
    .day-item .day-date { font-weight: 600; font-size: 14px; color: #333; }
    .day-item .day-total { font-size: 13px; color: #666; margin-top: 4px; font-family: 'Courier New', monospace; }
    .day-item .day-status { font-size: 11px; margin-top: 4px; }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 12px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid #e8eaed; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 18px; color: #333; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #e8eaed; display: flex; justify-content: flex-end; gap: 10px; }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 5px; color: #333; font-size: 13px; }
    .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #0066cc; box-shadow: 0 0 0 3px rgba(0,102,204,0.1); }

    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .empty-state h3 { color: #555; margin-bottom: 10px; }

    @media (max-width: 768px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .recon-panel { grid-template-columns: 1fr; }
      .day-list { flex-direction: column; }
    }
  </style>

<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:Order msdt:dt="string">147400.000000000</mso:Order>
<mso:ContentTypeId msdt:dt="string">0x010100FCE56FA388751B49A2E4121BC784923C</mso:ContentTypeId>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>
<body>
  <div class="content">
    <div class="page-header">
      <div>
        <h1>Cash Reconciliation</h1>
        <div class="sub">Match POS daily takings (cash & card) against bank deposits</div>
      </div>
      <div style="display: flex; gap: 10px;">
        <a href="customers.html" class="btn btn-secondary">Back to Customers</a>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card highlight">
        <div class="label">Unreconciled Days</div>
        <div class="value" id="unreconDays">0</div>
        <div class="sub">Days needing attention</div>
      </div>
      <div class="stat-card warning">
        <div class="label">Cash Pending</div>
        <div class="value" id="totalCashPending">R 0.00</div>
        <div class="sub">Awaiting bank deposit match</div>
      </div>
      <div class="stat-card warning">
        <div class="label">Card Pending</div>
        <div class="value" id="totalCardPending">R 0.00</div>
        <div class="sub">Awaiting merchant settlement</div>
      </div>
      <div class="stat-card success">
        <div class="label">Total Settled</div>
        <div class="value" id="totalSettled">R 0.00</div>
        <div class="sub">Matched to bank</div>
      </div>
    </div>

    <!-- Date Filter -->
    <div class="filters">
      <label>From:</label>
      <input type="date" id="reconFromDate" onchange="loadReconciliation()">
      <label>To:</label>
      <input type="date" id="reconToDate" onchange="loadReconciliation()">
      <select id="reconStatusFilter" onchange="loadReconciliation()">
        <option value="">All Days</option>
        <option value="pending" selected>Unreconciled Only</option>
        <option value="settled">Settled Only</option>
      </select>
    </div>

    <!-- Day Selector -->
    <div class="day-list" id="dayList">
    </div>

    <!-- Reconciliation Panel (shown when a day is selected) -->
    <div id="reconDetail" style="display: none;">
      <h2 style="margin-bottom: 15px; color: #333;" id="reconDateTitle">Reconciliation: --</h2>

      <div class="recon-panel">
        <!-- Cash Section -->
        <div class="recon-section">
          <div class="recon-section-header cash-header">CASH</div>
          <div class="recon-section-body">
            <div class="recon-row">
              <span class="recon-label">POS Cash Sales</span>
              <span class="recon-value" id="reconCashSales">R 0.00</span>
            </div>
            <div class="recon-row">
              <span class="recon-label">Number of Transactions</span>
              <span class="recon-value" id="reconCashCount">0</span>
            </div>
            <div class="recon-row">
              <span class="recon-label">Already Settled</span>
              <span class="recon-value amount-positive" id="reconCashSettled">R 0.00</span>
            </div>
            <div class="recon-row">
              <span class="recon-label">Pending Settlement</span>
              <span class="recon-value" id="reconCashPending">R 0.00</span>
            </div>
            <div style="padding-top: 15px;">
              <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Bank Deposit Amount</label>
              <input type="number" id="cashBankAmount" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" oninput="updateCashVariance()">
              <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin: 10px 0 5px;">Bank Description</label>
              <input type="text" id="cashBankDesc" placeholder="e.g. Cash deposit 22 Jan" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
            </div>
            <div class="recon-row variance" id="cashVarianceRow">
              <span class="recon-label">Variance</span>
              <span class="recon-value" id="cashVariance">R 0.00</span>
            </div>
          </div>
          <div class="settle-actions">
            <button class="btn btn-success btn-sm" id="settleCashBtn" onclick="settleCash()" disabled>Settle Cash</button>
          </div>
        </div>

        <!-- Card Section -->
        <div class="recon-section">
          <div class="recon-section-header card-header">CARD</div>
          <div class="recon-section-body">
            <div class="recon-row">
              <span class="recon-label">POS Card Sales</span>
              <span class="recon-value" id="reconCardSales">R 0.00</span>
            </div>
            <div class="recon-row">
              <span class="recon-label">Number of Transactions</span>
              <span class="recon-value" id="reconCardCount">0</span>
            </div>
            <div class="recon-row">
              <span class="recon-label">Already Settled</span>
              <span class="recon-value amount-positive" id="reconCardSettled">R 0.00</span>
            </div>
            <div class="recon-row">
              <span class="recon-label">Pending Settlement</span>
              <span class="recon-value" id="reconCardPending">R 0.00</span>
            </div>
            <div style="padding-top: 15px;">
              <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Bank Deposit Amount</label>
              <input type="number" id="cardBankAmount" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" oninput="updateCardVariance()">
              <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin: 10px 0 5px;">Bank Description</label>
              <input type="text" id="cardBankDesc" placeholder="e.g. Card merchant settlement" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
            </div>
            <div class="recon-row variance" id="cardVarianceRow">
              <span class="recon-label">Variance</span>
              <span class="recon-value" id="cardVariance">R 0.00</span>
            </div>
          </div>
          <div class="settle-actions">
            <button class="btn btn-success btn-sm" id="settleCardBtn" onclick="settleCard()" disabled>Settle Card</button>
          </div>
        </div>
      </div>

      <!-- POS Transactions for Selected Day -->
      <div class="card">
        <div class="card-header">
          <h2 id="dayTransactionsTitle">Transactions for --</h2>
        </div>
        <div class="card-body" style="padding: 0;">
          <table>
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Time</th>
                <th>Description</th>
                <th>Method</th>
                <th>Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="dayTransactionsBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Empty state when no days to reconcile -->
    <div id="emptyState" style="display: none;">
      <div class="empty-state">
        <h3>All Caught Up!</h3>
        <p>No unreconciled POS days found. All cash and card deposits have been matched.</p>
      </div>
    </div>
  </div>

  <script>
    let selectedDate = null;
    let dailyTotals = [];

    function init() {
      // Set default date range (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

      document.getElementById('reconFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('reconToDate').value = today.toISOString().split('T')[0];

      loadReconciliation();
    }

    function loadReconciliation() {
      const fromDate = document.getElementById('reconFromDate').value;
      const toDate = document.getElementById('reconToDate').value;
      const statusFilter = document.getElementById('reconStatusFilter').value;

      // Get all daily totals
      dailyTotals = LedgerSystem.getPOSDailyTotals(fromDate, toDate);

      // Filter by status
      let filteredDays = dailyTotals;
      if (statusFilter === 'pending') {
        filteredDays = dailyTotals.filter(d => d.cashPending > 0 || d.cardPending > 0);
      } else if (statusFilter === 'settled') {
        filteredDays = dailyTotals.filter(d => d.cashPending === 0 && d.cardPending === 0 && (d.cashSales > 0 || d.cardSales > 0));
      }

      // Update stats
      const unrecon = dailyTotals.filter(d => d.cashPending > 0 || d.cardPending > 0);
      const totalCashPending = unrecon.reduce((s, d) => s + d.cashPending, 0);
      const totalCardPending = unrecon.reduce((s, d) => s + d.cardPending, 0);
      const totalSettled = dailyTotals.reduce((s, d) => s + d.cashSettled + d.cardSettled, 0);

      document.getElementById('unreconDays').textContent = unrecon.length;
      document.getElementById('totalCashPending').textContent = formatCurrency(totalCashPending);
      document.getElementById('totalCardPending').textContent = formatCurrency(totalCardPending);
      document.getElementById('totalSettled').textContent = formatCurrency(totalSettled);

      // Render day list
      renderDayList(filteredDays);

      // If selected date is in list, keep it selected
      if (selectedDate && filteredDays.find(d => d.date === selectedDate)) {
        selectDay(selectedDate);
      } else if (filteredDays.length > 0) {
        selectDay(filteredDays[0].date);
      } else {
        document.getElementById('reconDetail').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
      }
    }

    function renderDayList(days) {
      const container = document.getElementById('dayList');

      if (days.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = days.map(day => {
        const isSettled = day.cashPending === 0 && day.cardPending === 0;
        const isActive = day.date === selectedDate;
        let statusText = '';
        if (isSettled && (day.cashSales > 0 || day.cardSales > 0)) {
          statusText = '<span style="color: #155724;">Fully Settled</span>';
        } else {
          const parts = [];
          if (day.cashPending > 0) parts.push('Cash: ' + formatCurrency(day.cashPending));
          if (day.cardPending > 0) parts.push('Card: ' + formatCurrency(day.cardPending));
          statusText = '<span style="color: #856404;">' + parts.join(' | ') + '</span>';
        }

        return `
          <div class="day-item ${isActive ? 'active' : ''} ${isSettled ? 'settled' : ''}" onclick="selectDay('${day.date}')">
            <div class="day-date">${formatDate(day.date)}</div>
            <div class="day-total">Total: ${formatCurrency(day.totalSales)}</div>
            <div class="day-status">${statusText}</div>
          </div>
        `;
      }).join('');
    }

    function selectDay(date) {
      selectedDate = date;
      const day = dailyTotals.find(d => d.date === date);

      if (!day) return;

      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('reconDetail').style.display = 'block';

      // Update day selector active state
      document.querySelectorAll('.day-item').forEach(el => el.classList.remove('active'));
      const activeItem = [...document.querySelectorAll('.day-item')].find(el => el.querySelector('.day-date').textContent === formatDate(date));
      if (activeItem) activeItem.classList.add('active');

      // Update title
      document.getElementById('reconDateTitle').textContent = 'Reconciliation: ' + formatDate(date);
      document.getElementById('dayTransactionsTitle').textContent = 'Transactions for ' + formatDate(date);

      // Cash section
      const cashSales = LedgerSystem.getPOSSales({ date, paymentMethod: 'cash' });
      document.getElementById('reconCashSales').textContent = formatCurrency(day.cashSales);
      document.getElementById('reconCashCount').textContent = cashSales.length;
      document.getElementById('reconCashSettled').textContent = formatCurrency(day.cashSettled);
      document.getElementById('reconCashPending').textContent = formatCurrency(day.cashPending);

      // Card section
      const cardSales = LedgerSystem.getPOSSales({ date, paymentMethod: 'card' });
      document.getElementById('reconCardSales').textContent = formatCurrency(day.cardSales);
      document.getElementById('reconCardCount').textContent = cardSales.length;
      document.getElementById('reconCardSettled').textContent = formatCurrency(day.cardSettled);
      document.getElementById('reconCardPending').textContent = formatCurrency(day.cardPending);

      // Reset input fields
      document.getElementById('cashBankAmount').value = '';
      document.getElementById('cashBankDesc').value = '';
      document.getElementById('cardBankAmount').value = '';
      document.getElementById('cardBankDesc').value = '';

      // Pre-fill bank amounts with pending amounts
      if (day.cashPending > 0) {
        document.getElementById('cashBankAmount').value = day.cashPending.toFixed(2);
        updateCashVariance();
      }
      if (day.cardPending > 0) {
        document.getElementById('cardBankAmount').value = day.cardPending.toFixed(2);
        updateCardVariance();
      }

      // Enable/disable settle buttons
      document.getElementById('settleCashBtn').disabled = day.cashPending === 0;
      document.getElementById('settleCardBtn').disabled = day.cardPending === 0;

      // Show transactions
      renderDayTransactions(date);
    }

    function renderDayTransactions(date) {
      const sales = LedgerSystem.getPOSSales({ date });
      sales.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

      const tbody = document.getElementById('dayTransactionsBody');
      tbody.innerHTML = sales.map(s => `
        <tr>
          <td><strong>${s.id}</strong></td>
          <td>${s.time || '-'}</td>
          <td>${s.description}</td>
          <td><span class="method-badge method-${s.paymentMethod}">${s.paymentMethod}</span></td>
          <td class="amount">${formatCurrency(s.total)}</td>
          <td><span class="status-badge status-${s.status}">${s.status}</span></td>
        </tr>
      `).join('');

      // Add totals row
      const cashTotal = sales.filter(s => s.paymentMethod === 'cash').reduce((sum, s) => sum + s.total, 0);
      const cardTotal = sales.filter(s => s.paymentMethod === 'card').reduce((sum, s) => sum + s.total, 0);
      const accountTotal = sales.filter(s => s.paymentMethod === 'account').reduce((sum, s) => sum + s.total, 0);
      const grandTotal = sales.reduce((sum, s) => sum + s.total, 0);

      tbody.innerHTML += `
        <tr style="background: #f0f9f0; font-weight: 600;">
          <td colspan="3">CASH TOTAL</td>
          <td><span class="method-badge method-cash">CASH</span></td>
          <td class="amount">${formatCurrency(cashTotal)}</td>
          <td></td>
        </tr>
        <tr style="background: #e8f4fd; font-weight: 600;">
          <td colspan="3">CARD TOTAL</td>
          <td><span class="method-badge method-card">CARD</span></td>
          <td class="amount">${formatCurrency(cardTotal)}</td>
          <td></td>
        </tr>
        ${accountTotal > 0 ? `
        <tr style="background: #fff8e1; font-weight: 600;">
          <td colspan="3">ACCOUNT TOTAL</td>
          <td><span class="method-badge method-account">ACCOUNT</span></td>
          <td class="amount">${formatCurrency(accountTotal)}</td>
          <td></td>
        </tr>` : ''}
        <tr style="background: #e8eaed; font-weight: 700;">
          <td colspan="4">DAY TOTAL</td>
          <td class="amount">${formatCurrency(grandTotal)}</td>
          <td></td>
        </tr>
      `;
    }

    function updateCashVariance() {
      const bankAmount = parseFloat(document.getElementById('cashBankAmount').value) || 0;
      const day = dailyTotals.find(d => d.date === selectedDate);
      if (!day) return;

      const variance = bankAmount - day.cashPending;
      document.getElementById('cashVariance').textContent = formatCurrency(variance);

      const row = document.getElementById('cashVarianceRow');
      if (Math.abs(variance) < 0.01) {
        row.className = 'recon-row variance zero';
        document.getElementById('cashVariance').style.color = '#155724';
      } else if (variance < 0) {
        row.className = 'recon-row variance';
        document.getElementById('cashVariance').style.color = '#dc3545';
      } else {
        row.className = 'recon-row variance';
        document.getElementById('cashVariance').style.color = '#004085';
      }

      document.getElementById('settleCashBtn').disabled = bankAmount <= 0 || day.cashPending === 0;
    }

    function updateCardVariance() {
      const bankAmount = parseFloat(document.getElementById('cardBankAmount').value) || 0;
      const day = dailyTotals.find(d => d.date === selectedDate);
      if (!day) return;

      const variance = bankAmount - day.cardPending;
      document.getElementById('cardVariance').textContent = formatCurrency(variance);

      const row = document.getElementById('cardVarianceRow');
      if (Math.abs(variance) < 0.01) {
        row.className = 'recon-row variance zero';
        document.getElementById('cardVariance').style.color = '#155724';
      } else if (variance < 0) {
        row.className = 'recon-row variance';
        document.getElementById('cardVariance').style.color = '#dc3545';
      } else {
        row.className = 'recon-row variance';
        document.getElementById('cardVariance').style.color = '#004085';
      }

      document.getElementById('settleCardBtn').disabled = bankAmount <= 0 || day.cardPending === 0;
    }

    function settleCash() {
      if (!selectedDate) return;

      const bankAmount = parseFloat(document.getElementById('cashBankAmount').value);
      const bankDesc = document.getElementById('cashBankDesc').value || 'Cash deposit ' + selectedDate;

      if (!bankAmount || bankAmount <= 0) {
        alert('Please enter the bank deposit amount');
        return;
      }

      const day = dailyTotals.find(d => d.date === selectedDate);
      const variance = Math.abs(bankAmount - day.cashPending);

      if (variance > 0.01) {
        const proceed = confirm(
          `There is a variance of ${formatCurrency(bankAmount - day.cashPending)}.\n\n` +
          `POS Cash Sales: ${formatCurrency(day.cashPending)}\n` +
          `Bank Deposit: ${formatCurrency(bankAmount)}\n\n` +
          `Do you want to settle anyway?`
        );
        if (!proceed) return;
      }

      try {
        const result = LedgerSystem.settlePOSDay(selectedDate, 'cash', bankAmount, bankDesc);
        alert(
          `Cash settled successfully!\n\n` +
          `Settled ${result.salesCount} transactions\n` +
          `Amount: ${formatCurrency(result.bankAmount)}\n` +
          `Journal: ${result.journalRef}` +
          (result.hasVariance ? `\nVariance: ${formatCurrency(result.difference)}` : '')
        );
        loadReconciliation();
      } catch (e) {
        alert('Error settling cash: ' + e.message);
      }
    }

    function settleCard() {
      if (!selectedDate) return;

      const bankAmount = parseFloat(document.getElementById('cardBankAmount').value);
      const bankDesc = document.getElementById('cardBankDesc').value || 'Card merchant settlement ' + selectedDate;

      if (!bankAmount || bankAmount <= 0) {
        alert('Please enter the bank deposit amount');
        return;
      }

      const day = dailyTotals.find(d => d.date === selectedDate);
      const variance = Math.abs(bankAmount - day.cardPending);

      if (variance > 0.01) {
        const proceed = confirm(
          `There is a variance of ${formatCurrency(bankAmount - day.cardPending)}.\n\n` +
          `POS Card Sales: ${formatCurrency(day.cardPending)}\n` +
          `Bank Deposit: ${formatCurrency(bankAmount)}\n\n` +
          `Do you want to settle anyway?`
        );
        if (!proceed) return;
      }

      try {
        const result = LedgerSystem.settlePOSDay(selectedDate, 'card', bankAmount, bankDesc);
        alert(
          `Card settled successfully!\n\n` +
          `Settled ${result.salesCount} transactions\n` +
          `Amount: ${formatCurrency(result.bankAmount)}\n` +
          `Journal: ${result.journalRef}` +
          (result.hasVariance ? `\nVariance: ${formatCurrency(result.difference)}` : '')
        );
        loadReconciliation();
      } catch (e) {
        alert('Error settling card: ' + e.message);
      }
    }

    function formatCurrency(amount) {
      return 'R ' + Math.abs(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-ZA', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Initialize
    init();
  </script>
</body>
</html>
