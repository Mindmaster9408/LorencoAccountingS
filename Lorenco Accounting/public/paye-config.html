<!DOCTYPE html>
<html lang="en" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
<head>
  <meta charset="UTF-8">
  <title>PAYE Configuration</title>
  <script src="js/navigation.js"></script>
  <style>
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; margin: 0; padding: 0; }
    .container { max-width: 700px; margin: 20px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 32px; }
    h2 { color: #0066cc; margin-bottom: 24px; }
    .section { margin-bottom: 32px; }
    .section-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
    .type-list { margin-bottom: 12px; }
    .type-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
    .type-row input[type=text] { width: 180px; padding: 4px 8px; }
    .type-row .remove-btn { color: #d32f2f; background: none; border: none; cursor: pointer; font-size: 16px; }
    .add-btn { background: #0066cc; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; cursor: pointer; font-size: 14px; margin-top: 8px; }
    .add-btn:active { background: #004c99; }
    .save-btn { background: #388e3c; color: #fff; border: none; border-radius: 4px; padding: 8px 24px; font-size: 16px; cursor: pointer; float: right; }
    .save-btn:active { background: #256029; }
    .default-label { color: #888; font-size: 13px; margin-left: 4px; }
    .employee-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .employee-table th, .employee-table td { padding: 8px; text-align: left; border-bottom: 1px solid #e0e0e0; }
    .employee-table th { background: #f5f5f5; font-weight: 600; }
    .employee-table input[type=text] { width: 100%; padding: 4px 8px; border: 1px solid #ccc; border-radius: 3px; }
    .employee-table .inactive { color: #999; text-decoration: line-through; }
    .employee-table .toggle-btn { background: none; border: none; cursor: pointer; font-size: 14px; padding: 2px 6px; }
    .employee-table .toggle-btn.active { color: #388e3c; }
    .employee-table .toggle-btn.inactive { color: #d32f2f; }
  </style>

<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:Order msdt:dt="string">149400.000000000</mso:Order>
<mso:ContentTypeId msdt:dt="string">0x010100FCE56FA388751B49A2E4121BC784923C</mso:ContentTypeId>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>
<body>
  <div class="container">
    <h2>PAYE Configuration</h2>
    <form id="payeConfigForm">
      <div class="section">
        <div class="section-title">Income Types</div>
        <div id="incomeTypesList" class="type-list"></div>
        <button type="button" class="add-btn" onclick="addIncomeType()">Add Income</button>
      </div>
      <div class="section">
        <div class="section-title">Deduction Types</div>
        <div id="deductionTypesList" class="type-list"></div>
        <button type="button" class="add-btn" onclick="addDeductionType()">Add Deduction</button>
      </div>
      <div class="section">
        <div class="section-title">Employees</div>
        <table class="employee-table" id="employeeTable">
          <thead>
            <tr>
              <th>Employee Code</th>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="employeeTableBody">
          </tbody>
        </table>
        <button type="button" class="add-btn" onclick="addEmployee()">Add Employee</button>
      </div>
      <button type="submit" class="save-btn">Save Configuration</button>
    </form>
  </div>
  <script>
    // --- PAYE Config UI Logic ---
    let incomeTypes = [];
    let deductionTypes = [];
    let employees = [];
    const defaultIncomeTypes = [ { key: 'basic_salary', label: 'Basic Salary', isDefault: true, isCustom: false } ];
    const defaultDeductionTypes = [
      { key: 'paye', label: 'PAYE', isDefault: true, isCustom: false },
      { key: 'uif', label: 'UIF', isDefault: true, isCustom: false }
    ];

    // Fetch config from backend
    async function fetchConfig() {
      const res = await fetch('/api/paye/config', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await res.json();
      incomeTypes = data.incomeTypes.length ? data.incomeTypes : [...defaultIncomeTypes];
      deductionTypes = data.deductionTypes.length ? data.deductionTypes : [...defaultDeductionTypes];
      renderTypes();
    }

    // Fetch employees from backend
    async function fetchEmployees() {
      try {
        const res = await fetch('/api/employees', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        if (res.ok) {
          const data = await res.json();
          employees = data.employees || [];
        } else {
          employees = [];
        }
      } catch (err) {
        console.warn('Failed to fetch employees, using demo data');
        employees = [
          { id: 1, employeeCode: 'EMP001', firstName: 'John', lastName: 'Smith', isActive: true },
          { id: 2, employeeCode: 'EMP002', firstName: 'Sarah', lastName: 'Johnson', isActive: true },
          { id: 3, employeeCode: 'EMP003', firstName: 'Michael', lastName: 'Williams', isActive: true },
          { id: 4, employeeCode: 'EMP004', firstName: 'Emma', lastName: 'Brown', isActive: true },
          { id: 5, employeeCode: 'EMP005', firstName: 'David', lastName: 'Jones', isActive: true }
        ];
      }
      renderEmployees();
    }
    function renderTypes() {
      // Income
      const incomeList = document.getElementById('incomeTypesList');
      incomeList.innerHTML = '';
      incomeTypes.forEach((t, idx) => {
        const row = document.createElement('div');
        row.className = 'type-row';
        row.innerHTML = `<input type="text" value="${t.label}" ${t.isDefault ? 'readonly' : ''} onchange="incomeTypes[${idx}].label=this.value">` +
          (t.isDefault ? '<span class="default-label">(default)</span>' : `<button type="button" class="remove-btn" onclick="removeIncomeType(${idx})">&times;</button>`);
        incomeList.appendChild(row);
      });
      // Deduction
      const deductionList = document.getElementById('deductionTypesList');
      deductionList.innerHTML = '';
      deductionTypes.forEach((t, idx) => {
        const row = document.createElement('div');
        row.className = 'type-row';
        row.innerHTML = `<input type="text" value="${t.label}" ${t.isDefault ? 'readonly' : ''} onchange="deductionTypes[${idx}].label=this.value">` +
          (t.isDefault ? '<span class="default-label">(default)</span>' : `<button type="button" class="remove-btn" onclick="removeDeductionType(${idx})">&times;</button>`);
        deductionList.appendChild(row);
      });
    }
    window.addIncomeType = function() {
      const label = prompt('Enter new income type name:');
      if (label) incomeTypes.push({ key: 'custom_' + Date.now(), label, isDefault: false, isCustom: true });
      renderTypes();
    }
    window.addDeductionType = function() {
      const label = prompt('Enter new deduction type name:');
      if (label) deductionTypes.push({ key: 'custom_' + Date.now(), label, isDefault: false, isCustom: true });
      renderTypes();
    }
    window.removeIncomeType = function(idx) {
      if (!incomeTypes[idx].isDefault) incomeTypes.splice(idx, 1);
      renderTypes();
    }
    window.removeDeductionType = function(idx) {
      if (!deductionTypes[idx].isDefault) deductionTypes.splice(idx, 1);
      renderTypes();
    }

    // Employee management
    function renderEmployees() {
      const tbody = document.getElementById('employeeTableBody');
      tbody.innerHTML = '';

      employees.forEach((emp, idx) => {
        const row = tbody.insertRow();
        row.className = emp.isActive ? '' : 'inactive';

        // Employee Code
        let codeCell = row.insertCell();
        codeCell.innerHTML = `<input type="text" value="${emp.employeeCode}" onchange="employees[${idx}].employeeCode=this.value">`;

        // First Name
        let firstNameCell = row.insertCell();
        firstNameCell.innerHTML = `<input type="text" value="${emp.firstName}" onchange="employees[${idx}].firstName=this.value">`;

        // Last Name
        let lastNameCell = row.insertCell();
        lastNameCell.innerHTML = `<input type="text" value="${emp.lastName}" onchange="employees[${idx}].lastName=this.value">`;

        // Status
        let statusCell = row.insertCell();
        statusCell.textContent = emp.isActive ? 'Active' : 'Inactive';
        statusCell.style.color = emp.isActive ? '#388e3c' : '#d32f2f';
        statusCell.style.fontWeight = 'bold';

        // Actions
        let actionCell = row.insertCell();
        actionCell.innerHTML = `
          <button type="button" class="toggle-btn ${emp.isActive ? 'active' : 'inactive'}" onclick="toggleEmployee(${idx})">
            ${emp.isActive ? '✓ Active' : '✗ Inactive'}
          </button>
        `;
      });
    }

    window.addEmployee = function() {
      const empCode = prompt('Enter employee code:');
      if (!empCode) return;

      const firstName = prompt('Enter first name:');
      if (!firstName) return;

      const lastName = prompt('Enter last name:');
      if (!lastName) return;

      employees.push({
        id: null, // Will be assigned by backend
        employeeCode: empCode,
        firstName: firstName,
        lastName: lastName,
        isActive: true
      });

      renderEmployees();
    }

    window.toggleEmployee = function(idx) {
      employees[idx].isActive = !employees[idx].isActive;
      renderEmployees();
    }

    document.getElementById('payeConfigForm').onsubmit = async function(e) {
      e.preventDefault();

      try {
        // Save PAYE config
        await fetch('/api/paye/config', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ incomeTypes, deductionTypes })
        });

        // Save employees
        await fetch('/api/employees', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ employees })
        });

        alert('Configuration and employees saved!');
      } catch (err) {
        alert('Failed to save: ' + err.message);
      }
    }

    // Initialize
    fetchConfig();
    fetchEmployees();
  </script>
</body>
</html>
