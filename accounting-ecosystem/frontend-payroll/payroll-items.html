<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Payroll Items - Lorenco Paytime</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .wrapper {
            display: flex;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* SIDEBAR STYLES */
        .sidebar {
            width: 300px;
            background: white;
            border-radius: 15px;
            padding: 25px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 2px solid #eee;
        }

        .sidebar-title {
            color: #667eea;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .sidebar-section {
            margin-top: 20px;
        }

        .sidebar-section-title {
            padding: 10px 20px;
            color: #999;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar-link {
            display: block;
            padding: 12px 20px;
            color: #666;
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }

        .sidebar-link:hover {
            background: #f8f9fa;
            color: #667eea;
            border-left-color: #667eea;
        }

        .sidebar-link.active {
            background: #f0f4ff;
            color: #667eea;
            border-left-color: #667eea;
            font-weight: 600;
        }

        .company-carousel {
            margin-top: 15px;
            padding: 15px 20px;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .carousel-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #999;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .carousel-companies {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .carousel-company {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .carousel-company:hover {
            background: #eee;
            border-color: #667eea;
            color: #667eea;
        }

        .sidebar-actions {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-sidebar {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-align: center;
        }

        .btn-switch {
            background: #667eea;
            color: white;
        }

        .btn-switch:hover {
            background: #5568d3;
        }

        .btn-logout {
            background: #eee;
            color: #333;
        }

        .btn-logout:hover {
            background: #ddd;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .page-header h1 {
            color: #667eea;
            font-size: 2rem;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }

        .category-section {
            background: #fafbff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #eee;
        }
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        .category-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .category-icon {
            font-size: 32px;
        }
        .category-title h2 {
            color: #333;
            font-size: 20px;
        }
        .category-title p {
            color: #666;
            font-size: 13px;
            margin-top: 5px;
        }
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .item-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
        }
        .item-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .item-title {
            flex: 1;
        }
        .item-code {
            font-size: 12px;
            font-weight: 700;
            color: #667eea;
            background: #e7eaff;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .item-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-top: 5px;
        }
        .item-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        .item-detail {
            font-size: 13px;
        }
        .item-detail-label {
            color: #666;
            font-weight: 600;
        }
        .item-detail-value {
            color: #333;
            margin-top: 3px;
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 3px;
        }
        .badge-taxable { background: #28a745; color: white; }
        .badge-non-taxable { background: #6c757d; color: white; }
        .badge-uif { background: #17a2b8; color: white; }
        .badge-no-uif { background: #e0e0e0; color: #666; }
        .badge-fixed { background: #667eea; color: white; }
        .badge-percentage { background: #fd7e14; color: white; }
        .badge-balance { background: #20c997; color: white; }
        .badge-hours { background: #6610f2; color: white; }

        .item-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            flex: 1;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            font-weight: 600;
        }
        .btn-edit-small {
            background: #667eea;
        }
        .btn-edit-small:hover {
            background: #5568d3;
        }
        .btn-delete-small {
            background: #dc3545;
        }
        .btn-delete-small:hover {
            background: #c82333;
        }
        .irp5-code {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #333;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            max-width: 700px;
            width: 90%;
            margin: 50px auto;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            color: #667eea;
            font-size: 22px;
        }
        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .modal-body {
            padding: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .empty-state-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 1024px) {
            .sidebar { width: 250px; }
            .main-content { padding: 25px; }
            .page-header h1 { font-size: 1.5rem; }
        }

        @media (max-width: 768px) {
            .wrapper { flex-direction: column; }
            .sidebar { width: 100%; position: relative; top: 0; }
            .main-content { padding: 20px; }
            .page-header { flex-direction: column; gap: 15px; }
            .items-grid { grid-template-columns: 1fr; }
            .category-header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
    <link rel="stylesheet" href="css/dark-theme.css">
    <link rel="stylesheet" href="css/mobile-responsive.css">
</head>
<body>
    <button id="mobile-hamburger" class="mobile-hamburger"><span style="font-size:20px;">&#9776;</span></button>
    <div id="mobile-overlay" class="mobile-overlay"></div>
    <div class="wrapper">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Menu</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title">Navigation</div>
                <a href="company-dashboard.html" class="sidebar-link">üìä Dashboard</a>
                <a href="employee-management.html" class="sidebar-link">üë• Employees</a>
                <a href="payruns.html" class="sidebar-link">üíµ Pay Runs</a>
                <a href="payroll-items.html" class="sidebar-link active">üìã Payroll Items</a>
                <a href="attendance.html" class="sidebar-link">&#x23F0; Attendance</a>
                <a href="reports.html" class="sidebar-link">üìä Reports</a>
                <a href="historical-import.html" class="sidebar-link">üì• Historical Import</a>
                <a href="company-details.html" class="sidebar-link">üè¢ Company Details</a>
            </div>

            <div class="company-carousel">
                <div class="carousel-title">Switch Company</div>
                <div class="carousel-container">
                    <div class="carousel-companies" id="companies-carousel">
                    </div>
                </div>
            </div>

            <div class="sidebar-actions">
                <button class="btn-sidebar btn-switch" onclick="window.location.href='company-selection.html'">‚Üê Return to Dashboard</button>
                <button class="btn-sidebar btn-logout" onclick="handleLogout()">üö™ Logout</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="page-header">
                <div>
                    <h1>üí∞ Payroll Items (IRP5 Compliant)</h1>
                    <p style="color: #667eea; font-weight: 600; margin-top: 5px;" id="company-name-header"></p>
                </div>
            </div>

            <div id="modalSuccess" class="success-msg"></div>

            <!-- INCOME SECTION -->
            <div class="category-section">
                <div class="category-header">
                    <div class="category-title">
                        <div class="category-icon">üíµ</div>
                        <div>
                            <h2>Income</h2>
                            <p>IRP5 Codes 3801-3810 | Basic Salary, Bonuses, Commission, etc.</p>
                        </div>
                    </div>
                    <button class="btn btn-success" data-permission="MANAGE_PAYROLL_ITEMS" onclick="openAddItemModal('income')">+ Add Income</button>
                </div>
                <div id="incomeItems" class="items-grid"></div>
            </div>

            <!-- ALLOWANCES SECTION -->
            <div class="category-section">
                <div class="category-header">
                    <div class="category-title">
                        <div class="category-icon">üöó</div>
                        <div>
                            <h2>Allowances</h2>
                            <p>IRP5 Codes 3701-3715 | Travel, Housing, Subsistence, etc.</p>
                        </div>
                    </div>
                    <button class="btn btn-success" data-permission="MANAGE_PAYROLL_ITEMS" onclick="openAddItemModal('allowance')">+ Add Allowance</button>
                </div>
                <div id="allowanceItems" class="items-grid"></div>
            </div>

            <!-- DEDUCTIONS SECTION -->
            <div class="category-section">
                <div class="category-header">
                    <div class="category-title">
                        <div class="category-icon">‚ûñ</div>
                        <div>
                            <h2>Deductions</h2>
                            <p>IRP5 Codes 4001-4024 | Medical Aid, Pension, Loans, etc.</p>
                        </div>
                    </div>
                    <button class="btn btn-success" data-permission="MANAGE_PAYROLL_ITEMS" onclick="openAddItemModal('deduction')">+ Add Deduction</button>
                </div>
                <div id="deductionItems" class="items-grid"></div>
            </div>

            <!-- EMPLOYER CONTRIBUTIONS SECTION -->
            <div class="category-section">
                <div class="category-header">
                    <div class="category-title">
                        <div class="category-icon">üè¢</div>
                        <div>
                            <h2>Employer Contributions</h2>
                            <p>IRP5 Codes 4474-4493 | Pension (Employer), UIF (Employer), etc.</p>
                        </div>
                    </div>
                    <button class="btn btn-success" data-permission="MANAGE_PAYROLL_ITEMS" onclick="openAddItemModal('employer_contribution')">+ Add Contribution</button>
                </div>
                <div id="employerContributionItems" class="items-grid"></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Payroll Item</h2>
                <button class="close-btn" onclick="closeItemModal()">Close</button>
            </div>
            <div class="modal-body">
                <div id="modalError" style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: none; border: 1px solid #f5c6cb;"></div>

                <form id="itemForm" onsubmit="saveItem(event)">
                    <input type="hidden" id="itemId">
                    <input type="hidden" id="itemType">

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Item Code *</label>
                            <input type="text" id="itemCode" required placeholder="e.g. BONUS01">
                        </div>
                        <div class="form-group">
                            <label>IRP5 Code</label>
                            <input type="text" id="irp5Code" placeholder="e.g. 3802" maxlength="4">
                            <small style="color: #666;">See SARS IRP5/IT3(a) codes</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Item Name *</label>
                        <input type="text" id="itemName" required placeholder="e.g. Performance Bonus">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Category *</label>
                            <select id="itemCategory" required>
                                <option value="">Select...</option>
                                <option value="fixed">Fixed Amount</option>
                                <option value="percentage">Percentage (%)</option>
                                <option value="increasing_balance">Increasing Balance (Loan Given)</option>
                                <option value="decreasing_balance">Decreasing Balance (Loan Repayment)</option>
                                <option value="hours_based">Hours Based</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Default Amount/Percentage</label>
                            <input type="number" id="defaultAmount" step="0.01" placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Taxable?</label>
                            <select id="isTaxable">
                                <option value="1">Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Affects UIF?</label>
                            <select id="affectsUif">
                                <option value="1">Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeItemModal()">Cancel</button>
                        <button type="submit" class="btn btn-success">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/data-access.js"></script>
    <script src="js/permissions.js"></script>
    <script src="js/audit.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentCompanyId = null;
        let currentItems = [];

        // Check authentication
        window.addEventListener('load', function() {
            const session = AUTH.getSession();
            if (!session || !session.company_id) {
                window.location.href = 'login.html';
                return;
            }

            currentCompanyId = session.company_id;
            loadPageData();
        });

        function loadPageData() {
            const session = AUTH.getSession();
            const company = AUTH.getCompanyById(session.company_id);

            if (company) {
                document.getElementById('company-name-header').textContent = company.name;
            }

            loadCompaniesCarousel();
            loadItems();
        }

        function loadCompaniesCarousel() {
            const session = AUTH.getSession();
            const companies = AUTH.getCompaniesForUser(session);
            const carousel = document.getElementById('companies-carousel');
            carousel.innerHTML = '';

            if (companies.length === 0) {
                carousel.innerHTML = '<div style="padding: 10px; color: #999; text-align: center; font-size: 12px;">No companies available</div>';
            } else {
                companies.forEach(company => {
                    const div = document.createElement('div');
                    div.className = 'carousel-company';
                    div.textContent = company.name;
                    if (company.id === session.company_id) {
                        div.style.background = '#667eea';
                        div.style.color = 'white';
                        div.style.fontWeight = 'bold';
                    }
                    div.onclick = () => switchToCompany(company.id);
                    carousel.appendChild(div);
                });
            }

            // Add Company button for business_owner and accountant
            if (session.role === 'business_owner' || session.role === 'accountant') {
                var addBtn = document.createElement('div');
                addBtn.className = 'carousel-company';
                addBtn.style.cssText = 'background:#e8f5e9; color:#28a745; font-weight:600; text-align:center; border:1px dashed #28a745; cursor:pointer;';
                addBtn.textContent = '+ Add Company';
                addBtn.onclick = function() { openAddCompanyModal(); };
                carousel.appendChild(addBtn);
            }
        }

        function switchToCompany(company_id) {
            const session = AUTH.getSession();
            session.company_id = company_id;
            localStorage.setItem('session', JSON.stringify(session));
            location.reload();
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                AUTH.logout();
            }
        }

        // ========== PAYROLL ITEMS CRUD (localStorage) ==========

        function getStorageKey() {
            return 'payroll_items_' + currentCompanyId;
        }

        function loadItems() {
            const stored = localStorage.getItem(getStorageKey());
            if (stored) {
                try {
                    currentItems = JSON.parse(stored);
                } catch (e) {
                    currentItems = [];
                }
            } else {
                currentItems = [];
            }
            displayItemsByCategory();
        }

        function saveItemsToStorage() {
            localStorage.setItem(getStorageKey(), JSON.stringify(currentItems));
        }

        function displayItemsByCategory() {
            const categories = {
                income: document.getElementById('incomeItems'),
                allowance: document.getElementById('allowanceItems'),
                deduction: document.getElementById('deductionItems'),
                employer_contribution: document.getElementById('employerContributionItems')
            };

            Object.values(categories).forEach(el => el.innerHTML = '');

            const grouped = {
                income: currentItems.filter(i => i.item_type === 'income'),
                allowance: currentItems.filter(i => i.item_type === 'allowance'),
                deduction: currentItems.filter(i => i.item_type === 'deduction'),
                employer_contribution: currentItems.filter(i => i.item_type === 'employer_contribution')
            };

            Object.keys(grouped).forEach(type => {
                if (grouped[type].length === 0) {
                    categories[type].innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>No items in this category</p>
                        </div>
                    `;
                } else {
                    categories[type].innerHTML = grouped[type].map(item => createItemCard(item)).join('');
                }
            });
            Permissions.enforceUI();
        }

        function createItemCard(item) {
            const categoryBadge = getCategoryBadge(item.category);
            const taxBadge = item.is_taxable ? '<span class="badge badge-taxable">Taxable</span>' : '<span class="badge badge-non-taxable">Non-Tax</span>';
            const uifBadge = item.affects_uif ? '<span class="badge badge-uif">UIF</span>' : '<span class="badge badge-no-uif">No UIF</span>';
            const irp5Badge = item.irp5_code ? `<div class="irp5-code">IRP5: ${item.irp5_code}</div>` : '';

            return `
                <div class="item-card">
                    ${irp5Badge}
                    <div class="item-card-header">
                        <div class="item-title">
                            <div class="item-code">${item.item_code}</div>
                            <div class="item-name">${item.item_name}</div>
                        </div>
                    </div>
                    <div class="item-details">
                        <div class="item-detail">
                            <div class="item-detail-label">Category</div>
                            <div class="item-detail-value">${categoryBadge}</div>
                        </div>
                        <div class="item-detail">
                            <div class="item-detail-label">Default Amount</div>
                            <div class="item-detail-value">${item.default_amount ? 'R ' + parseFloat(item.default_amount).toFixed(2) : '-'}</div>
                        </div>
                        <div class="item-detail">
                            <div class="item-detail-label">Tax & UIF</div>
                            <div class="item-detail-value">${taxBadge} ${uifBadge}</div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-small btn-edit-small" data-permission="MANAGE_PAYROLL_ITEMS" onclick="editItem('${item.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn-small btn-delete-small" data-permission="MANAGE_PAYROLL_ITEMS" onclick="deleteItem('${item.id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
        }

        function getCategoryBadge(category) {
            const badges = {
                'fixed': '<span class="badge badge-fixed">Fixed</span>',
                'percentage': '<span class="badge badge-percentage">Percentage</span>',
                'increasing_balance': '<span class="badge badge-balance">Increasing</span>',
                'decreasing_balance': '<span class="badge badge-balance">Decreasing</span>',
                'hours_based': '<span class="badge badge-hours">Hours</span>'
            };
            return badges[category] || category;
        }

        function getTypeName(type) {
            const names = {
                'income': 'Income Item',
                'allowance': 'Allowance',
                'deduction': 'Deduction',
                'employer_contribution': 'Employer Contribution'
            };
            return names[type] || type;
        }

        // ========== MODAL FUNCTIONS ==========

        function openAddItemModal(type) {
            document.getElementById('modalTitle').textContent = `Add ${getTypeName(type)}`;
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('itemType').value = type;
            document.getElementById('modalError').style.display = 'none';
            document.getElementById('itemModal').classList.add('show');
        }

        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('show');
            document.getElementById('modalError').style.display = 'none';
        }

        function editItem(id) {
            const item = currentItems.find(i => i.id === id);
            if (!item) return;

            document.getElementById('modalTitle').textContent = 'Edit Payroll Item';
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemType').value = item.item_type;
            document.getElementById('itemCode').value = item.item_code;
            document.getElementById('itemName').value = item.item_name;
            document.getElementById('irp5Code').value = item.irp5_code || '';
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('defaultAmount').value = item.default_amount || '';
            document.getElementById('isTaxable').value = item.is_taxable ? '1' : '0';
            document.getElementById('affectsUif').value = item.affects_uif ? '1' : '0';
            document.getElementById('modalError').style.display = 'none';

            document.getElementById('itemModal').classList.add('show');
        }

        function saveItem(event) {
            event.preventDefault();

            const errorDiv = document.getElementById('modalError');
            errorDiv.style.display = 'none';

            const itemId = document.getElementById('itemId').value;
            const isEdit = itemId !== '';

            const itemData = {
                id: itemId || 'pi-' + Math.random().toString(36).substr(2, 9),
                item_code: document.getElementById('itemCode').value.trim(),
                item_name: document.getElementById('itemName').value.trim(),
                item_type: document.getElementById('itemType').value,
                category: document.getElementById('itemCategory').value,
                irp5_code: document.getElementById('irp5Code').value.trim() || null,
                default_amount: parseFloat(document.getElementById('defaultAmount').value) || 0,
                is_taxable: parseInt(document.getElementById('isTaxable').value) === 1,
                affects_uif: parseInt(document.getElementById('affectsUif').value) === 1
            };

            // Check for duplicate item code (but allow same code when editing same item)
            const duplicate = currentItems.find(i => i.item_code === itemData.item_code && i.id !== itemData.id);
            if (duplicate) {
                errorDiv.textContent = `Item code "${itemData.item_code}" already exists. Use a different code.`;
                errorDiv.style.display = 'block';
                return;
            }

            if (isEdit) {
                const index = currentItems.findIndex(i => i.id === itemId);
                if (index !== -1) {
                    currentItems[index] = itemData;
                }
            } else {
                currentItems.push(itemData);
            }

            saveItemsToStorage();

            if (isEdit) {
                AuditTrail.logUpdate(currentCompanyId, 'payroll_item', 'Updated payroll item "' + itemData.item_name + '" (' + itemData.item_code + ') - ' + itemData.category + ', R' + itemData.default_amount.toFixed(2));
            } else {
                AuditTrail.logCreate(currentCompanyId, 'payroll_item', 'Created payroll item "' + itemData.item_name + '" (' + itemData.item_code + ') - ' + itemData.category + ', R' + itemData.default_amount.toFixed(2));
            }

            // Show success
            const successDiv = document.getElementById('modalSuccess');
            successDiv.textContent = isEdit ? 'Item successfully updated!' : 'Item successfully added!';
            successDiv.style.display = 'block';
            setTimeout(() => { successDiv.style.display = 'none'; }, 3000);

            closeItemModal();
            displayItemsByCategory();
        }

        function deleteItem(id) {
            if (!Permissions.require('MANAGE_PAYROLL_ITEMS')) return;
            if (!confirm('Are you sure you want to delete this item?')) return;

            var deleted = currentItems.find(i => i.id === id);
            currentItems = currentItems.filter(i => i.id !== id);
            saveItemsToStorage();
            AuditTrail.logDelete(currentCompanyId, 'payroll_item', 'Deleted payroll item "' + (deleted ? deleted.item_name : id) + '"' + (deleted ? ' (' + deleted.item_code + ')' : ''));
            displayItemsByCategory();

            const successDiv = document.getElementById('modalSuccess');
            successDiv.textContent = 'Item deleted!';
            successDiv.style.display = 'block';
            setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
        }

        // ---- Add Company Modal ----
        function openAddCompanyModal() {
            document.getElementById('addCompanyModal').style.display = 'flex';
            document.getElementById('newCompanyName').value = '';
            document.getElementById('newCompanyEmail').value = '';
            document.getElementById('addCompanyError').style.display = 'none';
        }

        function closeAddCompanyModal() {
            document.getElementById('addCompanyModal').style.display = 'none';
        }

        function submitAddCompany() {
            var name = document.getElementById('newCompanyName').value.trim();
            var email = document.getElementById('newCompanyEmail').value.trim();
            var errorDiv = document.getElementById('addCompanyError');

            if (!name) {
                errorDiv.textContent = 'Please enter a company name';
                errorDiv.style.display = 'block';
                return;
            }

            var session = AUTH.getSession();
            var result = AUTH.createCompany({ name: name, email: email });
            if (!result.success) {
                errorDiv.textContent = 'Failed to create company';
                errorDiv.style.display = 'block';
                return;
            }

            AUTH.addCompanyToUser(session.user_id, result.company.id);
            AUTH.refreshSessionCompanyIds(result.company.id);

            // Switch to the new company
            session = AUTH.getSession();
            session.company_id = result.company.id;
            localStorage.setItem('session', JSON.stringify(session));

            closeAddCompanyModal();
            location.reload();
        }
    </script>
    <!-- Add Company Modal -->
    <div id="addCompanyModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:15px; padding:30px; max-width:450px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color:#667eea; margin:0;">Add New Company</h2>
                <span style="font-size:1.5rem; cursor:pointer; color:#999;" onclick="closeAddCompanyModal()">&times;</span>
            </div>
            <div id="addCompanyError" style="display:none; background:#fee; color:#c33; padding:10px; border-radius:8px; margin-bottom:15px; border-left:4px solid #c33;"></div>
            <div style="margin-bottom:15px;">
                <label style="display:block; font-weight:600; color:#333; margin-bottom:5px;">Company Name *</label>
                <input type="text" id="newCompanyName" placeholder="Enter company name" style="width:100%; padding:12px; border:2px solid #eee; border-radius:8px; font-size:1rem;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; font-weight:600; color:#333; margin-bottom:5px;">Company Email</label>
                <input type="email" id="newCompanyEmail" placeholder="Enter company email" style="width:100%; padding:12px; border:2px solid #eee; border-radius:8px; font-size:1rem;">
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="closeAddCompanyModal()" style="flex:1; padding:12px; background:#999; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Cancel</button>
                <button onclick="submitAddCompany()" style="flex:1; padding:12px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Create Company</button>
            </div>
        </div>
    </div>
    <nav class="mobile-bottom-nav">
        <a href="company-dashboard.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128202;</span><span class="mobile-nav-label">Dashboard</span></a>
        <a href="employee-management.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128101;</span><span class="mobile-nav-label">Employees</span></a>
        <a href="payruns.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128181;</span><span class="mobile-nav-label">Pay Runs</span></a>
        <a href="reports.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128203;</span><span class="mobile-nav-label">Reports</span></a>
    </nav>
    <script src="js/mobile-utils.js"></script>
</body>
</html>
