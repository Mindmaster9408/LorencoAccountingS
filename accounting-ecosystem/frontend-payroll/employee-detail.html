<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Employee Detail - Lorenco Paytime</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .wrapper { display: flex; gap: 20px; max-width: 1600px; margin: 0 auto; }

        /* SIDEBAR */
        .sidebar {
            width: 300px; background: white; border-radius: 15px;
            padding: 25px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: fit-content; position: sticky; top: 20px;
        }
        .sidebar-header { padding: 0 20px 20px; border-bottom: 2px solid #eee; }
        .sidebar-title { color: #667eea; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .sidebar-section { margin-top: 20px; }
        .sidebar-section-title {
            padding: 10px 20px; color: #999; font-size: 0.75rem;
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
        }
        .sidebar-link {
            display: block; padding: 12px 20px; color: #666; text-decoration: none;
            transition: all 0.2s; border-left: 3px solid transparent; font-weight: 500;
        }
        .sidebar-link:hover { background: #f8f9fa; color: #667eea; border-left-color: #667eea; }
        .sidebar-link.active { background: #f0f4ff; color: #667eea; border-left-color: #667eea; font-weight: 600; }
        .company-carousel { margin-top: 15px; padding: 15px 20px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        .carousel-title { font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 10px; text-transform: uppercase; }
        .carousel-companies { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
        .carousel-company {
            background: #f8f9fa; padding: 10px 12px; border-radius: 6px; font-size: 0.85rem;
            color: #333; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .carousel-company:hover { background: #eee; border-color: #667eea; color: #667eea; }
        .sidebar-actions { padding: 15px 20px; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .btn-sidebar { padding: 10px 15px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; text-align: center; }
        .btn-switch { background: #667eea; color: white; }
        .btn-switch:hover { background: #5568d3; }
        .btn-logout { background: #eee; color: #333; }
        .btn-logout:hover { background: #ddd; }

        .main-content { flex: 1; }

        /* HEADER */
        .header {
            background: white; padding: 30px; border-radius: 15px;
            margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header h1 { color: #667eea; margin-bottom: 0; }
        .employee-info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }
        .info-item { padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .info-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .info-value { font-size: 16px; font-weight: 600; color: #333; }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab {
            padding: 15px 30px; background: white; border: none; border-radius: 10px 10px 0 0;
            cursor: pointer; font-size: 16px; font-weight: 600; color: #666; transition: all 0.3s;
        }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* CARD */
        .card {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
        }
        .card h3 { color: #667eea; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

        /* SECTIONS */
        .section-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section { background: #f8f9fa; padding: 20px; border-radius: 10px; }
        .section-title {
            font-weight: 600; color: #667eea; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* SALARY ITEMS */
        .salary-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .salary-item:hover { background: #e3f2fd; }
        .salary-item.editable { border-left: 3px solid #667eea; }
        .salary-label { font-size: 14px; color: #555; }
        .salary-value { font-weight: 600; color: #333; }
        .salary-item .delete-btn {
            background: #dc3545; color: white; border: none; border-radius: 4px;
            padding: 2px 8px; font-size: 11px; cursor: pointer; margin-left: 10px;
        }

        /* BUTTONS */
        .btn {
            padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 6px; font-size: 14px;
            font-weight: 600; cursor: pointer; transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-secondary { background: #6c757d; }

        /* COLLAPSIBLE */
        .collapsible { cursor: pointer; user-select: none; }
        .collapsible:hover { background: #e8eaf6; }
        .collapsed-content { display: none; padding: 15px; background: white; border-radius: 8px; margin-top: 10px; }
        .expanded .collapsed-content { display: block; }

        /* CHECKBOX */
        .checkbox { display: flex; align-items: center; gap: 8px; margin: 10px 0; }
        .checkbox input[type="checkbox"] { width: auto; }

        /* PAYROLL SUMMARY */
        .total-row { border-top: 2px solid #667eea; font-weight: 700; background: #f0f4ff !important; }

        /* MODAL */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;
        }
        .modal.show { display: flex; align-items: flex-start; justify-content: center; padding: 50px 20px; }
        .modal-content { background: white; max-width: 600px; width: 100%; border-radius: 15px; padding: 30px; }
        .modal-content.wide { max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #667eea;
        }
        .modal-header h3 { color: #667eea; margin: 0; }

        /* FORMS */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #555; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* LEAVE */
        .leave-balances { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .leave-balance-card {
            background: white; border-radius: 12px; padding: 20px; text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-top: 4px solid #667eea;
        }
        .leave-balance-card.sick { border-top-color: #dc3545; }
        .leave-balance-card.family { border-top-color: #ffc107; }
        .leave-balance-type { font-size: 0.85rem; color: #999; text-transform: uppercase; font-weight: 600; }
        .leave-balance-number { font-size: 2rem; font-weight: 700; color: #333; margin: 5px 0; }
        .leave-balance-total { font-size: 0.8rem; color: #999; }
        .leave-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .leave-table th, .leave-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .leave-table th { background: #f8f9fa; font-weight: 600; color: #333; }
        .leave-status { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .leave-approved { background: #d4edda; color: #155724; }
        .leave-pending { background: #fff3cd; color: #856404; }
        .leave-rejected { background: #f8d7da; color: #721c24; }

        /* NOTES */
        .note-item {
            background: #fff9c4; padding: 15px; border-radius: 8px;
            margin-bottom: 10px; border-left: 4px solid #fbc02d;
        }
        .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .note-meta { font-size: 12px; color: #666; }
        .note-text { color: #333; line-height: 1.5; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #333; font-size: 13px; }

        /* PAYSLIP STATUS */
        .payslip-status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 20px; border-radius: 8px; margin-bottom: 15px; font-weight: 600;
        }
        .payslip-status-bar.draft { background: #fff3cd; color: #856404; }
        .payslip-status-bar.finalized { background: #d4edda; color: #155724; }
        .payslip-status-bar.locked { background: #f8d7da; color: #721c24; }
        .locked-overlay {
            position: relative;
        }
        .locked-overlay::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.5); border-radius: 10px; z-index: 5;
            pointer-events: all; cursor: not-allowed;
        }
        .btn-finalize { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 8px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; }
        .btn-finalize:hover { transform: translateY(-1px); }
        .btn-unfinalize { background: linear-gradient(135deg, #ffc107, #ff9800); color: #333; padding: 8px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; }
        .btn-unfinalize:hover { transform: translateY(-1px); }

        /* AUTH MODAL */
        .auth-input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; margin-bottom: 10px; }
        .auth-input:focus { outline: none; border-color: #667eea; }
    </style>
    <link rel="stylesheet" href="css/dark-theme.css">
    <link rel="stylesheet" href="css/mobile-responsive.css">
</head>
<body>
    <button id="mobile-hamburger" class="mobile-hamburger"><span style="font-size:20px;">&#9776;</span></button>
    <div id="mobile-overlay" class="mobile-overlay"></div>
    <div class="wrapper">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Menu</div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-section-title">Navigation</div>
                <a href="company-dashboard.html" class="sidebar-link">üìä Dashboard</a>
                <a href="employee-management.html" class="sidebar-link">üë• Employees</a>
                <a href="payruns.html" class="sidebar-link active">üíµ Pay Runs</a>
                <a href="payroll-items.html" class="sidebar-link">üìã Payroll Items</a>
                <a href="attendance.html" class="sidebar-link">&#x23F0; Attendance</a>
                <a href="reports.html" class="sidebar-link">üìä Reports</a>
                <a href="historical-import.html" class="sidebar-link">üì• Historical Import</a>
                <a href="company-details.html" class="sidebar-link">üè¢ Company Details</a>
            </div>
            <div class="company-carousel">
                <div class="carousel-title">Switch Company</div>
                <div class="carousel-container">
                    <div class="carousel-companies" id="companies-carousel"></div>
                </div>
            </div>
            <div class="sidebar-actions">
                <button class="btn-sidebar btn-switch" onclick="window.location.href='company-selection.html'">‚Üê Return to Dashboard</button>
                <button class="btn-sidebar btn-logout" onclick="handleLogout()">üö™ Logout</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
        <!-- HEADER -->
        <div class="header">
            <div class="header-top">
                <h1 id="employeeName">Employee Detail</h1>
                <button class="btn" onclick="window.location.href='payruns.html'">‚Üê Back to Pay Runs</button>
            </div>
            <div class="employee-info">
                <div class="info-item"><div class="info-label">Employee Number</div><div class="info-value" id="empNumber">-</div></div>
                <div class="info-item"><div class="info-label">Position</div><div class="info-value" id="empPosition">-</div></div>
                <div class="info-item"><div class="info-label">Department</div><div class="info-value" id="empDepartment">-</div></div>
                <div class="info-item"><div class="info-label">ID Number</div><div class="info-value" id="empIdNumber">-</div></div>
                <div class="info-item"><div class="info-label">Date of Birth</div><div class="info-value" id="empDOB">-</div></div>
                <div class="info-item"><div class="info-label">Payment Method</div><div class="info-value" id="empPayMethod">-</div></div>
            </div>
        </div>

        <!-- EMPLOYEE QUICK NAV -->
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: white; padding: 12px 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
            <button class="btn btn-sm btn-secondary" onclick="navigateEmployee('prev')" id="empPrevBtn" title="Previous Employee" style="padding: 6px 10px; font-size: 16px; line-height: 1;">&#9664;</button>
            <select id="empQuickNav" onchange="navigateToEmployee(this.value)" style="flex: 1; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">
                <option value="">Loading employees...</option>
            </select>
            <button class="btn btn-sm btn-secondary" onclick="navigateEmployee('next')" id="empNextBtn" title="Next Employee" style="padding: 6px 10px; font-size: 16px; line-height: 1;">&#9654;</button>
            <span id="empNavCounter" style="font-size: 12px; color: #999; white-space: nowrap; min-width: 50px; text-align: center;"></span>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('payroll')">üí∞ Payroll</button>
            <button class="tab" onclick="switchTab('edit')">‚úèÔ∏è Edit Info</button>
            <button class="tab" onclick="switchTab('leave')">üèñÔ∏è Leave</button>
            <button class="tab" onclick="switchTab('attendance')">‚è∞ Attendance</button>
            <button class="tab" onclick="switchTab('notes')">üìù Notes</button>
        </div>

        <!-- ==================== PAYROLL TAB ==================== -->
        <div id="payroll-tab" class="tab-content active">
            <div class="card">
                <h3 style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <span>Payroll for Period: <select id="payPeriod" onchange="loadPayrollData()" style="padding: 5px 10px; border: 2px solid #667eea; border-radius: 6px; font-size: 14px;"></select></span>
                    <span id="finalizeBtn"></span>
                </h3>
                <div id="payslipStatusBar"></div>
                <div id="payrollContent">
                <div class="section-grid">
                    <div class="section">
                        <div class="section-title"><span>üìÖ Regular Inputs (Monthly)</span><button class="btn btn-sm btn-success" onclick="openAddRegularInput()">+ Add</button></div>
                        <div class="salary-item editable" data-permission="EDIT_PAYROLL" onclick="editBasicSalary()">
                            <span class="salary-label">Basic Salary</span>
                            <span class="salary-value" id="basicSalary">R 0.00</span>
                        </div>
                        <div id="regularInputsList"></div>
                    </div>
                    <div class="section">
                        <div class="section-title"><span>üìä Current Inputs (This Month)</span><button class="btn btn-sm btn-success" onclick="openAddCurrentInput()">+ Add</button></div>
                        <div id="currentInputsList"><p style="color: #999; font-size: 14px;">No current inputs for this period</p></div>
                    </div>
                </div>

                <!-- ADDITIONAL HOURS -->
                <div class="card" style="margin-top: 20px;">
                    <div class="checkbox">
                        <input type="checkbox" id="showAdditionalHours" onchange="toggleAdditionalHours()">
                        <label for="showAdditionalHours" style="margin: 0; cursor: pointer;">Pay for Additional Hours</label>
                    </div>
                    <div id="additionalHoursSection" style="display: none; margin-top: 15px;">
                        <div class="section collapsible" onclick="toggleSection(this)">
                            <div class="section-title">‚è∞ Overtime <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); openAddOvertime()">+ Add</button></div>
                            <div class="collapsed-content"><div id="overtimeList"></div></div>
                        </div>
                        <div class="section collapsible" onclick="toggleSection(this)" style="margin-top: 15px;">
                            <div class="section-title">‚è±Ô∏è Short Time <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); openAddShortTime()">+ Add</button></div>
                            <div class="collapsed-content"><div id="shortTimeList"></div></div>
                        </div>
                        <div class="section collapsible" onclick="toggleSection(this)" style="margin-top: 15px;">
                            <div class="section-title">üíµ Paid at Different Rate <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); openAddMultiRate()">+ Add</button></div>
                            <div class="collapsed-content"><div id="multiRateList"></div></div>
                        </div>
                    </div>
                </div>

                <!-- PAYROLL SUMMARY -->
                <div class="card" style="margin-top: 20px; background: linear-gradient(135deg, #f0f4ff 0%, #e8eaf6 100%);">
                    <h3>üí∞ Payroll Summary</h3>
                    <table>
                        <tr><td><strong>Gross Salary:</strong></td><td style="text-align: right;"><strong id="totalGross">R 0.00</strong></td></tr>
                        <tr><td>PAYE:</td><td style="text-align: right;" id="totalPAYE">R 0.00</td></tr>
                        <tr id="medicalCreditRow" style="display: none;"><td>Medical Tax Credit:</td><td style="text-align: right; color: #28a745;" id="totalMedicalCredit">- R 0.00</td></tr>
                        <tr><td>UIF:</td><td style="text-align: right;" id="totalUIF">R 0.00</td></tr>
                        <tr><td>Deductions:</td><td style="text-align: right;" id="totalDeductions">R 0.00</td></tr>
                        <tr class="total-row"><td><strong>NET SALARY:</strong></td><td style="text-align: right;"><strong id="totalNet" style="font-size: 18px; color: #28a745;">R 0.00</strong></td></tr>
                    </table>
                    <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="calculatePayslip()">Calculate Payslip</button>
                    <div id="payslipActions" style="display: none; margin-top: 10px; gap: 10px;">
                        <button class="btn" style="flex: 1;" onclick="previewPayslip()">Preview Payslip</button>
                        <button class="btn btn-success" style="flex: 1;" onclick="downloadPayslipPDF()">Download PDF</button>
                    </div>
                    <div id="negativeNetWarning" style="display: none; margin-top: 10px; padding: 12px 20px; background: #f8d7da; color: #721c24; border-radius: 8px; border-left: 4px solid #dc3545; font-weight: 600;">‚ö† NEGATIVE NET PAY ‚Äî Deductions exceed gross salary. Please review inputs before finalizing.</div>
                </div>

                <!-- PAYSLIP NARRATIVE -->
                <div class="card" id="narrativeCard" style="margin-top: 20px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); display: none;">
                    <h3 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleNarrative()">
                        <span>üìñ Payslip Explanation</span>
                        <span id="narrativeToggle" style="font-size: 1.2rem;">‚ñº</span>
                    </h3>
                    <div id="narrativeContent" style="display: none; margin-top: 15px;">
                        <div id="narrativeHTML"></div>
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary btn-sm" onclick="regenerateNarrative()">üîÑ Regenerate</button>
                        </div>
                    </div>
                </div>

                </div><!-- /payrollContent -->
            </div>
        </div>

        <!-- ==================== EDIT INFO TAB ==================== -->
        <div id="edit-tab" class="tab-content">
            <div class="card">
                <h3>Employee Information</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #667eea; margin-bottom: 10px;">Personal Information</h4>
                        <div class="info-item"><div class="info-label">Full Name</div><div class="info-value" id="editFullName">-</div></div>
                        <div class="info-item"><div class="info-label">ID Number</div><div class="info-value" id="editIdNumber">-</div></div>
                        <div class="info-item"><div class="info-label">Email</div><div class="info-value" id="editEmail">-</div></div>
                        <div class="info-item"><div class="info-label">Phone</div><div class="info-value" id="editPhone">-</div></div>
                    </div>
                    <div>
                        <h4 style="color: #667eea; margin-bottom: 10px;">Work Information</h4>
                        <div class="info-item"><div class="info-label">Employee Number</div><div class="info-value" id="editEmpNumber">-</div></div>
                        <div class="info-item"><div class="info-label">Job Title</div><div class="info-value" id="editJobTitle">-</div></div>
                        <div class="info-item"><div class="info-label">Department</div><div class="info-value" id="editDepartment">-</div></div>
                        <div class="info-item"><div class="info-label">Date Appointed</div><div class="info-value" id="editDateAppointed">-</div></div>
                        <div class="info-item"><div class="info-label">Payment Method</div><div class="info-value" id="editPayMethod">-</div></div>
                        <div class="info-item"><div class="info-label">Medical Aid Members</div><div class="info-value" id="editMedicalMembers">0</div></div>
                        <div class="info-item"><div class="info-label">Tax Directive (%)</div><div class="info-value" id="editTaxDirective">0</div></div>
                        <div class="info-item" id="editBankSection" style="display: none;">
                            <div class="info-label">Bank Details</div><div class="info-value" id="editBankDetails">-</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px;"><button class="btn" onclick="openEditEmployeeModal()">Edit Information</button></div>
            </div>
        </div>

        <!-- ==================== LEAVE TAB ==================== -->
        <div id="leave-tab" class="tab-content">
            <div class="card">
                <h3>Leave Management</h3>
                <div class="leave-balances">
                    <div class="leave-balance-card">
                        <div class="leave-balance-type">Annual Leave</div>
                        <div class="leave-balance-number" id="annualLeaveBalance">15</div>
                        <div class="leave-balance-total">of 15 days remaining</div>
                    </div>
                    <div class="leave-balance-card sick">
                        <div class="leave-balance-type">Sick Leave</div>
                        <div class="leave-balance-number" id="sickLeaveBalance">30</div>
                        <div class="leave-balance-total">of 30 days (3yr cycle)</div>
                    </div>
                    <div class="leave-balance-card family">
                        <div class="leave-balance-type">Family Responsibility</div>
                        <div class="leave-balance-number" id="familyLeaveBalance">3</div>
                        <div class="leave-balance-total">of 3 days remaining</div>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="openAddLeaveModal()">+ Add Leave Request</button>
                </div>
                <table class="leave-table">
                    <thead><tr><th>Type</th><th>Start Date</th><th>End Date</th><th>Days</th><th>Status</th><th>Reason</th><th>Actions</th></tr></thead>
                    <tbody id="leaveTableBody"><tr><td colspan="7" style="text-align: center; color: #999; padding: 30px;">No leave records yet</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- ==================== NOTES TAB ==================== -->
        <div id="notes-tab" class="tab-content">
            <div class="card">
                <h3>Employee Notes</h3>
                <div class="form-group">
                    <label>Add a note:</label>
                    <textarea id="newNote" rows="3" placeholder="Type your note here..."></textarea>
                </div>
                <button class="btn btn-success" onclick="addNote()">Save Note</button>
                <div id="notesList" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- ==================== ATTENDANCE TAB ==================== -->
        <div id="attendance-tab" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                    <h3>‚è∞ Attendance Records</h3>
                    <a href="attendance.html" class="btn btn-primary btn-sm">Open Full Attendance</a>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: #f0f4ff; border-radius: 10px; padding: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #667eea;" id="empAttDaysWorked">0</div>
                        <div style="font-size: 0.8rem; color: #888;">Days Worked</div>
                    </div>
                    <div style="background: #f0fff4; border-radius: 10px; padding: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #28a745;" id="empAttTotalHours">0</div>
                        <div style="font-size: 0.8rem; color: #888;">Total Hours</div>
                    </div>
                    <div style="background: #fff3f0; border-radius: 10px; padding: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #fd7e14;" id="empAttOvertime">0</div>
                        <div style="font-size: 0.8rem; color: #888;">Overtime</div>
                    </div>
                    <div style="background: #fff0f0; border-radius: 10px; padding: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #dc3545;" id="empAttAbsences">0</div>
                        <div style="font-size: 0.8rem; color: #888;">Absences</div>
                    </div>
                </div>
                <div class="responsive-table-wrapper">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Clock In</th><th>Clock Out</th><th>Hours</th><th>Status</th></tr>
                        </thead>
                        <tbody id="empAttendanceBody">
                            <tr><td colspan="5" style="text-align:center; color:#888; padding:20px;">Select a period and switch to this tab to load attendance.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div><!-- /main-content -->
    </div><!-- /wrapper -->

    <!-- ==================== MODALS ==================== -->

    <!-- Edit Basic Salary -->
    <div id="editBasicModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Edit Basic Salary</h3><button class="btn btn-danger btn-sm" onclick="closeModal('editBasicModal')">Close</button></div>
            <div class="form-group"><label>Basic Salary (per month)</label><input type="number" id="editBasicValue" step="0.01" min="0"></div>
            <button class="btn btn-success" style="width:100%;" onclick="saveBasicSalary()">Save</button>
        </div>
    </div>

    <!-- Add Regular Input -->
    <div id="addRegularModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add Regular Input</h3><button class="btn btn-danger btn-sm" onclick="closeModal('addRegularModal')">Close</button></div>
            <div class="form-group"><label>Payroll Item</label><select id="regularItemSelect" onchange="onRegularItemSelect()"></select></div>
            <div id="regularCustomFields">
                <div class="form-group"><label>Type</label><select id="regularInputType"><option value="allowance">Allowance</option><option value="deduction">Deduction</option></select></div>
                <div class="form-group"><label>Description</label><input type="text" id="regularInputDesc" placeholder="e.g. Housing Allowance"></div>
                <div class="form-group"><label>Amount (per month)</label><input type="number" id="regularInputAmount" step="0.01" min="0"></div>
            </div>
            <div id="regularItemInfo" style="display:none; background:#f0f4ff; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.85rem;">
                <span id="regularItemBadges"></span>
            </div>
            <button class="btn btn-success" style="width:100%;" onclick="saveRegularInput()">Save</button>
        </div>
    </div>

    <!-- Add Current Input -->
    <div id="addCurrentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add Current Input</h3><button class="btn btn-danger btn-sm" onclick="closeModal('addCurrentModal')">Close</button></div>
            <div class="form-group"><label>Payroll Item</label><select id="currentItemSelect" onchange="onCurrentItemSelect()"></select></div>
            <div id="currentCustomFields">
                <div class="form-group"><label>Type</label><select id="currentInputType"><option value="bonus">Bonus</option><option value="commission">Commission</option><option value="allowance">Allowance</option><option value="deduction">Deduction</option><option value="other">Other</option></select></div>
                <div class="form-group"><label>Description</label><input type="text" id="currentInputDesc"></div>
                <div class="form-group"><label>Amount</label><input type="number" id="currentInputAmount" step="0.01" min="0"></div>
            </div>
            <div id="currentItemInfo" style="display:none; background:#f0f4ff; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.85rem;">
                <span id="currentItemBadges"></span>
            </div>
            <button class="btn btn-success" style="width:100%;" onclick="saveCurrentInput()">Save</button>
        </div>
    </div>

    <!-- Add Overtime -->
    <div id="addOvertimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add Overtime</h3><button class="btn btn-danger btn-sm" onclick="closeModal('addOvertimeModal')">Close</button></div>
            <div class="form-group"><label>Date</label><input type="date" id="overtimeDate"></div>
            <div class="form-group"><label>Hours</label><input type="number" id="overtimeHours" step="0.5" min="0"></div>
            <div class="form-group"><label>Rate Multiplier</label><select id="overtimeRate"><option value="1.5">1.5x (Time and a half)</option><option value="2.0">2.0x (Double time)</option><option value="2.5">2.5x</option><option value="3.0">3.0x (Triple time)</option></select></div>
            <div class="form-group"><label>Description</label><input type="text" id="overtimeDesc"></div>
            <button class="btn btn-success" style="width:100%;" onclick="saveOvertime()">Save</button>
        </div>
    </div>

    <!-- Add Short Time -->
    <div id="addShortTimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add Short Time</h3><button class="btn btn-danger btn-sm" onclick="closeModal('addShortTimeModal')">Close</button></div>
            <div class="form-group"><label>Date</label><input type="date" id="shortTimeDate"></div>
            <div class="form-group"><label>Hours Missed</label><input type="number" id="shortTimeHours" step="0.5" min="0"></div>
            <div class="form-group"><label>Reason</label><input type="text" id="shortTimeReason"></div>
            <button class="btn btn-success" style="width:100%;" onclick="saveShortTime()">Save</button>
        </div>
    </div>

    <!-- Add Multi-Rate -->
    <div id="addMultiRateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add Paid at Different Rate</h3><button class="btn btn-danger btn-sm" onclick="closeModal('addMultiRateModal')">Close</button></div>
            <div class="form-group"><label>Description</label><input type="text" id="multiRateDesc"></div>
            <div class="form-group"><label>Hourly Rate (R)</label><input type="number" id="multiRateHourly" step="0.01" min="0"></div>
            <div class="form-group"><label>Hours</label><input type="number" id="multiRateHours" step="0.5" min="0"></div>
            <button class="btn btn-success" style="width:100%;" onclick="saveMultiRate()">Save</button>
        </div>
    </div>

    <!-- Edit Employee Info -->
    <div id="editEmployeeModal" class="modal">
        <div class="modal-content wide">
            <div class="modal-header"><h3>Edit Employee Information</h3><button class="btn btn-danger btn-sm" onclick="closeModal('editEmployeeModal')">Close</button></div>
            <div class="form-row">
                <div class="form-group"><label>First Name</label><input type="text" id="editFirstName"></div>
                <div class="form-group"><label>Last Name</label><input type="text" id="editLastName"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Email</label><input type="email" id="editEmailInput"></div>
                <div class="form-group"><label>Phone</label><input type="tel" id="editPhoneInput"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Job Title</label><input type="text" id="editJobTitleInput"></div>
                <div class="form-group"><label>Department</label><input type="text" id="editDepartmentInput"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Position</label><input type="text" id="editPositionInput"></div>
                <div class="form-group"><label>Date Appointed</label><input type="date" id="editDateAppointedInput"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Payment Method</label><select id="editPayMethodInput"><option value="EFT">EFT</option><option value="Cash">Cash</option><option value="Cheque">Cheque</option></select></div>
                <div class="form-group"><label>ID Number</label><input type="text" id="editIdNumberInput" maxlength="13"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Medical Aid Members</label><input type="number" id="editMedicalMembersInput" min="0" max="20" step="1" placeholder="0 = none"></div>
                <div class="form-group"><label>Tax Directive (%)</label><input type="number" id="editTaxDirectiveInput" min="0" max="100" step="0.01" placeholder="0 = standard PAYE"></div>
            </div>
            <h4 style="color: #667eea; margin: 15px 0 10px;">Bank Details</h4>
            <div class="form-row">
                <div class="form-group"><label>Bank Name</label><input type="text" id="editBankName"></div>
                <div class="form-group"><label>Account Holder</label><input type="text" id="editAccountHolder"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Account Number</label><input type="text" id="editAccountNumber"></div>
                <div class="form-group"><label>Branch Code</label><input type="text" id="editBranchCode"></div>
            </div>
            <button class="btn btn-success" style="margin-top: 15px; width: 100%;" onclick="saveEmployeeInfo()">Save Changes</button>
        </div>
    </div>

    <!-- Add Leave -->
    <div id="addLeaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add Leave Request</h3><button class="btn btn-danger btn-sm" onclick="closeModal('addLeaveModal')">Close</button></div>
            <div class="form-group"><label>Leave Type</label><select id="leaveType"><option value="annual">Annual Leave</option><option value="sick">Sick Leave</option><option value="family">Family Responsibility</option><option value="maternity">Maternity Leave</option><option value="study">Study Leave</option><option value="unpaid">Unpaid Leave</option></select></div>
            <div class="form-row">
                <div class="form-group"><label>Start Date</label><input type="date" id="leaveStartDate" onchange="calcLeaveDays()"></div>
                <div class="form-group"><label>End Date</label><input type="date" id="leaveEndDate" onchange="calcLeaveDays()"></div>
            </div>
            <div class="form-group"><label>Days (auto-calculated, weekdays only)</label><input type="number" id="leaveDays" min="0.5" step="0.5" readonly style="background: #f0f0f0;"></div>
            <div class="form-group"><label>Reason</label><textarea id="leaveReason" rows="2" placeholder="Reason for leave..."></textarea></div>
            <div class="form-group"><label>Status</label><select id="leaveStatus"><option value="approved">Approved</option><option value="pending">Pending</option><option value="rejected">Rejected</option></select></div>
            <button class="btn btn-success" style="width:100%;" onclick="saveLeave()">Save Leave</button>
        </div>
    </div>

    <!-- Payslip Preview Modal -->
    <div id="payslipPreviewModal" class="modal">
        <div class="modal-content wide" style="max-width: 700px; padding: 0; overflow: visible;">
            <div class="modal-header" style="padding: 15px 25px; border-bottom: 2px solid #667eea;" id="payslipPreviewHeader">
                <h3>Payslip Preview</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-sm" onclick="printPayslip()">Print</button>
                    <button class="btn btn-success btn-sm" onclick="downloadPayslipPDF()">Download PDF</button>
                    <button class="btn btn-danger btn-sm" onclick="closeModal('payslipPreviewModal')">Close</button>
                </div>
            </div>
            <div id="payslipPreviewBody" style="padding: 30px; font-family: 'Segoe UI', Arial, sans-serif;">
                <!-- Payslip content rendered here by previewPayslip() -->
            </div>
        </div>
    </div>
    <style id="payslipPrintStyles">
        @media print {
            body > *:not(#payslipPreviewModal) { display: none !important; }
            #payslipPreviewModal { position: static !important; background: none !important; display: block !important; overflow: visible !important; padding: 0 !important; }
            #payslipPreviewModal .modal-content { box-shadow: none !important; max-width: 100% !important; max-height: none !important; overflow: visible !important; border-radius: 0 !important; }
            #payslipPreviewHeader { display: none !important; }
            #payslipPreviewBody { padding: 10px !important; }
            .payslip-preview-footer-buttons { display: none !important; }
        }
    </style>

    <!-- Manager Auth Modal -->
    <div id="managerAuthModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header"><h3>Manager Authorization</h3><button class="btn btn-danger btn-sm" onclick="closeModal('managerAuthModal')">Close</button></div>
            <p style="color: #666; margin-bottom: 15px;">A pay run exists for this period. A manager must authorize changes to this payslip.</p>
            <div class="form-group"><label>Manager Email</label><input type="email" id="authEmail" class="auth-input" placeholder="manager@company.com"></div>
            <div class="form-group"><label>Manager Password</label><input type="password" id="authPassword" class="auth-input" placeholder="Password"></div>
            <button class="btn btn-success" style="width:100%;" onclick="verifyManagerAuth()">Authorize & Unlock</button>
        </div>
    </div>

    <script src="js/data-access.js"></script>
    <script src="js/permissions.js"></script>
    <script src="js/audit.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/payroll-engine.js"></script>
    <script src="js/payroll-items-helper.js"></script>
    <script>
        let currentCompanyId = null;
        let currentEmployee = null;
        let currentEmpId = null;
        let payrollData = { basic_salary: 0, regular_inputs: [] };
        let currentPeriod = '';

        // ========== INIT ==========
        window.addEventListener('load', function() {
            if (!AUTH.isLoggedIn()) { window.location.href = 'login.html'; return; }
            const session = AUTH.getSession();
            currentCompanyId = session.company_id;
            const params = new URLSearchParams(window.location.search);
            currentEmpId = params.get('id');
            if (!currentEmpId) { alert('No employee specified'); window.location.href = 'payruns.html'; return; }
            loadEmployee();
            loadEmployeeNav();
            loadCompaniesCarousel();
            initPeriodSelect();
            loadPayrollData();
            loadLeaveData();
            loadNotes();
        });

        // ========== SIDEBAR ==========
        function loadCompaniesCarousel() {
            const session = AUTH.getSession();
            const companies = AUTH.getCompaniesForUser(session);
            const carousel = document.getElementById('companies-carousel');
            carousel.innerHTML = '';

            if (companies.length === 0) {
                carousel.innerHTML = '<div style="padding: 10px; color: #999; text-align: center; font-size: 12px;">No companies available</div>';
            } else {
                companies.forEach(company => {
                    const div = document.createElement('div');
                    div.className = 'carousel-company';
                    div.textContent = company.name;
                    if (company.id === session.company_id) {
                        div.style.background = '#667eea';
                        div.style.color = 'white';
                        div.style.fontWeight = 'bold';
                    }
                    div.onclick = () => switchToCompany(company.id);
                    carousel.appendChild(div);
                });
            }

            // Add Company button for business_owner and accountant
            if (session.role === 'business_owner' || session.role === 'accountant') {
                var addBtn = document.createElement('div');
                addBtn.className = 'carousel-company';
                addBtn.style.cssText = 'background:#e8f5e9; color:#28a745; font-weight:600; text-align:center; border:1px dashed #28a745; cursor:pointer;';
                addBtn.textContent = '+ Add Company';
                addBtn.onclick = function() { openAddCompanyModal(); };
                carousel.appendChild(addBtn);
            }
        }

        function switchToCompany(companyId) {
            const session = AUTH.getSession();
            session.company_id = companyId;
            localStorage.setItem('session', JSON.stringify(session));
            window.location.href = 'payruns.html';
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) { AUTH.logout(); }
        }

        function loadEmployee() {
            const stored = localStorage.getItem('employees_' + currentCompanyId);
            const employees = stored ? JSON.parse(stored) : [];
            currentEmployee = employees.find(e => e.id === currentEmpId);
            if (!currentEmployee) { alert('Employee not found'); window.location.href = 'payruns.html'; return; }

            document.getElementById('employeeName').textContent = currentEmployee.first_name + ' ' + currentEmployee.last_name;
            document.getElementById('empNumber').textContent = currentEmployee.employee_number || '-';
            document.getElementById('empPosition').textContent = currentEmployee.position || currentEmployee.job_title || '-';
            document.getElementById('empDepartment').textContent = currentEmployee.department || '-';
            document.getElementById('empIdNumber').textContent = currentEmployee.id_number || '-';
            document.getElementById('empDOB').textContent = currentEmployee.id_number ? extractDOB(currentEmployee.id_number) : '-';
            document.getElementById('empPayMethod').textContent = currentEmployee.payment_method || 'EFT';

            // Edit Info tab
            document.getElementById('editFullName').textContent = currentEmployee.first_name + ' ' + currentEmployee.last_name;
            document.getElementById('editIdNumber').textContent = currentEmployee.id_number || '-';
            document.getElementById('editEmail').textContent = currentEmployee.email || '-';
            document.getElementById('editPhone').textContent = currentEmployee.phone || '-';
            document.getElementById('editEmpNumber').textContent = currentEmployee.employee_number || '-';
            document.getElementById('editJobTitle').textContent = currentEmployee.job_title || '-';
            document.getElementById('editDepartment').textContent = currentEmployee.department || '-';
            document.getElementById('editDateAppointed').textContent = currentEmployee.date_appointed || '-';
            document.getElementById('editPayMethod').textContent = currentEmployee.payment_method || 'EFT';
            document.getElementById('editMedicalMembers').textContent = currentEmployee.medical_aid_members || 0;
            document.getElementById('editTaxDirective').textContent = currentEmployee.tax_directive || 0;
            if (currentEmployee.payment_method === 'EFT' && currentEmployee.bank_name) {
                document.getElementById('editBankSection').style.display = '';
                document.getElementById('editBankDetails').textContent = currentEmployee.bank_name + ' - ' + (currentEmployee.account_number || '') + ' (Branch: ' + (currentEmployee.branch_code || '') + ')';
            }
        }

        function extractDOB(idNumber) {
            if (!idNumber || idNumber.length < 6) return '-';
            const yy = idNumber.substring(0, 2);
            const mm = idNumber.substring(2, 4);
            const dd = idNumber.substring(4, 6);
            const year = parseInt(yy) > 30 ? '19' + yy : '20' + yy;
            return dd + '/' + mm + '/' + year;
        }

        // ========== EMPLOYEE QUICK NAV ==========
        function getEmployeesSorted() {
            var stored = localStorage.getItem('employees_' + currentCompanyId);
            var employees = stored ? JSON.parse(stored) : [];
            employees.sort(function(a, b) {
                var nameA = ((a.first_name || '') + ' ' + (a.last_name || '')).toLowerCase();
                var nameB = ((b.first_name || '') + ' ' + (b.last_name || '')).toLowerCase();
                return nameA.localeCompare(nameB);
            });
            return employees;
        }

        function loadEmployeeNav() {
            var employees = getEmployeesSorted();
            var select = document.getElementById('empQuickNav');
            select.innerHTML = '';
            employees.forEach(function(emp) {
                var opt = document.createElement('option');
                opt.value = emp.id;
                opt.textContent = (emp.first_name || '') + ' ' + (emp.last_name || '') + (emp.employee_number ? ' (' + emp.employee_number + ')' : '');
                if (emp.id === currentEmpId) opt.selected = true;
                select.appendChild(opt);
            });
            var idx = employees.findIndex(function(e) { return e.id === currentEmpId; });
            document.getElementById('empNavCounter').textContent = (idx + 1) + ' of ' + employees.length;
        }

        function navigateToEmployee(empId) {
            if (!empId) return;
            window.location.href = 'employee-detail.html?id=' + empId;
        }

        function navigateEmployee(direction) {
            var employees = getEmployeesSorted();
            if (employees.length === 0) return;
            var idx = employees.findIndex(function(e) { return e.id === currentEmpId; });
            if (direction === 'prev') {
                idx = idx <= 0 ? employees.length - 1 : idx - 1;
            } else {
                idx = idx >= employees.length - 1 ? 0 : idx + 1;
            }
            window.location.href = 'employee-detail.html?id=' + employees[idx].id;
        }

        // ========== TAB SWITCHING ==========
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
            if (tab === 'attendance') loadEmployeeAttendance();
        }

        // ========== PERIOD SELECT ==========
        function initPeriodSelect() {
            const select = document.getElementById('payPeriod');
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const val = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
                const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = months[d.getMonth()] + ' ' + d.getFullYear();
                select.appendChild(opt);
            }
            currentPeriod = select.value;
        }

        // ========== STORAGE KEYS ==========
        function getPayrollKey() { return 'emp_payroll_' + currentCompanyId + '_' + currentEmpId; }
        function getCurrentKey() { return 'emp_current_' + currentCompanyId + '_' + currentEmpId + '_' + currentPeriod; }
        function getOvertimeKey() { return 'emp_overtime_' + currentCompanyId + '_' + currentEmpId + '_' + currentPeriod; }
        function getShortTimeKey() { return 'emp_short_time_' + currentCompanyId + '_' + currentEmpId + '_' + currentPeriod; }
        function getMultiRateKey() { return 'emp_multi_rate_' + currentCompanyId + '_' + currentEmpId + '_' + currentPeriod; }
        function getLeaveKey() { return 'emp_leave_' + currentCompanyId + '_' + currentEmpId; }
        function getNotesKey() { return 'emp_notes_' + currentCompanyId + '_' + currentEmpId; }
        function getPayslipStatusKey() { return 'emp_payslip_status_' + currentCompanyId + '_' + currentEmpId + '_' + currentPeriod; }

        // ========== PAYSLIP STATUS ==========
        function getPayslipStatus() {
            const stored = localStorage.getItem(getPayslipStatusKey());
            return stored ? JSON.parse(stored) : { status: 'draft' };
        }

        function isPayrunLockedForPeriod() {
            const payruns = JSON.parse(localStorage.getItem('payruns_' + currentCompanyId) || '[]');
            return payruns.find(pr => pr.period === currentPeriod && (pr.status === 'finalized' || pr.status === 'paid'));
        }

        function updatePayslipUI() {
            const psStatus = getPayslipStatus();
            const lockedRun = isPayrunLockedForPeriod();
            const statusBar = document.getElementById('payslipStatusBar');
            const btnArea = document.getElementById('finalizeBtn');
            const content = document.getElementById('payrollContent');

            content.classList.remove('locked-overlay');

            if (lockedRun && psStatus.status === 'finalized') {
                // Pay run exists AND payslip finalized = fully locked
                statusBar.innerHTML = '<div class="payslip-status-bar locked">üîí Locked ‚Äî Pay run (' + lockedRun.status + ') exists for this period. Manager authorization required to make changes.</div>';
                btnArea.innerHTML = '<button class="btn-unfinalize" onclick="requestManagerAuth()">üîì Request Unlock</button>';
                content.classList.add('locked-overlay');
            } else if (psStatus.status === 'finalized') {
                // Finalized but no pay run yet = can unfinalize freely
                statusBar.innerHTML = '<div class="payslip-status-bar finalized">‚úÖ Payslip finalized on ' + new Date(psStatus.finalized_date).toLocaleDateString() + ' by ' + (psStatus.finalized_by || 'System') + '</div>';
                btnArea.innerHTML = '<button class="btn-unfinalize" data-permission="UNFINALIZE_PAYSLIP" onclick="unfinalizePayslip()">‚Ü© Unfinalize</button>';
                content.classList.add('locked-overlay');
            } else {
                // Draft
                statusBar.innerHTML = '<div class="payslip-status-bar draft">üìù Draft ‚Äî Finalize this payslip to include it in a pay run.</div>';
                btnArea.innerHTML = '<button class="btn-finalize" data-permission="FINALIZE_PAYSLIP" onclick="finalizePayslip()">‚úì Finalize Payslip</button>';
            }
            Permissions.enforceUI();
        }

        function finalizePayslip() {
            if (!Permissions.require('FINALIZE_PAYSLIP')) return;
            // Auto-calculate before finalizing
            calculatePayslip();
            const session = AUTH.getSession();
            if (!confirm('Finalize this payslip for ' + formatPeriodLabel(currentPeriod) + '? It will be locked for editing.')) return;
            const status = { status: 'finalized', finalized_date: new Date().toISOString(), finalized_by: session.name || session.email };
            localStorage.setItem(getPayslipStatusKey(), JSON.stringify(status));
            AuditTrail.logFinalize(currentCompanyId, 'payslip', 'Finalized payslip for ' + (currentEmployee ? currentEmployee.first_name + ' ' + currentEmployee.last_name : currentEmpId) + ' - ' + formatPeriodLabel(currentPeriod));
            updatePayslipUI();
        }

        function unfinalizePayslip() {
            if (!Permissions.require('UNFINALIZE_PAYSLIP')) return;
            if (!confirm('Unfinalize this payslip? It will be editable again.')) return;
            localStorage.removeItem(getPayslipStatusKey());
            AuditTrail.logUnfinalize(currentCompanyId, 'payslip', 'Unfinalized payslip for ' + (currentEmployee ? currentEmployee.first_name + ' ' + currentEmployee.last_name : currentEmpId) + ' - ' + formatPeriodLabel(currentPeriod));
            updatePayslipUI();
        }

        function requestManagerAuth() {
            document.getElementById('authEmail').value = '';
            document.getElementById('authPassword').value = '';
            document.getElementById('managerAuthModal').classList.add('show');
        }

        function verifyManagerAuth() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            if (!email || !password) { alert('Please enter both email and password'); return; }

            // Check credentials via AUTH system
            const result = AUTH.findUserByEmail(email);
            if (!result) { alert('User not found'); return; }
            if (result.user.password !== password) { alert('Invalid password'); return; }

            // Check if user has authorized role
            const role = result.user.role || '';
            const allowedRoles = ['super_admin', 'admin', 'manager', 'business_owner'];
            if (!allowedRoles.includes(role)) {
                alert('Authorization denied. Only business owners, managers, and admins can unlock payslips.');
                return;
            }

            // Unlock: remove finalized status
            localStorage.removeItem(getPayslipStatusKey());
            closeModal('managerAuthModal');
            updatePayslipUI();
            alert('Payslip unlocked by ' + email + '. You can now make changes.');
        }

        function formatPeriodLabel(period) {
            const [year, month] = period.split('-');
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return months[parseInt(month) - 1] + ' ' + year;
        }

        // ========== PAYROLL DATA ==========
        function loadPayrollData() {
            currentPeriod = document.getElementById('payPeriod').value;
            const stored = localStorage.getItem(getPayrollKey());
            payrollData = stored ? JSON.parse(stored) : { basic_salary: 0, regular_inputs: [] };
            renderPayroll();
            updatePayslipUI();
        }

        function savePayrollData() {
            localStorage.setItem(getPayrollKey(), JSON.stringify(payrollData));
        }

        function renderPayroll() {
            document.getElementById('basicSalary').textContent = formatMoney(payrollData.basic_salary || 0);

            // Regular inputs
            const riList = document.getElementById('regularInputsList');
            riList.innerHTML = payrollData.regular_inputs.map(ri => {
                const color = ri.type === 'deduction' ? '#dc3545' : '#28a745';
                const prefix = ri.type === 'deduction' ? '- ' : '+ ';
                return '<div class="salary-item editable"><span class="salary-label">' + ri.description + ' <span style="color:' + color + '; font-size:11px;">(' + ri.type + ')</span></span><span><span class="salary-value" style="color:' + color + ';">' + prefix + formatMoney(ri.amount) + '</span><button class="delete-btn" onclick="event.stopPropagation(); deleteRegularInput(\'' + ri.id + '\')">x</button></span></div>';
            }).join('');

            // Current inputs
            const ciList = document.getElementById('currentInputsList');
            const currentInputs = JSON.parse(localStorage.getItem(getCurrentKey()) || '[]');
            if (currentInputs.length === 0) {
                ciList.innerHTML = '<p style="color: #999; font-size: 14px;">No current inputs for this period</p>';
            } else {
                ciList.innerHTML = currentInputs.map(ci => {
                    const color = ci.type === 'deduction' ? '#dc3545' : '#28a745';
                    const prefix = ci.type === 'deduction' ? '- ' : '+ ';
                    return '<div class="salary-item"><span class="salary-label">' + ci.description + ' <span style="color:' + color + '; font-size:11px;">(' + ci.type + ')</span></span><span><span class="salary-value" style="color:' + color + ';">' + prefix + formatMoney(ci.amount) + '</span><button class="delete-btn" onclick="event.stopPropagation(); deleteCurrentInput(\'' + ci.id + '\')">x</button></span></div>';
                }).join('');
            }

            // Overtime
            const otList = document.getElementById('overtimeList');
            const overtime = JSON.parse(localStorage.getItem(getOvertimeKey()) || '[]');
            otList.innerHTML = overtime.length === 0 ? '<p style="color:#999;font-size:14px;">No overtime recorded</p>' :
                overtime.map(ot => '<div class="salary-item"><span class="salary-label">' + ot.date + ' - ' + ot.hours + 'hrs @ ' + ot.rate_multiplier + 'x' + (ot.description ? ' (' + ot.description + ')' : '') + '</span><button class="delete-btn" onclick="event.stopPropagation(); deleteOvertime(\'' + ot.id + '\')">x</button></div>').join('');

            // Short time
            const stList = document.getElementById('shortTimeList');
            const shortTime = JSON.parse(localStorage.getItem(getShortTimeKey()) || '[]');
            stList.innerHTML = shortTime.length === 0 ? '<p style="color:#999;font-size:14px;">No short time recorded</p>' :
                shortTime.map(st => '<div class="salary-item"><span class="salary-label">' + st.date + ' - ' + st.hours_missed + 'hrs missed' + (st.reason ? ' (' + st.reason + ')' : '') + '</span><button class="delete-btn" onclick="event.stopPropagation(); deleteShortTime(\'' + st.id + '\')">x</button></div>').join('');

            // Multi-rate
            const mrList = document.getElementById('multiRateList');
            const multiRate = JSON.parse(localStorage.getItem(getMultiRateKey()) || '[]');
            mrList.innerHTML = multiRate.length === 0 ? '<p style="color:#999;font-size:14px;">No multi-rate hours recorded</p>' :
                multiRate.map(mr => '<div class="salary-item"><span class="salary-label">' + mr.description + ' - ' + mr.hours + 'hrs @ R' + parseFloat(mr.hourly_rate).toFixed(2) + '/hr</span><span><span class="salary-value">' + formatMoney(mr.hours * mr.hourly_rate) + '</span><button class="delete-btn" onclick="event.stopPropagation(); deleteMultiRate(\'' + mr.id + '\')">x</button></span></div>').join('');
            Permissions.enforceUI();
        }

        // ========== BASIC SALARY ==========
        function editBasicSalary() {
            document.getElementById('editBasicValue').value = payrollData.basic_salary || 0;
            document.getElementById('editBasicModal').classList.add('show');
        }
        function saveBasicSalary() {
            payrollData.basic_salary = parseFloat(document.getElementById('editBasicValue').value) || 0;
            savePayrollData(); renderPayroll(); closeModal('editBasicModal');
            AuditTrail.logUpdate(currentCompanyId, 'payroll', 'Updated basic salary to R' + payrollData.basic_salary.toFixed(2) + ' for ' + (currentEmployee ? currentEmployee.first_name + ' ' + currentEmployee.last_name : currentEmpId));
        }

        // ========== REGULAR INPUTS ==========
        function openAddRegularInput() {
            document.getElementById('regularInputDesc').value = '';
            document.getElementById('regularInputAmount').value = '';
            // Populate payroll item selector
            var select = document.getElementById('regularItemSelect');
            select.innerHTML = PayrollItemsHelper.renderSelectOptions(currentCompanyId, ['allowance', 'deduction', 'income']);
            select.value = '__custom__';
            document.getElementById('regularCustomFields').style.display = '';
            document.getElementById('regularItemInfo').style.display = 'none';
            document.getElementById('addRegularModal').classList.add('show');
        }
        function onRegularItemSelect() {
            var val = document.getElementById('regularItemSelect').value;
            var customFields = document.getElementById('regularCustomFields');
            var infoDiv = document.getElementById('regularItemInfo');
            if (!val || val === '__custom__') {
                customFields.style.display = '';
                infoDiv.style.display = 'none';
                return;
            }
            var item = PayrollItemsHelper.getById(currentCompanyId, val);
            if (!item) return;
            // Auto-fill form fields from master item
            document.getElementById('regularInputType').value = PayrollItemsHelper.mapItemTypeToInputType(item.item_type);
            document.getElementById('regularInputDesc').value = item.item_name;
            var amt = PayrollItemsHelper.calculateAmount(item, payrollData.basic_salary);
            document.getElementById('regularInputAmount').value = amt > 0 ? amt.toFixed(2) : (item.default_amount || '');
            customFields.style.display = '';
            // Show info badges
            var badges = (item.irp5_code ? '<strong>IRP5: ' + item.irp5_code + '</strong> | ' : '') +
                (item.is_taxable ? 'Taxable' : 'Non-Taxable') + ' | ' +
                (item.affects_uif ? 'Affects UIF' : 'No UIF') + ' | ' +
                'Code: ' + item.item_code;
            document.getElementById('regularItemBadges').innerHTML = badges;
            infoDiv.style.display = '';
        }
        function saveRegularInput() {
            const desc = document.getElementById('regularInputDesc').value.trim();
            const amount = parseFloat(document.getElementById('regularInputAmount').value);
            if (!desc || !amount) { alert('Please fill in all fields'); return; }
            var input = {
                id: 'ri-' + Math.random().toString(36).substr(2, 9),
                type: document.getElementById('regularInputType').value,
                description: desc,
                amount: amount
            };
            // Enrich with payroll item metadata if selected
            var selectedId = document.getElementById('regularItemSelect').value;
            if (selectedId && selectedId !== '__custom__' && selectedId !== '') {
                var item = PayrollItemsHelper.getById(currentCompanyId, selectedId);
                if (item) {
                    input.payroll_item_id = item.id;
                    input.item_code = item.item_code;
                    input.irp5_code = item.irp5_code || null;
                    input.is_taxable = item.is_taxable !== false;
                    input.affects_uif = item.affects_uif !== false;
                }
            }
            payrollData.regular_inputs.push(input);
            savePayrollData(); renderPayroll(); closeModal('addRegularModal');
            AuditTrail.logCreate(currentCompanyId, 'regular_input', 'Added regular input "' + desc + '" (' + input.type + ') R' + amount.toFixed(2) + ' for ' + (currentEmployee ? currentEmployee.first_name + ' ' + currentEmployee.last_name : currentEmpId));
        }
        function deleteRegularInput(id) {
            if (!confirm('Delete this regular input?')) return;
            var deleted = payrollData.regular_inputs.find(r => r.id === id);
            payrollData.regular_inputs = payrollData.regular_inputs.filter(r => r.id !== id);
            savePayrollData(); renderPayroll();
            AuditTrail.logDelete(currentCompanyId, 'regular_input', 'Deleted regular input "' + (deleted ? deleted.description : id) + '" for ' + (currentEmployee ? currentEmployee.first_name + ' ' + currentEmployee.last_name : currentEmpId));
        }

        // ========== CURRENT INPUTS ==========
        function openAddCurrentInput() {
            document.getElementById('currentInputDesc').value = '';
            document.getElementById('currentInputAmount').value = '';
            // Populate payroll item selector
            var select = document.getElementById('currentItemSelect');
            select.innerHTML = PayrollItemsHelper.renderSelectOptions(currentCompanyId, ['income', 'allowance', 'deduction']);
            select.value = '__custom__';
            document.getElementById('currentCustomFields').style.display = '';
            document.getElementById('currentItemInfo').style.display = 'none';
            document.getElementById('addCurrentModal').classList.add('show');
        }
        function onCurrentItemSelect() {
            var val = document.getElementById('currentItemSelect').value;
            var customFields = document.getElementById('currentCustomFields');
            var infoDiv = document.getElementById('currentItemInfo');
            if (!val || val === '__custom__') {
                customFields.style.display = '';
                infoDiv.style.display = 'none';
                return;
            }
            var item = PayrollItemsHelper.getById(currentCompanyId, val);
            if (!item) return;
            // Auto-fill form fields
            var mappedType = PayrollItemsHelper.mapItemTypeToInputType(item.item_type);
            document.getElementById('currentInputType').value = mappedType;
            document.getElementById('currentInputDesc').value = item.item_name;
            var amt = PayrollItemsHelper.calculateAmount(item, payrollData.basic_salary);
            document.getElementById('currentInputAmount').value = amt > 0 ? amt.toFixed(2) : (item.default_amount || '');
            customFields.style.display = '';
            // Show info badges
            var badges = (item.irp5_code ? '<strong>IRP5: ' + item.irp5_code + '</strong> | ' : '') +
                (item.is_taxable ? 'Taxable' : 'Non-Taxable') + ' | ' +
                (item.affects_uif ? 'Affects UIF' : 'No UIF') + ' | ' +
                'Code: ' + item.item_code;
            document.getElementById('currentItemBadges').innerHTML = badges;
            infoDiv.style.display = '';
        }
        function saveCurrentInput() {
            const desc = document.getElementById('currentInputDesc').value.trim();
            const amount = parseFloat(document.getElementById('currentInputAmount').value);
            if (!desc || !amount) { alert('Please fill in all fields'); return; }
            var input = {
                id: 'ci-' + Math.random().toString(36).substr(2, 9),
                type: document.getElementById('currentInputType').value,
                description: desc,
                amount: amount
            };
            // Enrich with payroll item metadata if selected
            var selectedId = document.getElementById('currentItemSelect').value;
            if (selectedId && selectedId !== '__custom__' && selectedId !== '') {
                var item = PayrollItemsHelper.getById(currentCompanyId, selectedId);
                if (item) {
                    input.payroll_item_id = item.id;
                    input.item_code = item.item_code;
                    input.irp5_code = item.irp5_code || null;
                    input.is_taxable = item.is_taxable !== false;
                    input.affects_uif = item.affects_uif !== false;
                }
            }
            const items = JSON.parse(localStorage.getItem(getCurrentKey()) || '[]');
            items.push(input);
            localStorage.setItem(getCurrentKey(), JSON.stringify(items)); renderPayroll(); closeModal('addCurrentModal');
            AuditTrail.logCreate(currentCompanyId, 'current_input', 'Added current input "' + desc + '" (' + input.type + ') R' + amount.toFixed(2) + ' for ' + (currentEmployee ? currentEmployee.first_name + ' ' + currentEmployee.last_name : currentEmpId) + ' - ' + currentPeriod);
        }
        function deleteCurrentInput(id) {
            if (!confirm('Delete this current input?')) return;
            var allItems = JSON.parse(localStorage.getItem(getCurrentKey()) || '[]');
            var deleted = allItems.find(i => i.id === id);
            const items = allItems.filter(i => i.id !== id);
            localStorage.setItem(getCurrentKey(), JSON.stringify(items)); renderPayroll();
            AuditTrail.logDelete(currentCompanyId, 'current_input', 'Deleted current input "' + (deleted ? deleted.description : id) + '" for ' + (currentEmployee ? currentEmployee.first_name + ' ' + currentEmployee.last_name : currentEmpId) + ' - ' + currentPeriod);
        }

        // ========== OVERTIME ==========
        function openAddOvertime() { document.getElementById('overtimeDate').value = ''; document.getElementById('overtimeHours').value = ''; document.getElementById('overtimeDesc').value = ''; document.getElementById('addOvertimeModal').classList.add('show'); }
        function saveOvertime() {
            const date = document.getElementById('overtimeDate').value;
            const hours = parseFloat(document.getElementById('overtimeHours').value);
            if (!date || !hours) { alert('Please fill in date and hours'); return; }
            const items = JSON.parse(localStorage.getItem(getOvertimeKey()) || '[]');
            items.push({ id: 'ot-' + Math.random().toString(36).substr(2, 9), date: date, hours: hours, rate_multiplier: parseFloat(document.getElementById('overtimeRate').value), description: document.getElementById('overtimeDesc').value.trim() });
            localStorage.setItem(getOvertimeKey(), JSON.stringify(items)); renderPayroll(); closeModal('addOvertimeModal');
        }
        function deleteOvertime(id) { if (!confirm('Delete?')) return; const items = JSON.parse(localStorage.getItem(getOvertimeKey()) || '[]').filter(i => i.id !== id); localStorage.setItem(getOvertimeKey(), JSON.stringify(items)); renderPayroll(); }

        // ========== SHORT TIME ==========
        function openAddShortTime() { document.getElementById('shortTimeDate').value = ''; document.getElementById('shortTimeHours').value = ''; document.getElementById('shortTimeReason').value = ''; document.getElementById('addShortTimeModal').classList.add('show'); }
        function saveShortTime() {
            const date = document.getElementById('shortTimeDate').value;
            const hours = parseFloat(document.getElementById('shortTimeHours').value);
            if (!date || !hours) { alert('Please fill in date and hours'); return; }
            const items = JSON.parse(localStorage.getItem(getShortTimeKey()) || '[]');
            items.push({ id: 'st-' + Math.random().toString(36).substr(2, 9), date: date, hours_missed: hours, reason: document.getElementById('shortTimeReason').value.trim() });
            localStorage.setItem(getShortTimeKey(), JSON.stringify(items)); renderPayroll(); closeModal('addShortTimeModal');
        }
        function deleteShortTime(id) { if (!confirm('Delete?')) return; const items = JSON.parse(localStorage.getItem(getShortTimeKey()) || '[]').filter(i => i.id !== id); localStorage.setItem(getShortTimeKey(), JSON.stringify(items)); renderPayroll(); }

        // ========== MULTI-RATE ==========
        function openAddMultiRate() { document.getElementById('multiRateDesc').value = ''; document.getElementById('multiRateHourly').value = ''; document.getElementById('multiRateHours').value = ''; document.getElementById('addMultiRateModal').classList.add('show'); }
        function saveMultiRate() {
            const desc = document.getElementById('multiRateDesc').value.trim();
            const rate = parseFloat(document.getElementById('multiRateHourly').value);
            const hours = parseFloat(document.getElementById('multiRateHours').value);
            if (!desc || !rate || !hours) { alert('Please fill in all fields'); return; }
            const items = JSON.parse(localStorage.getItem(getMultiRateKey()) || '[]');
            items.push({ id: 'mr-' + Math.random().toString(36).substr(2, 9), description: desc, hourly_rate: rate, hours: hours });
            localStorage.setItem(getMultiRateKey(), JSON.stringify(items)); renderPayroll(); closeModal('addMultiRateModal');
        }
        function deleteMultiRate(id) { if (!confirm('Delete?')) return; const items = JSON.parse(localStorage.getItem(getMultiRateKey()) || '[]').filter(i => i.id !== id); localStorage.setItem(getMultiRateKey(), JSON.stringify(items)); renderPayroll(); }

        // ========== TOGGLE ==========
        function toggleAdditionalHours() { document.getElementById('additionalHoursSection').style.display = document.getElementById('showAdditionalHours').checked ? 'block' : 'none'; }
        function toggleSection(el) { if (event.target.tagName === 'BUTTON') return; el.classList.toggle('expanded'); }

        // ========== CALCULATE PAYSLIP ==========
        function calculatePayslip() {
            var currentInputs = JSON.parse(localStorage.getItem(getCurrentKey()) || '[]');
            var overtime = JSON.parse(localStorage.getItem(getOvertimeKey()) || '[]');
            var multiRate = JSON.parse(localStorage.getItem(getMultiRateKey()) || '[]');
            var shortTime = JSON.parse(localStorage.getItem(getShortTimeKey()) || '[]');

            // Build employee options for age/medical/directive
            var employeeOptions = {};
            if (currentEmployee) {
                if (currentEmployee.id_number) {
                    var parts = currentPeriod.split('-');
                    var periodEnd = new Date(parseInt(parts[0]), parseInt(parts[1]), 0);
                    employeeOptions.age = PayrollEngine.getAgeFromId(currentEmployee.id_number, periodEnd);
                }
                if (currentEmployee.medical_aid_members) {
                    employeeOptions.medicalMembers = parseInt(currentEmployee.medical_aid_members) || 0;
                }
                if (currentEmployee.tax_directive) {
                    employeeOptions.taxDirective = parseFloat(currentEmployee.tax_directive) || 0;
                }
            }

            var calc = PayrollEngine.calculateFromData(
                payrollData, currentInputs, overtime, multiRate, shortTime, employeeOptions
            );

            document.getElementById('totalGross').textContent = formatMoney(calc.gross);
            document.getElementById('totalPAYE').textContent = formatMoney(calc.paye);
            document.getElementById('totalUIF').textContent = formatMoney(calc.uif);
            document.getElementById('totalDeductions').textContent = formatMoney(calc.deductions);
            document.getElementById('totalNet').textContent = formatMoney(calc.net);

            // Medical credit display
            if (calc.medicalCredit > 0) {
                document.getElementById('medicalCreditRow').style.display = '';
                document.getElementById('totalMedicalCredit').textContent = '- ' + formatMoney(calc.medicalCredit);
            } else {
                document.getElementById('medicalCreditRow').style.display = 'none';
            }

            // Negative net pay warning
            var netEl = document.getElementById('totalNet');
            var warningEl = document.getElementById('negativeNetWarning');
            if (calc.negativeNetPay) {
                netEl.style.color = '#dc3545';
                warningEl.style.display = 'block';
            } else {
                netEl.style.color = '#28a745';
                warningEl.style.display = 'none';
            }

            // Trigger narrative generation
            generateNarrative(calc.gross, calc.paye, calc.uif, calc.deductions, calc.net);

            // Show payslip action buttons
            document.getElementById('payslipActions').style.display = 'flex';
        }

        // ========== PAYSLIP PREVIEW & PDF EXPORT ==========
        function getPayslipData() {
            var currentInputs = JSON.parse(localStorage.getItem(getCurrentKey()) || '[]');
            var overtime = JSON.parse(localStorage.getItem(getOvertimeKey()) || '[]');
            var multiRate = JSON.parse(localStorage.getItem(getMultiRateKey()) || '[]');
            var shortTime = JSON.parse(localStorage.getItem(getShortTimeKey()) || '[]');

            var employeeOptions = {};
            if (currentEmployee) {
                if (currentEmployee.id_number) {
                    var parts = currentPeriod.split('-');
                    var periodEnd = new Date(parseInt(parts[0]), parseInt(parts[1]), 0);
                    employeeOptions.age = PayrollEngine.getAgeFromId(currentEmployee.id_number, periodEnd);
                }
                if (currentEmployee.medical_aid_members) employeeOptions.medicalMembers = parseInt(currentEmployee.medical_aid_members) || 0;
                if (currentEmployee.tax_directive) employeeOptions.taxDirective = parseFloat(currentEmployee.tax_directive) || 0;
            }

            var calc = PayrollEngine.calculateFromData(payrollData, currentInputs, overtime, multiRate, shortTime, employeeOptions);

            // Build itemized allowances list
            var allowances = [];
            (payrollData.regular_inputs || []).forEach(function(ri) {
                if (ri.type !== 'deduction') allowances.push({ description: ri.description || ri.type, amount: ri.amount });
            });
            currentInputs.forEach(function(ci) {
                if (ci.type !== 'deduction') allowances.push({ description: ci.description || ci.type, amount: ci.amount });
            });

            // Build itemized deductions list
            var deductionsList = [];
            (payrollData.regular_inputs || []).forEach(function(ri) {
                if (ri.type === 'deduction') deductionsList.push({ description: ri.description || 'Deduction', amount: ri.amount });
            });
            currentInputs.forEach(function(ci) {
                if (ci.type === 'deduction') deductionsList.push({ description: ci.description || 'Deduction', amount: ci.amount });
            });

            // Calculate overtime amount
            var hourlyRate = payrollData.basic_salary ? payrollData.basic_salary / 173.33 : 0;
            var overtimeAmount = 0;
            overtime.forEach(function(ot) {
                overtimeAmount += (parseFloat(ot.hours) || 0) * hourlyRate * (parseFloat(ot.rate_multiplier) || 1.5);
            });

            // Calculate multi-rate amount
            var multiRateAmount = 0;
            multiRate.forEach(function(mr) {
                multiRateAmount += (parseFloat(mr.hours) || 0) * (parseFloat(mr.hourly_rate) || 0);
            });
            if (multiRateAmount > 0) {
                allowances.push({ description: 'Paid at Different Rate', amount: multiRateAmount });
            }

            // Enrich calc with itemized data for PDF
            calc.basicSalary = payrollData.basic_salary || 0;
            calc.allowances = allowances;
            calc.deductionsList = deductionsList;
            calc.overtimeAmount = overtimeAmount;
            calc.totalDeductions = calc.deductions;

            return {
                calc: calc,
                employee: currentEmployee,
                period: currentPeriod,
                companyId: currentCompanyId
            };
        }

        function previewPayslip() {
            var data = getPayslipData();
            var calc = data.calc;
            var emp = data.employee;
            var details = PDFBranding.getCompanyDetails(data.companyId);
            var company = AUTH.getCompanyById(data.companyId);
            var companyName = details.company_name || (company ? company.name : 'Company');
            var periodLabel = PDFBranding.formatPeriod(data.period);

            var html = '';

            // Company Header
            html += '<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">';
            if (details.logo_data) {
                html += '<img src="' + details.logo_data + '" style="max-height: 50px; max-width: 120px;" alt="Logo">';
            }
            html += '<div>';
            html += '<div style="font-size: 20px; font-weight: 700; color: #667eea;">' + companyName + '</div>';
            if (details.address_line1) html += '<div style="font-size: 12px; color: #888;">' + details.address_line1 + '</div>';
            if (details.phone || details.email) html += '<div style="font-size: 12px; color: #888;">' + (details.phone ? 'Tel: ' + details.phone : '') + (details.phone && details.email ? '  |  ' : '') + (details.email ? 'Email: ' + details.email : '') + '</div>';
            html += '</div></div>';

            // Payslip Title Bar
            html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            html += '<span style="font-size: 16px; font-weight: 700;">PAYSLIP</span>';
            html += '<span style="font-size: 14px;">' + periodLabel + '</span>';
            html += '</div>';

            // Employee Details
            html += '<div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 15px;">';
            html += '<div style="font-weight: 700; color: #333; margin-bottom: 8px; font-size: 13px;">Employee Details</div>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 12px; color: #555;">';
            html += '<div>Name: <strong>' + (emp.first_name || '') + ' ' + (emp.last_name || '') + '</strong></div>';
            html += '<div>ID Number: <strong>' + (emp.id_number || '-') + '</strong></div>';
            html += '<div>Emp No: <strong>' + (emp.employee_number || '-') + '</strong></div>';
            html += '<div>Department: <strong>' + (emp.department || '-') + '</strong></div>';
            html += '<div>Position: <strong>' + (emp.position || emp.job_title || '-') + '</strong></div>';
            html += '<div>Payment: <strong>' + (emp.payment_method || 'EFT') + '</strong></div>';
            html += '</div></div>';

            // Earnings Section
            html += '<div style="margin-bottom: 15px;">';
            html += '<div style="background: #28a745; color: white; padding: 6px 15px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; font-weight: 700; font-size: 12px;">';
            html += '<span>EARNINGS</span><span>Amount</span></div>';
            html += '<div style="border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 6px 6px; padding: 8px 15px;">';

            // Basic Salary
            html += '<div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px;">';
            html += '<span>Basic Salary</span><span>' + formatMoney(calc.basicSalary) + '</span></div>';

            // Allowances
            if (calc.allowances && calc.allowances.length > 0) {
                calc.allowances.forEach(function(a) {
                    html += '<div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px;">';
                    html += '<span>' + a.description + '</span><span>' + formatMoney(a.amount) + '</span></div>';
                });
            }

            // Overtime
            if (calc.overtimeAmount > 0) {
                html += '<div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px;">';
                html += '<span>Overtime</span><span>' + formatMoney(calc.overtimeAmount) + '</span></div>';
            }

            // Total Gross
            html += '<div style="border-top: 2px solid #333; margin-top: 6px; padding-top: 6px; display: flex; justify-content: space-between; font-weight: 700; font-size: 13px;">';
            html += '<span>TOTAL GROSS</span><span>' + formatMoney(calc.gross) + '</span></div>';
            html += '</div></div>';

            // Deductions Section
            html += '<div style="margin-bottom: 15px;">';
            html += '<div style="background: #dc3545; color: white; padding: 6px 15px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; font-weight: 700; font-size: 12px;">';
            html += '<span>DEDUCTIONS</span><span>Amount</span></div>';
            html += '<div style="border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 6px 6px; padding: 8px 15px;">';

            // PAYE
            html += '<div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px;">';
            html += '<span>PAYE (Income Tax)</span><span>' + formatMoney(calc.paye) + '</span></div>';

            // UIF
            html += '<div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px;">';
            html += '<span>UIF</span><span>' + formatMoney(calc.uif) + '</span></div>';

            // Medical Tax Credit
            if (calc.medicalCredit > 0) {
                html += '<div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; color: #28a745;">';
                html += '<span>Medical Tax Credit</span><span>- ' + formatMoney(calc.medicalCredit) + '</span></div>';
            }

            // Other deductions
            if (calc.deductionsList && calc.deductionsList.length > 0) {
                calc.deductionsList.forEach(function(d) {
                    html += '<div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px;">';
                    html += '<span>' + d.description + '</span><span>' + formatMoney(d.amount) + '</span></div>';
                });
            }

            // Total Deductions
            var totalDed = (calc.paye || 0) + (calc.uif || 0) + (calc.deductions || 0);
            html += '<div style="border-top: 2px solid #333; margin-top: 6px; padding-top: 6px; display: flex; justify-content: space-between; font-weight: 700; font-size: 13px;">';
            html += '<span>TOTAL DEDUCTIONS</span><span>' + formatMoney(totalDed) + '</span></div>';
            html += '</div></div>';

            // NET PAY
            html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            html += '<span style="font-size: 18px; font-weight: 700;">NET PAY</span>';
            html += '<span style="font-size: 22px; font-weight: 700;">' + formatMoney(calc.net) + '</span>';
            html += '</div>';

            // Footer
            html += '<div style="font-size: 10px; color: #999; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">';
            html += '<div>Generated: ' + new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString() + '</div>';
            html += '<div>This is a system-generated document.</div>';
            html += '</div>';

            document.getElementById('payslipPreviewBody').innerHTML = html;
            document.getElementById('payslipPreviewModal').classList.add('show');
        }

        function downloadPayslipPDF() {
            var data = getPayslipData();
            PDFBranding.generatePayslipPDF(data.employee, data.period, data.calc, data.companyId);
            AuditTrail.logExport(currentCompanyId, 'payslip', 'Exported payslip PDF for ' + currentEmployee.first_name + ' ' + currentEmployee.last_name + ' - ' + formatPeriodLabel(currentPeriod));
        }

        function printPayslip() {
            window.print();
        }

        // ========== NARRATIVE FUNCTIONS ==========
        function generateNarrative(gross, paye, uif, deductions, net) {
            if (typeof NarrativeGenerator === 'undefined') return;

            var currentCalc = {
                gross: gross, paye: paye, uif: uif,
                totalDeductions: deductions, net: net,
                basicSalary: payrollData.basic_salary || 0,
                overtimeAmount: 0, currentInputsTotal: 0
            };

            // Calculate overtime amount
            var hourlyRate = payrollData.basic_salary ? payrollData.basic_salary / 173.33 : 0;
            JSON.parse(localStorage.getItem(getOvertimeKey()) || '[]').forEach(function(ot) {
                currentCalc.overtimeAmount += (parseFloat(ot.hours) || 0) * hourlyRate * (parseFloat(ot.rate_multiplier) || 1.5);
            });

            // Calculate current inputs total
            JSON.parse(localStorage.getItem(getCurrentKey()) || '[]').forEach(function(ci) {
                if (ci.type !== 'deduction') currentCalc.currentInputsTotal += parseFloat(ci.amount) || 0;
            });

            // Get previous period calc
            var prevPeriod = getPreviousPeriod(currentPeriod);
            var prevCalc = calculatePeriodSilent(prevPeriod);

            var narrative = NarrativeGenerator.generate(currentEmployee, currentPeriod, currentCalc, prevCalc, payrollData);
            NarrativeGenerator.save(currentCompanyId, currentEmpId, currentPeriod, narrative);

            var html = NarrativeGenerator.formatAsHTML(narrative);
            document.getElementById('narrativeHTML').innerHTML = html;
            document.getElementById('narrativeCard').style.display = 'block';
        }

        function calculatePeriodSilent(period) {
            var calc = PayrollEngine.calculateEmployeePeriod(currentCompanyId, currentEmpId, period, payrollData);
            // Calculate overtime amount separately for narrative
            var hr = payrollData.basic_salary ? payrollData.basic_salary / PayrollEngine.HOURLY_DIVISOR : 0;
            var otKey = 'emp_overtime_' + currentCompanyId + '_' + currentEmpId + '_' + period;
            var otAmount = 0;
            JSON.parse(localStorage.getItem(otKey) || '[]').forEach(function(ot) {
                otAmount += (parseFloat(ot.hours)||0) * hr * (parseFloat(ot.rate_multiplier)||1.5);
            });
            return { gross: calc.gross, paye: calc.paye, uif: calc.uif, totalDeductions: calc.deductions, net: calc.net, basicSalary: payrollData.basic_salary || 0, overtimeAmount: otAmount, currentInputsTotal: 0 };
        }

        function getPreviousPeriod(period) {
            var parts = period.split('-').map(Number);
            var y = parts[0], m = parts[1] - 1;
            if (m === 0) { m = 12; y--; }
            return y + '-' + String(m).padStart(2, '0');
        }

        function toggleNarrative() {
            var content = document.getElementById('narrativeContent');
            var toggle = document.getElementById('narrativeToggle');
            if (content.style.display === 'none') {
                content.style.display = 'block'; toggle.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none'; toggle.textContent = '‚ñº';
            }
        }

        function regenerateNarrative() {
            NarrativeGenerator.clear(currentCompanyId, currentEmpId, currentPeriod);
            calculatePayslip();
        }

        // ========== EMPLOYEE ATTENDANCE TAB ==========
        function loadEmployeeAttendance() {
            var period = currentPeriod;
            if (!period) return;
            var parts = period.split('-');
            var year = parseInt(parts[0]), month = parseInt(parts[1]);
            var daysInMonth = new Date(year, month, 0).getDate();
            var tbody = document.getElementById('empAttendanceBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            var totalHours = 0, daysWorked = 0, overtime = 0, absences = 0;
            var today = new Date();

            for (var day = 1; day <= daysInMonth; day++) {
                var date = new Date(year, month - 1, day);
                var dateStr = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                var key = 'attendance_' + currentCompanyId + '_' + dateStr;
                var entries = JSON.parse(localStorage.getItem(key) || '[]');
                var empEntry = entries.find(function(e) { return e.emp_id === currentEmpId; });
                var isWeekend = (date.getDay() === 0 || date.getDay() === 6);

                if (empEntry) {
                    daysWorked++;
                    totalHours += empEntry.hours || 0;
                    if (empEntry.hours > 8) overtime += (empEntry.hours - 8);
                    var isLate = false;
                    if (empEntry.clock_in) {
                        var p = empEntry.clock_in.split(':').map(Number);
                        isLate = (p[0] > 8 || (p[0] === 8 && p[1] > 0));
                    }
                    tbody.innerHTML += '<tr><td>' + dateStr + '</td><td>' + (empEntry.clock_in || '--') + '</td><td>' + (empEntry.clock_out || '--') + '</td><td><strong>' + (empEntry.hours || 0).toFixed(1) + 'h</strong></td><td>' + (isLate ? '<span class="badge" style="background:#fff3cd;color:#856404;">Late</span>' : '<span class="badge" style="background:#d4edda;color:#155724;">Present</span>') + '</td></tr>';
                } else if (!isWeekend && date < today) {
                    absences++;
                }
            }

            if (daysWorked === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#888; padding:20px;">No attendance records for this period.</td></tr>';
            }

            var el = function(id, val) { var e = document.getElementById(id); if (e) e.textContent = val; };
            el('empAttDaysWorked', daysWorked);
            el('empAttTotalHours', totalHours.toFixed(1));
            el('empAttOvertime', overtime.toFixed(1));
            el('empAttAbsences', absences);
        }

        // ========== EDIT EMPLOYEE ==========
        function openEditEmployeeModal() {
            const e = currentEmployee;
            document.getElementById('editFirstName').value = e.first_name || '';
            document.getElementById('editLastName').value = e.last_name || '';
            document.getElementById('editEmailInput').value = e.email || '';
            document.getElementById('editPhoneInput').value = e.phone || '';
            document.getElementById('editJobTitleInput').value = e.job_title || '';
            document.getElementById('editDepartmentInput').value = e.department || '';
            document.getElementById('editPositionInput').value = e.position || '';
            document.getElementById('editDateAppointedInput').value = e.date_appointed || '';
            document.getElementById('editPayMethodInput').value = e.payment_method || 'EFT';
            document.getElementById('editIdNumberInput').value = e.id_number || '';
            document.getElementById('editMedicalMembersInput').value = e.medical_aid_members || '';
            document.getElementById('editTaxDirectiveInput').value = e.tax_directive || '';
            document.getElementById('editBankName').value = e.bank_name || '';
            document.getElementById('editAccountHolder').value = e.account_holder || '';
            document.getElementById('editAccountNumber').value = e.account_number || '';
            document.getElementById('editBranchCode').value = e.branch_code || '';
            document.getElementById('editEmployeeModal').classList.add('show');
        }
        function saveEmployeeInfo() {
            currentEmployee.first_name = document.getElementById('editFirstName').value.trim();
            currentEmployee.last_name = document.getElementById('editLastName').value.trim();
            currentEmployee.email = document.getElementById('editEmailInput').value.trim();
            currentEmployee.phone = document.getElementById('editPhoneInput').value.trim();
            currentEmployee.job_title = document.getElementById('editJobTitleInput').value.trim();
            currentEmployee.department = document.getElementById('editDepartmentInput').value.trim();
            currentEmployee.position = document.getElementById('editPositionInput').value.trim();
            currentEmployee.date_appointed = document.getElementById('editDateAppointedInput').value;
            currentEmployee.payment_method = document.getElementById('editPayMethodInput').value;
            currentEmployee.id_number = document.getElementById('editIdNumberInput').value.trim();
            currentEmployee.medical_aid_members = parseInt(document.getElementById('editMedicalMembersInput').value) || 0;
            currentEmployee.tax_directive = parseFloat(document.getElementById('editTaxDirectiveInput').value) || 0;
            currentEmployee.bank_name = document.getElementById('editBankName').value.trim();
            currentEmployee.account_holder = document.getElementById('editAccountHolder').value.trim();
            currentEmployee.account_number = document.getElementById('editAccountNumber').value.trim();
            currentEmployee.branch_code = document.getElementById('editBranchCode').value.trim();

            const stored = localStorage.getItem('employees_' + currentCompanyId);
            const employees = stored ? JSON.parse(stored) : [];
            const idx = employees.findIndex(e => e.id === currentEmpId);
            if (idx !== -1) { employees[idx] = currentEmployee; localStorage.setItem('employees_' + currentCompanyId, JSON.stringify(employees)); }
            AuditTrail.logUpdate(currentCompanyId, 'employee', 'Updated employee info for ' + currentEmployee.first_name + ' ' + currentEmployee.last_name + ' (' + (currentEmployee.employee_number || currentEmpId) + ')');
            loadEmployee(); closeModal('editEmployeeModal'); alert('Employee information saved!');
        }

        // ========== LEAVE ==========
        function loadLeaveData() {
            const leave = JSON.parse(localStorage.getItem(getLeaveKey()) || '[]');
            renderLeave(leave); updateLeaveBalances(leave);
        }
        function renderLeave(leave) {
            const tbody = document.getElementById('leaveTableBody');
            if (leave.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;padding:30px;">No leave records yet</td></tr>'; return; }
            const typeNames = { annual: 'Annual', sick: 'Sick', family: 'Family Resp.', maternity: 'Maternity', study: 'Study', unpaid: 'Unpaid' };
            tbody.innerHTML = [...leave].sort((a, b) => b.start_date.localeCompare(a.start_date)).map(l =>
                '<tr><td>' + (typeNames[l.type] || l.type) + '</td><td>' + l.start_date + '</td><td>' + l.end_date + '</td><td>' + l.days + '</td><td><span class="leave-status leave-' + l.status + '">' + l.status + '</span></td><td>' + (l.reason || '-') + '</td><td><button class="btn btn-danger btn-sm" onclick="deleteLeave(\'' + l.id + '\')">Delete</button></td></tr>'
            ).join('');
        }
        function updateLeaveBalances(leave) {
            const approved = leave.filter(l => l.status === 'approved');
            document.getElementById('annualLeaveBalance').textContent = Math.max(15 - approved.filter(l => l.type === 'annual').reduce((s, l) => s + parseFloat(l.days), 0), 0);
            document.getElementById('sickLeaveBalance').textContent = Math.max(30 - approved.filter(l => l.type === 'sick').reduce((s, l) => s + parseFloat(l.days), 0), 0);
            document.getElementById('familyLeaveBalance').textContent = Math.max(3 - approved.filter(l => l.type === 'family').reduce((s, l) => s + parseFloat(l.days), 0), 0);
        }
        function openAddLeaveModal() { document.getElementById('leaveStartDate').value = ''; document.getElementById('leaveEndDate').value = ''; document.getElementById('leaveDays').value = ''; document.getElementById('leaveReason').value = ''; document.getElementById('addLeaveModal').classList.add('show'); }
        function calcLeaveDays() {
            const start = document.getElementById('leaveStartDate').value;
            const end = document.getElementById('leaveEndDate').value;
            if (start && end) {
                let days = 0; const curr = new Date(start); const e = new Date(end);
                while (curr <= e) { const day = curr.getDay(); if (day !== 0 && day !== 6) days++; curr.setDate(curr.getDate() + 1); }
                document.getElementById('leaveDays').value = days;
            }
        }
        function saveLeave() {
            const start = document.getElementById('leaveStartDate').value;
            const end = document.getElementById('leaveEndDate').value;
            const days = parseFloat(document.getElementById('leaveDays').value);
            if (!start || !end || !days) { alert('Please fill in all required fields'); return; }
            const leave = JSON.parse(localStorage.getItem(getLeaveKey()) || '[]');
            leave.push({ id: 'lv-' + Math.random().toString(36).substr(2, 9), type: document.getElementById('leaveType').value, start_date: start, end_date: end, days: days, status: document.getElementById('leaveStatus').value, reason: document.getElementById('leaveReason').value.trim(), date_created: new Date().toISOString() });
            localStorage.setItem(getLeaveKey(), JSON.stringify(leave)); loadLeaveData(); closeModal('addLeaveModal');
        }
        function deleteLeave(id) { if (!confirm('Delete this leave record?')) return; const leave = JSON.parse(localStorage.getItem(getLeaveKey()) || '[]').filter(l => l.id !== id); localStorage.setItem(getLeaveKey(), JSON.stringify(leave)); loadLeaveData(); }

        // ========== NOTES ==========
        function loadNotes() {
            const notes = JSON.parse(localStorage.getItem(getNotesKey()) || '[]');
            const list = document.getElementById('notesList');
            if (notes.length === 0) { list.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">No notes yet. Add a note above.</p>'; return; }
            list.innerHTML = [...notes].sort((a, b) => b.date_created.localeCompare(a.date_created)).map(n => {
                const d = new Date(n.date_created);
                return '<div class="note-item"><div class="note-header"><span class="note-meta">' + d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) + ' - ' + (n.author || 'System') + '</span><button class="btn btn-danger btn-sm" onclick="deleteNote(\'' + n.id + '\')">Delete</button></div><div class="note-text">' + n.text.replace(/\n/g, '<br>') + '</div></div>';
            }).join('');
        }
        function addNote() {
            const text = document.getElementById('newNote').value.trim();
            if (!text) { alert('Please enter a note'); return; }
            const session = AUTH.getSession();
            const notes = JSON.parse(localStorage.getItem(getNotesKey()) || '[]');
            notes.push({ id: 'nt-' + Math.random().toString(36).substr(2, 9), text: text, date_created: new Date().toISOString(), author: session.name || session.email });
            localStorage.setItem(getNotesKey(), JSON.stringify(notes));
            document.getElementById('newNote').value = ''; loadNotes();
        }
        function deleteNote(id) { if (!confirm('Delete this note?')) return; const notes = JSON.parse(localStorage.getItem(getNotesKey()) || '[]').filter(n => n.id !== id); localStorage.setItem(getNotesKey(), JSON.stringify(notes)); loadNotes(); }

        // ========== HELPERS ==========
        function formatMoney(amount) { return 'R ' + (parseFloat(amount) || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' '); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        document.querySelectorAll('.modal').forEach(modal => { modal.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('show'); }); });

        // ---- Add Company Modal ----
        function openAddCompanyModal() {
            document.getElementById('addCompanyModal').style.display = 'flex';
            document.getElementById('newCompanyName').value = '';
            document.getElementById('newCompanyEmail').value = '';
            document.getElementById('addCompanyError').style.display = 'none';
        }

        function closeAddCompanyModal() {
            document.getElementById('addCompanyModal').style.display = 'none';
        }

        function submitAddCompany() {
            var name = document.getElementById('newCompanyName').value.trim();
            var email = document.getElementById('newCompanyEmail').value.trim();
            var errorDiv = document.getElementById('addCompanyError');

            if (!name) {
                errorDiv.textContent = 'Please enter a company name';
                errorDiv.style.display = 'block';
                return;
            }

            var session = AUTH.getSession();
            var result = AUTH.createCompany({ name: name, email: email });
            if (!result.success) {
                errorDiv.textContent = 'Failed to create company';
                errorDiv.style.display = 'block';
                return;
            }

            AUTH.addCompanyToUser(session.user_id, result.company.id);
            AUTH.refreshSessionCompanyIds(result.company.id);

            // Switch to the new company
            session = AUTH.getSession();
            session.company_id = result.company.id;
            localStorage.setItem('session', JSON.stringify(session));

            closeAddCompanyModal();
            location.reload();
        }
    </script>
    <script src="js/narrative-generator.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/pdf-branding.js"></script>
    <!-- Add Company Modal -->
    <div id="addCompanyModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:15px; padding:30px; max-width:450px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color:#667eea; margin:0;">Add New Company</h2>
                <span style="font-size:1.5rem; cursor:pointer; color:#999;" onclick="closeAddCompanyModal()">&times;</span>
            </div>
            <div id="addCompanyError" style="display:none; background:#fee; color:#c33; padding:10px; border-radius:8px; margin-bottom:15px; border-left:4px solid #c33;"></div>
            <div style="margin-bottom:15px;">
                <label style="display:block; font-weight:600; color:#333; margin-bottom:5px;">Company Name *</label>
                <input type="text" id="newCompanyName" placeholder="Enter company name" style="width:100%; padding:12px; border:2px solid #eee; border-radius:8px; font-size:1rem;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; font-weight:600; color:#333; margin-bottom:5px;">Company Email</label>
                <input type="email" id="newCompanyEmail" placeholder="Enter company email" style="width:100%; padding:12px; border:2px solid #eee; border-radius:8px; font-size:1rem;">
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="closeAddCompanyModal()" style="flex:1; padding:12px; background:#999; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Cancel</button>
                <button onclick="submitAddCompany()" style="flex:1; padding:12px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Create Company</button>
            </div>
        </div>
    </div>
    <nav class="mobile-bottom-nav">
        <a href="company-dashboard.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128202;</span><span class="mobile-nav-label">Dashboard</span></a>
        <a href="employee-management.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128101;</span><span class="mobile-nav-label">Employees</span></a>
        <a href="payruns.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128181;</span><span class="mobile-nav-label">Pay Runs</span></a>
        <a href="reports.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128203;</span><span class="mobile-nav-label">Reports</span></a>
    </nav>
    <script src="js/mobile-utils.js"></script>
</body>
</html>
