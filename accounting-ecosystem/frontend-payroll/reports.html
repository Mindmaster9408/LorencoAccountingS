<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reports - Lorenco Paytime</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .wrapper { display: flex; gap: 20px; max-width: 1600px; margin: 0 auto; }

        /* SIDEBAR */
        .sidebar {
            width: 300px; background: white; border-radius: 15px;
            padding: 25px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: fit-content; position: sticky; top: 20px;
        }
        .sidebar-header { padding: 0 20px 20px; border-bottom: 2px solid #eee; }
        .sidebar-title { color: #667eea; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .sidebar-section { margin-top: 20px; }
        .sidebar-section-title {
            padding: 10px 20px; color: #999; font-size: 0.75rem;
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
        }
        .sidebar-link {
            display: block; padding: 12px 20px; color: #666; text-decoration: none;
            transition: all 0.2s; border-left: 3px solid transparent; font-weight: 500;
        }
        .sidebar-link:hover { background: #f8f9fa; color: #667eea; border-left-color: #667eea; }
        .sidebar-link.active { background: #f0f4ff; color: #667eea; border-left-color: #667eea; font-weight: 600; }
        .company-carousel { margin-top: 15px; padding: 15px 20px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        .carousel-title { font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 10px; text-transform: uppercase; }
        .carousel-companies { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
        .carousel-company {
            background: #f8f9fa; padding: 10px 12px; border-radius: 6px; font-size: 0.85rem;
            color: #333; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .carousel-company:hover { background: #eee; border-color: #667eea; color: #667eea; }
        .sidebar-actions { padding: 15px 20px; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .btn-sidebar { padding: 10px 15px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; text-align: center; }
        .btn-switch { background: #667eea; color: white; }
        .btn-switch:hover { background: #5568d3; }
        .btn-logout { background: #eee; color: #333; }
        .btn-logout:hover { background: #ddd; }

        /* MAIN CONTENT */
        .main-content { flex: 1; background: white; border-radius: 15px; padding: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eee; }
        .page-header h1 { color: #667eea; font-size: 2rem; }

        /* REPORT CARDS GRID */
        .report-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .report-card {
            background: #f8f9fa; border-radius: 12px; padding: 25px; cursor: pointer;
            transition: all 0.3s; border: 2px solid transparent; text-align: center;
        }
        .report-card:hover { border-color: #667eea; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(102,126,234,0.15); }
        .report-card-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .report-card-title { font-size: 1.1rem; font-weight: 700; color: #333; margin-bottom: 5px; }
        .report-card-desc { font-size: 0.85rem; color: #888; }
        .report-card-secure { border-color: #dc3545; background: #fff5f5; }
        .report-card-secure:hover { border-color: #dc3545; box-shadow: 0 8px 25px rgba(220,53,69,0.15); }

        /* BACK BUTTON */
        .btn-back { background: none; border: 2px solid #667eea; color: #667eea; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn-back:hover { background: #667eea; color: white; }

        /* FILTER PANEL */
        .filter-panel {
            background: #f8f9fa; border-radius: 12px; padding: 25px; margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }
        .filter-title { font-size: 0.85rem; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 15px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .filter-group label { display: block; margin-bottom: 5px; color: #555; font-weight: 600; font-size: 13px; }
        .filter-group input, .filter-group select {
            width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px;
        }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #667eea; }
        .filter-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: linear-gradient(135deg, #17a2b8, #138496); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* EXPORT BAR */
        .export-bar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .export-bar .label { font-weight: 600; color: #555; font-size: 14px; margin-right: 5px; }

        /* RESULTS TABLE */
        .results-container { overflow-x: auto; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .results-table th, .results-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
        .results-table th { background: #f8f9fa; font-weight: 600; color: #333; position: sticky; top: 0; }
        .results-table tr:hover { background: #f8f9fa; }
        .results-table .amount { text-align: right; font-weight: 600; }
        .results-table .total-row { background: #f0f4ff; font-weight: 700; border-top: 2px solid #667eea; }
        .results-table .total-row td { padding: 12px; }
        .results-table .variance-high { background: #fff5f5; color: #dc3545; }
        .results-table .variance-new { background: #e3f2fd; color: #1976d2; }
        .results-table .masked { color: #999; letter-spacing: 2px; }

        /* SUMMARY CARDS */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2); color: white;
            padding: 20px; border-radius: 10px; text-align: center;
        }
        .summary-card.green { background: linear-gradient(135deg, #28a745, #20c997); }
        .summary-card.orange { background: linear-gradient(135deg, #fd7e14, #ffc107); }
        .summary-card.red { background: linear-gradient(135deg, #dc3545, #c82333); }
        .summary-card.teal { background: linear-gradient(135deg, #17a2b8, #138496); }
        .summary-card-label { font-size: 0.75rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-card-value { font-size: 1.5rem; font-weight: 700; margin-top: 5px; }

        /* CONFIDENTIAL BADGE */
        .confidential-badge { display: inline-block; background: #dc3545; color: white; padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-left: 10px; }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-icon { font-size: 3rem; margin-bottom: 15px; }
        .empty-text { font-size: 1.1rem; margin-bottom: 5px; }
        .empty-sub { font-size: 0.9rem; color: #bbb; }

        /* DEPARTMENT BREAKDOWN */
        .dept-breakdown { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .dept-card { background: #f8f9fa; border-radius: 8px; padding: 15px; border-left: 4px solid #667eea; }
        .dept-card-title { font-weight: 700; color: #333; margin-bottom: 8px; }
        .dept-card-stat { display: flex; justify-content: space-between; font-size: 13px; color: #666; margin-top: 4px; }

        @media (max-width: 1024px) {
            .sidebar { width: 250px; }
            .main-content { padding: 25px; }
            .page-header h1 { font-size: 1.5rem; }
        }
        @media (max-width: 768px) {
            .wrapper { flex-direction: column; }
            .sidebar { width: 100%; position: relative; top: 0; }
            .main-content { padding: 20px; }
            .page-header { flex-direction: column; gap: 15px; }
            .report-cards { grid-template-columns: 1fr; }
            .filter-grid { grid-template-columns: 1fr; }
            .summary-cards { grid-template-columns: 1fr 1fr; }
        }
    </style>
    <link rel="stylesheet" href="css/dark-theme.css">
    <link rel="stylesheet" href="css/mobile-responsive.css">
</head>
<body>
    <button id="mobile-hamburger" class="mobile-hamburger"><span style="font-size:20px;">&#9776;</span></button>
    <div id="mobile-overlay" class="mobile-overlay"></div>
    <div class="wrapper">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Menu</div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-section-title">Navigation</div>
                <a href="company-dashboard.html" class="sidebar-link">üìä Dashboard</a>
                <a href="employee-management.html" class="sidebar-link">üë• Employees</a>
                <a href="payruns.html" class="sidebar-link">üíµ Pay Runs</a>
                <a href="payroll-items.html" class="sidebar-link">üìã Payroll Items</a>
                <a href="attendance.html" class="sidebar-link">&#x23F0; Attendance</a>
                <a href="reports.html" class="sidebar-link active">üìä Reports</a>
                <a href="historical-import.html" class="sidebar-link">üì• Historical Import</a>
                <a href="company-details.html" class="sidebar-link">üè¢ Company Details</a>
            </div>
            <div class="company-carousel">
                <div class="carousel-title">Switch Company</div>
                <div class="carousel-container">
                    <div class="carousel-companies" id="companies-carousel"></div>
                </div>
            </div>
            <div class="sidebar-actions">
                <button class="btn-sidebar btn-switch" onclick="window.location.href='company-selection.html'">‚Üê Return to Dashboard</button>
                <button class="btn-sidebar btn-logout" onclick="handleLogout()">üö™ Logout</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- REPORT SELECTION VIEW -->
            <div id="report-selection-view">
                <div class="page-header">
                    <h1>üìä Reports</h1>
                    <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;" id="company-name-badge"></span>
                </div>
                <div class="report-cards">
                    <div class="report-card" onclick="openReport('transaction-history')">
                        <div class="report-card-icon">üí≥</div>
                        <div class="report-card-title">Transaction History</div>
                        <div class="report-card-desc">All payroll transactions with full breakdown</div>
                    </div>
                    <div class="report-card" onclick="openReport('employee-master')">
                        <div class="report-card-icon">üë•</div>
                        <div class="report-card-title">Employee Master List</div>
                        <div class="report-card-desc">Complete employee directory</div>
                    </div>
                    <div class="report-card report-card-secure" onclick="openReport('bank-details')">
                        <div class="report-card-icon">üè¶</div>
                        <div class="report-card-title">Bank Details</div>
                        <div class="report-card-desc">Secure banking information report</div>
                    </div>
                    <div class="report-card" onclick="openReport('payroll-summary')">
                        <div class="report-card-icon">üí∞</div>
                        <div class="report-card-title">Payroll Summary</div>
                        <div class="report-card-desc">Period-based payroll overview</div>
                    </div>
                    <div class="report-card" onclick="openReport('audit-user')">
                        <div class="report-card-icon">üîç</div>
                        <div class="report-card-title">Audit Trail - User Activity</div>
                        <div class="report-card-desc">Track who did what and when</div>
                    </div>
                    <div class="report-card" onclick="openReport('audit-employee')">
                        <div class="report-card-icon">üìã</div>
                        <div class="report-card-title">Audit Trail - Per Employee</div>
                        <div class="report-card-desc">All actions on a specific employee</div>
                    </div>
                    <div class="report-card" onclick="openReport('tax-report')">
                        <div class="report-card-icon">üèõÔ∏è</div>
                        <div class="report-card-title">Tax Report (SARS)</div>
                        <div class="report-card-desc">PAYE, UIF, SDL compliance summaries</div>
                    </div>
                    <div class="report-card" onclick="openReport('ytd-report')">
                        <div class="report-card-icon">üìà</div>
                        <div class="report-card-title">Year-to-Date</div>
                        <div class="report-card-desc">Cumulative earnings from tax year start</div>
                    </div>
                    <div class="report-card" onclick="openReport('variance-report')">
                        <div class="report-card-icon">üìä</div>
                        <div class="report-card-title">Variance Report</div>
                        <div class="report-card-desc">Compare periods and spot anomalies</div>
                    </div>
                </div>
            </div>

            <!-- REPORT DETAIL VIEW -->
            <div id="report-detail-view" style="display: none;">
                <div class="page-header">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button class="btn-back" onclick="backToSelection()">‚Üê Back</button>
                        <h1 id="report-title"></h1>
                    </div>
                </div>

                <!-- Filter Panel -->
                <div class="filter-panel" id="filter-panel"></div>

                <!-- Export Bar -->
                <div class="export-bar" id="export-bar" style="display: none;">
                    <span class="label">Export:</span>
                    <button class="btn btn-success btn-sm" onclick="exportCSV()" data-permission="EXPORT_DATA">CSV</button>
                    <button class="btn btn-info btn-sm" onclick="exportExcel()" data-permission="EXPORT_DATA">Excel</button>
                    <button class="btn btn-danger btn-sm" onclick="exportPDF()" data-permission="EXPORT_DATA">PDF</button>
                </div>

                <!-- Summary Cards -->
                <div id="summary-section"></div>

                <!-- Results -->
                <div id="results-section"></div>
            </div>
        </div>
    </div>

    <!-- CDN Libraries for Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <script src="js/data-access.js"></script>
    <script src="js/permissions.js"></script>
    <script src="js/audit.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/payroll-engine.js"></script>
    <script>
        let currentCompanyId = null;
        let employees = [];
        let payruns = [];
        let currentReport = null;
        let currentReportData = { headers: [], rows: [], title: '' };

        // ========== INIT ==========
        window.addEventListener('load', function() {
            if (!AUTH.isLoggedIn()) { window.location.href = 'login.html'; return; }
            const session = AUTH.getSession();
            currentCompanyId = session.company_id;
            const company = AUTH.getCompanyById(currentCompanyId);
            document.getElementById('company-name-badge').textContent = company ? company.name : 'Unknown';
            loadCompaniesCarousel();
            loadData();
        });

        // ========== SIDEBAR ==========
        function loadCompaniesCarousel() {
            const session = AUTH.getSession();
            const companies = AUTH.getCompaniesForUser(session);
            const carousel = document.getElementById('companies-carousel');
            carousel.innerHTML = '';

            if (companies.length === 0) {
                carousel.innerHTML = '<div style="padding: 10px; color: #999; text-align: center; font-size: 12px;">No companies available</div>';
            } else {
                companies.forEach(company => {
                    const div = document.createElement('div');
                    div.className = 'carousel-company';
                    div.textContent = company.name;
                    if (company.id === session.company_id) {
                        div.style.background = '#667eea';
                        div.style.color = 'white';
                        div.style.fontWeight = 'bold';
                    }
                    div.onclick = () => switchToCompany(company.id);
                    carousel.appendChild(div);
                });
            }

            // Add Company button for business_owner and accountant
            if (session.role === 'business_owner' || session.role === 'accountant') {
                var addBtn = document.createElement('div');
                addBtn.className = 'carousel-company';
                addBtn.style.cssText = 'background:#e8f5e9; color:#28a745; font-weight:600; text-align:center; border:1px dashed #28a745; cursor:pointer;';
                addBtn.textContent = '+ Add Company';
                addBtn.onclick = function() { openAddCompanyModal(); };
                carousel.appendChild(addBtn);
            }
        }

        function switchToCompany(companyId) {
            const session = AUTH.getSession();
            session.company_id = companyId;
            localStorage.setItem('session', JSON.stringify(session));
            location.reload();
        }
        function handleLogout() { if (confirm('Are you sure you want to logout?')) AUTH.logout(); }

        // ========== DATA LOADING ==========
        function loadData() {
            employees = JSON.parse(localStorage.getItem('employees_' + currentCompanyId) || '[]');
            payruns = JSON.parse(localStorage.getItem('payruns_' + currentCompanyId) || '[]');
        }

        function getEmployeePayroll(empId) {
            return JSON.parse(localStorage.getItem('emp_payroll_' + currentCompanyId + '_' + empId) || '{"basic_salary":0,"regular_inputs":[]}');
        }

        function getPayslipStatus(empId, period) {
            return JSON.parse(localStorage.getItem('emp_payslip_status_' + currentCompanyId + '_' + empId + '_' + period) || '{"status":"draft"}');
        }

        function calculateEmployeePeriod(empId, period) {
            return PayrollEngine.calculateEmployeePeriod(currentCompanyId, empId, period);
        }

        function r2(n) { return Math.round(n * 100) / 100; }
        function formatMoney(a) { return 'R ' + (a || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' '); }
        function formatPeriod(p) { const parts = p.split('-'); const m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return m[parseInt(parts[1])-1] + ' ' + parts[0]; }

        // ========== AUDIT LOGGING ==========
        function logAudit(action_type, entity_type, description, employee_id, parameters) {
            if (typeof AuditTrail !== 'undefined') {
                AuditTrail.log(currentCompanyId, action_type, entity_type, description, {
                    employee_id: employee_id || null,
                    parameters: parameters || null
                });
            }
        }

        function logReportGeneration(reportType, parameters) {
            const session = AUTH.getSession();
            const history = JSON.parse(localStorage.getItem('report_history_' + currentCompanyId) || '[]');
            history.push({
                id: 'rpt-' + Math.random().toString(36).substr(2, 9),
                report_type: reportType,
                generated_by: session.name || session.email,
                generated_at: new Date().toISOString(),
                parameters: parameters
            });
            localStorage.setItem('report_history_' + currentCompanyId, JSON.stringify(history));
            logAudit('GENERATE', 'report', 'Generated ' + reportType + ' report', null, parameters);
        }

        // ========== REPORT NAVIGATION ==========
        function openReport(type) {
            currentReport = type;
            document.getElementById('report-selection-view').style.display = 'none';
            document.getElementById('report-detail-view').style.display = 'block';
            renderReportFilters(type);
        }

        function backToSelection() {
            document.getElementById('report-detail-view').style.display = 'none';
            document.getElementById('report-selection-view').style.display = 'block';
            currentReport = null;
        }

        // ========== GET AVAILABLE PERIODS ==========
        function getAvailablePeriods() {
            const periods = new Set();
            payruns.forEach(pr => { if (pr.period) periods.add(pr.period); });
            // Also add current and past 12 months
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                periods.add(d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0'));
            }
            // Include historical periods
            const histPeriods = PayrollEngine.getHistoricalPeriods(currentCompanyId);
            histPeriods.forEach(p => periods.add(p));
            return Array.from(periods).sort().reverse();
        }

        function getDepartments() {
            const depts = new Set();
            employees.forEach(e => { if (e.department) depts.add(e.department); });
            return Array.from(depts).sort();
        }

        // ========== RENDER FILTERS ==========
        function renderReportFilters(type) {
            const titles = {
                'transaction-history': 'üí≥ Transaction History Report',
                'employee-master': 'üë• Employee Master List',
                'bank-details': 'üè¶ Bank Details Report',
                'payroll-summary': 'üí∞ Payroll Summary Report',
                'audit-user': 'üîç Audit Trail - User Activity',
                'audit-employee': 'üìã Audit Trail - Per Employee',
                'tax-report': 'üèõÔ∏è Tax Report (SARS Compliance)',
                'ytd-report': 'üìà Year-to-Date Report',
                'variance-report': 'üìä Variance Report'
            };
            document.getElementById('report-title').innerHTML = titles[type] || type;
            if (type === 'bank-details') {
                document.getElementById('report-title').innerHTML += '<span class="confidential-badge">Confidential</span>';
            }

            const periods = getAvailablePeriods();
            const depts = getDepartments();
            const empOptions = employees.map(e => '<option value="' + e.id + '">' + e.first_name + ' ' + e.last_name + ' (' + e.employee_number + ')</option>').join('');
            const deptOptions = depts.map(d => '<option value="' + d + '">' + d + '</option>').join('');
            const periodOptions = periods.map(p => '<option value="' + p + '">' + formatPeriod(p) + '</option>').join('');

            let filterHTML = '<div class="filter-title">Filters</div><div class="filter-grid">';

            if (['transaction-history', 'payroll-summary', 'tax-report', 'ytd-report'].includes(type)) {
                filterHTML += '<div class="filter-group"><label>From Period</label><select id="filter-from">' + periodOptions + '</select></div>';
                filterHTML += '<div class="filter-group"><label>To Period</label><select id="filter-to">' + periodOptions + '</select></div>';
            }
            if (type === 'variance-report') {
                filterHTML += '<div class="filter-group"><label>Period 1 (Compare From)</label><select id="filter-period1">' + periodOptions + '</select></div>';
                filterHTML += '<div class="filter-group"><label>Period 2 (Compare To)</label><select id="filter-period2">' + (periods.length > 1 ? periods.slice(1).map(p => '<option value="' + p + '">' + formatPeriod(p) + '</option>').join('') : periodOptions) + '</select></div>';
            }
            if (['transaction-history', 'employee-master', 'bank-details', 'payroll-summary', 'ytd-report', 'variance-report'].includes(type)) {
                filterHTML += '<div class="filter-group"><label>Employee</label><select id="filter-employee"><option value="">All Employees</option>' + empOptions + '</select></div>';
                filterHTML += '<div class="filter-group"><label>Department</label><select id="filter-department"><option value="">All Departments</option>' + deptOptions + '</select></div>';
            }
            if (type === 'transaction-history') {
                filterHTML += '<div class="filter-group"><label>Status</label><select id="filter-status"><option value="">All</option><option value="draft">Draft</option><option value="finalized">Finalized</option><option value="paid">Paid</option></select></div>';
            }
            if (type === 'audit-user') {
                filterHTML += '<div class="filter-group"><label>Date From</label><input type="date" id="filter-date-from"></div>';
                filterHTML += '<div class="filter-group"><label>Date To</label><input type="date" id="filter-date-to"></div>';
                filterHTML += '<div class="filter-group"><label>Action Type</label><select id="filter-action"><option value="">All Actions</option><option value="CREATE">Create</option><option value="UPDATE">Update</option><option value="DELETE">Delete</option><option value="VIEW">View</option><option value="GENERATE">Generate</option></select></div>';
            }
            if (type === 'audit-employee') {
                filterHTML += '<div class="filter-group"><label>Employee</label><select id="filter-employee" required><option value="">Select Employee</option>' + empOptions + '</select></div>';
                filterHTML += '<div class="filter-group"><label>Date From</label><input type="date" id="filter-date-from"></div>';
                filterHTML += '<div class="filter-group"><label>Date To</label><input type="date" id="filter-date-to"></div>';
            }

            filterHTML += '</div><div class="filter-actions">';
            filterHTML += '<button class="btn btn-primary" onclick="generateReport()">Generate Report</button>';
            filterHTML += '<button class="btn btn-secondary" onclick="renderReportFilters(\'' + type + '\')">Reset Filters</button>';
            filterHTML += '</div>';

            document.getElementById('filter-panel').innerHTML = filterHTML;
            document.getElementById('export-bar').style.display = 'none';
            document.getElementById('summary-section').innerHTML = '';
            document.getElementById('results-section').innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">Configure filters and click "Generate Report"</div></div>';

            // Set default "To" period to first option
            if (document.getElementById('filter-to')) {
                document.getElementById('filter-to').selectedIndex = 0;
            }
        }

        // ========== GENERATE REPORT ==========
        function generateReport() {
            switch (currentReport) {
                case 'transaction-history': generateTransactionHistory(); break;
                case 'employee-master': generateEmployeeMaster(); break;
                case 'bank-details': generateBankDetails(); break;
                case 'payroll-summary': generatePayrollSummary(); break;
                case 'audit-user': generateAuditUser(); break;
                case 'audit-employee': generateAuditEmployee(); break;
                case 'tax-report': generateTaxReport(); break;
                case 'ytd-report': generateYTDReport(); break;
                case 'variance-report': generateVarianceReport(); break;
            }
        }

        // ========== REPORT 1: TRANSACTION HISTORY ==========
        function generateTransactionHistory() {
            const fromPeriod = document.getElementById('filter-from').value;
            const toPeriod = document.getElementById('filter-to').value;
            const empFilter = document.getElementById('filter-employee').value;
            const deptFilter = document.getElementById('filter-department').value;
            const statusFilter = document.getElementById('filter-status').value;

            const periods = getAvailablePeriods().filter(p => p >= toPeriod && p <= fromPeriod);
            let filteredEmps = employees.filter(e => {
                if (empFilter && e.id !== empFilter) return false;
                if (deptFilter && e.department !== deptFilter) return false;
                return true;
            });

            const headers = ['Period', 'Employee #', 'Employee Name', 'Department', 'Gross Pay', 'PAYE', 'UIF', 'Deductions', 'Net Pay', 'Status'];
            const rows = [];
            let totals = { gross: 0, paye: 0, uif: 0, deductions: 0, net: 0 };

            periods.forEach(period => {
                filteredEmps.forEach(emp => {
                    const calc = calculateEmployeePeriod(emp.id, period);
                    if (calc.gross <= 0) return;
                    const ps = getPayslipStatus(emp.id, period);
                    if (statusFilter && ps.status !== statusFilter) return;
                    rows.push([
                        formatPeriod(period), emp.employee_number, emp.first_name + ' ' + emp.last_name,
                        emp.department || '-', formatMoney(calc.gross), formatMoney(calc.paye),
                        formatMoney(calc.uif), formatMoney(calc.deductions), formatMoney(calc.net), ps.status
                    ]);
                    totals.gross += calc.gross; totals.paye += calc.paye; totals.uif += calc.uif;
                    totals.deductions += calc.deductions; totals.net += calc.net;
                });
            });

            currentReportData = { headers, rows, title: 'Transaction History Report' };

            // Summary
            document.getElementById('summary-section').innerHTML =
                '<div class="summary-cards">' +
                '<div class="summary-card"><div class="summary-card-label">Total Transactions</div><div class="summary-card-value">' + rows.length + '</div></div>' +
                '<div class="summary-card green"><div class="summary-card-label">Total Gross</div><div class="summary-card-value">' + formatMoney(totals.gross) + '</div></div>' +
                '<div class="summary-card red"><div class="summary-card-label">Total PAYE</div><div class="summary-card-value">' + formatMoney(totals.paye) + '</div></div>' +
                '<div class="summary-card teal"><div class="summary-card-label">Total Net</div><div class="summary-card-value">' + formatMoney(totals.net) + '</div></div>' +
                '</div>';

            renderTable(headers, rows, [
                '', '', '', 'TOTALS:', formatMoney(totals.gross), formatMoney(totals.paye),
                formatMoney(totals.uif), formatMoney(totals.deductions), formatMoney(totals.net), ''
            ]);
            logReportGeneration('Transaction History', { from: fromPeriod, to: toPeriod, employee: empFilter, department: deptFilter });
        }

        // ========== REPORT 2: EMPLOYEE MASTER LIST ==========
        function generateEmployeeMaster() {
            const empFilter = document.getElementById('filter-employee').value;
            const deptFilter = document.getElementById('filter-department').value;

            let filteredEmps = employees.filter(e => {
                if (empFilter && e.id !== empFilter) return false;
                if (deptFilter && e.department !== deptFilter) return false;
                return true;
            });

            const headers = ['Employee #', 'Full Name', 'ID Number', 'Email', 'Phone', 'Department', 'Job Title', 'Position', 'Payment Method', 'Date Appointed'];
            const rows = filteredEmps.map(e => [
                e.employee_number, e.first_name + ' ' + e.last_name, e.id_number || '-',
                e.email || '-', e.phone || '-', e.department || '-', e.job_title || '-',
                e.position || '-', e.payment_method || 'EFT', e.date_appointed || '-'
            ]);

            currentReportData = { headers, rows, title: 'Employee Master List' };

            // Department breakdown
            const deptCounts = {};
            filteredEmps.forEach(e => {
                const d = e.department || 'Unassigned';
                deptCounts[d] = (deptCounts[d] || 0) + 1;
            });

            let deptHTML = '<div class="dept-breakdown">';
            Object.entries(deptCounts).sort((a,b) => b[1]-a[1]).forEach(([dept, count]) => {
                deptHTML += '<div class="dept-card"><div class="dept-card-title">' + dept + '</div><div class="dept-card-stat"><span>Employees</span><strong>' + count + '</strong></div></div>';
            });
            deptHTML += '</div>';

            document.getElementById('summary-section').innerHTML =
                '<div class="summary-cards">' +
                '<div class="summary-card"><div class="summary-card-label">Total Employees</div><div class="summary-card-value">' + filteredEmps.length + '</div></div>' +
                '<div class="summary-card green"><div class="summary-card-label">Departments</div><div class="summary-card-value">' + Object.keys(deptCounts).length + '</div></div>' +
                '</div>' + deptHTML;

            renderTable(headers, rows);
            logReportGeneration('Employee Master List', { employee: empFilter, department: deptFilter });
        }

        // ========== REPORT 3: BANK DETAILS (SECURE) ==========
        function generateBankDetails() {
            const empFilter = document.getElementById('filter-employee').value;
            const deptFilter = document.getElementById('filter-department').value;

            let filteredEmps = employees.filter(e => {
                if (empFilter && e.id !== empFilter) return false;
                if (deptFilter && e.department !== deptFilter) return false;
                return true;
            });

            const headers = ['Employee #', 'Employee Name', 'Bank Name', 'Account Holder', 'Account Number', 'Branch Code', 'Payment Method'];
            const rows = filteredEmps.map(e => [
                e.employee_number, e.first_name + ' ' + e.last_name,
                e.bank_name || '-', e.account_holder || '-',
                maskAccountNumber(e.account_number), e.branch_code || '-', e.payment_method || 'EFT'
            ]);

            currentReportData = { headers, rows, title: 'Bank Details Report (CONFIDENTIAL)', isSensitive: true };

            document.getElementById('summary-section').innerHTML =
                '<div class="summary-cards">' +
                '<div class="summary-card red"><div class="summary-card-label">Confidential</div><div class="summary-card-value">Bank Details</div></div>' +
                '<div class="summary-card"><div class="summary-card-label">Employees</div><div class="summary-card-value">' + filteredEmps.length + '</div></div>' +
                '<div class="summary-card green"><div class="summary-card-label">With Bank Details</div><div class="summary-card-value">' + filteredEmps.filter(e => e.bank_name).length + '</div></div>' +
                '</div>' +
                '<div style="background:#fff3cd; padding:12px; border-radius:8px; margin-bottom:15px; color:#856404; font-size:13px;">' +
                '<strong>Security Notice:</strong> Account numbers are masked. This report access has been logged in the audit trail. ' +
                '<button class="btn btn-sm btn-danger" onclick="toggleAccountMask()" style="margin-left:10px;" id="mask-toggle-btn" data-permission="VIEW_BANK_DETAILS">Show Full Numbers</button></div>';

            renderTable(headers, rows);
            logAudit('VIEW', 'bank_details', 'Viewed bank details report for ' + filteredEmps.length + ' employees');
            logReportGeneration('Bank Details', { employee: empFilter, department: deptFilter });
        }

        let accountsMasked = true;
        function maskAccountNumber(num) {
            if (!num) return '-';
            if (accountsMasked && num.length > 4) return '****' + num.slice(-4);
            return num;
        }

        function toggleAccountMask() {
            if (!Permissions.require('VIEW_BANK_DETAILS')) return;
            accountsMasked = !accountsMasked;
            const btn = document.getElementById('mask-toggle-btn');
            btn.textContent = accountsMasked ? 'Show Full Numbers' : 'Hide Numbers';
            if (!accountsMasked) {
                logAudit('VIEW', 'bank_details', 'Revealed full bank account numbers');
            }
            generateReport();
        }

        // ========== REPORT 4: PAYROLL SUMMARY ==========
        function generatePayrollSummary() {
            const fromPeriod = document.getElementById('filter-from').value;
            const toPeriod = document.getElementById('filter-to').value;
            const empFilter = document.getElementById('filter-employee').value;
            const deptFilter = document.getElementById('filter-department').value;

            const periods = getAvailablePeriods().filter(p => p >= toPeriod && p <= fromPeriod);
            let filteredEmps = employees.filter(e => {
                if (empFilter && e.id !== empFilter) return false;
                if (deptFilter && e.department !== deptFilter) return false;
                return true;
            });

            let totals = { gross: 0, paye: 0, uif_emp: 0, uif_er: 0, sdl: 0, deductions: 0, net: 0 };
            const deptTotals = {};
            const headers = ['Employee #', 'Employee Name', 'Department', 'Gross Pay', 'PAYE', 'UIF (Employee)', 'UIF (Employer)', 'SDL', 'Other Deductions', 'Net Pay'];
            const rows = [];

            periods.forEach(period => {
                filteredEmps.forEach(emp => {
                    const calc = calculateEmployeePeriod(emp.id, period);
                    if (calc.gross <= 0) return;
                    const uifEr = calc.uif; // Employer matches
                    rows.push([
                        emp.employee_number, emp.first_name + ' ' + emp.last_name, emp.department || '-',
                        formatMoney(calc.gross), formatMoney(calc.paye), formatMoney(calc.uif),
                        formatMoney(uifEr), formatMoney(calc.sdl), formatMoney(calc.deductions), formatMoney(calc.net)
                    ]);
                    totals.gross += calc.gross; totals.paye += calc.paye; totals.uif_emp += calc.uif;
                    totals.uif_er += uifEr; totals.sdl += calc.sdl; totals.deductions += calc.deductions; totals.net += calc.net;

                    const dept = emp.department || 'Unassigned';
                    if (!deptTotals[dept]) deptTotals[dept] = { gross: 0, paye: 0, net: 0, count: 0 };
                    deptTotals[dept].gross += calc.gross; deptTotals[dept].paye += calc.paye;
                    deptTotals[dept].net += calc.net; deptTotals[dept].count++;
                });
            });

            const ctc = totals.gross + totals.uif_er + totals.sdl;
            currentReportData = { headers, rows, title: 'Payroll Summary Report' };

            // Department breakdown
            let deptHTML = '<div class="dept-breakdown">';
            Object.entries(deptTotals).forEach(([dept, d]) => {
                deptHTML += '<div class="dept-card"><div class="dept-card-title">' + dept + ' (' + d.count + ' entries)</div>' +
                    '<div class="dept-card-stat"><span>Gross</span><strong>' + formatMoney(d.gross) + '</strong></div>' +
                    '<div class="dept-card-stat"><span>PAYE</span><strong>' + formatMoney(d.paye) + '</strong></div>' +
                    '<div class="dept-card-stat"><span>Net</span><strong>' + formatMoney(d.net) + '</strong></div></div>';
            });
            deptHTML += '</div>';

            document.getElementById('summary-section').innerHTML =
                '<div class="summary-cards">' +
                '<div class="summary-card"><div class="summary-card-label">Total Gross</div><div class="summary-card-value">' + formatMoney(totals.gross) + '</div></div>' +
                '<div class="summary-card red"><div class="summary-card-label">Total PAYE</div><div class="summary-card-value">' + formatMoney(totals.paye) + '</div></div>' +
                '<div class="summary-card orange"><div class="summary-card-label">Total UIF (Both)</div><div class="summary-card-value">' + formatMoney(totals.uif_emp + totals.uif_er) + '</div></div>' +
                '<div class="summary-card teal"><div class="summary-card-label">Total SDL</div><div class="summary-card-value">' + formatMoney(totals.sdl) + '</div></div>' +
                '<div class="summary-card green"><div class="summary-card-label">Total Net</div><div class="summary-card-value">' + formatMoney(totals.net) + '</div></div>' +
                '<div class="summary-card" style="background: linear-gradient(135deg, #e17055, #d63031);"><div class="summary-card-label">Cost to Company</div><div class="summary-card-value">' + formatMoney(ctc) + '</div></div>' +
                '</div>' + deptHTML;

            renderTable(headers, rows, [
                '', '', 'TOTALS:', formatMoney(totals.gross), formatMoney(totals.paye),
                formatMoney(totals.uif_emp), formatMoney(totals.uif_er), formatMoney(totals.sdl),
                formatMoney(totals.deductions), formatMoney(totals.net)
            ]);
            logReportGeneration('Payroll Summary', { from: fromPeriod, to: toPeriod });
        }

        // ========== REPORT 5a: AUDIT TRAIL - USER ACTIVITY ==========
        function generateAuditUser() {
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const actionFilter = document.getElementById('filter-action').value;

            let logs = JSON.parse(localStorage.getItem('audit_log_' + currentCompanyId) || '[]');
            logs.sort((a, b) => b.timestamp.localeCompare(a.timestamp));

            if (dateFrom) logs = logs.filter(l => l.timestamp.slice(0, 10) >= dateFrom);
            if (dateTo) logs = logs.filter(l => l.timestamp.slice(0, 10) <= dateTo);
            if (actionFilter) logs = logs.filter(l => l.action_type === actionFilter);

            const headers = ['Timestamp', 'User', 'Action Type', 'Entity Type', 'Description'];
            const rows = logs.map(l => [
                new Date(l.timestamp).toLocaleString(), l.user_name || '-',
                l.action_type, l.entity_type, l.description || '-'
            ]);

            currentReportData = { headers, rows, title: 'Audit Trail - User Activity' };

            document.getElementById('summary-section').innerHTML =
                '<div class="summary-cards">' +
                '<div class="summary-card"><div class="summary-card-label">Total Events</div><div class="summary-card-value">' + rows.length + '</div></div>' +
                '</div>';

            renderTable(headers, rows);
            // Don't log audit report generation to avoid infinite loop of audit entries
        }

        // ========== REPORT 5b: AUDIT TRAIL - PER EMPLOYEE ==========
        function generateAuditEmployee() {
            const empFilter = document.getElementById('filter-employee').value;
            if (!empFilter) { alert('Please select an employee'); return; }
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;

            const emp = employees.find(e => e.id === empFilter);
            let logs = JSON.parse(localStorage.getItem('audit_log_' + currentCompanyId) || '[]');
            logs = logs.filter(l => l.employee_id === empFilter);
            logs.sort((a, b) => b.timestamp.localeCompare(a.timestamp));

            if (dateFrom) logs = logs.filter(l => l.timestamp.slice(0, 10) >= dateFrom);
            if (dateTo) logs = logs.filter(l => l.timestamp.slice(0, 10) <= dateTo);

            const headers = ['Timestamp', 'User', 'Action Type', 'Description'];
            const rows = logs.map(l => [
                new Date(l.timestamp).toLocaleString(), l.user_name || '-',
                l.action_type, l.description || '-'
            ]);

            currentReportData = { headers, rows, title: 'Audit Trail - ' + (emp ? emp.first_name + ' ' + emp.last_name : 'Employee') };

            document.getElementById('summary-section').innerHTML =
                '<div class="summary-cards">' +
                '<div class="summary-card"><div class="summary-card-label">Employee</div><div class="summary-card-value">' + (emp ? emp.first_name + ' ' + emp.last_name : '-') + '</div></div>' +
                '<div class="summary-card"><div class="summary-card-label">Total Events</div><div class="summary-card-value">' + rows.length + '</div></div>' +
                '</div>';

            renderTable(headers, rows);
        }

        // ========== REPORT 6: TAX REPORT (SARS) ==========
        function generateTaxReport() {
            const fromPeriod = document.getElementById('filter-from').value;
            const toPeriod = document.getElementById('filter-to').value;

            const periods = getAvailablePeriods().filter(p => p >= toPeriod && p <= fromPeriod);
            let totals = { paye: 0, uif_emp: 0, uif_er: 0, sdl: 0, gross: 0 };
            const headers = ['Employee #', 'Employee Name', 'ID Number', 'Gross Remuneration', 'PAYE', 'UIF (Employee)', 'UIF (Employer)', 'SDL'];
            const rows = [];

            periods.forEach(period => {
                employees.forEach(emp => {
                    const calc = calculateEmployeePeriod(emp.id, period);
                    if (calc.gross <= 0) return;
                    const uifEr = calc.uif;
                    rows.push([
                        emp.employee_number, emp.first_name + ' ' + emp.last_name,
                        emp.id_number || '-', formatMoney(calc.gross), formatMoney(calc.paye),
                        formatMoney(calc.uif), formatMoney(uifEr), formatMoney(calc.sdl)
                    ]);
                    totals.paye += calc.paye; totals.uif_emp += calc.uif;
                    totals.uif_er += uifEr; totals.sdl += calc.sdl; totals.gross += calc.gross;
                });
            });

            const totalPayable = totals.paye + totals.sdl + totals.uif_emp + totals.uif_er;
            currentReportData = { headers, rows, title: 'Tax Report (SARS Compliance)' };

            document.getElementById('summary-section').innerHTML =
                '<div class="summary-cards">' +
                '<div class="summary-card"><div class="summary-card-label">Total PAYE</div><div class="summary-card-value">' + formatMoney(totals.paye) + '</div></div>' +
                '<div class="summary-card orange"><div class="summary-card-label">UIF (Employee)</div><div class="summary-card-value">' + formatMoney(totals.uif_emp) + '</div></div>' +
                '<div class="summary-card orange"><div class="summary-card-label">UIF (Employer)</div><div class="summary-card-value">' + formatMoney(totals.uif_er) + '</div></div>' +
                '<div class="summary-card teal"><div class="summary-card-label">SDL</div><div class="summary-card-value">' + formatMoney(totals.sdl) + '</div></div>' +
                '<div class="summary-card red"><div class="summary-card-label">Total Payable to SARS</div><div class="summary-card-value">' + formatMoney(totalPayable) + '</div></div>' +
                '<div class="summary-card green"><div class="summary-card-label">Total Gross</div><div class="summary-card-value">' + formatMoney(totals.gross) + '</div></div>' +
                '</div>';

            renderTable(headers, rows, [
                '', '', 'TOTALS:', formatMoney(totals.gross), formatMoney(totals.paye),
                formatMoney(totals.uif_emp), formatMoney(totals.uif_er), formatMoney(totals.sdl)
            ]);
            logReportGeneration('Tax Report', { from: fromPeriod, to: toPeriod });
        }

        // ========== REPORT 7: YEAR-TO-DATE ==========
        function generateYTDReport() {
            const empFilter = document.getElementById('filter-employee').value;
            const deptFilter = document.getElementById('filter-department').value;

            // SA tax year starts March 1
            const now = new Date();
            let taxYearStart;
            if (now.getMonth() >= 2) { // March (0-indexed: 2) or later
                taxYearStart = now.getFullYear() + '-03';
            } else {
                taxYearStart = (now.getFullYear() - 1) + '-03';
            }
            const currentPeriod = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            const periods = getAvailablePeriods().filter(p => p >= taxYearStart && p <= currentPeriod);

            let filteredEmps = employees.filter(e => {
                if (empFilter && e.id !== empFilter) return false;
                if (deptFilter && e.department !== deptFilter) return false;
                return true;
            });

            const headers = ['Employee #', 'Employee Name', 'Department', 'YTD Gross', 'YTD PAYE', 'YTD UIF', 'YTD Deductions', 'YTD Net', 'Pay Periods'];
            const rows = [];

            filteredEmps.forEach(emp => {
                let ytd = { gross: 0, paye: 0, uif: 0, deductions: 0, net: 0, periods: 0 };
                periods.forEach(period => {
                    const calc = calculateEmployeePeriod(emp.id, period);
                    if (calc.gross > 0) {
                        ytd.gross += calc.gross; ytd.paye += calc.paye; ytd.uif += calc.uif;
                        ytd.deductions += calc.deductions; ytd.net += calc.net; ytd.periods++;
                    }
                });
                if (ytd.periods > 0) {
                    rows.push([
                        emp.employee_number, emp.first_name + ' ' + emp.last_name, emp.department || '-',
                        formatMoney(ytd.gross), formatMoney(ytd.paye), formatMoney(ytd.uif),
                        formatMoney(ytd.deductions), formatMoney(ytd.net), ytd.periods
                    ]);
                }
            });

            currentReportData = { headers, rows, title: 'Year-to-Date Report (Tax Year from ' + formatPeriod(taxYearStart) + ')' };

            document.getElementById('summary-section').innerHTML =
                '<div class="summary-cards">' +
                '<div class="summary-card"><div class="summary-card-label">Tax Year Start</div><div class="summary-card-value">' + formatPeriod(taxYearStart) + '</div></div>' +
                '<div class="summary-card green"><div class="summary-card-label">Employees with Data</div><div class="summary-card-value">' + rows.length + '</div></div>' +
                '<div class="summary-card teal"><div class="summary-card-label">Periods Covered</div><div class="summary-card-value">' + periods.length + '</div></div>' +
                '</div>';

            renderTable(headers, rows);
            logReportGeneration('Year-to-Date', { taxYearStart, employee: empFilter, department: deptFilter });
        }

        // ========== REPORT 8: VARIANCE REPORT ==========
        function generateVarianceReport() {
            const period1 = document.getElementById('filter-period1').value;
            const period2 = document.getElementById('filter-period2').value;
            const empFilter = document.getElementById('filter-employee').value;
            const deptFilter = document.getElementById('filter-department').value;

            let filteredEmps = employees.filter(e => {
                if (empFilter && e.id !== empFilter) return false;
                if (deptFilter && e.department !== deptFilter) return false;
                return true;
            });

            const headers = ['Employee #', 'Employee Name', formatPeriod(period1) + ' Gross', formatPeriod(period2) + ' Gross', 'Variance (R)', 'Variance (%)', 'Flag'];
            const rows = [];

            filteredEmps.forEach(emp => {
                const calc1 = calculateEmployeePeriod(emp.id, period1);
                const calc2 = calculateEmployeePeriod(emp.id, period2);
                if (calc1.gross <= 0 && calc2.gross <= 0) return;

                const variance = calc1.gross - calc2.gross;
                const variancePct = calc2.gross > 0 ? ((variance / calc2.gross) * 100) : (calc1.gross > 0 ? 100 : 0);
                let flag = '';
                let rowClass = '';
                if (calc2.gross <= 0 && calc1.gross > 0) { flag = 'NEW'; rowClass = 'variance-new'; }
                else if (calc1.gross <= 0 && calc2.gross > 0) { flag = 'REMOVED'; rowClass = 'variance-high'; }
                else if (Math.abs(variancePct) > 10) { flag = variancePct > 0 ? 'INCREASE' : 'DECREASE'; rowClass = 'variance-high'; }

                rows.push({
                    data: [
                        emp.employee_number, emp.first_name + ' ' + emp.last_name,
                        formatMoney(calc1.gross), formatMoney(calc2.gross),
                        formatMoney(variance), variancePct.toFixed(1) + '%', flag
                    ],
                    className: rowClass
                });
            });

            currentReportData = {
                headers,
                rows: rows.map(r => r.data),
                title: 'Variance Report: ' + formatPeriod(period1) + ' vs ' + formatPeriod(period2)
            };

            const flagged = rows.filter(r => r.data[6]).length;
            document.getElementById('summary-section').innerHTML =
                '<div class="summary-cards">' +
                '<div class="summary-card"><div class="summary-card-label">Employees Compared</div><div class="summary-card-value">' + rows.length + '</div></div>' +
                '<div class="summary-card red"><div class="summary-card-label">Flagged Variances</div><div class="summary-card-value">' + flagged + '</div></div>' +
                '</div>';

            // Render with row classes
            let html = '<div class="results-container"><table class="results-table"><thead><tr>';
            headers.forEach(h => { html += '<th>' + h + '</th>'; });
            html += '</tr></thead><tbody>';
            if (rows.length === 0) {
                html += '<tr><td colspan="' + headers.length + '" style="text-align:center;padding:30px;color:#999;">No data found</td></tr>';
            } else {
                rows.forEach(row => {
                    html += '<tr class="' + (row.className || '') + '">';
                    row.data.forEach((cell, i) => {
                        const cls = (i >= 2 && i <= 5) ? ' class="amount"' : '';
                        html += '<td' + cls + '>' + cell + '</td>';
                    });
                    html += '</tr>';
                });
            }
            html += '</tbody></table></div>';
            document.getElementById('results-section').innerHTML = html;
            document.getElementById('export-bar').style.display = 'flex';
            Permissions.enforceUI();
            logReportGeneration('Variance Report', { period1, period2 });
        }

        // ========== TABLE RENDERER ==========
        function renderTable(headers, rows, totalRow) {
            let html = '<div class="results-container"><table class="results-table"><thead><tr>';
            headers.forEach(h => { html += '<th>' + h + '</th>'; });
            html += '</tr></thead><tbody>';

            if (rows.length === 0) {
                html += '<tr><td colspan="' + headers.length + '" style="text-align:center;padding:30px;color:#999;">No data found for the selected filters</td></tr>';
            } else {
                rows.forEach(row => {
                    html += '<tr>';
                    row.forEach((cell, i) => {
                        const isAmount = typeof cell === 'string' && cell.startsWith('R ');
                        html += '<td' + (isAmount ? ' class="amount"' : '') + '>' + cell + '</td>';
                    });
                    html += '</tr>';
                });
            }

            if (totalRow) {
                html += '<tr class="total-row">';
                totalRow.forEach((cell, i) => {
                    const isAmount = typeof cell === 'string' && cell.startsWith('R ');
                    html += '<td' + (isAmount ? ' class="amount"' : '') + '>' + cell + '</td>';
                });
                html += '</tr>';
            }

            html += '</tbody></table></div>';
            document.getElementById('results-section').innerHTML = html;
            document.getElementById('export-bar').style.display = rows.length > 0 ? 'flex' : 'none';
            Permissions.enforceUI();
        }

        // ========== EXPORT: CSV ==========
        function exportCSV() {
            if (!Permissions.require('EXPORT_DATA')) return;
            if (!currentReportData.rows.length) return;
            const escape = v => '"' + String(v).replace(/"/g, '""') + '"';
            let csv = currentReportData.headers.map(escape).join(',') + '\n';
            currentReportData.rows.forEach(row => {
                csv += row.map(escape).join(',') + '\n';
            });
            downloadFile(csv, currentReportData.title.replace(/[^a-zA-Z0-9]/g, '_') + '.csv', 'text/csv');
            logAudit('GENERATE', 'export', 'Exported ' + currentReportData.title + ' to CSV');
        }

        // ========== EXPORT: EXCEL ==========
        function exportExcel() {
            if (!Permissions.require('EXPORT_DATA')) return;
            if (!currentReportData.rows.length) return;
            if (typeof XLSX === 'undefined') { alert('Excel library not loaded. Please check your internet connection.'); return; }

            const wb = XLSX.utils.book_new();
            const data = [currentReportData.headers, ...currentReportData.rows.map(row =>
                row.map(cell => {
                    if (typeof cell === 'string' && cell.startsWith('R ')) {
                        return parseFloat(cell.replace(/R\s*/g, '').replace(/\s/g, '')) || 0;
                    }
                    return cell;
                })
            )];
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Column widths
            ws['!cols'] = currentReportData.headers.map(() => ({ wch: 18 }));

            XLSX.utils.book_append_sheet(wb, ws, 'Report');
            XLSX.writeFile(wb, currentReportData.title.replace(/[^a-zA-Z0-9]/g, '_') + '.xlsx');
            logAudit('GENERATE', 'export', 'Exported ' + currentReportData.title + ' to Excel');
        }

        // ========== EXPORT: PDF ==========
        function exportPDF() {
            if (!Permissions.require('EXPORT_DATA')) return;
            if (!currentReportData.rows.length) return;
            if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
                alert('PDF library not loaded. Please check your internet connection.'); return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: currentReportData.headers.length > 6 ? 'landscape' : 'portrait' });

            // Header
            const company = AUTH.getCompanyById(currentCompanyId);
            doc.setFontSize(18);
            doc.setTextColor(102, 126, 234);
            doc.text(company ? company.name : 'Lorenco Paytime', 14, 22);
            doc.setFontSize(14);
            doc.setTextColor(51, 51, 51);
            doc.text(currentReportData.title, 14, 32);
            doc.setFontSize(9);
            doc.setTextColor(128, 128, 128);
            doc.text('Generated: ' + new Date().toLocaleString() + ' | By: ' + (AUTH.getSession().name || AUTH.getSession().email), 14, 40);

            // Confidential watermark
            if (currentReportData.isSensitive) {
                doc.setFontSize(60);
                doc.setTextColor(255, 0, 0);
                doc.setGState(new doc.GState({ opacity: 0.1 }));
                doc.text('CONFIDENTIAL', doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() / 2, { align: 'center', angle: 45 });
                doc.setGState(new doc.GState({ opacity: 1 }));
            }

            // Table
            const bodyRows = currentReportData.rows.map(row =>
                row.map(cell => String(cell))
            );

            doc.autoTable({
                startY: 48,
                head: [currentReportData.headers],
                body: bodyRows,
                theme: 'grid',
                headStyles: { fillColor: [102, 126, 234], textColor: 255, fontSize: 8 },
                bodyStyles: { fontSize: 7 },
                alternateRowStyles: { fillColor: [248, 249, 250] },
                margin: { left: 14, right: 14 }
            });

            doc.save(currentReportData.title.replace(/[^a-zA-Z0-9]/g, '_') + '.pdf');
            logAudit('GENERATE', 'export', 'Exported ' + currentReportData.title + ' to PDF');
        }

        // ========== DOWNLOAD HELPER ==========
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function openAddCompanyModal() {
            document.getElementById('addCompanyModal').style.display = 'flex';
            document.getElementById('newCompanyName').value = '';
            document.getElementById('newCompanyEmail').value = '';
            document.getElementById('addCompanyError').style.display = 'none';
        }

        function closeAddCompanyModal() {
            document.getElementById('addCompanyModal').style.display = 'none';
        }

        function submitAddCompany() {
            var name = document.getElementById('newCompanyName').value.trim();
            var email = document.getElementById('newCompanyEmail').value.trim();
            var errorDiv = document.getElementById('addCompanyError');

            if (!name) {
                errorDiv.textContent = 'Please enter a company name';
                errorDiv.style.display = 'block';
                return;
            }

            var session = AUTH.getSession();
            var result = AUTH.createCompany({ name: name, email: email });
            if (!result.success) {
                errorDiv.textContent = 'Failed to create company';
                errorDiv.style.display = 'block';
                return;
            }

            AUTH.addCompanyToUser(session.user_id, result.company.id);
            AUTH.refreshSessionCompanyIds(result.company.id);

            // Switch to the new company
            session = AUTH.getSession();
            session.company_id = result.company.id;
            localStorage.setItem('session', JSON.stringify(session));

            closeAddCompanyModal();
            location.reload();
        }
    </script>

    <!-- Add Company Modal -->
    <div id="addCompanyModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:15px; padding:30px; max-width:450px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color:#667eea; margin:0;">Add New Company</h2>
                <span style="font-size:1.5rem; cursor:pointer; color:#999;" onclick="closeAddCompanyModal()">&times;</span>
            </div>
            <div id="addCompanyError" style="display:none; background:#fee; color:#c33; padding:10px; border-radius:8px; margin-bottom:15px; border-left:4px solid #c33;"></div>
            <div style="margin-bottom:15px;">
                <label style="display:block; font-weight:600; color:#333; margin-bottom:5px;">Company Name *</label>
                <input type="text" id="newCompanyName" placeholder="Enter company name" style="width:100%; padding:12px; border:2px solid #eee; border-radius:8px; font-size:1rem;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; font-weight:600; color:#333; margin-bottom:5px;">Company Email</label>
                <input type="email" id="newCompanyEmail" placeholder="Enter company email" style="width:100%; padding:12px; border:2px solid #eee; border-radius:8px; font-size:1rem;">
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="closeAddCompanyModal()" style="flex:1; padding:12px; background:#999; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Cancel</button>
                <button onclick="submitAddCompany()" style="flex:1; padding:12px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Create Company</button>
            </div>
        </div>
    </div>

    <nav class="mobile-bottom-nav">
        <a href="company-dashboard.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128202;</span><span class="mobile-nav-label">Dashboard</span></a>
        <a href="employee-management.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128101;</span><span class="mobile-nav-label">Employees</span></a>
        <a href="payruns.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128181;</span><span class="mobile-nav-label">Pay Runs</span></a>
        <a href="reports.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128203;</span><span class="mobile-nav-label">Reports</span></a>
    </nav>
    <script src="js/mobile-utils.js"></script>
</body>
</html>
