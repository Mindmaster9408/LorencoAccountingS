<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorenco Paytime - Comprehensive Test Suite</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5; padding: 20px; min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; border-radius: 15px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102,126,234,0.3);
        }
        .header h1 { font-size: 1.8rem; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 0.95rem; }
        .summary-bar {
            display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;
        }
        .summary-card {
            background: rgba(255,255,255,0.2); padding: 15px 25px; border-radius: 10px;
            text-align: center; min-width: 120px;
        }
        .summary-card .number { font-size: 2rem; font-weight: 700; }
        .summary-card .label { font-size: 0.8rem; text-transform: uppercase; opacity: 0.9; }
        .controls {
            display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600;
            cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: white; color: #667eea; }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; }
        .suite-section {
            background: white; border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;
        }
        .suite-header {
            padding: 15px 20px; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center;
            background: #f8f9fa; border-bottom: 1px solid #eee; transition: background 0.2s;
        }
        .suite-header:hover { background: #f0f2f5; }
        .suite-title { font-weight: 700; color: #333; font-size: 1rem; }
        .suite-stats { display: flex; gap: 10px; align-items: center; }
        .suite-badge {
            padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;
        }
        .badge-pass { background: #d4edda; color: #155724; }
        .badge-fail { background: #f8d7da; color: #721c24; }
        .badge-info { background: #cce5ff; color: #004085; }
        .suite-body { padding: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .suite-section.expanded .suite-body { max-height: 5000px; }
        .test-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem;
        }
        .test-row:last-child { border-bottom: none; }
        .test-desc { color: #555; flex: 1; }
        .test-result { font-weight: 600; min-width: 60px; text-align: right; }
        .test-pass { color: #28a745; }
        .test-fail { color: #dc3545; }
        .test-detail { font-size: 0.8rem; color: #999; margin-left: 10px; }
        .fail-detail {
            background: #fff3f3; padding: 8px 20px 8px 40px; font-size: 0.85rem;
            color: #721c24; border-bottom: 1px solid #f0f0f0;
        }

        /* UAT Checklist */
        .uat-section { padding: 20px; }
        .uat-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .uat-item:last-child { border-bottom: none; }
        .uat-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .uat-item label { cursor: pointer; color: #555; font-size: 0.9rem; }
        .uat-item input:checked + label { color: #28a745; text-decoration: line-through; }
        .uat-category { font-weight: 700; color: #667eea; margin-top: 15px; margin-bottom: 5px; font-size: 0.95rem; }

        /* Performance results */
        .perf-bar {
            height: 8px; background: #e0e0e0; border-radius: 4px; margin-top: 5px; overflow: hidden;
        }
        .perf-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .perf-fast { background: #28a745; }
        .perf-medium { background: #ffc107; }
        .perf-slow { background: #dc3545; }

        .expand-icon { transition: transform 0.3s; font-size: 1.2rem; color: #667eea; }
        .suite-section.expanded .expand-icon { transform: rotate(180deg); }

        .timestamp { margin-top: 15px; font-size: 0.85rem; opacity: 0.8; }
    </style>
    <link rel="stylesheet" href="css/dark-theme.css">
</head>
<body>

    <div class="header">
        <h1>Lorenco Paytime - Comprehensive Test Suite</h1>
        <p>SA PAYE 2024/2025 | Unit, Integration, Performance & Security Tests</p>
        <div class="summary-bar" id="summaryBar"></div>
        <div class="controls">
            <button class="btn btn-primary" onclick="runAllTests()">Run All Tests</button>
            <button class="btn btn-secondary" onclick="runCategory('unit')">Unit Tests</button>
            <button class="btn btn-secondary" onclick="runCategory('integration')">Integration Tests</button>
            <button class="btn btn-secondary" onclick="runCategory('performance')">Performance Tests</button>
            <button class="btn btn-secondary" onclick="runCategory('security')">Security Tests</button>
        </div>
        <div class="timestamp" id="timestamp"></div>
    </div>

    <div id="results"></div>

    <script src="js/data-access.js"></script>
    <script src="js/payroll-engine.js"></script>
    <script>
    // ============================================================
    // TEST RUNNER FRAMEWORK
    // ============================================================
    var TestRunner = {
        results: [],
        passed: 0,
        failed: 0,
        total: 0,
        currentSuite: '',
        currentCategory: '',

        reset: function() {
            this.results = [];
            this.passed = 0;
            this.failed = 0;
            this.total = 0;
        },

        suite: function(name, category) {
            this.currentSuite = name;
            this.currentCategory = category || 'unit';
        },

        assertEqual: function(desc, actual, expected) {
            this.total++;
            var pass;
            if (typeof expected === 'number' && typeof actual === 'number') {
                pass = Math.abs(actual - expected) < 0.005;
            } else {
                pass = actual === expected;
            }
            if (pass) this.passed++; else this.failed++;
            this.results.push({
                suite: this.currentSuite,
                category: this.currentCategory,
                desc: desc,
                pass: pass,
                actual: actual,
                expected: expected
            });
        },

        assertClose: function(desc, actual, expected, tolerance) {
            tolerance = tolerance || 0.02;
            this.total++;
            var pass = Math.abs(actual - expected) <= tolerance;
            if (pass) this.passed++; else this.failed++;
            this.results.push({
                suite: this.currentSuite,
                category: this.currentCategory,
                desc: desc,
                pass: pass,
                actual: actual,
                expected: expected
            });
        },

        assertTrue: function(desc, value) {
            this.total++;
            var pass = !!value;
            if (pass) this.passed++; else this.failed++;
            this.results.push({
                suite: this.currentSuite,
                category: this.currentCategory,
                desc: desc,
                pass: pass,
                actual: value,
                expected: true
            });
        },

        assertFalse: function(desc, value) {
            this.total++;
            var pass = !value;
            if (pass) this.passed++; else this.failed++;
            this.results.push({
                suite: this.currentSuite,
                category: this.currentCategory,
                desc: desc,
                pass: pass,
                actual: value,
                expected: false
            });
        },

        assertPerformance: function(desc, durationMs, maxMs) {
            this.total++;
            var pass = durationMs <= maxMs;
            if (pass) this.passed++; else this.failed++;
            this.results.push({
                suite: this.currentSuite,
                category: this.currentCategory,
                desc: desc + ' (' + Math.round(durationMs) + 'ms / ' + maxMs + 'ms limit)',
                pass: pass,
                actual: Math.round(durationMs) + 'ms',
                expected: '<= ' + maxMs + 'ms',
                perfMs: durationMs,
                perfMax: maxMs
            });
        }
    };

    // ============================================================
    // TEST DATA SETUP & CLEANUP
    // ============================================================
    var TEST_COMPANY = 'TEST_COMP_SUITE';
    var TEST_PERIOD = '2025-01';

    function setupTestData() {
        // Employee A: R10,000 basic, no extras
        localStorage.setItem('emp_payroll_' + TEST_COMPANY + '_emp-A', JSON.stringify({
            basic_salary: 10000, regular_inputs: []
        }));

        // Employee B: R50,000 basic, medical aid R2,000 + retirement R5,000
        localStorage.setItem('emp_payroll_' + TEST_COMPANY + '_emp-B', JSON.stringify({
            basic_salary: 50000, regular_inputs: [
                { id: 'ri-1', type: 'deduction', amount: 2000, description: 'Medical Aid' },
                { id: 'ri-2', type: 'deduction', amount: 5000, description: 'Retirement Fund' }
            ]
        }));

        // Employee C: R15,000 basic, mid-month hire (short time = half month)
        localStorage.setItem('emp_payroll_' + TEST_COMPANY + '_emp-C', JSON.stringify({
            basic_salary: 15000, regular_inputs: []
        }));
        localStorage.setItem('emp_short_time_' + TEST_COMPANY + '_emp-C_' + TEST_PERIOD, JSON.stringify([
            { id: 'st-1', hours_missed: 86.665, description: 'Mid-month hire (started 15th)' }
        ]));

        // Employee D: R30,000 basic, loan repayment R2,000
        localStorage.setItem('emp_payroll_' + TEST_COMPANY + '_emp-D', JSON.stringify({
            basic_salary: 30000, regular_inputs: [
                { id: 'ri-3', type: 'deduction', amount: 2000, description: 'Loan Repayment' }
            ]
        }));

        // Employee E: R100,000 basic, no extras
        localStorage.setItem('emp_payroll_' + TEST_COMPANY + '_emp-E', JSON.stringify({
            basic_salary: 100000, regular_inputs: []
        }));

        // Employee list
        localStorage.setItem('employees_' + TEST_COMPANY, JSON.stringify([
            { id: 'emp-A', employee_number: 'EMP001', first_name: 'Alice', last_name: 'Anderson', department: 'Finance', id_number: '9001015800085', payment_method: 'EFT', bank_name: 'FNB', account_number: '1234567890', branch_code: '250655' },
            { id: 'emp-B', employee_number: 'EMP002', first_name: 'Bob', last_name: 'Brown', department: 'IT', id_number: '8502025800086', payment_method: 'EFT', bank_name: 'ABSA', account_number: '9876543210', branch_code: '632005' },
            { id: 'emp-C', employee_number: 'EMP003', first_name: 'Carol', last_name: 'Clark', department: 'Finance', payment_method: 'Cash' },
            { id: 'emp-D', employee_number: 'EMP004', first_name: 'Dave', last_name: 'Davis', department: 'IT', payment_method: 'EFT', bank_name: 'Standard Bank', account_number: '5555666677', branch_code: '051001' },
            { id: 'emp-E', employee_number: 'EMP005', first_name: 'Eve', last_name: 'Evans', department: 'Management', payment_method: 'EFT', bank_name: 'Nedbank', account_number: '1112223334', branch_code: '198765' }
        ]));

        // Payrun for the period
        localStorage.setItem('payruns_' + TEST_COMPANY, JSON.stringify([
            { id: 'pr-test-1', period: TEST_PERIOD, status: 'finalized', frequency: 'Monthly', created: '2025-01-25T10:00:00Z' }
        ]));

        // Payslip statuses (all finalized for integration tests)
        ['emp-A', 'emp-B', 'emp-C', 'emp-D', 'emp-E'].forEach(function(empId) {
            localStorage.setItem('emp_payslip_status_' + TEST_COMPANY + '_' + empId + '_' + TEST_PERIOD,
                JSON.stringify({ status: 'finalized', finalized_at: '2025-01-25T10:00:00Z' }));
        });

        // Audit log (empty)
        localStorage.setItem('audit_log_' + TEST_COMPANY, JSON.stringify([]));
    }

    function cleanupTestData() {
        var keysToRemove = [];
        for (var i = 0; i < localStorage.length; i++) {
            var key = localStorage.key(i);
            if (key && key.indexOf(TEST_COMPANY) !== -1) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(function(key) { localStorage.removeItem(key); });
    }

    // ============================================================
    // CATEGORY 1: UNIT TESTS - PAYE BRACKET CALCULATIONS
    // ============================================================
    function runPAYETests() {
        TestRunner.suite('1. PAYE Bracket Calculations', 'unit');

        // Case 1: R0/month
        TestRunner.assertEqual('R0/month -> PAYE = R0',
            PayrollEngine.calculateMonthlyPAYE(0), 0);

        // Case 2: R7,979.17/month (at tax threshold)
        // annual = 95750.04, tax = 17235.0072, after rebate = 0.0072, monthly = 0.00
        TestRunner.assertEqual('R7,979.17/month -> PAYE = R0 (at threshold)',
            PayrollEngine.calculateMonthlyPAYE(7979.17), 0);

        // Case 3: R7,980/month (just above threshold)
        // annual = 95760, tax = 17236.80, after rebate = 1.80, monthly = 0.15
        TestRunner.assertEqual('R7,980/month -> PAYE = R0.15 (just above threshold)',
            PayrollEngine.calculateMonthlyPAYE(7980), 0.15);

        // Case 4: R10,000/month (bracket 1)
        // annual = 120000, tax = 21600, after rebate = 4365, monthly = 363.75
        TestRunner.assertEqual('R10,000/month -> PAYE = R363.75 (bracket 1)',
            PayrollEngine.calculateMonthlyPAYE(10000), 363.75);

        // Case 5: R17,712/month (UIF cap boundary salary)
        // annual = 212544, tax = 38257.92, after rebate = 21022.92, monthly = 1751.91
        TestRunner.assertEqual('R17,712/month -> PAYE = R1,751.91 (UIF cap boundary)',
            PayrollEngine.calculateMonthlyPAYE(17712), 1751.91);

        // Case 6: R20,000/month (bracket 2)
        // annual = 240000, tax = 42678+(240000-237100)*0.26 = 43432, after rebate = 26197, monthly = 2183.08
        TestRunner.assertEqual('R20,000/month -> PAYE = R2,183.08 (bracket 2)',
            PayrollEngine.calculateMonthlyPAYE(20000), 2183.08);

        // Case 7: R25,000/month (bracket 2 mid)
        // annual = 300000, tax = 42678+(300000-237100)*0.26 = 59032, after rebate = 41797, monthly = 3483.08
        TestRunner.assertEqual('R25,000/month -> PAYE = R3,483.08 (bracket 2 mid)',
            PayrollEngine.calculateMonthlyPAYE(25000), 3483.08);

        // Case 8: R37,000/month (bracket 3)
        // annual = 444000, tax = 77362+(444000-370500)*0.31 = 100147, after rebate = 82912, monthly = 6909.33
        TestRunner.assertEqual('R37,000/month -> PAYE = R6,909.33 (bracket 3)',
            PayrollEngine.calculateMonthlyPAYE(37000), 6909.33);

        // Case 9: R50,000/month (bracket 4)
        // annual = 600000, tax = 121475+(600000-512800)*0.36 = 152867, after rebate = 135632, monthly = 11302.67
        TestRunner.assertEqual('R50,000/month -> PAYE = R11,302.67 (bracket 4)',
            PayrollEngine.calculateMonthlyPAYE(50000), 11302.67);

        // Case 10: R65,000/month (bracket 5)
        // annual = 780000, tax = 179147+(780000-673000)*0.39 = 220877, after rebate = 203642, monthly = 16970.17
        TestRunner.assertEqual('R65,000/month -> PAYE = R16,970.17 (bracket 5)',
            PayrollEngine.calculateMonthlyPAYE(65000), 16970.17);

        // Case 11: R100,000/month (bracket 6)
        // annual = 1200000, tax = 251258+(1200000-857900)*0.41 = 391520, after rebate = 374285, monthly = 31190.42
        TestRunner.assertEqual('R100,000/month -> PAYE = R31,190.42 (bracket 6)',
            PayrollEngine.calculateMonthlyPAYE(100000), 31190.42);

        // Case 12: R200,000/month (bracket 7)
        // annual = 2400000, tax = 644489+(2400000-1817000)*0.45 = 906839, after rebate = 889604, monthly = 74133.67
        TestRunner.assertEqual('R200,000/month -> PAYE = R74,133.67 (bracket 7)',
            PayrollEngine.calculateMonthlyPAYE(200000), 74133.67);

        // Case 13: R1,000,000/month (bracket 7 extreme)
        // annual = 12000000, tax = 644489+(12000000-1817000)*0.45 = 5226839, after rebate = 5209604, monthly = 434133.67
        TestRunner.assertEqual('R1,000,000/month -> PAYE = R434,133.67 (top bracket extreme)',
            PayrollEngine.calculateMonthlyPAYE(1000000), 434133.67);

        // Case 14: Negative gross
        TestRunner.assertEqual('Negative gross -> PAYE = R0',
            PayrollEngine.calculateMonthlyPAYE(-5000), 0);

        // Case 15: R1/month (very small)
        // annual = 12, tax = 12*0.18 = 2.16, after rebate = -17232.84 -> 0
        TestRunner.assertEqual('R1/month -> PAYE = R0 (rebate exceeds tax)',
            PayrollEngine.calculateMonthlyPAYE(1), 0);
    }

    // ============================================================
    // CATEGORY 2: UNIT TESTS - UIF CALCULATIONS
    // ============================================================
    function runUIFTests() {
        TestRunner.suite('2. UIF Calculations', 'unit');

        TestRunner.assertEqual('R0 gross -> UIF = R0',
            PayrollEngine.calculateUIF(0), 0);

        TestRunner.assertEqual('R10,000 gross -> UIF = R100.00',
            PayrollEngine.calculateUIF(10000), 100.00);

        TestRunner.assertEqual('R17,711 gross -> UIF = R177.11 (just under cap)',
            PayrollEngine.calculateUIF(17711), 177.11);

        TestRunner.assertEqual('R17,712 gross -> UIF = R177.12 (exact cap)',
            PayrollEngine.calculateUIF(17712), 177.12);

        TestRunner.assertEqual('R17,713 gross -> UIF = R177.12 (above cap, clamped)',
            PayrollEngine.calculateUIF(17713), 177.12);

        TestRunner.assertEqual('R100,000 gross -> UIF = R177.12 (well above cap)',
            PayrollEngine.calculateUIF(100000), 177.12);
    }

    // ============================================================
    // CATEGORY 3: UNIT TESTS - SDL CALCULATIONS
    // ============================================================
    function runSDLTests() {
        TestRunner.suite('3. SDL Calculations', 'unit');

        TestRunner.assertEqual('R0 gross -> SDL = R0',
            PayrollEngine.calculateSDL(0), 0);

        TestRunner.assertEqual('R10,000 gross -> SDL = R100.00',
            PayrollEngine.calculateSDL(10000), 100.00);

        TestRunner.assertEqual('R100,000 gross -> SDL = R1,000.00',
            PayrollEngine.calculateSDL(100000), 1000.00);
    }

    // ============================================================
    // CATEGORY 4: UNIT TESTS - TAX BRACKET DETECTION
    // ============================================================
    function runBracketTests() {
        TestRunner.suite('4. Tax Bracket Detection', 'unit');

        TestRunner.assertEqual('R100,000 annual -> bracket 1 (18%)',
            PayrollEngine.getTaxBracket(100000).index, 1);

        TestRunner.assertEqual('R250,000 annual -> bracket 2 (26%)',
            PayrollEngine.getTaxBracket(250000).index, 2);

        TestRunner.assertEqual('R400,000 annual -> bracket 3 (31%)',
            PayrollEngine.getTaxBracket(400000).index, 3);

        TestRunner.assertEqual('R550,000 annual -> bracket 4 (36%)',
            PayrollEngine.getTaxBracket(550000).index, 4);

        TestRunner.assertEqual('R750,000 annual -> bracket 5 (39%)',
            PayrollEngine.getTaxBracket(750000).index, 5);

        TestRunner.assertEqual('R1,000,000 annual -> bracket 6 (41%)',
            PayrollEngine.getTaxBracket(1000000).index, 6);

        TestRunner.assertEqual('R2,000,000 annual -> bracket 7 (45%)',
            PayrollEngine.getTaxBracket(2000000).index, 7);
    }

    // ============================================================
    // CATEGORY 5-9: INTEGRATION TESTS - EMPLOYEE PAYROLL
    // ============================================================
    function runEmployeeATests() {
        TestRunner.suite('5. Employee A - R10,000 basic, no extras', 'integration');
        var calc = PayrollEngine.calculateFromData(
            { basic_salary: 10000, regular_inputs: [] }, [], [], [], []);

        TestRunner.assertEqual('Gross = R10,000', calc.gross, 10000);
        TestRunner.assertEqual('PAYE = R363.75', calc.paye, 363.75);
        TestRunner.assertEqual('UIF = R100.00', calc.uif, 100.00);
        TestRunner.assertEqual('SDL = R100.00', calc.sdl, 100.00);
        TestRunner.assertEqual('Deductions = R0', calc.deductions, 0);
        TestRunner.assertEqual('Net = R9,536.25', calc.net, 9536.25);
    }

    function runEmployeeBTests() {
        TestRunner.suite('6. Employee B - R50,000 + medical aid + retirement', 'integration');
        var calc = PayrollEngine.calculateFromData(
            { basic_salary: 50000, regular_inputs: [
                { type: 'deduction', amount: 2000 },
                { type: 'deduction', amount: 5000 }
            ]}, [], [], [], []);

        TestRunner.assertEqual('Gross = R50,000 (deductions do not reduce gross)', calc.gross, 50000);
        TestRunner.assertEqual('PAYE = R11,302.67', calc.paye, 11302.67);
        TestRunner.assertEqual('UIF = R177.12', calc.uif, 177.12);
        TestRunner.assertEqual('SDL = R500.00', calc.sdl, 500.00);
        TestRunner.assertEqual('Deductions = R7,000', calc.deductions, 7000);
        TestRunner.assertEqual('Net = R31,520.21', calc.net, 31520.21);
    }

    function runEmployeeCTests() {
        TestRunner.suite('7. Employee C - R15,000 pro-rated (mid-month hire)', 'integration');
        // Short time: 86.665 hours missed out of 173.33 = half the salary deducted
        var calc = PayrollEngine.calculateFromData(
            { basic_salary: 15000, regular_inputs: [] }, [], [], [],
            [{ hours_missed: 86.665 }]);

        TestRunner.assertClose('Gross = R7,500 (pro-rated via short time)', calc.gross, 7500, 0.05);
        TestRunner.assertEqual('PAYE = R0 (below tax threshold)', calc.paye, 0);
        TestRunner.assertClose('UIF = R75.00', calc.uif, 75.00, 0.02);
        TestRunner.assertClose('Deductions = R0', calc.deductions, 0, 0.01);
        TestRunner.assertClose('Net = R7,425.00', calc.net, 7425.00, 0.10);
    }

    function runEmployeeDTests() {
        TestRunner.suite('8. Employee D - R30,000 + R2,000 loan repayment', 'integration');
        var calc = PayrollEngine.calculateFromData(
            { basic_salary: 30000, regular_inputs: [
                { type: 'deduction', amount: 2000 }
            ]}, [], [], [], []);

        TestRunner.assertEqual('Gross = R30,000', calc.gross, 30000);
        TestRunner.assertEqual('PAYE = R4,783.08', calc.paye, 4783.08);
        TestRunner.assertEqual('UIF = R177.12', calc.uif, 177.12);
        TestRunner.assertEqual('SDL = R300.00', calc.sdl, 300.00);
        TestRunner.assertEqual('Deductions = R2,000', calc.deductions, 2000);
        TestRunner.assertEqual('Net = R23,039.80', calc.net, 23039.80);
    }

    function runEmployeeETests() {
        TestRunner.suite('9. Employee E - R100,000 (tax directive scenario)', 'integration');
        var calc = PayrollEngine.calculateFromData(
            { basic_salary: 100000, regular_inputs: [] }, [], [], [], []);

        TestRunner.assertEqual('Gross = R100,000', calc.gross, 100000);
        TestRunner.assertEqual('PAYE = R31,190.42', calc.paye, 31190.42);
        TestRunner.assertEqual('UIF = R177.12', calc.uif, 177.12);
        TestRunner.assertEqual('SDL = R1,000.00', calc.sdl, 1000.00);
        TestRunner.assertEqual('Deductions = R0', calc.deductions, 0);
        TestRunner.assertEqual('Net = R68,632.46', calc.net, 68632.46);
    }

    // ============================================================
    // CATEGORY 10: INTEGRATION TESTS - LOCALSTORAGE WRAPPER
    // ============================================================
    function runLocalStorageTests() {
        TestRunner.suite('10. localStorage Integration', 'integration');

        // Test that calculateEmployeePeriod reads from localStorage correctly
        var calcA = PayrollEngine.calculateEmployeePeriod(TEST_COMPANY, 'emp-A', TEST_PERIOD);
        TestRunner.assertEqual('localStorage: Employee A gross = R10,000', calcA.gross, 10000);
        TestRunner.assertEqual('localStorage: Employee A PAYE = R363.75', calcA.paye, 363.75);

        var calcB = PayrollEngine.calculateEmployeePeriod(TEST_COMPANY, 'emp-B', TEST_PERIOD);
        TestRunner.assertEqual('localStorage: Employee B deductions = R7,000', calcB.deductions, 7000);

        var calcC = PayrollEngine.calculateEmployeePeriod(TEST_COMPANY, 'emp-C', TEST_PERIOD);
        TestRunner.assertClose('localStorage: Employee C gross = R7,500 (short time applied)', calcC.gross, 7500, 0.05);

        // Verify pre-loaded payrollData parameter takes precedence
        var override = PayrollEngine.calculateEmployeePeriod(TEST_COMPANY, 'emp-A', TEST_PERIOD,
            { basic_salary: 20000, regular_inputs: [] });
        TestRunner.assertEqual('Pre-loaded payrollData overrides localStorage', override.gross, 20000);
    }

    // ============================================================
    // CATEGORY 11: INTEGRATION TESTS - PAYRUN TOTALS
    // ============================================================
    function runPayrunTotalTests() {
        TestRunner.suite('11. Payrun Totals (5 employees)', 'integration');

        var employees = [
            { payrollData: { basic_salary: 10000, regular_inputs: [] }, ci: [], ot: [], mr: [], st: [] },
            { payrollData: { basic_salary: 50000, regular_inputs: [{ type: 'deduction', amount: 2000 }, { type: 'deduction', amount: 5000 }] }, ci: [], ot: [], mr: [], st: [] },
            { payrollData: { basic_salary: 15000, regular_inputs: [] }, ci: [], ot: [], mr: [], st: [{ hours_missed: 86.665 }] },
            { payrollData: { basic_salary: 30000, regular_inputs: [{ type: 'deduction', amount: 2000 }] }, ci: [], ot: [], mr: [], st: [] },
            { payrollData: { basic_salary: 100000, regular_inputs: [] }, ci: [], ot: [], mr: [], st: [] }
        ];

        var totals = { gross: 0, paye: 0, uif: 0, sdl: 0, deductions: 0, net: 0 };
        employees.forEach(function(emp) {
            var calc = PayrollEngine.calculateFromData(emp.payrollData, emp.ci, emp.ot, emp.mr, emp.st);
            totals.gross += calc.gross;
            totals.paye += calc.paye;
            totals.uif += calc.uif;
            totals.sdl += calc.sdl;
            totals.deductions += calc.deductions;
            totals.net += calc.net;
        });

        TestRunner.assertClose('Total Gross = R197,500', totals.gross, 197500, 0.10);
        TestRunner.assertClose('Total PAYE = R47,639.92', totals.paye, 47639.92, 0.10);
        TestRunner.assertClose('Total UIF = R706.36', totals.uif, 706.36, 0.05);
        TestRunner.assertClose('Total Deductions = R9,000', totals.deductions, 9000, 0.05);
        TestRunner.assertClose('Total Net = R140,153.72', totals.net, 140153.72, 0.15);

        // EMP201 total: PAYE + SDL + UIF(emp) + UIF(employer)
        var emp201 = totals.paye + totals.sdl + totals.uif + totals.uif; // employer matches employee UIF
        TestRunner.assertClose('EMP201 Total Payable = R51,027.64', emp201, 51027.64, 0.20);
    }

    // ============================================================
    // CATEGORY 12: EDGE CASE TESTS
    // ============================================================
    function runEdgeCaseTests() {
        TestRunner.suite('12. Edge Cases', 'unit');

        // Very small salary
        var calc1 = PayrollEngine.calculateFromData({ basic_salary: 1, regular_inputs: [] }, [], [], [], []);
        TestRunner.assertEqual('R1/month: PAYE = R0', calc1.paye, 0);
        TestRunner.assertEqual('R1/month: UIF = R0.01', calc1.uif, 0.01);

        // Gross exactly R0 after short time
        var calc2 = PayrollEngine.calculateFromData(
            { basic_salary: 10000, regular_inputs: [] }, [], [], [],
            [{ hours_missed: 173.33 }]);
        TestRunner.assertClose('Full short time: gross = R0', calc2.gross, 0, 0.05);
        TestRunner.assertEqual('Full short time: PAYE = R0', calc2.paye, 0);
        TestRunner.assertClose('Full short time: net = R0', calc2.net, 0, 0.05);

        // Multiple overtime entries
        var calc3 = PayrollEngine.calculateFromData(
            { basic_salary: 10000, regular_inputs: [] }, [],
            [{ hours: 10, rate_multiplier: 1.5 }, { hours: 5, rate_multiplier: 2 }],
            [], []);
        var hourly = 10000 / 173.33;
        var expectedOT = 10 * hourly * 1.5 + 5 * hourly * 2;
        TestRunner.assertClose('Multiple overtime entries accumulate correctly',
            calc3.gross, 10000 + expectedOT, 0.10);

        // Multiple deduction types
        var calc4 = PayrollEngine.calculateFromData(
            { basic_salary: 20000, regular_inputs: [
                { type: 'deduction', amount: 500 },
                { type: 'deduction', amount: 1000 }
            ]},
            [{ type: 'deduction', amount: 300 }], [], [], []);
        TestRunner.assertEqual('Multiple deductions accumulate: R1,800', calc4.deductions, 1800);

        // Mixed allowances and deductions
        var calc5 = PayrollEngine.calculateFromData(
            { basic_salary: 10000, regular_inputs: [
                { type: 'allowance', amount: 2000, description: 'Housing' },
                { type: 'deduction', amount: 500, description: 'Medical' }
            ]}, [], [], [], []);
        TestRunner.assertEqual('Allowance increases gross to R12,000', calc5.gross, 12000);
        TestRunner.assertEqual('Deduction stays at R500', calc5.deductions, 500);

        // Missing/undefined payroll data defaults safely
        var calc6 = PayrollEngine.calculateFromData({}, [], [], [], []);
        TestRunner.assertEqual('Empty payroll data: gross = R0', calc6.gross, 0);
        TestRunner.assertEqual('Empty payroll data: net = R0', calc6.net, 0);

        // Null/undefined arrays
        var calc7 = PayrollEngine.calculateFromData(
            { basic_salary: 10000, regular_inputs: [] }, null, null, null, null);
        TestRunner.assertEqual('Null arrays: gross = R10,000', calc7.gross, 10000);
        TestRunner.assertEqual('Null arrays: net = R9,536.25', calc7.net, 9536.25);
    }

    // ============================================================
    // CATEGORY 13: REPORT CALCULATION TESTS
    // ============================================================
    function runReportTests() {
        TestRunner.suite('13. Report Data Calculations', 'integration');

        // Test 13.1: Transaction history totals for single period
        var empIds = ['emp-A', 'emp-B', 'emp-C', 'emp-D', 'emp-E'];
        var totalGross = 0, totalNet = 0;
        empIds.forEach(function(empId) {
            var calc = PayrollEngine.calculateEmployeePeriod(TEST_COMPANY, empId, TEST_PERIOD);
            totalGross += calc.gross;
            totalNet += calc.net;
        });
        TestRunner.assertClose('Transaction History: total gross = R197,500', totalGross, 197500, 0.10);
        TestRunner.assertClose('Transaction History: total net = R140,153.72', totalNet, 140153.72, 0.20);

        // Test 13.2: Employee Master List count
        var empList = JSON.parse(localStorage.getItem('employees_' + TEST_COMPANY) || '[]');
        TestRunner.assertEqual('Employee Master List: 5 employees', empList.length, 5);

        // Test 13.3: Bank details masking
        var acctNum = '1234567890';
        var masked = '****' + acctNum.slice(-4);
        TestRunner.assertEqual('Bank details masking: ****7890', masked, '****7890');

        // Test 13.4: Department breakdown
        var depts = {};
        empList.forEach(function(e) {
            depts[e.department] = (depts[e.department] || 0) + 1;
        });
        TestRunner.assertEqual('Department count Finance = 2', depts['Finance'], 2);
        TestRunner.assertEqual('Department count IT = 2', depts['IT'], 2);
        TestRunner.assertEqual('Department count Management = 1', depts['Management'], 1);

        // Test 13.5: Tax report SDL totals
        var totalSDL = 0;
        empIds.forEach(function(empId) {
            var calc = PayrollEngine.calculateEmployeePeriod(TEST_COMPANY, empId, TEST_PERIOD);
            totalSDL += calc.sdl;
        });
        TestRunner.assertClose('Tax Report: Total SDL = R1,975', totalSDL, 1975, 0.10);

        // Test 13.6: Variance detection (>10% change)
        var periodA = 30000;
        var periodB = 35000;
        var variance = Math.abs(periodB - periodA) / periodA * 100;
        TestRunner.assertTrue('Variance detection: 16.7% flagged as >10%', variance > 10);
    }

    // ============================================================
    // CATEGORY 14: UAT CHECKLIST (Manual)
    // ============================================================
    function renderUATChecklist() {
        var container = document.getElementById('results');

        var uatItems = {
            'Authentication': [
                'Login with Super Admin credentials (antonjvr@lorenco)',
                'Login with Demo User credentials (demo@example.com)',
                'Login with invalid credentials shows error message',
                'Registration creates new account',
                'Logout clears session and redirects to login'
            ],
            'Company Management': [
                'Company selection shows correct companies for user',
                'Super Admin dashboard shows all companies',
                'Company switching works without logout',
                'Company details page loads correctly'
            ],
            'Employee Management': [
                'Employee list loads with correct count',
                'Add new employee with all required fields',
                'Edit existing employee details',
                'Delete employee with confirmation dialog',
                'Employee search and filter works'
            ],
            'Payroll Processing': [
                'Set basic salary on employee detail page',
                'Add regular allowance and verify gross increases',
                'Add regular deduction and verify net decreases',
                'Add current period input (bonus/commission)',
                'Add overtime entry and verify calculation',
                'Add short time entry and verify pro-rata',
                'Payslip calculation matches expected values',
                'Finalize payslip locks editing',
                'Unfinalize payslip re-enables editing'
            ],
            'Pay Runs': [
                'Create pay run for current period',
                'Pay run shows correct employee count',
                'Finalize pay run with all finalized payslips',
                'Mark pay run as paid',
                'EMP201 preview shows correct totals',
                'UIF return preview shows correct totals'
            ],
            'Reports & Exports': [
                'Generate all 9 report types',
                'Export report to CSV',
                'Export report to Excel (opens correctly)',
                'Export report to PDF (renders properly)',
                'Generate ABSA EFT file',
                'Generate FNB EFT file',
                'Generate Standard Bank EFT file',
                'Generate Nedbank EFT file',
                'Generate branded payslip PDF',
                'Generate bulk payslips PDF',
                'Sage Pastel journal export',
                'Xero journal export'
            ],
            'Narratives & Mobile': [
                'Payslip narrative generates correctly',
                'Mobile responsive layout works on phone',
                'Attendance page loads and records data'
            ]
        };

        var html = '<div class="suite-section expanded"><div class="suite-header" onclick="this.parentElement.classList.toggle(\'expanded\')">' +
            '<span class="suite-title">14. User Acceptance Testing Checklist (Manual)</span>' +
            '<span class="suite-stats"><span class="suite-badge badge-info">Manual</span>' +
            '<span class="expand-icon">&#9660;</span></span></div>' +
            '<div class="suite-body"><div class="uat-section">';

        var itemIndex = 0;
        Object.keys(uatItems).forEach(function(category) {
            html += '<div class="uat-category">' + category + '</div>';
            uatItems[category].forEach(function(item) {
                html += '<div class="uat-item"><input type="checkbox" id="uat-' + itemIndex + '">' +
                    '<label for="uat-' + itemIndex + '">' + item + '</label></div>';
                itemIndex++;
            });
        });

        html += '</div></div></div>';
        container.innerHTML += html;
    }

    // ============================================================
    // CATEGORY 15: PERFORMANCE TESTS
    // ============================================================
    function runPerformanceTests() {
        TestRunner.suite('15. Performance Tests', 'performance');

        // Test 15.1: Write 100 employee payroll records
        var startWrite = performance.now();
        for (var i = 0; i < 100; i++) {
            localStorage.setItem('emp_payroll_' + TEST_COMPANY + '_perf-' + i, JSON.stringify({
                basic_salary: 10000 + (i * 500),
                regular_inputs: [{ type: 'deduction', amount: 500, description: 'Test' }]
            }));
        }
        var writeTime = performance.now() - startWrite;
        TestRunner.assertPerformance('Write 100 employee payroll records', writeTime, 500);

        // Test 15.2: Read 100 employee payroll records
        var startRead = performance.now();
        for (var j = 0; j < 100; j++) {
            JSON.parse(localStorage.getItem('emp_payroll_' + TEST_COMPANY + '_perf-' + j));
        }
        var readTime = performance.now() - startRead;
        TestRunner.assertPerformance('Read 100 employee payroll records', readTime, 200);

        // Test 15.3: Calculate payroll for 100 employees
        var startCalc = performance.now();
        for (var k = 0; k < 100; k++) {
            PayrollEngine.calculateFromData(
                { basic_salary: 10000 + (k * 500), regular_inputs: [{ type: 'deduction', amount: 500 }] },
                [], [], [], []);
        }
        var calcTime = performance.now() - startCalc;
        TestRunner.assertPerformance('Calculate payroll for 100 employees', calcTime, 1000);

        // Test 15.4: localStorage size check
        var totalSize = 0;
        for (var m = 0; m < localStorage.length; m++) {
            var key = localStorage.key(m);
            totalSize += key.length + (localStorage.getItem(key) || '').length;
        }
        var sizeMB = totalSize / (1024 * 1024);
        TestRunner.assertTrue('localStorage usage under 5MB (current: ' + sizeMB.toFixed(2) + 'MB)', sizeMB < 5);

        // Cleanup performance test data
        for (var n = 0; n < 100; n++) {
            localStorage.removeItem('emp_payroll_' + TEST_COMPANY + '_perf-' + n);
        }
    }

    // ============================================================
    // CATEGORY 16: SECURITY TESTS
    // ============================================================
    function runSecurityTests() {
        TestRunner.suite('16. Security Tests', 'security');

        // Test 16.1: Company A cannot read Company B's employees
        localStorage.setItem('employees_TEST_SEC_A', JSON.stringify([{ id: 'e1', name: 'Emp A' }]));
        localStorage.setItem('employees_TEST_SEC_B', JSON.stringify([{ id: 'e2', name: 'Emp B' }]));
        var compAData = JSON.parse(localStorage.getItem('employees_TEST_SEC_A'));
        var compBData = JSON.parse(localStorage.getItem('employees_TEST_SEC_B'));
        TestRunner.assertTrue('Company isolation: A and B data stored separately',
            compAData[0].name !== compBData[0].name);
        TestRunner.assertEqual('Company A sees own employee', compAData[0].name, 'Emp A');
        localStorage.removeItem('employees_TEST_SEC_A');
        localStorage.removeItem('employees_TEST_SEC_B');

        // Test 16.2: Company A cannot read Company B's payroll
        localStorage.setItem('emp_payroll_TEST_SEC_A_e1', JSON.stringify({ basic_salary: 10000 }));
        var crossRead = localStorage.getItem('emp_payroll_TEST_SEC_B_e1');
        TestRunner.assertTrue('Company isolation: cross-company payroll returns null', crossRead === null);
        localStorage.removeItem('emp_payroll_TEST_SEC_A_e1');

        // Test 16.3: XSS in employee name (simulated)
        var xssName = '<script>alert("xss")</script>';
        var div = document.createElement('div');
        div.textContent = xssName; // textContent is safe
        TestRunner.assertTrue('XSS: textContent does not execute script',
            div.innerHTML.indexOf('<script>') === -1 || div.innerHTML.indexOf('&lt;') !== -1);

        // Test 16.4: XSS in description field (simulated)
        var xssDesc = '<img src=x onerror=alert(1)>';
        var div2 = document.createElement('div');
        div2.textContent = xssDesc;
        TestRunner.assertTrue('XSS: img onerror neutralized via textContent',
            div2.innerHTML.indexOf('onerror') === -1 || div2.innerHTML.indexOf('&lt;') !== -1);

        // Test 16.5: Audit log records entries
        var auditKey = 'audit_log_' + TEST_COMPANY;
        var logs = JSON.parse(localStorage.getItem(auditKey) || '[]');
        logs.push({ timestamp: new Date().toISOString(), action: 'TEST', resource: 'security_test', description: 'Test audit entry' });
        localStorage.setItem(auditKey, JSON.stringify(logs));
        var verifyLogs = JSON.parse(localStorage.getItem(auditKey));
        TestRunner.assertTrue('Audit log records entries', verifyLogs.length > 0);
        TestRunner.assertEqual('Audit log action stored correctly', verifyLogs[verifyLogs.length - 1].action, 'TEST');

        // Test 16.6: Session data structure includes company_id
        var mockSession = { user_id: 'u1', email: 'test@test.com', name: 'Test', role: 'business_owner', company_id: 'comp-1', login_time: new Date().toISOString() };
        TestRunner.assertTrue('Session includes company_id for isolation', mockSession.hasOwnProperty('company_id'));
        TestRunner.assertTrue('Session includes role for RBAC', mockSession.hasOwnProperty('role'));
    }

    // ============================================================
    // CATEGORY 17: MEDICAL TAX CREDITS
    // ============================================================
    function runMedicalCreditTests() {
        TestRunner.suite('17. Medical Tax Credits', 'unit');

        // Test 17.1: Zero members = no credit
        TestRunner.assertEqual('0 members = R0 credit', PayrollEngine.calculateMedicalCredit(0), 0);

        // Test 17.2: 1 member (employee only)
        TestRunner.assertEqual('1 member = R364', PayrollEngine.calculateMedicalCredit(1), 364);

        // Test 17.3: 2 members (employee + 1 dependent)
        TestRunner.assertEqual('2 members = R728', PayrollEngine.calculateMedicalCredit(2), 728);

        // Test 17.4: 3 members (employee + 2 dependents)
        TestRunner.assertEqual('3 members = R974', PayrollEngine.calculateMedicalCredit(3), 974);

        // Test 17.5: 5 members (employee + 4 dependents)
        TestRunner.assertEqual('5 members = R1466', PayrollEngine.calculateMedicalCredit(5), 1466);

        // Test 17.6: Null/negative members = no credit
        TestRunner.assertEqual('null members = R0', PayrollEngine.calculateMedicalCredit(null), 0);
        TestRunner.assertEqual('negative members = R0', PayrollEngine.calculateMedicalCredit(-1), 0);

        // Test 17.7: Medical credit reduces PAYE
        var payeNoCredit = PayrollEngine.calculateMonthlyPAYE(20000, {});
        var payeWithCredit = PayrollEngine.calculateMonthlyPAYE(20000, { medicalMembers: 2 });
        TestRunner.assertTrue('Medical credit reduces PAYE', payeWithCredit < payeNoCredit);
        TestRunner.assertClose('PAYE reduction equals credit amount', payeNoCredit - payeWithCredit, 728, 1);

        // Test 17.8: Medical credit cannot make PAYE negative
        var payeLowIncome = PayrollEngine.calculateMonthlyPAYE(3000, { medicalMembers: 5 });
        TestRunner.assertTrue('PAYE with large credit not negative', payeLowIncome >= 0);

        // Test 17.9: calculateFromData includes medicalCredit in return
        var calc = PayrollEngine.calculateFromData(
            { basic_salary: 20000, regular_inputs: [] }, [], [], [], [],
            { medicalMembers: 3 }
        );
        TestRunner.assertEqual('calculateFromData returns medicalCredit', calc.medicalCredit, 974);
    }

    // ============================================================
    // CATEGORY 18: AGE-BASED REBATES
    // ============================================================
    function runAgeRebateTests() {
        TestRunner.suite('18. Age-Based Rebates', 'unit');

        // Test 18.1: getAgeFromId with valid ID (born 1950-01-01, ref 2025-02-28)
        var age75 = PayrollEngine.getAgeFromId('5001015800085', new Date(2025, 1, 28));
        TestRunner.assertEqual('Age from ID 5001015800085 at Feb 2025 = 75', age75, 75);

        // Test 18.2: getAgeFromId with young person (born 2000-06-15)
        var age24 = PayrollEngine.getAgeFromId('0006158000084', new Date(2025, 1, 28));
        TestRunner.assertEqual('Age from ID 0006158000084 at Feb 2025 = 24', age24, 24);

        // Test 18.3: getAgeFromId with 65-year-old (born 1960-03-20)
        var age64 = PayrollEngine.getAgeFromId('6003208000085', new Date(2025, 1, 28));
        TestRunner.assertEqual('Age from ID 6003208000085 at Feb 2025 = 64', age64, 64);
        var age65 = PayrollEngine.getAgeFromId('6003208000085', new Date(2025, 3, 20));
        TestRunner.assertEqual('Same ID at Mar 2025 = 65', age65, 65);

        // Test 18.4: Null/invalid ID returns null
        TestRunner.assertEqual('Null ID returns null', PayrollEngine.getAgeFromId(null), null);
        TestRunner.assertEqual('Empty ID returns null', PayrollEngine.getAgeFromId(''), null);
        TestRunner.assertEqual('Short ID returns null', PayrollEngine.getAgeFromId('123'), null);

        // Test 18.5: Annual PAYE with no age (primary rebate only)
        var taxNoAge = PayrollEngine.calculateAnnualPAYE(300000);
        var expectedNoAge = 42678 + (300000 - 237100) * 0.26 - 17235;
        TestRunner.assertClose('Annual PAYE no age = primary rebate only', taxNoAge, expectedNoAge, 1);

        // Test 18.6: Annual PAYE with age 65 (secondary rebate)
        var taxAge65 = PayrollEngine.calculateAnnualPAYE(300000, 65);
        var expectedAge65 = expectedNoAge - 9444;
        TestRunner.assertClose('Annual PAYE age 65 = primary + secondary rebate', taxAge65, expectedAge65, 1);

        // Test 18.7: Annual PAYE with age 75 (tertiary rebate)
        var taxAge75 = PayrollEngine.calculateAnnualPAYE(300000, 75);
        var expectedAge75 = expectedAge65 - 3145;
        TestRunner.assertClose('Annual PAYE age 75 = all three rebates', taxAge75, expectedAge75, 1);

        // Test 18.8: Rebates cannot make PAYE negative
        var taxLowAge75 = PayrollEngine.calculateAnnualPAYE(100000, 75);
        TestRunner.assertTrue('Low income age 75 PAYE >= 0', taxLowAge75 >= 0);

        // Test 18.9: Monthly PAYE passes age correctly
        var monthlyNoAge = PayrollEngine.calculateMonthlyPAYE(25000, {});
        var monthlyAge65 = PayrollEngine.calculateMonthlyPAYE(25000, { age: 65 });
        TestRunner.assertTrue('Monthly PAYE age 65 less than no age', monthlyAge65 < monthlyNoAge);
    }

    // ============================================================
    // CATEGORY 19: TAX DIRECTIVE OVERRIDE
    // ============================================================
    function runTaxDirectiveTests() {
        TestRunner.suite('19. Tax Directive Override', 'unit');

        // Test 19.1: 25% directive on R20,000
        var paye25 = PayrollEngine.calculateMonthlyPAYE(20000, { taxDirective: 25 });
        TestRunner.assertClose('25% directive on R20k = R5000', paye25, 5000, 1);

        // Test 19.2: 35% directive on R30,000
        var paye35 = PayrollEngine.calculateMonthlyPAYE(30000, { taxDirective: 35 });
        TestRunner.assertClose('35% directive on R30k = R10500', paye35, 10500, 1);

        // Test 19.3: 0% directive = standard PAYE (not directive mode)
        var paye0 = PayrollEngine.calculateMonthlyPAYE(20000, { taxDirective: 0 });
        var payeStandard = PayrollEngine.calculateMonthlyPAYE(20000, {});
        TestRunner.assertClose('0% directive = standard PAYE', paye0, payeStandard, 1);

        // Test 19.4: Directive overrides age/medical options
        var payeDirectiveWithAge = PayrollEngine.calculateMonthlyPAYE(20000, { taxDirective: 25, age: 65, medicalMembers: 3 });
        TestRunner.assertClose('Directive ignores age/medical', payeDirectiveWithAge, 5000, 1);

        // Test 19.5: calculateFromData with tax directive
        var calc = PayrollEngine.calculateFromData(
            { basic_salary: 20000, regular_inputs: [] }, [], [], [], [],
            { taxDirective: 30 }
        );
        TestRunner.assertClose('calculateFromData with 30% directive', calc.paye, 6000, 1);

        // Test 19.6: 100% directive
        var paye100 = PayrollEngine.calculateMonthlyPAYE(15000, { taxDirective: 100 });
        TestRunner.assertClose('100% directive = full salary', paye100, 15000, 1);
    }

    // ============================================================
    // CATEGORY 20: NEGATIVE NET PAY
    // ============================================================
    function runNegativeNetPayTests() {
        TestRunner.suite('20. Negative Net Pay', 'unit');

        // Test 20.1: Normal case - net is positive
        var calcPositive = PayrollEngine.calculateFromData(
            { basic_salary: 20000, regular_inputs: [] }, [], [], [], [], {}
        );
        TestRunner.assertFalse('Normal salary has positive net', calcPositive.negativeNetPay);
        TestRunner.assertTrue('Net is positive', calcPositive.net > 0);

        // Test 20.2: Deductions exceed gross - net is negative
        var calcNeg = PayrollEngine.calculateFromData(
            { basic_salary: 5000, regular_inputs: [
                { type: 'deduction', amount: 8000, description: 'Large deduction' }
            ] }, [], [], [], [], {}
        );
        TestRunner.assertTrue('Large deduction flags negativeNetPay', calcNeg.negativeNetPay);
        TestRunner.assertTrue('Net is actually negative', calcNeg.net < 0);

        // Test 20.3: Multiple deductions exceeding gross
        var calcMulti = PayrollEngine.calculateFromData(
            { basic_salary: 10000, regular_inputs: [
                { type: 'deduction', amount: 5000, description: 'Ded 1' },
                { type: 'deduction', amount: 5000, description: 'Ded 2' },
                { type: 'deduction', amount: 5000, description: 'Ded 3' }
            ] }, [], [], [], [], {}
        );
        TestRunner.assertTrue('Multiple deductions flag negative', calcMulti.negativeNetPay);

        // Test 20.4: Exactly zero net
        var calcZero = PayrollEngine.calculateFromData(
            { basic_salary: 0, regular_inputs: [] }, [], [], [], [], {}
        );
        TestRunner.assertFalse('Zero salary is not negative', calcZero.negativeNetPay);

        // Test 20.5: Current inputs as deductions causing negative
        var calcCurrentNeg = PayrollEngine.calculateFromData(
            { basic_salary: 5000, regular_inputs: [] },
            [{ type: 'deduction', amount: 10000, description: 'Advance repayment' }],
            [], [], [], {}
        );
        TestRunner.assertTrue('Current deduction can cause negative net', calcCurrentNeg.negativeNetPay);

        // Test 20.6: taxableGross is returned separately
        var calcTaxable = PayrollEngine.calculateFromData(
            { basic_salary: 15000, regular_inputs: [
                { type: 'allowance', amount: 2000, description: 'Travel', is_taxable: false }
            ] }, [], [], [], [], {}
        );
        TestRunner.assertEqual('Gross includes non-taxable', calcTaxable.gross, 17000);
        TestRunner.assertEqual('taxableGross excludes non-taxable', calcTaxable.taxableGross, 15000);
    }

    // ============================================================
    // CATEGORY 21: PAYROLL ITEMS TAXABILITY
    // ============================================================
    function runTaxabilityTests() {
        TestRunner.suite('21. Payroll Items Taxability', 'unit');

        // Test 21.1: Non-taxable allowance increases gross but not PAYE
        var calcNonTax = PayrollEngine.calculateFromData(
            { basic_salary: 20000, regular_inputs: [
                { type: 'allowance', amount: 3000, description: 'Travel', is_taxable: false }
            ] }, [], [], [], [], {}
        );
        TestRunner.assertEqual('Non-taxable: gross = R23,000', calcNonTax.gross, 23000);
        TestRunner.assertEqual('Non-taxable: taxableGross = R20,000', calcNonTax.taxableGross, 20000);
        var payeOnlyBasic = PayrollEngine.calculateMonthlyPAYE(20000, {});
        TestRunner.assertEqual('Non-taxable: PAYE same as R20k basic', calcNonTax.paye, payeOnlyBasic);

        // Test 21.2: Taxable allowance increases both gross and PAYE
        var calcTax = PayrollEngine.calculateFromData(
            { basic_salary: 20000, regular_inputs: [
                { type: 'allowance', amount: 3000, description: 'Housing', is_taxable: true }
            ] }, [], [], [], [], {}
        );
        TestRunner.assertEqual('Taxable: gross = R23,000', calcTax.gross, 23000);
        TestRunner.assertEqual('Taxable: taxableGross = R23,000', calcTax.taxableGross, 23000);
        var payeWith = PayrollEngine.calculateMonthlyPAYE(23000, {});
        TestRunner.assertEqual('Taxable: PAYE matches R23k', calcTax.paye, payeWith);

        // Test 21.3: Default (no is_taxable flag) treats as taxable
        var calcDefault = PayrollEngine.calculateFromData(
            { basic_salary: 20000, regular_inputs: [
                { type: 'allowance', amount: 3000, description: 'Bonus' }
            ] }, [], [], [], [], {}
        );
        TestRunner.assertEqual('Default: taxableGross = R23,000 (treated as taxable)', calcDefault.taxableGross, 23000);

        // Test 21.4: Multiple mixed taxable/non-taxable
        var calcMixed = PayrollEngine.calculateFromData(
            { basic_salary: 15000, regular_inputs: [
                { type: 'allowance', amount: 2000, description: 'Housing', is_taxable: true },
                { type: 'allowance', amount: 1000, description: 'Travel', is_taxable: false },
                { type: 'allowance', amount: 500, description: 'Phone', is_taxable: false }
            ] }, [], [], [], [], {}
        );
        TestRunner.assertEqual('Mixed: gross = R18,500', calcMixed.gross, 18500);
        TestRunner.assertEqual('Mixed: taxableGross = R17,000', calcMixed.taxableGross, 17000);

        // Test 21.5: Non-taxable current input
        var calcCINonTax = PayrollEngine.calculateFromData(
            { basic_salary: 20000, regular_inputs: [] },
            [{ type: 'allowance', amount: 5000, description: 'Reimbursement', is_taxable: false }],
            [], [], [], {}
        );
        TestRunner.assertEqual('CI non-taxable: gross = R25,000', calcCINonTax.gross, 25000);
        TestRunner.assertEqual('CI non-taxable: taxableGross = R20,000', calcCINonTax.taxableGross, 20000);

        // Test 21.6: Deductions are NOT affected by taxability tracking
        var calcDed = PayrollEngine.calculateFromData(
            { basic_salary: 20000, regular_inputs: [
                { type: 'deduction', amount: 1000, description: 'Pension', is_taxable: false }
            ] }, [], [], [], [], {}
        );
        TestRunner.assertEqual('Deduction: gross stays R20,000', calcDed.gross, 20000);
        TestRunner.assertEqual('Deduction: deductions = R1,000', calcDed.deductions, 1000);

        // Test 21.7: PAYE difference between taxable and non-taxable
        TestRunner.assertTrue('PAYE higher when allowance is taxable', calcTax.paye > calcNonTax.paye);
    }

    // ============================================================
    // RENDER RESULTS
    // ============================================================
    function renderResults(filterCategory) {
        var container = document.getElementById('results');
        container.innerHTML = '';

        // Group results by suite
        var suites = {};
        TestRunner.results.forEach(function(r) {
            if (filterCategory && r.category !== filterCategory) return;
            if (!suites[r.suite]) suites[r.suite] = [];
            suites[r.suite].push(r);
        });

        Object.keys(suites).forEach(function(suiteName) {
            var tests = suites[suiteName];
            var passed = tests.filter(function(t) { return t.pass; }).length;
            var failed = tests.length - passed;
            var allPass = failed === 0;

            var html = '<div class="suite-section' + (failed > 0 ? ' expanded' : '') + '">' +
                '<div class="suite-header" onclick="this.parentElement.classList.toggle(\'expanded\')">' +
                '<span class="suite-title">' + suiteName + '</span>' +
                '<span class="suite-stats">' +
                '<span class="suite-badge ' + (allPass ? 'badge-pass' : 'badge-fail') + '">' +
                passed + '/' + tests.length + ' passed</span>' +
                '<span class="expand-icon">&#9660;</span>' +
                '</span></div><div class="suite-body">';

            tests.forEach(function(t) {
                html += '<div class="test-row">' +
                    '<span class="test-desc">' + t.desc + '</span>' +
                    '<span class="test-result ' + (t.pass ? 'test-pass' : 'test-fail') + '">' +
                    (t.pass ? 'PASS' : 'FAIL') + '</span></div>';
                if (!t.pass) {
                    html += '<div class="fail-detail">Expected: ' + JSON.stringify(t.expected) +
                        ' | Actual: ' + JSON.stringify(t.actual) + '</div>';
                }
            });

            html += '</div></div>';
            container.innerHTML += html;
        });

        // Update summary bar
        var filteredTotal = 0, filteredPassed = 0, filteredFailed = 0;
        TestRunner.results.forEach(function(r) {
            if (filterCategory && r.category !== filterCategory) return;
            filteredTotal++;
            if (r.pass) filteredPassed++; else filteredFailed++;
        });

        document.getElementById('summaryBar').innerHTML =
            '<div class="summary-card"><div class="number">' + filteredTotal + '</div><div class="label">Total Tests</div></div>' +
            '<div class="summary-card" style="' + (filteredPassed > 0 ? 'background:rgba(40,167,69,0.3)' : '') + '"><div class="number">' + filteredPassed + '</div><div class="label">Passed</div></div>' +
            '<div class="summary-card" style="' + (filteredFailed > 0 ? 'background:rgba(220,53,69,0.3)' : '') + '"><div class="number">' + filteredFailed + '</div><div class="label">Failed</div></div>' +
            '<div class="summary-card"><div class="number">' + (filteredTotal > 0 ? Math.round(filteredPassed / filteredTotal * 100) : 0) + '%</div><div class="label">Pass Rate</div></div>';

        document.getElementById('timestamp').textContent = 'Last run: ' + new Date().toLocaleString();
    }

    // ============================================================
    // RUN FUNCTIONS
    // ============================================================
    function runAllTests() {
        TestRunner.reset();
        setupTestData();

        // Unit tests
        runPAYETests();
        runUIFTests();
        runSDLTests();
        runBracketTests();

        // Integration tests
        runEmployeeATests();
        runEmployeeBTests();
        runEmployeeCTests();
        runEmployeeDTests();
        runEmployeeETests();
        runLocalStorageTests();
        runPayrunTotalTests();

        // Edge cases
        runEdgeCaseTests();

        // Report calculations
        runReportTests();

        // Performance
        runPerformanceTests();

        // Security
        runSecurityTests();

        // Phase 1 enhancements
        runMedicalCreditTests();
        runAgeRebateTests();
        runTaxDirectiveTests();
        runNegativeNetPayTests();

        // Phase 2 enhancements
        runTaxabilityTests();

        cleanupTestData();

        renderResults();
        renderUATChecklist();
    }

    function runCategory(category) {
        TestRunner.reset();
        setupTestData();

        if (category === 'unit') {
            runPAYETests();
            runUIFTests();
            runSDLTests();
            runBracketTests();
            runEdgeCaseTests();
            runMedicalCreditTests();
            runAgeRebateTests();
            runTaxDirectiveTests();
            runNegativeNetPayTests();
            runTaxabilityTests();
        } else if (category === 'integration') {
            runEmployeeATests();
            runEmployeeBTests();
            runEmployeeCTests();
            runEmployeeDTests();
            runEmployeeETests();
            runLocalStorageTests();
            runPayrunTotalTests();
            runReportTests();
        } else if (category === 'performance') {
            runPerformanceTests();
        } else if (category === 'security') {
            runSecurityTests();
        }

        cleanupTestData();
        renderResults(category);
        if (category === 'integration') renderUATChecklist();
    }

    // Auto-run on page load
    window.addEventListener('load', runAllTests);
    </script>
</body>
</html>
