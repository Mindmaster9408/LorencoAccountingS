<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Admin Dashboard - Lorenco Paytime</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-info p {
            color: #666;
            margin: 5px 0;
        }

        .user-info strong {
            color: #333;
            display: block;
            font-size: 1.1rem;
        }

        .badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .btn-logout {
            padding: 10px 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: #ff5252;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #999;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stat-card.active {
            border-top: 4px solid #28a745;
        }

        .stat-card.suspended {
            border-top: 4px solid #dc3545;
        }

        .search-bar {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .search-bar input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .companies-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .companies-section h2 {
            color: #667eea;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #eee;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .company-name {
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-suspended {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-action {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-view {
            background: #667eea;
            color: white;
        }

        .btn-view:hover {
            background: #5568d3;
        }

        .btn-suspend {
            background: #ffc107;
            color: #333;
        }

        .btn-suspend:hover {
            background: #ffb300;
        }

        .btn-activate {
            background: #28a745;
            color: white;
        }

        .btn-activate:hover {
            background: #218838;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h3 {
            color: #667eea;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-body p {
            color: #666;
            line-height: 1.6;
            margin: 10px 0;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-modal-cancel {
            background: #eee;
            color: #333;
        }

        .btn-modal-cancel:hover {
            background: #ddd;
        }

        .btn-modal-confirm {
            background: #667eea;
            color: white;
        }

        .btn-modal-confirm:hover {
            background: #5568d3;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header-right {
                width: 100%;
                justify-content: center;
                flex-direction: column;
            }

            .user-info {
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }

            .btn-action {
                width: 100%;
                padding: 6px 10px;
            }
        }
    </style>
    <link rel="stylesheet" href="css/dark-theme.css">
    <link rel="stylesheet" href="css/mobile-responsive.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚙️ Super Admin Dashboard</h1>
            <div class="header-right">
                <div class="user-info">
                    <p>Logged in as</p>
                    <strong>Super Administrator</strong>
                    <span class="badge">SUPER ADMIN</span>
                </div>
                <button class="btn-logout" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Companies</div>
                <div class="stat-number" id="total-companies">0</div>
            </div>
            <div class="stat-card active">
                <div class="stat-label">Active Companies</div>
                <div class="stat-number" id="active-companies">0</div>
            </div>
            <div class="stat-card suspended">
                <div class="stat-label">Suspended Companies</div>
                <div class="stat-number" id="suspended-companies">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Employees</div>
                <div class="stat-number" id="total-employees">0</div>
            </div>
        </div>

        <div class="search-bar">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Search companies by name, email, or ID..." 
                onkeyup="filterCompanies()"
            >
        </div>

        <div class="companies-section">
            <h2>Company Management</h2>
            <table id="companies-table">
                <thead>
                    <tr>
                        <th>Company Name</th>
                        <th>Email</th>
                        <th>Owner</th>
                        <th>Employees</th>
                        <th>Status</th>
                        <th>Subscription</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="companies-tbody">
                    <!-- Companies will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Company Detail Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Company Details</h3>
                <button class="close-btn" onclick="closeModal('detail-modal')">×</button>
            </div>
            <div class="modal-body" id="detail-modal-body">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-cancel" onclick="closeModal('detail-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirm-title">Confirm Action</h3>
                <button class="close-btn" onclick="closeModal('confirm-modal')">×</button>
            </div>
            <div class="modal-body" id="confirm-body">
                <!-- Confirmation message will be here -->
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-cancel" onclick="closeModal('confirm-modal')">Cancel</button>
                <button class="btn-modal btn-modal-confirm" id="confirm-btn" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>

    <script src="js/data-access.js"></script>
    <script src="js/permissions.js"></script>
    <script src="js/audit.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let allCompanies = [];
        let currentAction = null;
        let currentCompanyId = null;

        // Check authentication
        window.addEventListener('load', function() {
            const session = AUTH.getSession();
            if (!session || session.role !== 'super_admin') {
                window.location.href = 'login.html';
                return;
            }

            loadDashboard();
        });

        function loadDashboard() {
            allCompanies = AUTH.getAllCompaniesWithRegistered();
            updateStats();
            renderCompanies(allCompanies);
        }

        function updateStats() {
            const total = allCompanies.length;
            const active = allCompanies.filter(c => c.active).length;
            const suspended = total - active;
            const totalEmployees = allCompanies.reduce((sum, c) => sum + c.employees, 0);

            document.getElementById('total-companies').textContent = total;
            document.getElementById('active-companies').textContent = active;
            document.getElementById('suspended-companies').textContent = suspended;
            document.getElementById('total-employees').textContent = totalEmployees;
        }

        function renderCompanies(companies) {
            const tbody = document.getElementById('companies-tbody');
            tbody.innerHTML = '';

            companies.forEach(company => {
                const owners = AUTH.getCompanyOwner(company.id);
                var ownerHtml = '';
                if (owners.length > 0) {
                    ownerHtml = owners.map(function(o) {
                        return '<div style="font-size:0.85rem;"><strong>' + o.name + '</strong><br><span style="color:#999;">' + o.email + '</span></div>';
                    }).join('');
                } else {
                    ownerHtml = '<span style="color:#999; font-size:0.85rem;">No owner</span>';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="company-name">${company.name}</td>
                    <td>${company.email}</td>
                    <td>${ownerHtml}</td>
                    <td>${company.employees}</td>
                    <td>
                        <span class="status-badge ${company.active ? 'status-active' : 'status-suspended'}">
                            ${company.active ? 'Active' : 'Suspended'}
                        </span>
                    </td>
                    <td>${company.subscription_status === 'active' ? '✓ Active' : '⚠ Suspended'}</td>
                    <td>${new Date(company.created_date).toLocaleDateString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="viewDetails('${company.id}')">View</button>
                            ${company.active ?
                                `<button class="btn-action btn-suspend" onclick="suspendCompany('${company.id}')">Suspend</button>` :
                                `<button class="btn-action btn-activate" onclick="activateCompany('${company.id}')">Activate</button>`
                            }
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterCompanies() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filtered = allCompanies.filter(company => 
                company.name.toLowerCase().includes(searchTerm) ||
                company.email.toLowerCase().includes(searchTerm) ||
                company.id.toLowerCase().includes(searchTerm)
            );
            renderCompanies(filtered);
        }

        function viewDetails(company_id) {
            const company = AUTH.getCompanyById(company_id);
            if (!company) return;

            const owners = AUTH.getCompanyOwner(company_id);
            var ownerInfo = 'No owner assigned';
            if (owners.length > 0) {
                ownerInfo = owners.map(function(o) {
                    return '<strong>' + o.name + '</strong> (' + o.email + ') - ' + o.role;
                }).join('<br>');
            }

            const detailsHtml = `
                <p><strong>Company Name:</strong> ${company.name}</p>
                <p><strong>Email:</strong> ${company.email}</p>
                <p><strong>Company ID:</strong> ${company.id}</p>
                <p><strong>Owner/Accountant:</strong><br>${ownerInfo}</p>
                <p><strong>Total Employees:</strong> ${company.employees}</p>
                <p><strong>Status:</strong> <span style="color: ${company.active ? '#28a745' : '#dc3545'}; font-weight: 600;">${company.active ? 'ACTIVE' : 'SUSPENDED'}</span></p>
                <p><strong>Subscription Status:</strong> ${company.subscription_status === 'active' ? '✓ Active' : '⚠ Suspended'}</p>
                <p><strong>Created Date:</strong> ${new Date(company.created_date).toLocaleDateString()}</p>
            `;

            document.getElementById('detail-modal-body').innerHTML = detailsHtml;
            openModal('detail-modal');
        }

        function suspendCompany(company_id) {
            currentCompanyId = company_id;
            currentAction = 'suspend';
            const company = AUTH.getCompanyById(company_id);

            document.getElementById('confirm-title').textContent = 'Suspend Company';
            document.getElementById('confirm-body').innerHTML = `
                <p>Are you sure you want to <strong>suspend</strong> the following company?</p>
                <p style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>${company.name}</strong><br>
                    <span style="color: #666; font-size: 0.9rem;">${company.email}</span>
                </p>
                <p style="margin-top: 15px; color: #dc3545;"><strong>⚠️ Warning:</strong> This will suspend all access for this company's users until reactivated.</p>
            `;
            openModal('confirm-modal');
        }

        function activateCompany(company_id) {
            currentCompanyId = company_id;
            currentAction = 'activate';
            const company = AUTH.getCompanyById(company_id);

            document.getElementById('confirm-title').textContent = 'Activate Company';
            document.getElementById('confirm-body').innerHTML = `
                <p>Are you sure you want to <strong>activate</strong> the following company?</p>
                <p style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>${company.name}</strong><br>
                    <span style="color: #666; font-size: 0.9rem;">${company.email}</span>
                </p>
                <p style="margin-top: 15px; color: #28a745;"><strong>✓ Notice:</strong> This will restore full access for this company's users.</p>
            `;
            openModal('confirm-modal');
        }

        function confirmAction() {
            if (currentAction === 'suspend' || currentAction === 'activate') {
                AUTH.toggleCompanyStatus(currentCompanyId);
                AuditTrail.logUpdate(currentCompanyId, 'company', (currentAction === 'suspend' ? 'Suspended' : 'Activated') + ' company via super admin dashboard');
                closeModal('confirm-modal');
                loadDashboard();
                
                // Show success message
                showNotification(
                    currentAction === 'suspend' ? 
                    'Company suspended successfully' : 
                    'Company activated successfully'
                );
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showNotification(message) {
            // Simple notification - you can enhance this with a toast notification library
            console.log('✓ ' + message);
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                AUTH.logout();
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const detailModal = document.getElementById('detail-modal');
            const confirmModal = document.getElementById('confirm-modal');

            if (event.target === detailModal) {
                closeModal('detail-modal');
            }
            if (event.target === confirmModal) {
                closeModal('confirm-modal');
            }
        });
    </script>
    <script src="js/mobile-utils.js"></script>
</body>
</html>
