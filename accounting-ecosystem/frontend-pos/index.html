<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <title>Checkout Charlie POS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            overflow: hidden;
        }

        /* Top Navigation Bar - Purple Gradient */
        .top-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-brand {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-right: 30px;
        }
        .nav-tabs {
            display: flex;
            gap: 5px;
            flex: 1;
        }
        .nav-tab {
            padding: 8px 20px;
            color: white;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: 500;
        }
        .nav-tab:hover {
            background: rgba(255,255,255,0.1);
        }
        .nav-tab.active {
            background: white;
            color: #667eea;
            border-color: white;
        }
        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            font-size: 13px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .session-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
        }
        .manage-till-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 6px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 400px;
        }
        .login-box h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Main Container */
        .main-container {
            display: none;
            height: calc(100vh - 50px);
        }

        /* Till Interface */
        .till-interface {
            display: none;
            height: 100%;
        }
        .till-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            height: 100%;
            gap: 0;
        }
        .products-panel {
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #e0e0e0;
        }
        .search-bar {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }
        .search-wrapper {
            position: relative;
        }
        .barcode-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
        }
        .barcode-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        .scan-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #667eea;
        }
        .categories {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
        }
        .category-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 600;
            transition: all 0.3s;
        }
        .category-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        .category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .products-grid {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            align-content: start;
        }
        .product-tile {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .product-tile:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.2);
        }
        .product-tile:active {
            transform: scale(0.98);
        }
        .product-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .product-price {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        .product-stock {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        .cart-panel {
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        .cart-header {
            background: white;
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .cart-header h2 {
            color: #333;
            margin-bottom: 10px;
        }
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .cart-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .cart-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        .item-name {
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        .item-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .cart-item-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .qty-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .qty-btn {
            width: 35px;
            height: 35px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        .qty-display {
            font-weight: bold;
            font-size: 18px;
            min-width: 30px;
            text-align: center;
        }
        .item-total {
            font-weight: bold;
            font-size: 18px;
            color: #667eea;
        }
        .cart-summary {
            background: white;
            padding: 20px;
            border-top: 2px solid #e0e0e0;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .summary-row.total {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
            margin-top: 10px;
        }
        .checkout-section {
            padding: 20px;
            background: white;
            border-top: 2px solid #e0e0e0;
        }
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }
        .payment-btn {
            padding: 8px 4px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 11px;
            text-align: center;
            line-height: 1.2;
        }
        .payment-btn .pay-icon {
            display: block;
            font-size: 18px;
            margin-bottom: 2px;
        }
        .payment-btn:hover {
            border-color: #667eea;
        }
        .payment-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .checkout-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }
        .checkout-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .clear-cart-btn {
            width: 100%;
            padding: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .empty-cart {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Settings Layout */
        .settings-layout {
            display: none;
            height: 100%;
        }
        .settings-grid {
            display: flex;
            height: 100%;
        }
        .settings-sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
        }
        .settings-menu-item {
            padding: 15px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        .settings-menu-item:hover {
            background: #f5f5f5;
        }
        .settings-menu-item.active {
            background: #667eea;
            color: white;
            border-left-color: #764ba2;
        }
        .settings-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #fafafa;
        }

        /* Products Page */
        .products-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        .header-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #764ba2;
        }
        .btn-secondary {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }
        .btn-secondary:hover {
            background: #f5f5f5;
        }

        /* Products Table */
        .products-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .products-table {
            width: 100%;
            border-collapse: collapse;
        }
        .products-table thead {
            background: #f8f9fa;
        }
        .products-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            font-size: 13px;
        }
        .products-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .products-table tbody tr:hover {
            background: #f9f9f9;
            cursor: pointer;
        }
        .product-count {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            padding: 0 15px;
        }

        /* Customers Table */
        .customers-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        .customers-table thead {
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
        }
        .customers-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        .customers-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .customers-table tbody tr:hover {
            background: #f9f9f9;
        }
        .customer-count {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            padding: 0 15px;
        }
        .customers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }
        .customers-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .btn-sm {
            padding: 6px 12px !important;
            font-size: 12px !important;
            margin-right: 5px;
        }
        .btn-danger {
            background: #dc3545 !important;
        }
        .btn-danger:hover {
            background: #c82333 !important;
        }

        /* Cash Up Styles */
        .cash-row {
            display: grid;
            grid-template-columns: 100px 1fr 100px;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .cash-row label {
            font-weight: 500;
            margin: 0;
        }
        .cash-row input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        .cash-row .total {
            text-align: right;
            font-weight: 600;
            color: #333;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-card h4 {
            margin: 0 0 8px 0;
            color: #666;
            font-size: 13px;
            font-weight: 500;
        }
        .summary-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }
        .variance-positive {
            color: #28a745 !important;
        }
        .variance-negative {
            color: #dc3545 !important;
        }

        /* Split Payment Styles */
        .split-payment-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        .split-payment-section.active {
            display: block;
        }
        .split-payment-row {
            display: grid;
            grid-template-columns: 100px 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .split-payment-row label {
            font-weight: 500;
            margin: 0;
        }
        .split-payment-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .split-remaining {
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }

        /* Stock Interface Styles */
        .stock-interface {
            display: none;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
        }
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        .stock-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .stock-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stock-table th, .stock-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .stock-table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        .stock-table tbody tr:hover {
            background: #f9f9f9;
        }
        .low-stock {
            background: #fff3e0 !important;
        }
        .out-of-stock {
            background: #ffebee !important;
        }
        .stock-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .stock-badge.ok { background: #e8f5e9; color: #2e7d32; }
        .stock-badge.low { background: #fff3e0; color: #e65100; }
        .stock-badge.out { background: #ffebee; color: #c62828; }

        /* Sale Search Styles */
        .sale-search-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .sale-result-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            border-left: 4px solid #667eea;
        }
        .sale-result-card:hover {
            background: #f0f0f0;
        }

        /* Discount Badge */
        .discount-badge {
            background: #ff5722;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .original-price {
            text-decoration: line-through;
            color: #999;
            font-size: 12px;
        }

        /* Quantity Input in Cart */
        .qty-input {
            width: 50px;
            text-align: center;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Manager Auth Modal */
        .auth-required {
            background: #fff3e0;
            border: 2px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .auth-required h4 {
            color: #e65100;
            margin: 0 0 10px 0;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }
        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102,126,234,0.1);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .error-text {
            color: #d32f2f;
            font-size: 12px;
            margin-top: 5px;
        }

        .required {
            color: #d32f2f;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            min-width: 300px;
        }
        .notification.success {
            border-left: 5px solid #28a745;
        }
        .notification.error {
            border-left: 5px solid #dc3545;
        }

        /* Company Selector Modal */
        .company-selector-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .company-selector-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .company-selector-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }
        .company-selector-box .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }
        .company-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .company-card {
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .company-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .company-card.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        .company-card .company-name {
            font-weight: 600;
            font-size: 16px;
        }
        .company-card .company-role {
            font-size: 12px;
            opacity: 0.8;
            text-transform: capitalize;
        }
        .company-card .role-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }
        .company-card.selected .role-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Role-based visibility classes */
        .role-hidden {
            display: none !important;
        }

        /* Enterprise Layout Styles */
        .enterprise-layout {
            display: none;
            padding: 20px;
            height: calc(100vh - 50px);
            overflow-y: auto;
            background: #f5f7fa;
        }
        .enterprise-layout h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }
        .kpi-card.green { border-left-color: #4caf50; }
        .kpi-card.orange { border-left-color: #ff9800; }
        .kpi-card.red { border-left-color: #f44336; }
        .kpi-card.purple { border-left-color: #9c27b0; }
        .kpi-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .kpi-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        .kpi-sub {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .enterprise-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .enterprise-section h3 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .enterprise-table {
            width: 100%;
            border-collapse: collapse;
        }
        .enterprise-table th {
            background: #f5f7fa;
            padding: 10px 12px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }
        .enterprise-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .enterprise-table tr:hover td {
            background: #f9f9ff;
        }
        .status-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-badge.active { background: #e8f5e9; color: #2e7d32; }
        .status-badge.pending { background: #fff3e0; color: #e65100; }
        .status-badge.closed { background: #e0e0e0; color: #616161; }
        .status-badge.alert { background: #ffebee; color: #c62828; }

        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 55px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
            animation: pulse-offline 2s infinite;
        }
        .offline-indicator.show { display: flex; align-items: center; gap: 8px; }
        .offline-indicator.syncing { background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%); }
        @keyframes pulse-offline {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .sync-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .enterprise-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        .enterprise-toolbar input, .enterprise-toolbar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .ent-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        .ent-btn-primary {
            background: #667eea;
            color: white;
        }
        .ent-btn-primary:hover { background: #5a6fd6; }
        .ent-btn-success {
            background: #4caf50;
            color: white;
        }
        .ent-btn-success:hover { background: #43a047; }
        .ent-btn-warning {
            background: #ff9800;
            color: white;
        }
        .ent-btn-danger {
            background: #f44336;
            color: white;
        }
        .alert-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .alert-row.warning { background: #fff3e0; }
        .alert-row.critical { background: #ffebee; }
        .alert-row.info { background: #e3f2fd; }
        .tab-sub-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .sub-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            border-radius: 6px 6px 0 0;
            font-size: 14px;
        }
        .sub-tab:hover { background: #f5f7fa; }
        .sub-tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            font-weight: 600;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
        <span id="offlineIcon">&#9888;</span>
        <span id="offlineText">You are offline</span>
        <span id="syncCount" class="sync-count" style="display:none;">0 pending</span>
    </div>

    <!-- Company Selector Screen -->
    <div id="companySelectorScreen" class="company-selector-screen">
        <div class="company-selector-box">
            <h1>Select Company</h1>
            <p class="subtitle">Welcome back, <span id="welcomeUserName"></span>! Choose which company to access.</p>
            <div class="company-list" id="companyList"></div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="selectCompany()" id="selectCompanyBtn" disabled>Continue</button>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="logoutFromCompanySelector()">Logout</button>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box" id="loginBox">
            <h1>üõí Checkout Charlie</h1>
            <div class="form-group">
                <label>Username or Email</label>
                <input type="text" id="loginUsername" value="demo" autofocus>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" value="demo123">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="login()">Login</button>
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <span style="color: #666;">Don't have an account?</span>
                <button onclick="showRegisterForm()" style="background: none; border: none; color: #667eea; cursor: pointer; font-weight: 600; text-decoration: underline;">Register your company</button>
            </div>
        </div>

        <!-- Registration Form -->
        <div class="login-box" id="registerBox" style="display: none; max-width: 500px;">
            <h1 style="font-size: 22px;">üìù Register Your Company</h1>
            <p style="color: #666; margin-bottom: 20px; font-size: 13px;">Fill in your details below. Your account will be reviewed and activated.</p>

            <div style="background: #f5f7fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="margin: 0 0 10px; font-size: 14px; color: #667eea;">Your Details</h3>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 12px;">Full Name *</label>
                    <input type="text" id="regFullName" placeholder="e.g. John Smith">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">Username *</label>
                        <input type="text" id="regUsername" placeholder="e.g. jsmith">
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">Email *</label>
                        <input type="email" id="regEmail" placeholder="you@example.com">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px;">Password * (min 6 characters)</label>
                    <input type="password" id="regPassword" placeholder="Create a secure password">
                </div>
            </div>

            <div style="background: #f5f7fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="margin: 0 0 10px; font-size: 14px; color: #667eea;">Company Details</h3>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 12px;">Company Name *</label>
                    <input type="text" id="regCompanyName" placeholder="e.g. ABC Trading Pty Ltd">
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 12px;">Trading Name</label>
                    <input type="text" id="regTradingName" placeholder="e.g. ABC Store">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">Registration Number</label>
                        <input type="text" id="regRegNumber" placeholder="Company reg #">
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">VAT Number</label>
                        <input type="text" id="regVatNumber" placeholder="VAT number">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">Contact Email</label>
                        <input type="email" id="regContactEmail" placeholder="Company email">
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">Contact Phone</label>
                        <input type="text" id="regContactPhone" placeholder="Phone number">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px;">Address</label>
                    <textarea id="regAddress" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" placeholder="Business address"></textarea>
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%;" onclick="registerCompany()">Register Company</button>
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="showLoginForm()" style="background: none; border: none; color: #667eea; cursor: pointer;">‚Üê Back to Login</button>
            </div>
        </div>
    </div>

    <!-- Super Admin Portal -->
    <div id="superAdminPortal" style="display: none; min-height: 100vh; background: #1a1a2e; overflow-y: auto; height: 100vh;">
        <div style="background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: white;">
                <span style="font-size: 20px; font-weight: bold;">üîê Lorenco Admin Portal</span>
                <span style="margin-left: 15px; opacity: 0.7; font-size: 13px;">Platform Management</span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span style="color: #4ade80; font-size: 13px;" id="adminUserName"></span>
                <button onclick="logoutAdmin()" style="background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">Logout</button>
            </div>
        </div>

        <div style="padding: 20px; max-width: 1400px; margin: 0 auto;">
            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; border-radius: 12px; color: white;">
                    <div style="font-size: 12px; opacity: 0.8; text-transform: uppercase;">Total Companies</div>
                    <div style="font-size: 32px; font-weight: bold;" id="statTotalCompanies">0</div>
                </div>
                <div style="background: linear-gradient(135deg, #4ade80, #22c55e); padding: 20px; border-radius: 12px; color: white;">
                    <div style="font-size: 12px; opacity: 0.8; text-transform: uppercase;">Active</div>
                    <div style="font-size: 32px; font-weight: bold;" id="statActiveCompanies">0</div>
                </div>
                <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); padding: 20px; border-radius: 12px; color: white;">
                    <div style="font-size: 12px; opacity: 0.8; text-transform: uppercase;">Pending Approval</div>
                    <div style="font-size: 32px; font-weight: bold;" id="statPendingCompanies">0</div>
                </div>
                <div style="background: linear-gradient(135deg, #ef4444, #dc2626); padding: 20px; border-radius: 12px; color: white;">
                    <div style="font-size: 12px; opacity: 0.8; text-transform: uppercase;">Suspended</div>
                    <div style="font-size: 32px; font-weight: bold;" id="statSuspendedCompanies">0</div>
                </div>
            </div>

            <!-- Companies Table -->
            <div style="background: #0f3460; border-radius: 12px; overflow: hidden;">
                <div style="padding: 15px 20px; border-bottom: 1px solid #1a1a2e; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: white; font-size: 18px;">All Companies</h2>
                    <button onclick="loadAdminCompanies()" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">‚Üª Refresh</button>
                </div>
                <div style="overflow-x: auto; max-height: 60vh; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; color: white;">
                        <thead>
                            <tr style="background: #16213e;">
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Company</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Owner</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Email</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Users</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Sales</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Status</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Registered</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminCompaniesTable">
                            <tr><td colspan="8" style="padding: 40px; text-align: center; color: #94a3b8;">Loading companies...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users Table -->
            <div style="background: #0f3460; border-radius: 12px; overflow: hidden; margin-top: 20px;">
                <div style="padding: 15px 20px; border-bottom: 1px solid #1a1a2e; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: white; font-size: 18px;">All Users</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="cleanOrphanedUsers()" style="background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">üßπ Clean Orphaned</button>
                        <button onclick="loadAdminUsers()" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">‚Üª Refresh</button>
                    </div>
                </div>
                <div style="overflow-x: auto; max-height: 40vh; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; color: white;">
                        <thead>
                            <tr style="background: #16213e; position: sticky; top: 0;">
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">User</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Email</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Companies</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Type</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Created</th>
                                <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #94a3b8;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersTable">
                            <tr><td colspan="6" style="padding: 40px; text-align: center; color: #94a3b8;">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Company Edit Modal -->
    <div id="adminCompanyModal" class="modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 600px; background: #1a1a2e; color: white;">
            <div class="modal-header" style="background: #0f3460; border-bottom: 1px solid #16213e;">
                <h2 style="color: white;">Company Details</h2>
                <button class="close-btn" onclick="closeAdminCompanyModal()" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                <!-- Owner Info Section -->
                <div style="background: #0f3460; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #667eea;">Owner Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><span style="color: #94a3b8;">Name:</span> <span id="adminOwnerName">-</span></div>
                        <div><span style="color: #94a3b8;">Username:</span> <span id="adminOwnerUsername">-</span></div>
                        <div><span style="color: #94a3b8;">Email:</span> <span id="adminOwnerEmail">-</span></div>
                        <div><span style="color: #94a3b8;">Phone:</span> <span id="adminOwnerPhone">-</span></div>
                    </div>
                </div>

                <!-- Company Details Form -->
                <input type="hidden" id="adminCompanyId">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="color: #94a3b8; font-size: 13px;">Company Name *</label>
                    <input type="text" id="adminCompanyName" class="form-control" style="background: #0f3460; border: 1px solid #16213e; color: white; padding: 10px; border-radius: 6px; width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="color: #94a3b8; font-size: 13px;">Trading Name</label>
                    <input type="text" id="adminTradingName" class="form-control" style="background: #0f3460; border: 1px solid #16213e; color: white; padding: 10px; border-radius: 6px; width: 100%;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="color: #94a3b8; font-size: 13px;">VAT Number</label>
                        <input type="text" id="adminVatNumber" class="form-control" style="background: #0f3460; border: 1px solid #16213e; color: white; padding: 10px; border-radius: 6px; width: 100%;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="color: #94a3b8; font-size: 13px;">Registration Number</label>
                        <input type="text" id="adminRegNumber" class="form-control" style="background: #0f3460; border: 1px solid #16213e; color: white; padding: 10px; border-radius: 6px; width: 100%;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="color: #94a3b8; font-size: 13px;">Contact Email</label>
                        <input type="email" id="adminContactEmail" class="form-control" style="background: #0f3460; border: 1px solid #16213e; color: white; padding: 10px; border-radius: 6px; width: 100%;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="color: #94a3b8; font-size: 13px;">Contact Phone</label>
                        <input type="text" id="adminContactPhone" class="form-control" style="background: #0f3460; border: 1px solid #16213e; color: white; padding: 10px; border-radius: 6px; width: 100%;">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="color: #94a3b8; font-size: 13px;">Address</label>
                    <textarea id="adminAddress" class="form-control" rows="2" style="background: #0f3460; border: 1px solid #16213e; color: white; padding: 10px; border-radius: 6px; width: 100%; resize: vertical;"></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="color: #94a3b8; font-size: 13px;">Subscription Status</label>
                    <select id="adminSubStatus" class="form-control" style="background: #0f3460; border: 1px solid #16213e; color: white; padding: 10px; border-radius: 6px; width: 100%;">
                        <option value="pending">Pending</option>
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                        <option value="trial">Trial</option>
                    </select>
                </div>

                <!-- Stats Section -->
                <div style="background: #0f3460; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #667eea;">Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 14px;">
                        <div><span style="color: #94a3b8;">Users:</span> <span id="adminStatUsers">0</span></div>
                        <div><span style="color: #94a3b8;">Products:</span> <span id="adminStatProducts">0</span></div>
                        <div><span style="color: #94a3b8;">Sales:</span> <span id="adminStatSales">0</span></div>
                        <div><span style="color: #94a3b8;">Registered:</span> <span id="adminStatCreated">-</span></div>
                        <div><span style="color: #94a3b8;">Activated:</span> <span id="adminStatApproved">-</span></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background: #0f3460; padding: 15px 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeAdminCompanyModal()" style="background: #374151; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Cancel</button>
                <button onclick="saveAdminCompany()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-container">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="nav-brand">Checkout Charlie</div>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('till', event)">Till</button>
                <button class="nav-tab" onclick="showTab('stock', event)">Stock</button>
                <button class="nav-tab" onclick="showTab('reports', event)">Reports</button>
                <button class="nav-tab" onclick="showTab('cashup', event)">Cash Up</button>
                <button class="nav-tab enterprise-tab" onclick="showTab('dashboard', event)">Dashboard</button>
                <button class="nav-tab enterprise-tab" onclick="showTab('loyalty', event)">Loyalty</button>
                <button class="nav-tab" onclick="showTab('settings', event)">Settings</button>
            </div>
            <div class="nav-right">
                <div class="user-info">
                    <span id="userName"></span>
                </div>
                <span class="session-badge" id="sessionStatus">No Session</span>
                <button class="manage-till-btn" onclick="showSwitchStoreModal()">Switch Store</button>
                <button class="manage-till-btn" onclick="manageSession()">Manage Till</button>
                <button class="manage-till-btn" onclick="logout()" style="background: rgba(220,53,69,0.2); border-color: #dc3545;">Logout</button>
            </div>
        </div>

        <!-- Till Interface -->
        <div id="tillInterface" class="till-interface">
            <div class="till-grid">
                <!-- Products Panel -->
                <div class="products-panel">
                    <div class="search-bar">
                        <div class="search-wrapper">
                            <input
                                type="text"
                                id="barcodeInput"
                                class="barcode-input"
                                placeholder="Scan barcode or search product..."
                                autofocus
                                autocomplete="off"
                            >
                            <span class="scan-icon">üì∑</span>
                        </div>
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">Scan barcode or type to search products</div>
                    </div>

                    <div class="categories" id="categories"></div>

                    <div class="products-grid" id="productsGrid"></div>
                </div>

                <!-- Cart Panel -->
                <div class="cart-panel">
                    <div class="cart-header">
                        <h2>Current Sale</h2>
                        <div id="cartItemCount">0 items</div>
                    </div>

                    <div class="cart-items" id="cartItems">
                        <div class="empty-cart">
                            <p>üõí Cart is empty</p>
                            <p style="font-size: 14px;">Scan or click products to add</p>
                        </div>
                    </div>

                    <div class="cart-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">R 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>VAT (15%):</span>
                            <span id="vat">R 0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>TOTAL:</span>
                            <span id="total">R 0.00</span>
                        </div>
                    </div>

                    <div class="checkout-section">
                        <div class="payment-methods">
                            <button class="payment-btn selected" onclick="selectPayment('CASH', this)"><span class="pay-icon">üíµ</span>Cash</button>
                            <button class="payment-btn" onclick="selectPayment('CARD', this)"><span class="pay-icon">üí≥</span>Card</button>
                            <button class="payment-btn" onclick="selectPayment('EFT', this)"><span class="pay-icon">üè¶</span>EFT</button>
                            <button class="payment-btn" onclick="selectPayment('ACCOUNT', this)"><span class="pay-icon">üë§</span>Account</button>
                            <button class="payment-btn" onclick="selectPayment('SNAPSCAN', this)"><span class="pay-icon">üì±</span>SnapScan</button>
                            <button class="payment-btn" onclick="selectPayment('ZAPPER', this)"><span class="pay-icon">‚ö°</span>Zapper</button>
                            <button class="payment-btn" onclick="selectPayment('GIFT_CARD', this)"><span class="pay-icon">üéÅ</span>Gift Card</button>
                            <button class="payment-btn" onclick="toggleSplitPayment()" id="splitPaymentBtn"><span class="pay-icon">‚úÇÔ∏è</span>Split</button>
                        </div>

                        <!-- Split Payment Section -->
                        <div id="splitPaymentSection" class="split-payment-section">
                            <div style="font-weight:600;margin-bottom:10px;color:#333;">Split Payment Allocation</div>
                            <div id="splitPaymentRows">
                                <div class="split-payment-row">
                                    <label>üíµ Cash:</label>
                                    <input type="number" class="split-amount" data-method="CASH" step="0.01" min="0" value="0" oninput="updateSplitRemaining()">
                                </div>
                                <div class="split-payment-row">
                                    <label>üí≥ Card:</label>
                                    <input type="number" class="split-amount" data-method="CARD" step="0.01" min="0" value="0" oninput="updateSplitRemaining()">
                                </div>
                                <div class="split-payment-row">
                                    <label>üè¶ EFT:</label>
                                    <input type="number" class="split-amount" data-method="EFT" step="0.01" min="0" value="0" oninput="updateSplitRemaining()">
                                </div>
                                <div class="split-payment-row">
                                    <label>üì± SnapScan:</label>
                                    <input type="number" class="split-amount" data-method="SNAPSCAN" step="0.01" min="0" value="0" oninput="updateSplitRemaining()">
                                </div>
                            </div>
                            <div class="split-remaining">
                                Remaining: <span id="splitRemainingAmount">R 0.00</span>
                            </div>
                        </div>

                        <!-- Account Customer Selection (shown when ACCOUNT selected) -->
                        <div id="accountCustomerSection" style="display:none; background:#f0f4ff; padding:12px; border-radius:8px; margin-bottom:10px;">
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Select Account Customer</label>
                            <div style="display:flex;gap:8px;">
                                <input type="text" id="accountCustomerSearch" placeholder="Search by name or phone..." style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;" oninput="searchAccountCustomers(this.value)">
                            </div>
                            <div id="accountCustomerResults" style="max-height:120px;overflow-y:auto;margin-top:8px;"></div>
                            <div id="selectedAccountCustomer" style="display:none;margin-top:8px;padding:8px;background:white;border-radius:6px;border:2px solid #667eea;">
                                <span id="selectedAccountName" style="font-weight:600;"></span>
                                <span id="selectedAccountBalance" style="float:right;color:#666;font-size:13px;"></span>
                            </div>
                        </div>

                        <button class="checkout-btn" id="checkoutBtn" onclick="checkout()" disabled>Complete Sale</button>
                        <button class="clear-cart-btn" onclick="clearCart()">Clear Cart</button>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="openSaleSearch()">üîç Search Sale / Reprint</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Interface -->
        <div id="stockInterface" class="stock-interface">
            <div style="max-width: 1400px; margin: 0 auto;">
                <div class="stock-header">
                    <h1 style="color: #667eea; margin: 0;">Stock Management</h1>
                    <div class="stock-filters">
                        <select id="stockFilterCategory" onchange="filterStock()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="">All Categories</option>
                        </select>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="lowStockOnly" onchange="filterStock()">
                            Low Stock Only
                        </label>
                        <button class="btn btn-primary" onclick="showStockTakeModal()">Stock Take</button>
                        <button class="btn btn-secondary" onclick="showStockAdjustModal()">Adjust Stock</button>
                    </div>
                </div>

                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Stock Qty</th>
                            <th>Min Level</th>
                            <th>Status</th>
                            <th>Unit Price</th>
                            <th>Stock Value</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Sale Search Interface (inside Till) -->
        <div id="saleSearchModal" class="modal-overlay">
            <div class="modal" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>Search Sales</h2>
                    <button class="close-btn" onclick="closeSaleSearch()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="saleSearchQuery" placeholder="Sale number, customer, or amount..." onkeyup="debounceSearchSales()">
                        <input type="date" id="saleSearchDate">
                        <button class="btn btn-primary" onclick="searchSales()">Search</button>
                    </div>
                    <div id="saleSearchResults" style="max-height: 400px; overflow-y: auto;">
                        <p style="text-align: center; color: #999;">Enter search criteria and click Search</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sale Detail Modal (for reprint/return) -->
        <div id="saleDetailModal" class="modal-overlay">
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>Sale Details</h2>
                    <button class="close-btn" onclick="closeSaleDetail()">&times;</button>
                </div>
                <div class="modal-body" id="saleDetailContent">
                    <!-- Populated dynamically -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeSaleDetail()">Close</button>
                    <button class="btn btn-secondary" onclick="reprintReceipt()">Reprint Receipt</button>
                    <button class="btn btn-danger" onclick="showReturnModal()">Process Return</button>
                </div>
            </div>
        </div>

        <!-- Stock Adjust Modal -->
        <div id="stockAdjustModal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Adjust Stock</h2>
                    <button class="close-btn" onclick="closeStockAdjust()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Product</label>
                        <select id="adjustProductId" style="width: 100%;" onchange="loadProductStock()">
                            <option value="">Select a product...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Current Stock: <span id="currentStockDisplay">-</span></label>
                    </div>
                    <div class="form-group">
                        <label>Adjustment Type</label>
                        <select id="adjustType">
                            <option value="add">Add Stock</option>
                            <option value="remove">Remove Stock</option>
                            <option value="set">Set Stock Level</option>
                            <option value="damage">Damaged/Broken</option>
                            <option value="theft">Theft/Loss</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="adjustQuantity" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>Reason</label>
                        <textarea id="adjustReason" rows="2" placeholder="Enter reason for adjustment..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeStockAdjust()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitStockAdjust()">Adjust Stock</button>
                </div>
            </div>
        </div>

        <!-- Daily Discount Modal -->
        <div id="dailyDiscountModal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Add Daily Discount</h2>
                    <button class="close-btn" onclick="closeDailyDiscount()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Product</label>
                        <select id="discountProductId" style="width: 100%;" onchange="loadProductPrice()">
                            <option value="">Select a product...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Original Price: <span id="originalPriceDisplay">R 0.00</span></label>
                    </div>
                    <div class="form-group">
                        <label>Discount Price</label>
                        <input type="number" id="discountPrice" step="0.01" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>Valid Until (leave blank for today only)</label>
                        <input type="date" id="discountEndDate">
                    </div>
                    <div class="form-group">
                        <label>Reason</label>
                        <input type="text" id="discountReason" placeholder="e.g., Expiring soon, Clearance">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeDailyDiscount()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitDailyDiscount()">Apply Discount</button>
                </div>
            </div>
        </div>

        <!-- Manager Authorization Modal -->
        <div id="managerAuthModal" class="modal-overlay">
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header">
                    <h2>Manager Authorization Required</h2>
                    <button class="close-btn" onclick="closeManagerAuth()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="auth-required">
                        <h4>This action requires manager approval</h4>
                        <p id="authActionDescription">A manager or business owner must authorize this action.</p>
                    </div>
                    <div class="form-group">
                        <label>Manager Username</label>
                        <input type="text" id="managerUsername" placeholder="Enter manager username">
                    </div>
                    <div class="form-group">
                        <label>Manager Password</label>
                        <input type="password" id="managerPassword" placeholder="Enter manager password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeManagerAuth()">Cancel</button>
                    <button class="btn btn-primary" onclick="verifyManagerAuth()">Authorize</button>
                </div>
            </div>
        </div>

        <!-- Reports Layout -->
        <div id="reportsLayout" class="settings-layout" style="display: none;">
            <div class="settings-grid">
                <div class="settings-sidebar">
                    <h3 style="padding: 15px; border-bottom: 1px solid #ddd; margin: 0;">Sales Reports</h3>
                    <div class="settings-menu-item" onclick="showReport('gross-profit', event)">Gross Profit</div>
                    <div class="settings-menu-item" onclick="showReport('gross-profit-by-person', event)">Gross Profit by Person</div>
                    <div class="settings-menu-item" onclick="showReport('gross-profit-by-product', event)">Gross Profit by Product</div>
                    <div class="settings-menu-item" onclick="showReport('daily-summary', event)">Sales Daily Summary</div>
                    <div class="settings-menu-item" onclick="showReport('audit-trail', event)">Sales Audit Trail</div>
                    <div class="settings-menu-item" onclick="showReport('forensic-audit', event)">Forensic Audit Log</div>
                    <div class="settings-menu-item" onclick="showReport('payment-methods', event)">Payment Methods</div>
                    <div class="settings-menu-item" onclick="showReport('suspicious-activity', event)">Suspicious Activity</div>
                    
                    <h3 style="padding: 15px 15px 10px; border-top: 1px solid #ddd; margin: 10px 0 0; color: #667eea;">VAT Reports</h3>
                    <div class="settings-menu-item" onclick="showReport('vat-detail', event)">VAT Detail</div>
                    <div class="settings-menu-item" onclick="showReport('vat-summary', event)">VAT Summary</div>
                    
                    <h3 style="padding: 15px 15px 10px; border-top: 1px solid #ddd; margin: 10px 0 0; color: #667eea;">Integrations</h3>
                    <div class="settings-menu-item" onclick="showReport('inventory-sync', event)">Inventory Sync</div>
                    <div class="settings-menu-item" onclick="showReport('accounting-sync', event)">Accounting Sync</div>
                </div>

                <div class="settings-content">
                    <!-- Report Header with Date Range -->
                    <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div>
                                <label style="font-size: 12px; color: #666;">Start Date</label>
                                <input type="date" id="reportStartDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">End Date</label>
                                <input type="date" id="reportEndDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <button class="btn btn-primary" onclick="loadCurrentReport()" style="align-self: flex-end;">Generate Report</button>
                            <button class="btn btn-secondary" onclick="exportCurrentReport()" style="align-self: flex-end;">üì• Export CSV</button>
                        </div>
                    </div>

                    <!-- Report Container -->
                    <div id="reportContainer" style="background: white; border-radius: 8px; padding: 20px;">
                        <p style="text-align: center; color: #999;">Select a report to view</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash Up Layout -->
        <div id="cashUpLayout" style="display: none; padding: 20px; height: calc(100vh - 120px); overflow-y: auto;">
            <div style="max-width: 1200px; margin: 0 auto; padding-bottom: 40px;">
                <h1 style="margin-bottom: 30px; color: #667eea;">üí∞ Cash Up</h1>

                <!-- Pending Cashups Section (sessions from daily reset) -->
                <div id="pendingCashupsSection" style="display: none; margin-bottom: 30px;">
                    <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #e65100; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">‚è≥</span> Pending Cashups from Previous Days
                        </h3>
                        <p style="color: #666; margin-bottom: 15px;">These sessions were reset for a new day but still need their cashup completed.</p>
                        <div id="pendingCashupsList"></div>
                    </div>
                </div>

                <!-- Current Session Info -->
                <div id="sessionInfo" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                        <div>
                            <div style="font-size: 13px; opacity: 0.9;">Till Session</div>
                            <div id="cashUpSessionId" style="font-size: 20px; font-weight: bold;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; opacity: 0.9;">Opened By</div>
                            <div id="cashUpUser" style="font-size: 20px; font-weight: bold;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; opacity: 0.9;">Opening Balance</div>
                            <div id="cashUpOpeningBalance" style="font-size: 20px; font-weight: bold;">R 0.00</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; opacity: 0.9;">Session Started</div>
                            <div id="cashUpOpenedAt" style="font-size: 20px; font-weight: bold;">-</div>
                        </div>
                    </div>
                </div>

                <!-- Session Summary -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; border-left: 5px solid #4caf50;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Total Sales</div>
                        <div id="cashUpTotalSales" style="font-size: 32px; font-weight: bold; color: #2e7d32;">R 0.00</div>
                        <div id="cashUpSalesCount" style="font-size: 13px; color: #666; margin-top: 5px;">0 transactions</div>
                    </div>
                    <div style="background: #fff3e0; padding: 20px; border-radius: 10px; border-left: 5px solid #ff9800;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Expected Cash</div>
                        <div id="cashUpExpectedCash" style="font-size: 32px; font-weight: bold; color: #e65100;">R 0.00</div>
                        <div style="font-size: 13px; color: #666; margin-top: 5px;">Opening + Sales</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 5px solid #2196f3;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Payment Breakdown</div>
                        <div id="cashUpPaymentBreakdown" style="font-size: 14px; margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; margin: 5px 0;"><span>Cash:</span><span id="cashSales">R 0.00</span></div>
                            <div style="display: flex; justify-content: space-between; margin: 5px 0;"><span>Card:</span><span id="cardSales">R 0.00</span></div>
                            <div style="display: flex; justify-content: space-between; margin: 5px 0;"><span>Account:</span><span id="accountSales">R 0.00</span></div>
                        </div>
                    </div>
                </div>

                <!-- Cash Counter -->
                <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <h2 style="margin-bottom: 20px; color: #667eea;">üíµ Count Cash in Till</h2>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <!-- Notes -->
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 10px;">Notes</label>
                            <div style="display: grid; gap: 10px;">
                                <div class="cash-row">
                                    <span>R 200</span>
                                    <input type="number" id="note200" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total200">R 0.00</span>
                                </div>
                                <div class="cash-row">
                                    <span>R 100</span>
                                    <input type="number" id="note100" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total100">R 0.00</span>
                                </div>
                                <div class="cash-row">
                                    <span>R 50</span>
                                    <input type="number" id="note50" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total50">R 0.00</span>
                                </div>
                                <div class="cash-row">
                                    <span>R 20</span>
                                    <input type="number" id="note20" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total20">R 0.00</span>
                                </div>
                                <div class="cash-row">
                                    <span>R 10</span>
                                    <input type="number" id="note10" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total10">R 0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Coins -->
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 10px;">Coins</label>
                            <div style="display: grid; gap: 10px;">
                                <div class="cash-row">
                                    <span>R 5</span>
                                    <input type="number" id="coin5" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total5">R 0.00</span>
                                </div>
                                <div class="cash-row">
                                    <span>R 2</span>
                                    <input type="number" id="coin2" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total2">R 0.00</span>
                                </div>
                                <div class="cash-row">
                                    <span>R 1</span>
                                    <input type="number" id="coin1" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total1">R 0.00</span>
                                </div>
                                <div class="cash-row">
                                    <span>50c</span>
                                    <input type="number" id="coin050" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total050">R 0.00</span>
                                </div>
                                <div class="cash-row">
                                    <span>20c</span>
                                    <input type="number" id="coin020" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total020">R 0.00</span>
                                </div>
                                <div class="cash-row">
                                    <span>10c</span>
                                    <input type="number" id="coin010" min="0" value="0" oninput="calculateCashTotal()">
                                    <span id="total010">R 0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Counted -->
                    <div style="margin-top: 25px; padding: 20px; background: #f5f5f5; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 16px; font-weight: bold; color: #666;">Total Cash Counted:</div>
                            <div id="totalCountedDisplay" style="font-size: 36px; font-weight: bold; color: #667eea;">R 0.00</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 16px; font-weight: bold; color: #666;">Expected:</div>
                            <div id="expectedCashAmount" style="font-size: 36px; font-weight: bold; color: #999;">R 0.00</div>
                        </div>
                    </div>

                    <!-- Variance Display -->
                    <div id="varianceInfo" style="margin-top: 20px; padding: 20px; border-radius: 8px; display: none; background: #fff8e1; border: 2px solid #ffc107;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span id="varianceLabel" style="font-size: 18px; font-weight: bold;">Variance:</span>
                            <span id="varianceAmount" style="font-size: 32px; font-weight: bold;"></span>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">Notes</h3>
                    <textarea id="cashUpNotes" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; resize: vertical;" placeholder="Add any notes about this cash up session (e.g., reasons for variance, missing receipts, etc.)"></textarea>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 15px; justify-content: space-between; flex-wrap: wrap;">
                    <button class="btn btn-secondary manager-only" onclick="dailyTillReset()" style="padding: 15px 30px; font-size: 16px; background: #ff9800; color: white; border: none;">Daily Reset (Start Fresh)</button>
                    <div style="display: flex; gap: 15px;">
                        <button class="btn btn-secondary" onclick="showTab('till', event)" style="padding: 15px 30px; font-size: 16px;">Cancel</button>
                        <button class="btn btn-primary" onclick="completeCashUp()" style="padding: 15px 30px; font-size: 16px; background: #4caf50; border: none;">‚úì Complete Cash Up & Close Till</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Layout -->
        <div id="settingsLayout" class="settings-layout">
            <div class="settings-grid">
                <div class="settings-sidebar">
                    <div class="settings-menu-item active" onclick="showSettings('products', event)">Products</div>
                    <div class="settings-menu-item" onclick="showSettings('customers', event)">Customers</div>
                    <div class="settings-menu-item" onclick="showSettings('companies', event)">Companies</div>
                    <div class="settings-menu-item" onclick="showSettings('users', event)">Users</div>
                    <div class="settings-menu-item" onclick="showSettings('general', event)">General</div>
                    <div class="settings-menu-item" onclick="showSettings('receipt-printers', event)">Receipt Printers</div>
                    <div class="settings-menu-item" onclick="showSettings('categories', event)">Categories</div>
                    <div class="settings-menu-item" onclick="showSettings('brands', event)">Brands</div>
                    <div class="settings-menu-item" onclick="showSettings('suppliers', event)">Suppliers</div>
                    <div class="settings-menu-item" onclick="showSettings('sites', event)">Sites</div>
                </div>

                <div class="settings-content">
                    <!-- Products Section -->
                    <div id="productsSection">
                        <div class="products-header">
                            <div class="search-box">
                                <input type="text" id="productSearch" placeholder="Search..." onkeyup="searchProducts()">
                                <span class="search-icon">üîç</span>
                            </div>
                            <div class="header-actions">
                                <button class="btn btn-secondary" onclick="showDailyDiscountModal()">Daily Discounts</button>
                                <button class="btn btn-secondary" onclick="exportProducts()">Export Products</button>
                                <button class="btn btn-secondary" onclick="importProducts()">Import Products</button>
                                <button class="btn btn-primary" onclick="showAddProduct()">Add Product</button>
                            </div>
                        </div>

                        <!-- Multi-Location Stock Info -->
                        <div id="multiLocationInfo" style="background: #e3f2fd; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; display: none;">
                            <strong>Multi-Location Mode:</strong> Stock is tracked separately per location. Click a product to manage stock levels for each location.
                        </div>

                        <div class="products-container">
                            <div class="product-count" id="productCount">0 Products</div>
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Stock</th>
                                        <th>Locations</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <!-- Products will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Companies Section -->
                    <div id="companiesSection" style="display: none;">
                        <div class="products-header">
                            <h3 style="margin:0;">Company Management</h3>
                            <div class="header-actions">
                                <button class="btn btn-secondary" onclick="showAddLocationModal()">+ Add Location</button>
                                <button class="btn btn-primary" onclick="showAddCompanyModal()">+ New Company</button>
                            </div>
                        </div>

                        <!-- Tabs for Locations vs Other Companies -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                            <button class="btn" id="tabLocations" onclick="showCompanyTab('locations')" style="background: #667eea; color: white;">My Locations</button>
                            <button class="btn btn-secondary" id="tabCompanies" onclick="showCompanyTab('companies')">Other Companies</button>
                        </div>

                        <!-- Info Box -->
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px;">
                            <strong>Locations</strong> are branches of your main company (same VAT, same business). Reports can be viewed per location or combined.<br>
                            <strong>Other Companies</strong> are separate businesses you own (separate invoicing, separate VAT).
                        </div>

                        <!-- Main Company Card -->
                        <div id="mainCompanyCard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 12px; opacity: 0.8; text-transform: uppercase;">Current Company</div>
                                    <div style="font-size: 24px; font-weight: bold;" id="mainCompanyName">Loading...</div>
                                    <div style="opacity: 0.9;" id="mainCompanyDetails"></div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; opacity: 0.8;">VAT Number</div>
                                    <div style="font-size: 18px; font-weight: bold;" id="mainCompanyVat">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Locations List -->
                        <div id="locationsList">
                            <h4 style="margin: 0 0 15px 0;">Store Locations</h4>
                            <div class="products-container">
                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>Location Name</th>
                                            <th>Address</th>
                                            <th>Phone</th>
                                            <th>Users</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="locationsTableBody">
                                        <tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">No locations yet. Add your first store location.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Other Companies List -->
                        <div id="otherCompaniesList" style="display: none;">
                            <h4 style="margin: 0 0 15px 0;">Your Other Companies</h4>
                            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Separate businesses with their own invoicing and data. Click "Switch" to access them.</p>
                            <div class="products-container">
                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>Company Name</th>
                                            <th>Trading Name</th>
                                            <th>VAT Number</th>
                                            <th>Locations</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="otherCompaniesTableBody">
                                        <tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">No other companies. Register a new company to manage multiple businesses.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Users Section -->
                    <div id="usersSection" style="display: none;">
                        <div class="products-header">
                            <div style="display:flex;align-items:center;gap:15px;">
                                <h3 style="margin:0;">User Management</h3>
                                <select id="userCompanyFilter" onchange="loadCompanyUsers()" style="padding:8px;border:1px solid #ddd;border-radius:6px;">
                                    <option value="">Select company...</option>
                                </select>
                            </div>
                            <div class="header-actions">
                                <button class="btn btn-primary" onclick="showAddUserModal()">+ Add User</button>
                            </div>
                        </div>
                        <p style="color: #666; margin: 10px 0 20px; font-size: 13px;">Users belong to specific companies. Each user can have a different role per company. Select a company above to manage its users.</p>
                        <div class="products-container">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>Full Name</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Employee ID</th>
                                        <th>Status</th>
                                        <th>Last Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr><td colspan="8" style="text-align:center;color:#999;padding:20px;">Select a company to view its users</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Customers Section -->
                    <div id="customersSection" style="display: none;">
                        <div class="customers-header">
                            <div class="search-box">
                                <input type="text" id="customerSearch" placeholder="Search customers..." onkeyup="searchCustomers()">
                                <span class="search-icon">üîç</span>
                            </div>
                            <div class="header-actions">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="activeCustomersOnly" checked onchange="toggleActiveOnly()">
                                    Active customers only
                                </label>
                                <button class="btn btn-secondary" onclick="exportCustomers()">Export Customers</button>
                                <button class="btn btn-primary" onclick="showAddCustomer()">Add Customer</button>
                            </div>
                        </div>

                        <div class="customers-container">
                            <div class="customer-count" id="customerCount">0 Customers</div>
                            <table class="customers-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>Group</th>
                                        <th>Loyalty</th>
                                        <th>Balance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customersTableBody">
                                    <!-- Customers will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Receipt Printers Section -->
                    <div id="receipt-printersSection" style="display: none;">
                        <div class="products-header">
                            <h3 style="margin:0;">Receipt Printers</h3>
                            <div class="header-actions">
                                <button class="btn btn-primary" onclick="showAddPrinterModal()">+ Add Printer</button>
                            </div>
                        </div>
                        <p style="color: #666; margin: 10px 0 20px; font-size: 13px;">Configure network thermal printers for receipt printing. Most POS thermal printers use port 9100.</p>

                        <!-- Receipt Settings -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0;">Receipt Settings</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Receipt Header</label>
                                    <textarea id="receiptHeader" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="Your company name or message"></textarea>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Receipt Footer</label>
                                    <textarea id="receiptFooter" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="Thank you message, return policy, etc."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="autoPrintReceipt">
                                    Auto-print receipt after each sale
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="saveReceiptSettings()" style="margin-top: 15px;">Save Settings</button>
                        </div>

                        <!-- Printers Table -->
                        <div class="products-container">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>Printer Name</th>
                                        <th>IP Address</th>
                                        <th>Port</th>
                                        <th>Paper Width</th>
                                        <th>Default</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="printersTableBody">
                                    <tr><td colspan="7" style="text-align:center;color:#999;padding:20px;">Loading printers...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- General Section -->
                    <div id="generalSection" style="display: none;">
                        <div class="products-header">
                            <h3 style="margin:0;">General Settings</h3>
                        </div>
                        <p style="color: #666; margin: 10px 0 20px; font-size: 13px;">Company-wide settings and defaults for this store.</p>

                        <!-- Company Information -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0;">Company Information</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Company Name *</label>
                                    <input type="text" id="settingsCompanyName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="e.g. ABC Trading (Pty) Ltd">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Trading Name</label>
                                    <input type="text" id="settingsTradingName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="e.g. ABC Store">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">VAT Number</label>
                                    <input type="text" id="settingsVatNumber" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="e.g. 4123456789">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Registration Number</label>
                                    <input type="text" id="settingsRegNumber" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="e.g. 2020/123456/07">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Contact Phone</label>
                                    <input type="text" id="settingsPhone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="e.g. 012 345 6789">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Contact Email</label>
                                    <input type="email" id="settingsEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="e.g. info@company.co.za">
                                </div>
                                <div style="grid-column: span 2;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Address</label>
                                    <textarea id="settingsAddress" rows="2" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="e.g. 123 Main Street, Sandton, 2196"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Numbering Settings -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0;">Numbering Settings</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Product Code Prefix</label>
                                    <input type="text" id="settingsProductPrefix" maxlength="5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-transform: uppercase;" placeholder="e.g. PRO" value="PRO">
                                    <div style="font-size: 11px; color: #666; margin-top: 3px;">New products will start with this prefix</div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Receipt Number Prefix</label>
                                    <input type="text" id="settingsReceiptPrefix" maxlength="5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-transform: uppercase;" placeholder="e.g. INV" value="INV">
                                    <div style="font-size: 11px; color: #666; margin-top: 3px;">Sales receipts will use this prefix</div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Next Receipt Number</label>
                                    <input type="number" id="settingsNextReceiptNumber" min="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" value="1">
                                    <div style="font-size: 11px; color: #666; margin-top: 3px;">Next receipt will be this number</div>
                                </div>
                            </div>
                        </div>

                        <!-- Till Settings -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0;">Till Settings</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Default Opening Float (R)</label>
                                    <input type="number" id="defaultFloatAmount" step="0.01" min="0" value="500.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">VAT Rate (%)</label>
                                    <input type="number" id="settingsVatRate" step="0.01" min="0" max="100" value="15" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="settingsAutoPrint" checked>
                                    Print receipt on completion of sale
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="settingsOpenDrawer" checked>
                                    Open cash drawer on completion of sale
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="settingsGroupItems" checked>
                                    Group same sale items
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="settingsShowImages">
                                    Use product images for favourites
                                </label>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="saveGeneralSettings()" style="padding: 12px 30px;">Save All Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Add Product</h2>
                <button class="close-btn" onclick="closeProductModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Barcode Section -->
                <div class="form-group">
                    <label>Barcode</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="productBarcode" placeholder="Scan or enter barcode">
                        <button class="btn btn-secondary" onclick="scanBarcode()" style="width: auto; padding: 10px 15px;">üì∑ Scan</button>
                        <button class="btn btn-secondary" onclick="generateBarcode()" style="width: auto; padding: 10px 15px;">üè∑Ô∏è Generate</button>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;" id="barcodeStatus"></div>
                </div>

                <!-- Sean AI Assistant -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #667eea;">ü§ñ Ask Sean AI</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 3px;">Let Sean help fill product details from barcode or description</div>
                        </div>
                        <button class="btn btn-primary" onclick="askSean()" style="width: auto; padding: 10px 20px;">Ask Sean</button>
                    </div>
                    <div id="seanResponse" style="margin-top: 10px; display: none; background: white; padding: 10px; border-radius: 5px; font-size: 13px;"></div>
                </div>

                <div class="form-group">
                    <label>Code <span class="required">*</span></label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="productCodePrefix" maxlength="3" style="width: 80px; text-transform: uppercase;" placeholder="PRE" value="PRO">
                        <input type="text" id="productCode" required style="flex: 1;" readonly>
                        <button type="button" class="btn btn-secondary" onclick="generateProductCode()" style="width: auto; padding: 10px 15px;">Generate</button>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Enter 3-letter prefix (e.g., company initials) then click Generate</div>
                    <div class="error-text" id="codeError" style="display: none;">This field is required</div>
                </div>

                <div class="form-group">
                    <label>Description <span class="required">*</span></label>
                    <input type="text" id="productDescription" required>
                    <div class="error-text" id="descError" style="display: none;">This field is required</div>
                </div>

                <div class="form-group">
                    <label>Searchable</label>
                    <input type="text" id="productSearchable">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="productCategory">
                            <option value="">Default Category</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Brand</label>
                        <select id="productBrand">
                            <option value="">Default Brand</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Unit</label>
                    <input type="text" id="productUnit" placeholder="e.g., ea, kg">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="productRequiresVat" checked onchange="toggleVatRate()">
                            Requires VAT
                        </label>
                    </div>

                    <div class="form-group">
                        <label>VAT Rate (%)</label>
                        <select id="productTaxRate">
                            <option value="0">0%</option>
                            <option value="15" selected>15%</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cost</label>
                        <input type="number" id="productCost" step="0.01" value="0.00">
                    </div>

                    <div class="form-group">
                        <label>Gross Profit</label>
                        <input type="number" id="productGrossProfit" step="0.0001" value="0.0000" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Inclusive Price</label>
                        <input type="number" id="productPrice" step="0.01" value="0.00">
                    </div>

                    <div class="form-group">
                        <label>Gross Profit %</label>
                        <input type="number" id="productGrossProfitPercent" step="0.01" value="0.00" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="productActive" checked>
                        Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div id="customerModal" class="modal-overlay">
        <div class="modal" style="max-width:650px;">
            <div class="modal-header">
                <h2 id="customerModalTitle">Add Customer</h2>
                <button class="modal-close" onclick="closeCustomerModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height:65vh;overflow-y:auto;">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="customerFirstName" placeholder="First name">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="customerLastName" placeholder="Last name">
                    </div>
                </div>

                <div class="form-group">
                    <label>Display Name / Company <span class="required">*</span></label>
                    <input type="text" id="customerName" required placeholder="e.g. John Smith or ABC Trading">
                    <div class="error-text" id="nameError" style="display: none;">This field is required</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="customerPhone" placeholder="e.g. 082 123 4567">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="customerEmail" placeholder="email@example.com">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ID Number</label>
                        <input type="text" id="customerIdNumber" placeholder="SA ID number" maxlength="13">
                    </div>
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="customerDOB">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Customer Group</label>
                        <select id="customerGroup">
                            <option value="general">General</option>
                            <option value="wholesale">Wholesale</option>
                            <option value="vip">VIP</option>
                            <option value="staff">Staff</option>
                            <option value="trade">Trade</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Customer Type</label>
                        <select id="customerType">
                            <option value="Cash Sale Customer">Cash Sale Customer</option>
                            <option value="Account Customer">Account Customer</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Credit Limit (R)</label>
                    <input type="number" id="customerCreditLimit" step="0.01" min="0" value="0" placeholder="0.00">
                    <div style="font-size:11px;color:#666;margin-top:3px;">Set to 0 for no credit. Only applies to Account Customers.</div>
                </div>

                <div class="form-group">
                    <label>Contact Person</label>
                    <input type="text" id="customerContactPerson" placeholder="Contact person name">
                </div>

                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="tel" id="customerContactNumber" placeholder="Alternative contact number">
                </div>

                <div class="form-group">
                    <label>Address Line 1</label>
                    <input type="text" id="customerAddress1">
                </div>

                <div class="form-group">
                    <label>Address Line 2</label>
                    <input type="text" id="customerAddress2">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Suburb</label>
                        <input type="text" id="customerSuburb">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="customerCity">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Province</label>
                        <input type="text" id="customerProvince">
                    </div>
                    <div class="form-group">
                        <label>Postal Code</label>
                        <input type="text" id="customerPostalCode">
                    </div>
                </div>

                <div class="form-group">
                    <label>Tax Reference</label>
                    <input type="text" id="customerTaxReference">
                </div>

                <div class="form-group">
                    <label>Company</label>
                    <input type="text" id="customerCompany">
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="customerNotes" rows="2" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="Internal notes about this customer..."></textarea>
                </div>

                <div class="form-group">
                    <label>Custom Field</label>
                    <input type="text" id="customerCustomField">
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="customerActive" checked>
                            Active Customer
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="customerMarketingConsent">
                            Marketing Consent
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCustomerModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCustomer()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Company Modal -->
    <div id="companyModal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h2 id="companyModalTitle">Add Company</h2>
                <button class="close-btn" onclick="closeCompanyModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding:20px;">
                <div style="display:grid;gap:15px;">
                    <div>
                        <label style="font-weight:600;display:block;margin-bottom:5px;">Company Name *</label>
                        <input type="text" id="companyName" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="e.g. ABC Trading Pty Ltd">
                    </div>
                    <div>
                        <label style="font-weight:600;display:block;margin-bottom:5px;">Trading Name</label>
                        <input type="text" id="companyTradingName" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="e.g. ABC Store">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Registration Number</label>
                            <input type="text" id="companyRegNumber" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">VAT Number</label>
                            <input type="text" id="companyVatNumber" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Contact Email</label>
                            <input type="email" id="companyEmail" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Contact Phone</label>
                            <input type="text" id="companyPhone" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                    </div>
                    <div>
                        <label style="font-weight:600;display:block;margin-bottom:5px;">Address</label>
                        <textarea id="companyAddress" rows="2" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;resize:vertical;"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding:15px 20px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px;">
                <button class="btn btn-secondary" onclick="closeCompanyModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCompany()">Create Company</button>
            </div>
        </div>
    </div>

    <!-- Add Location Modal -->
    <div id="locationModal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h2 id="locationModalTitle">Add Store Location</h2>
                <button class="close-btn" onclick="closeLocationModal()" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding:20px;">
                <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #2e7d32;">
                    <strong>Location = Branch of your company</strong><br>
                    Same VAT number, same business entity. Perfect for multiple stores.
                </div>
                <div style="display:grid;gap:15px;">
                    <div>
                        <label style="font-weight:600;display:block;margin-bottom:5px;">Location Name *</label>
                        <input type="text" id="locationName" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="e.g. Main Branch, Sandton Store, Mall Outlet">
                    </div>
                    <div>
                        <label style="font-weight:600;display:block;margin-bottom:5px;">Address</label>
                        <textarea id="locationAddress" rows="2" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;resize:vertical;" placeholder="Physical address of this location"></textarea>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Phone</label>
                            <input type="text" id="locationPhone" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="Location phone number">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Email</label>
                            <input type="email" id="locationEmail" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="Location email">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding:15px 20px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px;">
                <button class="btn btn-secondary" onclick="closeLocationModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveLocation()">Add Location</button>
            </div>
        </div>
    </div>

    <!-- Product Stock Modal (Multi-Location) -->
    <div id="productStockModal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h2>Manage Stock by Location</h2>
                <button class="close-btn" onclick="closeProductStockModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding:20px;">
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 18px; font-weight: bold;" id="stockProductName">Product Name</div>
                    <div style="color: #666;" id="stockProductCode">Code: ABC123</div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="stockShareAllLocations" onchange="toggleShareAllLocations()">
                        <strong>Share this product to all locations</strong>
                    </label>
                </div>

                <h4 style="margin: 0 0 10px 0;">Stock per Location</h4>
                <table class="products-table" style="margin-bottom: 0;">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th style="width: 120px;">Stock</th>
                            <th style="width: 120px;">Reorder Level</th>
                            <th style="width: 80px;">Active</th>
                        </tr>
                    </thead>
                    <tbody id="productStockTableBody">
                        <tr><td colspan="4" style="text-align:center;color:#999;padding:20px;">Loading locations...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer" style="padding:15px 20px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px;">
                <button class="btn btn-secondary" onclick="closeProductStockModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProductStock()">Save Stock Levels</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="userModal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h2>Add User to Company</h2>
                <button class="close-btn" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding:20px;">
                <div style="display:grid;gap:15px;">
                    <div>
                        <label style="font-weight:600;display:block;margin-bottom:5px;">Company *</label>
                        <select id="userCompanySelect" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                            <option value="">Select company...</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight:600;display:block;margin-bottom:5px;">Full Name *</label>
                        <input type="text" id="userFullName" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="e.g. John Smith">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Username *</label>
                            <input type="text" id="userUsername" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="e.g. jsmith">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Email</label>
                            <input type="email" id="userEmail" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Password *</label>
                            <input type="password" id="userPassword" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="Min 6 characters">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Role *</label>
                            <select id="userRole" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                <option value="">Select role...</option>
                                <optgroup label="Corporate">
                                    <option value="corporate_admin">Corporate Admin</option>
                                    <option value="corporate_finance">Corporate Finance</option>
                                    <option value="corporate_ops">Corporate Operations</option>
                                </optgroup>
                                <optgroup label="Regional">
                                    <option value="regional_manager">Regional Manager</option>
                                    <option value="regional_analyst">Regional Analyst</option>
                                </optgroup>
                                <optgroup label="District">
                                    <option value="district_manager">District Manager</option>
                                    <option value="district_trainer">District Trainer</option>
                                </optgroup>
                                <optgroup label="Store">
                                    <option value="store_manager">Store Manager</option>
                                    <option value="assistant_manager">Assistant Manager</option>
                                    <option value="shift_supervisor">Shift Supervisor</option>
                                    <option value="senior_cashier">Senior Cashier</option>
                                    <option value="cashier">Cashier</option>
                                    <option value="trainee">Trainee</option>
                                </optgroup>
                                <optgroup label="Special">
                                    <option value="business_owner">Business Owner</option>
                                    <option value="accountant">Accountant</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="font-weight:600;display:block;margin-bottom:5px;">Employee ID</label>
                        <input type="text" id="userEmployeeId" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="Optional - e.g. EMP-001">
                    </div>
                </div>
                <div style="margin-top:15px;padding:12px;background:#e3f2fd;border-radius:8px;font-size:13px;color:#1565c0;">
                    This user will belong ONLY to the selected company. They will not see data from any other company.
                </div>
            </div>
            <div class="modal-footer" style="padding:15px 20px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px;">
                <button class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveUser()">Create User</button>
            </div>
        </div>
    </div>

    <!-- Printer Modal -->
    <div id="printerModal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width:450px;">
            <div class="modal-header">
                <h2 id="printerModalTitle">Add Printer</h2>
                <button class="close-btn" onclick="closePrinterModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding:20px;">
                <div style="display:grid;gap:15px;">
                    <div>
                        <label style="font-weight:600;display:block;margin-bottom:5px;">Printer Name *</label>
                        <input type="text" id="printerName" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="e.g. Main Receipt Printer">
                    </div>
                    <div>
                        <label style="font-weight:600;display:block;margin-bottom:5px;">IP Address *</label>
                        <input type="text" id="printerIp" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="e.g. 192.168.1.100">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Port</label>
                            <input type="number" id="printerPort" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" value="9100">
                            <div style="font-size:11px;color:#666;margin-top:3px;">Default: 9100</div>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:5px;">Paper Width</label>
                            <select id="printerPaperWidth" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                <option value="80">80mm (Standard)</option>
                                <option value="58">58mm (Small)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="printerIsDefault">
                            Set as default printer
                        </label>
                    </div>
                </div>
                <div style="margin-top:15px;padding:12px;background:#fff3e0;border-radius:8px;font-size:13px;color:#e65100;">
                    <strong>Tip:</strong> Most thermal receipt printers use port 9100. Make sure the printer is connected to your network and powered on.
                </div>
            </div>
            <div class="modal-footer" style="padding:15px 20px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px;">
                <button class="btn btn-secondary" onclick="closePrinterModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePrinter()">Save Printer</button>
            </div>
        </div>
    </div>

    <!-- ========== ENTERPRISE LAYOUTS ========== -->

    <!-- Dashboard Layout -->
    <div id="dashboardLayout" class="enterprise-layout">
        <h1>Enterprise Dashboard</h1>
        <div class="dashboard-grid" id="dashboardKPIs">
            <div class="kpi-card">
                <div class="kpi-label">Today's Sales</div>
                <div class="kpi-value" id="kpiTodaySales">R 0.00</div>
                <div class="kpi-sub" id="kpiTodayTransactions">0 transactions</div>
            </div>
            <div class="kpi-card green">
                <div class="kpi-label">Gross Profit</div>
                <div class="kpi-value" id="kpiGrossProfit">R 0.00</div>
                <div class="kpi-sub" id="kpiProfitMargin">0% margin</div>
            </div>
            <div class="kpi-card orange">
                <div class="kpi-label">Avg Transaction</div>
                <div class="kpi-value" id="kpiAvgTransaction">R 0.00</div>
                <div class="kpi-sub" id="kpiAvgBasket">0 items avg</div>
            </div>
            <div class="kpi-card purple">
                <div class="kpi-label">Active Employees</div>
                <div class="kpi-value" id="kpiActiveEmployees">0</div>
                <div class="kpi-sub">on shift today</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="enterprise-section">
                <h3>Loss Prevention Alerts</h3>
                <div id="dashboardAlerts">
                    <div class="empty-state"><div class="icon">&#9989;</div><p>No active alerts</p></div>
                </div>
            </div>
            <div class="enterprise-section">
                <h3>Recent Activity</h3>
                <div id="dashboardActivity">
                    <div class="empty-state"><div class="icon">&#128196;</div><p>No recent activity</p></div>
                </div>
            </div>
        </div>

        <div class="enterprise-section">
            <h3>Location Performance</h3>
            <table class="enterprise-table" id="dashboardLocations">
                <thead>
                    <tr>
                        <th>Location</th>
                        <th>Type</th>
                        <th>Today's Sales</th>
                        <th>Transactions</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="locationPerformanceBody">
                    <tr><td colspan="5" style="text-align:center;color:#999;padding:20px;">Loading locations...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Loyalty Layout -->
    <div id="loyaltyLayout" class="enterprise-layout">
        <h1>Customer Loyalty & Promotions</h1>
        <div class="tab-sub-nav">
            <button class="sub-tab active" onclick="showLoyaltyTab('programs', event)">Programs</button>
            <button class="sub-tab" onclick="showLoyaltyTab('members', event)">Members</button>
            <button class="sub-tab" onclick="showLoyaltyTab('promotions', event)">Promotions</button>
        </div>

        <div id="loyPrograms">
            <div class="enterprise-toolbar">
                <h3 style="margin:0;">Loyalty Programs</h3>
                <button class="ent-btn ent-btn-primary" onclick="showNewProgramModal()">+ New Program</button>
            </div>
            <div class="enterprise-section">
                <table class="enterprise-table">
                    <thead>
                        <tr>
                            <th>Program Name</th>
                            <th>Points per R1</th>
                            <th>Point Value</th>
                            <th>Min Redemption</th>
                            <th>Expiry</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="loyaltyProgramsBody">
                        <tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">Loading programs...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="loyMembers" style="display:none;">
            <div class="enterprise-toolbar">
                <input type="text" id="loyMemberSearch" placeholder="Search members..." onkeyup="searchLoyaltyMembers()">
                <button class="ent-btn ent-btn-primary" onclick="showEnrollCustomerModal()">+ Enroll Customer</button>
            </div>
            <div class="enterprise-section">
                <table class="enterprise-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Loyalty #</th>
                            <th>Program</th>
                            <th>Tier</th>
                            <th>Points Balance</th>
                            <th>Lifetime Spend</th>
                        </tr>
                    </thead>
                    <tbody id="loyaltyMembersBody">
                        <tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">Loading members...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="loyPromotions" style="display:none;">
            <div class="enterprise-toolbar">
                <div style="display:flex;gap:10px;">
                    <input type="text" id="promoSearch" placeholder="Search promotions...">
                    <select id="promoFilter">
                        <option value="">All Promotions</option>
                        <option value="active">Active</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
                <button class="ent-btn ent-btn-primary" onclick="showNewPromotionModal()">+ New Promotion</button>
            </div>
            <div class="enterprise-section">
                <table class="enterprise-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Code</th>
                            <th>Type</th>
                            <th>Discount</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Usage</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="promotionsTableBody">
                        <tr><td colspan="8" style="text-align:center;color:#999;padding:20px;">Loading promotions...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        const API_URL = window.location.origin + '/api';
        let token = null;
        let currentUser = null;
        let currentSession = null;
        let products = [];
        let cart = [];
        let categories = new Set();
        let selectedCategory = 'all';
        let selectedPayment = 'CASH';
        let editingProductId = null;
        let currentTab = 'till';
        let availableCompanies = [];
        let selectedCompanyId = null;
        let userRole = null;
        let userPermissions = {};

        // ========== OFFLINE-FIRST FUNCTIONALITY ==========
        let isOnline = navigator.onLine;
        let db = null;
        const DB_NAME = 'CheckoutCharliePOS';
        const DB_VERSION = 1;

        // Initialize IndexedDB
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    console.log('[IndexedDB] Database opened successfully');
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;

                    // Products store (cached from server)
                    if (!database.objectStoreNames.contains('products')) {
                        const productsStore = database.createObjectStore('products', { keyPath: 'id' });
                        productsStore.createIndex('product_code', 'product_code', { unique: false });
                        productsStore.createIndex('barcode', 'barcode', { unique: false });
                    }

                    // Customers store (cached from server)
                    if (!database.objectStoreNames.contains('customers')) {
                        database.createObjectStore('customers', { keyPath: 'id' });
                    }

                    // Offline sales queue
                    if (!database.objectStoreNames.contains('offlineSales')) {
                        const salesStore = database.createObjectStore('offlineSales', { keyPath: 'tempId', autoIncrement: true });
                        salesStore.createIndex('synced', 'synced', { unique: false });
                        salesStore.createIndex('createdAt', 'createdAt', { unique: false });
                    }

                    // Session data
                    if (!database.objectStoreNames.contains('sessionData')) {
                        database.createObjectStore('sessionData', { keyPath: 'key' });
                    }

                    console.log('[IndexedDB] Database schema created/updated');
                };
            });
        }

        // Save products to IndexedDB
        async function cacheProducts(productList) {
            if (!db) return;
            const tx = db.transaction('products', 'readwrite');
            const store = tx.objectStore('products');

            // Clear existing and add new
            await store.clear();
            for (const product of productList) {
                store.put(product);
            }

            return new Promise((resolve, reject) => {
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        // Get products from IndexedDB
        async function getCachedProducts() {
            if (!db) return [];
            return new Promise((resolve, reject) => {
                const tx = db.transaction('products', 'readonly');
                const store = tx.objectStore('products');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        // Save customers to IndexedDB
        async function cacheCustomers(customerList) {
            if (!db) return;
            const tx = db.transaction('customers', 'readwrite');
            const store = tx.objectStore('customers');

            await store.clear();
            for (const customer of customerList) {
                store.put(customer);
            }

            return new Promise((resolve, reject) => {
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        // Get customers from IndexedDB
        async function getCachedCustomers() {
            if (!db) return [];
            return new Promise((resolve, reject) => {
                const tx = db.transaction('customers', 'readonly');
                const store = tx.objectStore('customers');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        // Save offline sale
        async function saveOfflineSale(saleData) {
            if (!db) return null;
            return new Promise((resolve, reject) => {
                const tx = db.transaction('offlineSales', 'readwrite');
                const store = tx.objectStore('offlineSales');

                const sale = {
                    ...saleData,
                    synced: false,
                    createdAt: new Date().toISOString(),
                    tempSaleNumber: 'OFFLINE-' + Date.now()
                };

                const request = store.add(sale);
                request.onsuccess = () => {
                    sale.tempId = request.result;
                    updateOfflineCount();
                    resolve(sale);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Get pending offline sales
        async function getPendingOfflineSales() {
            if (!db) return [];
            return new Promise((resolve, reject) => {
                const tx = db.transaction('offlineSales', 'readonly');
                const store = tx.objectStore('offlineSales');
                const request = store.getAll();

                request.onsuccess = () => {
                    // Filter for unsynced sales (synced === false or synced === 0)
                    const pending = (request.result || []).filter(sale => !sale.synced);
                    resolve(pending);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Mark sale as synced
        async function markSaleSynced(tempId, serverSaleId) {
            if (!db) return;
            return new Promise((resolve, reject) => {
                const tx = db.transaction('offlineSales', 'readwrite');
                const store = tx.objectStore('offlineSales');
                const getRequest = store.get(tempId);

                getRequest.onsuccess = () => {
                    const sale = getRequest.result;
                    if (sale) {
                        sale.synced = true;
                        sale.serverSaleId = serverSaleId;
                        sale.syncedAt = new Date().toISOString();
                        store.put(sale);
                    }
                    resolve();
                };
                getRequest.onerror = () => reject(getRequest.error);
            });
        }

        // Sync offline sales to server
        async function syncOfflineSales() {
            if (!isOnline || !token) return;

            const pendingSales = await getPendingOfflineSales();
            if (pendingSales.length === 0) return;

            console.log(`[Sync] Syncing ${pendingSales.length} offline sales...`);
            updateOfflineIndicator(true, pendingSales.length);

            for (const sale of pendingSales) {
                try {
                    const response = await fetch(`${API_URL}/pos/sales`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            tillSessionId: sale.tillSessionId,
                            items: sale.items,
                            paymentMethod: sale.paymentMethod,
                            offlineCreatedAt: sale.createdAt
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        await markSaleSynced(sale.tempId, result.saleId);
                        console.log(`[Sync] Sale ${sale.tempSaleNumber} synced as ${result.saleNumber}`);
                    }
                } catch (error) {
                    console.error('[Sync] Failed to sync sale:', error);
                }
            }

            updateOfflineCount();
            showNotification('Offline sales synced successfully!', 'success');
        }

        // Update offline sale count
        async function updateOfflineCount() {
            const pending = await getPendingOfflineSales();
            const countEl = document.getElementById('syncCount');
            if (pending.length > 0) {
                countEl.textContent = `${pending.length} pending`;
                countEl.style.display = 'inline';
            } else {
                countEl.style.display = 'none';
            }
        }

        // Update offline indicator
        function updateOfflineIndicator(syncing = false, count = 0) {
            const indicator = document.getElementById('offlineIndicator');
            const icon = document.getElementById('offlineIcon');
            const text = document.getElementById('offlineText');

            if (!isOnline) {
                indicator.classList.add('show');
                indicator.classList.remove('syncing');
                icon.innerHTML = '&#9888;';
                text.textContent = 'Offline Mode - Sales will sync when online';
            } else if (syncing) {
                indicator.classList.add('show', 'syncing');
                icon.innerHTML = '&#8635;';
                text.textContent = `Syncing ${count} sales...`;
            } else {
                indicator.classList.remove('show', 'syncing');
            }
        }

        // Online/Offline event handlers
        window.addEventListener('online', async () => {
            console.log('[Network] Back online');
            isOnline = true;
            updateOfflineIndicator();
            showNotification('Connection restored! Syncing data...', 'success');

            // Sync offline sales
            await syncOfflineSales();

            // Refresh products
            await loadProducts();
        });

        window.addEventListener('offline', () => {
            console.log('[Network] Gone offline');
            isOnline = false;
            updateOfflineIndicator();
            showNotification('You are offline. Sales will be saved locally.', 'info');
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('[ServiceWorker] Registered:', registration.scope);

                    // Listen for sync messages from service worker
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        if (event.data.type === 'SYNC_SALES') {
                            syncOfflineSales();
                        }
                    });
                } catch (error) {
                    console.log('[ServiceWorker] Registration failed:', error);
                }
            });
        }

        // Initialize on page load
        window.addEventListener('load', async () => {
            await initIndexedDB();
            isOnline = navigator.onLine;
            updateOfflineIndicator();
            await updateOfflineCount();

            // ‚îÄ‚îÄ SSO Pickup from Ecosystem Dashboard ‚îÄ‚îÄ
            const ssoSource = localStorage.getItem('sso_source');
            if (ssoSource === 'ecosystem') {
                const ssoToken = localStorage.getItem('token');
                const ssoUser = localStorage.getItem('user');
                const ssoCompany = localStorage.getItem('company');
                if (ssoToken && ssoUser) {
                    try {
                        token = ssoToken;
                        currentUser = JSON.parse(ssoUser);
                        const company = ssoCompany ? JSON.parse(ssoCompany) : null;
                        if (company) {
                            selectedCompanyId = company.id;
                            currentCompanyId = company.id;
                            currentCompanyName = company.company_name || company.trading_name;
                            userRole = company.role || currentUser.role || 'admin';
                        }
                        // Clear SSO flag so refreshes use normal auth
                        localStorage.removeItem('sso_source');
                        console.log('[SSO] Ecosystem bypass ‚Äî user:', currentUser.fullName, 'company:', currentCompanyName);
                        completeLogin();
                        return; // Skip showing login screen
                    } catch (e) {
                        console.warn('[SSO] Failed to parse ecosystem data:', e);
                        localStorage.removeItem('sso_source');
                    }
                }
            }
        });

        // ========== END OFFLINE FUNCTIONALITY ==========

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (response.ok) {
                    // BYPASSED: Super admins now use the app like normal users with extra access
                    // Admin dashboard code preserved for future use
                    /*
                    if (result.isSuperAdmin) {
                        token = result.token;
                        localStorage.setItem('token', token);
                        localStorage.setItem('isSuperAdmin', 'true');
                        currentUser = result.user;
                        showSuperAdminPortal();
                        return;
                    }
                    */
                    // Store super admin flag but continue normal app flow
                    if (result.isSuperAdmin) {
                        localStorage.setItem('isSuperAdmin', 'true');
                    }

                    // Check if we need to select a company
                    if (result.requiresCompanySelection && result.companies && result.companies.length > 1) {
                        // Store temporary token for company selection
                        token = result.token;
                        localStorage.setItem('token', token);
                        currentUser = result.user;
                        availableCompanies = result.companies;

                        // Show company selector
                        document.getElementById('welcomeUserName').textContent = currentUser.fullName;
                        renderCompanyList(result.companies);
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('companySelectorScreen').style.display = 'flex';
                    } else if (result.companies && result.companies.length === 1) {
                        // Auto-select single company
                        token = result.token;
                        localStorage.setItem('token', token);
                        currentUser = result.user;
                        await selectCompanyById(result.companies[0].id);
                    } else if (result.token && !result.requiresCompanySelection) {
                        // Direct login (already has company context)
                        token = result.token;
                        localStorage.setItem('token', token);
                        currentUser = result.user;
                        userRole = result.user.role || 'cashier';
                        userPermissions = result.permissions || {};

                        completeLogin();
                    } else {
                        alert(result.error || 'No companies available');
                    }
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        function renderCompanyList(companies) {
            const listEl = document.getElementById('companyList');
            listEl.innerHTML = companies.map(company => `
                <div class="company-card" onclick="selectCompanyCard(${company.id}, this)" data-company-id="${company.id}">
                    <div>
                        <div class="company-name">${company.name}</div>
                        <div class="company-role">${company.role.replace('_', ' ')}</div>
                    </div>
                    <span class="role-badge">${company.role.replace('_', ' ')}</span>
                </div>
            `).join('');
        }

        function selectCompanyCard(companyId, element) {
            // Remove selected from all cards
            document.querySelectorAll('.company-card').forEach(card => card.classList.remove('selected'));
            // Add selected to clicked card
            element.classList.add('selected');
            selectedCompanyId = companyId;
            document.getElementById('selectCompanyBtn').disabled = false;
        }

        async function selectCompany() {
            if (!selectedCompanyId) return;
            await selectCompanyById(selectedCompanyId);
        }

        async function selectCompanyById(companyId) {
            try {
                const response = await fetch(`${API_URL}/auth/select-company`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ companyId })
                });

                const result = await response.json();

                if (response.ok) {
                    token = result.token;
                    localStorage.setItem('token', token);
                    userRole = result.role;
                    userPermissions = result.permissions || {};
                    currentCompanyId = result.company.id;
                    currentCompanyName = result.company.company_name;

                    document.getElementById('companySelectorScreen').style.display = 'none';
                    completeLogin();
                } else {
                    // Handle subscription errors
                    if (result.subscriptionStatus === 'suspended') {
                        alert('Company Suspended\\n\\nYour company subscription has been suspended. Please contact support to reactivate.');
                    } else if (result.subscriptionStatus === 'pending') {
                        alert('Pending Approval\\n\\nYour company registration is still pending approval. Please wait for activation.');
                    } else {
                        alert(result.error || 'Failed to select company');
                    }
                }
            } catch (error) {
                alert('Error selecting company: ' + error.message);
            }
        }

        function completeLogin() {
            document.getElementById('userName').textContent = currentUser.fullName + (userRole ? ` (${userRole.replace('_', ' ')})` : '');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';

            // Apply role-based visibility
            applyRoleBasedVisibility();

            loadProducts();
            checkSession();
            showTab('till');
        }

        function applyRoleBasedVisibility() {
            // Get all nav tabs
            const reportsTab = document.querySelector('.nav-tab[onclick*="reports"]');
            const settingsTab = document.querySelector('.nav-tab[onclick*="settings"]');

            // Hide reports for admin and cashier (they can't see profit/sales/VAT reports)
            if (userRole === 'admin' || userRole === 'cashier') {
                if (reportsTab) reportsTab.classList.add('role-hidden');
            }

            // Hide settings for cashier
            if (userRole === 'cashier') {
                if (settingsTab) settingsTab.classList.add('role-hidden');
            }

            // Show reports for cashup only if admin
            // (Admins CAN see cash-up reports, but not sales/profit/VAT)
        }

        function logoutFromCompanySelector() {
            token = null;
            localStorage.removeItem('token');
            currentUser = null;
            availableCompanies = [];
            selectedCompanyId = null;
            document.getElementById('companySelectorScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }

        function logout() {
            token = null;
            localStorage.removeItem('token');
            currentUser = null;
            currentSession = null;
            userRole = null;
            userPermissions = {};
            availableCompanies = [];
            selectedCompanyId = null;

            // Reset role-based visibility
            document.querySelectorAll('.role-hidden').forEach(el => el.classList.remove('role-hidden'));

            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }

        async function checkSession() {
            try {
                const response = await fetch(`${API_URL}/pos/sessions?status=open`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (result.sessions && result.sessions.length > 0) {
                    currentSession = result.sessions[0];
                    document.getElementById('sessionStatus').textContent = 'Till Open';
                    document.getElementById('checkoutBtn').disabled = cart.length === 0;
                } else {
                    document.getElementById('sessionStatus').textContent = 'No Session';
                    showNotification('Please open a till session', 'error');
                }
            } catch (error) {
                console.error('Session check error:', error);
            }
        }

        async function manageSession() {
            if (currentSession) {
                const close = confirm('Close current till session?');
                if (close) {
                    const balance = prompt('Enter closing balance:');
                    if (balance !== null) {
                        try {
                            const response = await fetch(`${API_URL}/pos/sessions/${currentSession.id}/close`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ closingBalance: parseFloat(balance), notes: 'Manual close' })
                            });

                            const result = await response.json();
                            if (response.ok) {
                                showNotification(`Session closed. Variance: R ${result.variance.toFixed(2)}`, 'success');
                                currentSession = null;
                                document.getElementById('sessionStatus').textContent = 'No Session';
                                document.getElementById('checkoutBtn').disabled = true;
                            } else {
                                showNotification(result.error || 'Error closing session', 'error');
                            }
                        } catch (error) {
                            showNotification('Error closing session', 'error');
                        }
                    }
                }
            } else {
                const balance = prompt('Enter opening balance:', '0');
                if (balance !== null) {
                    try {
                        const tillsResponse = await fetch(`${API_URL}/pos/tills`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const tillsResult = await tillsResponse.json();

                        if (tillsResult.tills.length === 0) {
                            showNotification('No tills available', 'error');
                            return;
                        }

                        const response = await fetch(`${API_URL}/pos/sessions/open`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                tillId: tillsResult.tills[0].id,
                                openingBalance: parseFloat(balance)
                            })
                        });

                        const result = await response.json();
                        if (response.ok) {
                            showNotification('Session opened', 'success');
                            await checkSession();
                        } else {
                            showNotification(result.error || 'Error opening session', 'error');
                        }
                    } catch (error) {
                        showNotification('Error opening session', 'error');
                    }
                }
            }
        }

        async function loadProducts() {
            try {
                // Try to load from server if online
                if (isOnline) {
                    const response = await fetch(`${API_URL}/pos/products`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    products = result.products;

                    // Cache products in IndexedDB for offline use
                    await cacheProducts(products);
                    console.log('[Products] Cached', products.length, 'products for offline');
                } else {
                    // Load from IndexedDB cache when offline
                    products = await getCachedProducts();
                    console.log('[Products] Loaded', products.length, 'cached products (offline)');

                    if (products.length === 0) {
                        showNotification('No cached products available offline', 'error');
                    }
                }

                // Extract categories
                categories = new Set(['all']);
                products.forEach(p => {
                    if (p.category) categories.add(p.category);
                });

                renderCategories();
                displayProductsGrid(products);
                displayProductsTable(products);
            } catch (error) {
                console.error('Error loading products:', error);

                // Fallback to cached products on error
                try {
                    products = await getCachedProducts();
                    if (products.length > 0) {
                        console.log('[Products] Using cached products after error');
                        categories = new Set(['all']);
                        products.forEach(p => {
                            if (p.category) categories.add(p.category);
                        });
                        renderCategories();
                        displayProductsGrid(products);
                        displayProductsTable(products);
                        showNotification('Using cached products (offline mode)', 'info');
                    }
                } catch (cacheError) {
                    console.error('Error loading cached products:', cacheError);
                }
            }
        }

        // Cash Up Functions
        let currentSessionData = null;

        async function loadCashUpSession() {
            // Load pending cashups first
            await loadPendingCashups();

            try {
                // Get current session
                const sessionResponse = await fetch(`${API_URL}/pos/sessions/current`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const sessionResult = await sessionResponse.json();

                if (!sessionResult.session) {
                    // No active session - show message but don't error (pending cashups may still be visible)
                    document.getElementById('sessionInfo').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p style="font-size: 18px; margin: 0;">No active till session</p>
                            <p style="opacity: 0.8; margin-top: 10px;">Open a till session to see cash up details</p>
                        </div>
                    `;
                    return;
                }

                currentSessionData = sessionResult.session;

                // Get sales for this session
                const salesResponse = await fetch(`${API_URL}/pos/sales?session_id=${currentSessionData.id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const salesResult = await salesResponse.json();

                // Calculate totals
                let totalSales = 0;
                let cashSales = 0;
                let cardSales = 0;
                let accountSales = 0;

                salesResult.sales.forEach(sale => {
                    totalSales += sale.total_amount;
                    if (sale.payment_method === 'CASH') cashSales += sale.total_amount;
                    if (sale.payment_method === 'CARD') cardSales += sale.total_amount;
                    if (sale.payment_method === 'ACCOUNT') accountSales += sale.total_amount;
                });

                // Update UI
                document.getElementById('cashUpSessionId').textContent = `Till ${currentSessionData.till_id}`;
                document.getElementById('cashUpUser').textContent = currentUser;
                document.getElementById('cashUpOpeningBalance').textContent = `R ${parseFloat(currentSessionData.opening_balance).toFixed(2)}`;

                const openTime = new Date(currentSessionData.opened_at);
                document.getElementById('cashUpOpenedAt').textContent = openTime.toLocaleString();

                document.getElementById('cashUpTotalSales').textContent = `R ${totalSales.toFixed(2)}`;
                document.getElementById('cashUpSalesCount').textContent = `${salesResult.sales.length} transactions`;

                const expectedCash = parseFloat(currentSessionData.opening_balance) + cashSales;
                document.getElementById('cashUpExpectedCash').textContent = `R ${expectedCash.toFixed(2)}`;
                document.getElementById('expectedCashAmount').textContent = `R ${expectedCash.toFixed(2)}`;

                document.getElementById('cashSales').textContent = `R ${cashSales.toFixed(2)}`;
                document.getElementById('cardSales').textContent = `R ${cardSales.toFixed(2)}`;
                document.getElementById('accountSales').textContent = `R ${accountSales.toFixed(2)}`;

                // Reset denomination inputs
                resetDenominations();

            } catch (error) {
                console.error('Error loading cash up session:', error);
                showNotification('Error loading session data', 'error');
            }
        }

        async function loadPendingCashups() {
            try {
                const response = await fetch(`${API_URL}/pos/sessions/pending-cashup`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                const section = document.getElementById('pendingCashupsSection');
                const list = document.getElementById('pendingCashupsList');

                if (result.sessions && result.sessions.length > 0) {
                    section.style.display = 'block';
                    list.innerHTML = result.sessions.map(session => `
                        <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; color: #333;">
                                    ${session.till_name} - ${session.user_name}
                                </div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">
                                    Opened: ${new Date(session.opened_at).toLocaleString()} |
                                    Sales: R ${parseFloat(session.total_sales || 0).toFixed(2)} (${session.sale_count} transactions) |
                                    Expected: R ${parseFloat(session.expected_balance || 0).toFixed(2)}
                                </div>
                            </div>
                            <button onclick="showPendingCashupModal(${session.id}, ${session.expected_balance || 0})"
                                    style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                Complete Cashup
                            </button>
                        </div>
                    `).join('');
                } else {
                    section.style.display = 'none';
                    list.innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading pending cashups:', error);
            }
        }

        function showPendingCashupModal(sessionId, expectedBalance) {
            const countedAmount = prompt(
                `Complete Cashup for Session #${sessionId}\n\n` +
                `Expected Amount: R ${parseFloat(expectedBalance).toFixed(2)}\n\n` +
                `Enter the actual cash counted:`
            );

            if (countedAmount === null) return;

            const counted = parseFloat(countedAmount);
            if (isNaN(counted)) {
                showNotification('Please enter a valid number', 'error');
                return;
            }

            const variance = counted - expectedBalance;
            const notes = prompt(
                `Variance: R ${variance.toFixed(2)} (${variance >= 0 ? 'Over' : 'Short'})\n\n` +
                `Add any notes (optional):`
            ) || '';

            completePendingCashup(sessionId, counted, notes);
        }

        async function completePendingCashup(sessionId, closingBalance, notes) {
            try {
                const response = await fetch(`${API_URL}/pos/sessions/${sessionId}/complete-cashup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        closing_balance: closingBalance,
                        notes: notes
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`Cashup completed. Variance: R ${result.variance.toFixed(2)}`, 'success');
                    await loadPendingCashups(); // Refresh the list
                } else {
                    showNotification(result.error || 'Failed to complete cashup', 'error');
                }
            } catch (error) {
                showNotification('Error completing cashup: ' + error.message, 'error');
            }
        }

        function resetDenominations() {
            document.getElementById('note200').value = '0';
            document.getElementById('note100').value = '0';
            document.getElementById('note50').value = '0';
            document.getElementById('note20').value = '0';
            document.getElementById('note10').value = '0';
            document.getElementById('coin5').value = '0';
            document.getElementById('coin2').value = '0';
            document.getElementById('coin1').value = '0';
            document.getElementById('coin050').value = '0';
            document.getElementById('coin020').value = '0';
            document.getElementById('coin010').value = '0';
            
            document.getElementById('total200').textContent = 'R0.00';
            document.getElementById('total100').textContent = 'R0.00';
            document.getElementById('total50').textContent = 'R0.00';
            document.getElementById('total20').textContent = 'R0.00';
            document.getElementById('total10').textContent = 'R0.00';
            document.getElementById('total5').textContent = 'R0.00';
            document.getElementById('total2').textContent = 'R0.00';
            document.getElementById('total1').textContent = 'R0.00';
            document.getElementById('total050').textContent = 'R0.00';
            document.getElementById('total020').textContent = 'R0.00';
            document.getElementById('total010').textContent = 'R0.00';
            
            document.getElementById('totalCountedDisplay').textContent = 'R0.00';
            document.getElementById('varianceInfo').style.display = 'none';
        }

        function calculateCashTotal() {
            const denominations = [
                { id: 'note200', value: 200 },
                { id: 'note100', value: 100 },
                { id: 'note50', value: 50 },
                { id: 'note20', value: 20 },
                { id: 'note10', value: 10 },
                { id: 'coin5', value: 5 },
                { id: 'coin2', value: 2 },
                { id: 'coin1', value: 1 },
                { id: 'coin050', value: 0.50 },
                { id: 'coin020', value: 0.20 },
                { id: 'coin010', value: 0.10 }
            ];

            let totalCounted = 0;

            denominations.forEach(denom => {
                const qty = parseInt(document.getElementById(denom.id).value) || 0;
                const total = qty * denom.value;
                totalCounted += total;
                
                // Update individual total
                const totalId = 'total' + denom.id.replace('note', '').replace('coin', '');
                document.getElementById(totalId).textContent = `R${total.toFixed(2)}`;
            });

            // Update total counted
            document.getElementById('totalCountedDisplay').textContent = `R${totalCounted.toFixed(2)}`;

            // Calculate variance
            const expectedText = document.getElementById('expectedCashAmount').textContent;
            const expectedCash = parseFloat(expectedText.replace('R', ''));
            const variance = totalCounted - expectedCash;

            // Show variance
            const varianceDiv = document.getElementById('varianceInfo');
            const varianceAmount = document.getElementById('varianceAmount');
            
            varianceDiv.style.display = 'block';
            varianceAmount.textContent = `R${Math.abs(variance).toFixed(2)}`;
            
            if (variance > 0) {
                varianceAmount.className = 'variance-positive';
                document.getElementById('varianceLabel').textContent = 'Over:';
            } else if (variance < 0) {
                varianceAmount.className = 'variance-negative';
                document.getElementById('varianceLabel').textContent = 'Short:';
            } else {
                varianceAmount.className = '';
                document.getElementById('varianceLabel').textContent = 'Balanced:';
            }

            return totalCounted;
        }

        async function completeCashUp() {
            if (!currentSessionData) {
                showNotification('No active session', 'error');
                return;
            }

            const totalCounted = calculateCashTotal();
            const notes = document.getElementById('cashUpNotes').value;

            const expectedText = document.getElementById('expectedCashAmount').textContent;
            const expectedCash = parseFloat(expectedText.replace('R', ''));
            const variance = totalCounted - expectedCash;

            const confirmed = confirm(
                `Complete cash up and close till?\n\n` +
                `Counted: R${totalCounted.toFixed(2)}\n` +
                `Expected: R${expectedCash.toFixed(2)}\n` +
                `Variance: R${variance.toFixed(2)}\n\n` +
                `This will close the till session.`
            );

            if (!confirmed) return;

            try {
                const response = await fetch(`${API_URL}/pos/sessions/${currentSessionData.id}/close`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        closing_balance: totalCounted,
                        expected_balance: expectedCash,
                        variance: variance,
                        notes: notes
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Till session closed successfully', 'success');
                    currentSessionData = null;
                    showTab('till');
                } else {
                    showNotification(result.error || 'Error closing session', 'error');
                }
            } catch (error) {
                console.error('Error completing cash up:', error);
                showNotification('Error closing session', 'error');
            }
        }

        function cancelCashUp() {
            if (confirm('Cancel cash up and return to Till?')) {
                showTab('till');
            }
        }


        function renderCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = '';

            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn' + (cat === selectedCategory ? ' active' : '');
                btn.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                btn.onclick = () => filterByCategory(cat);
                container.appendChild(btn);
            });
        }

        function filterByCategory(category) {
            selectedCategory = category;
            renderCategories();
            const filtered = selectedCategory === 'all'
                ? products
                : products.filter(p => p.category === selectedCategory);
            displayProductsGrid(filtered);
        }

        function displayProductsGrid(productsToShow) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';

            productsToShow.forEach(product => {
                const tile = document.createElement('div');
                tile.className = 'product-tile';
                tile.onclick = () => addToCart(product);

                tile.innerHTML = `
                    <div class="product-name">${product.product_name}</div>
                    <div class="product-price">R ${parseFloat(product.unit_price).toFixed(2)}</div>
                    <div class="product-stock">Stock: ${product.stock_quantity}</div>
                `;

                grid.appendChild(tile);
            });
        }

        function displayProductsTable(productsToShow) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            document.getElementById('productCount').textContent = `${productsToShow.length} Products`;

            productsToShow.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" style="cursor:pointer;">${product.product_code}</td>
                    <td onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" style="cursor:pointer;">${product.product_name}</td>
                    <td onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" style="cursor:pointer;">${product.category || '-'}</td>
                    <td onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" style="cursor:pointer;">R ${parseFloat(product.unit_price).toFixed(2)}</td>
                    <td onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" style="cursor:pointer;">${product.stock_quantity || product.current_stock || 0}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding:4px 10px;font-size:11px;"
                            onclick="event.stopPropagation(); showProductStockModal(${product.id}, '${(product.product_name || '').replace(/'/g, "\\'")}', '${product.product_code}')">
                            Manage
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function searchProducts() {
            const query = document.getElementById('productSearch').value.toLowerCase();
            const filtered = products.filter(p =>
                p.product_name.toLowerCase().includes(query) ||
                p.product_code.toLowerCase().includes(query)
            );
            displayProductsTable(filtered);
        }

        // Barcode scanning
        document.addEventListener('DOMContentLoaded', function() {
            const barcodeInput = document.getElementById('barcodeInput');
            if (barcodeInput) {
                let barcodeTimeout = null;

                barcodeInput.addEventListener('input', function(e) {
                    const value = e.target.value;

                    clearTimeout(barcodeTimeout);

                    if (/^\d{8,}$/.test(value)) {
                        barcodeTimeout = setTimeout(() => searchByBarcode(value), 300);
                    } else if (value.length >= 2) {
                        barcodeTimeout = setTimeout(() => searchByName(value), 300);
                    }
                });

                barcodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const value = e.target.value;
                        if (/^\d{8,}$/.test(value)) {
                            searchByBarcode(value);
                        }
                    }
                });
            }

            // Calculate profit when cost or price changes
            const costInput = document.getElementById('productCost');
            const priceInput = document.getElementById('productPrice');
            const profitInput = document.getElementById('productGrossProfit');
            const profitPercentInput = document.getElementById('productGrossProfitPercent');

            function calculateProfit() {
                const cost = parseFloat(costInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const profit = price - cost;
                const profitPercent = cost > 0 ? ((profit / cost) * 100) : 0;

                profitInput.value = profit.toFixed(4);
                profitPercentInput.value = profitPercent.toFixed(2);
            }

            if (costInput && priceInput) {
                costInput.addEventListener('input', calculateProfit);
                priceInput.addEventListener('input', calculateProfit);
            }
        });

        function searchByBarcode(barcode) {
            const product = products.find(p => p.product_code === barcode);
            if (product) {
                addToCart(product);
                document.getElementById('barcodeInput').value = '';
                showNotification(`Added: ${product.product_name}`, 'success');
            } else {
                showNotification('Product not found', 'error');
            }
        }

        function searchByName(query) {
            const filtered = products.filter(p =>
                p.product_name.toLowerCase().includes(query.toLowerCase()) ||
                p.product_code.toLowerCase().includes(query.toLowerCase())
            );

            displayProductsGrid(filtered);
        }

        function addToCart(product) {
            const existing = cart.find(item => item.productId === product.id);

            if (existing) {
                if (existing.quantity < product.stock_quantity) {
                    existing.quantity++;
                } else {
                    showNotification('Not enough stock', 'error');
                    return;
                }
            } else {
                cart.push({
                    productId: product.id,
                    name: product.product_name,
                    price: product.unit_price,
                    quantity: 1,
                    maxStock: product.stock_quantity
                });
            }

            updateCart();
            setTimeout(() => {
                const input = document.getElementById('barcodeInput');
                if (input) input.focus();
            }, 100);
        }

        function updateCart() {
            const container = document.getElementById('cartItems');

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <p>üõí Cart is empty</p>
                        <p style="font-size: 14px;">Scan or click products to add</p>
                    </div>
                `;
                document.getElementById('checkoutBtn').disabled = true;
            } else {
                container.innerHTML = '';

                cart.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cart-item';
                    itemDiv.innerHTML = `
                        <div class="cart-item-header">
                            <div class="item-name">${item.name}</div>
                            <button class="item-remove" onclick="removeItem(${item.productId})">‚úï</button>
                        </div>
                        <div class="cart-item-controls">
                            <div class="qty-controls">
                                <button class="qty-btn" onclick="updateQty(${item.productId}, -1)">-</button>
                                <span class="qty-display">${item.quantity}</span>
                                <button class="qty-btn" onclick="updateQty(${item.productId}, 1)">+</button>
                            </div>
                            <div class="item-total">R ${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });

                document.getElementById('checkoutBtn').disabled = !currentSession;
            }

            // Update totals
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const vat = subtotal * 0.15;
            const total = subtotal + vat;

            document.getElementById('subtotal').textContent = `R ${subtotal.toFixed(2)}`;
            document.getElementById('vat').textContent = `R ${vat.toFixed(2)}`;
            document.getElementById('total').textContent = `R ${total.toFixed(2)}`;
            document.getElementById('cartItemCount').textContent = `${cart.length} items`;

            // Update split payment remaining if active
            if (splitPaymentMode) {
                updateSplitRemaining();
            }
        }

        function updateQty(productId, change) {
            const item = cart.find(i => i.productId === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeItem(productId);
                } else if (item.quantity > item.maxStock) {
                    item.quantity = item.maxStock;
                    showNotification('Maximum stock reached', 'error');
                }
                updateCart();
            }
        }

        function removeItem(productId) {
            cart = cart.filter(item => item.productId !== productId);
            updateCart();
        }

        function clearCart() {
            if (cart.length > 0 && confirm('Clear all items?')) {
                cart = [];
                updateCart();
            }
        }

        let selectedAccountCustomerId = null;

        function selectPayment(method, btnEl) {
            selectedPayment = method;
            document.querySelectorAll('.payment-btn:not(#splitPaymentBtn)').forEach(btn => {
                btn.classList.remove('selected');
            });
            if (btnEl) btnEl.classList.add('selected');

            // Close split payment if open
            if (splitPaymentMode) {
                splitPaymentMode = false;
                document.getElementById('splitPaymentSection').classList.remove('active');
                document.getElementById('splitPaymentBtn').classList.remove('selected');
            }

            // Show/hide account customer selector
            const accountSection = document.getElementById('accountCustomerSection');
            if (method === 'ACCOUNT') {
                accountSection.style.display = 'block';
            } else {
                accountSection.style.display = 'none';
                selectedAccountCustomerId = null;
            }
        }

        async function searchAccountCustomers(query) {
            if (!query || query.length < 2) {
                document.getElementById('accountCustomerResults').innerHTML = '';
                return;
            }
            try {
                const res = await fetch(`${API_URL}/customers/search?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const customers = data.customers || [];
                const container = document.getElementById('accountCustomerResults');
                if (customers.length === 0) {
                    container.innerHTML = '<div style="padding:8px;color:#999;font-size:13px;">No customers found</div>';
                    return;
                }
                container.innerHTML = customers.slice(0, 5).map(c => `
                    <div onclick="selectAccountCustomer(${c.id}, '${(c.name || '').replace(/'/g, "\\'")}', ${c.current_balance || 0}, ${c.credit_limit || 0})"
                         style="padding:8px 10px;cursor:pointer;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;font-size:13px;"
                         onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='transparent'">
                        <div><strong>${c.name}</strong> ${c.phone ? '(' + c.phone + ')' : ''}</div>
                        <div style="color:#666;">Bal: R ${parseFloat(c.current_balance || 0).toFixed(2)} / R ${parseFloat(c.credit_limit || 0).toFixed(2)}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error searching account customers:', e);
            }
        }

        function selectAccountCustomer(id, name, balance, limit) {
            selectedAccountCustomerId = id;
            document.getElementById('accountCustomerResults').innerHTML = '';
            document.getElementById('accountCustomerSearch').value = '';
            document.getElementById('selectedAccountCustomer').style.display = 'block';
            document.getElementById('selectedAccountName').textContent = name;
            document.getElementById('selectedAccountBalance').textContent = `Balance: R ${parseFloat(balance).toFixed(2)} / Limit: R ${parseFloat(limit).toFixed(2)}`;
        }

        let lastSaleId = null;
        let autoPrintEnabled = false;

        async function checkout() {
            if (cart.length === 0 || !currentSession) {
                showNotification('Cart is empty or no session open', 'error');
                return;
            }

            // Calculate totals for offline mode
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const vatAmount = subtotal * 0.15;
            const totalAmount = subtotal + vatAmount;

            const saleData = {
                tillSessionId: currentSession.id,
                items: cart.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity,
                    productName: item.name,
                    unitPrice: item.price,
                    totalPrice: item.price * item.quantity
                })),
                paymentMethod: selectedPayment,
                subtotal,
                vatAmount,
                totalAmount
            };

            // If offline, save to IndexedDB
            if (!isOnline) {
                try {
                    const offlineSale = await saveOfflineSale(saleData);

                    // Update local stock (decrease quantities)
                    for (const item of cart) {
                        const product = products.find(p => p.id === item.productId);
                        if (product) {
                            product.current_stock = Math.max(0, (product.current_stock || 0) - item.quantity);
                        }
                    }
                    await cacheProducts(products);

                    // Show offline sale complete modal
                    showOfflineSaleModal(offlineSale);

                    cart = [];
                    updateCart();
                    displayProductsGrid(products);

                    // Print receipt (browser dialog)
                    if (autoPrintEnabled) {
                        printOfflineReceipt(offlineSale);
                    }
                } catch (error) {
                    showNotification('Failed to save offline sale: ' + error.message, 'error');
                }
                return;
            }

            // Online mode - send to server
            try {
                const response = await fetch(`${API_URL}/pos/sales`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tillSessionId: currentSession.id,
                        items: cart.map(item => ({
                            productId: item.productId,
                            quantity: item.quantity
                        })),
                        paymentMethod: selectedPayment,
                        customerId: selectedAccountCustomerId || undefined
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    lastSaleId = result.saleId;

                    // Show sale complete modal with print option
                    showSaleCompleteModal(result);

                    cart = [];
                    updateCart();
                    await loadProducts();

                    // Auto-print if enabled
                    if (autoPrintEnabled && lastSaleId) {
                        printReceipt(lastSaleId);
                    }
                } else {
                    showNotification(result.error || 'Checkout failed', 'error');
                }
            } catch (error) {
                // Network error - try offline save
                console.log('[Checkout] Network error, saving offline:', error);
                try {
                    const offlineSale = await saveOfflineSale(saleData);
                    showOfflineSaleModal(offlineSale);
                    cart = [];
                    updateCart();
                    showNotification('Sale saved offline - will sync when online', 'info');
                } catch (offlineError) {
                    showNotification('Checkout failed: ' + error.message, 'error');
                }
            }
        }

        function showOfflineSaleModal(sale) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'saleCompleteModal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header" style="background: #ff9800; color: white;">
                        <h2 style="margin: 0;">Sale Saved (Offline)</h2>
                        <button class="close-btn" onclick="closeSaleCompleteModal()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 30px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">&#9888;</div>
                        <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">#${sale.tempSaleNumber}</div>
                        <div style="font-size: 32px; font-weight: bold; color: #ff9800; margin-bottom: 20px;">R ${sale.totalAmount.toFixed(2)}</div>
                        <div style="color: #666; margin-bottom: 10px;">Payment: ${sale.paymentMethod}</div>
                        <div style="background: #fff3e0; padding: 10px; border-radius: 8px; color: #e65100; font-size: 13px; margin-bottom: 20px;">
                            This sale is saved locally and will sync automatically when internet is restored.
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-primary" onclick="printOfflineReceipt(${JSON.stringify(sale).replace(/"/g, '&quot;')})" style="padding: 15px 30px; font-size: 16px;">
                                Print Receipt
                            </button>
                            <button class="btn btn-secondary" onclick="closeSaleCompleteModal()" style="padding: 15px 30px; font-size: 16px;">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showSaleCompleteModal(sale) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'saleCompleteModal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal" style="max-width: 450px;">
                    <div class="modal-header" style="background: #10b981; color: white;">
                        <h2 style="margin: 0;">Sale Complete!</h2>
                        <button class="close-btn" onclick="closeSaleCompleteModal()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 25px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">&#10003;</div>
                        <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">#${sale.saleNumber}</div>
                        <div style="font-size: 32px; font-weight: bold; color: #10b981; margin-bottom: 15px;">R ${sale.totalAmount.toFixed(2)}</div>
                        <div style="color: #666; margin-bottom: 20px;">Payment: ${selectedPayment}</div>
                        
                        <div style="background:#f8f9fa;border-radius:10px;padding:15px;text-align:left;margin-bottom:15px;">
                            <div style="font-weight:600;margin-bottom:10px;color:#333;">Send Receipt</div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                                <button class="btn btn-primary" onclick="deliverReceipt(${sale.saleId}, 'print')" style="padding:10px;font-size:13px;">
                                    &#128424; Print
                                </button>
                                <button class="btn btn-secondary" onclick="showEmailReceiptInput(${sale.saleId})" style="padding:10px;font-size:13px;">
                                    &#9993; Email
                                </button>
                                <button class="btn btn-secondary" onclick="showSmsReceiptInput(${sale.saleId})" style="padding:10px;font-size:13px;">
                                    &#128172; SMS
                                </button>
                                <button class="btn btn-secondary" onclick="showWhatsAppReceiptInput(${sale.saleId})" style="padding:10px;font-size:13px;">
                                    &#128242; WhatsApp
                                </button>
                            </div>
                            <div id="receiptDeliveryInput" style="margin-top:10px;display:none;">
                                <div style="display:flex;gap:8px;">
                                    <input type="text" id="receiptDeliveryValue" placeholder="" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;">
                                    <button class="btn btn-primary" onclick="sendReceiptDelivery(${sale.saleId})" style="padding:8px 15px;">Send</button>
                                </div>
                            </div>
                            <div id="receiptDeliveryStatus" style="margin-top:8px;font-size:12px;"></div>
                        </div>

                        <button class="btn btn-secondary" onclick="closeSaleCompleteModal()" style="padding: 12px 30px; font-size: 16px; width:100%;">
                            Done
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeSaleCompleteModal() {
            const modal = document.getElementById('saleCompleteModal');
            if (modal) {
                modal.remove();
            }
            const input = document.getElementById('barcodeInput');
            if (input) input.focus();
        }

        async function printReceipt(saleId) {
            // If offline, get receipt preview and use browser print
            if (!isOnline) {
                showNotification('Offline - using browser print dialog', 'info');
                try {
                    // Try to get cached sale or generate basic receipt
                    const response = await fetch(`${API_URL}/receipts/preview/${saleId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const result = await response.json();
                        printBrowserReceipt(result.receiptHtml);
                    }
                } catch (e) {
                    showNotification('Cannot print offline - sale not cached', 'error');
                }
                return;
            }

            try {
                showNotification('Preparing receipt...', 'info');

                const response = await fetch(`${API_URL}/receipts/print/${saleId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ open_drawer: true })
                });

                const result = await response.json();

                if (result.success && result.method === 'thermal') {
                    showNotification('Receipt sent to thermal printer!', 'success');
                    closeSaleCompleteModal();
                } else if (result.receiptHtml) {
                    // Use browser print dialog - shows all installed printers
                    showNotification('Opening print dialog...', 'info');
                    printBrowserReceipt(result.receiptHtml);
                    closeSaleCompleteModal();
                } else {
                    showNotification(result.error || 'Print failed', 'error');
                }
            } catch (error) {
                // Network error - try to get preview for browser print
                try {
                    const previewResponse = await fetch(`${API_URL}/receipts/preview/${saleId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (previewResponse.ok) {
                        const preview = await previewResponse.json();
                        printBrowserReceipt(preview.receiptHtml);
                        closeSaleCompleteModal();
                    } else {
                        showNotification('Print error: ' + error.message, 'error');
                    }
                } catch (e) {
                    showNotification('Print error: ' + error.message, 'error');
                }
            }
        }

        function printBrowserReceipt(html) {
            const printWindow = window.open('', '_blank', 'width=400,height=600');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        async function printLastReceipt() {
            if (lastSaleId) {
                await printReceipt(lastSaleId);
            } else {
                showNotification('No recent sale to print', 'error');
            }
        }

        // Print receipt for offline sales (browser print dialog - shows all installed printers)
        function printOfflineReceipt(sale) {
            // Handle if sale is passed as string (from onclick)
            if (typeof sale === 'string') {
                try {
                    sale = JSON.parse(sale);
                } catch (e) {
                    showNotification('Error parsing sale data', 'error');
                    return;
                }
            }

            const html = generateOfflineReceiptHtml(sale);
            printBrowserReceipt(html);
            closeSaleCompleteModal();
        }

        function generateOfflineReceiptHtml(sale) {
            const formatCurrency = (amt) => 'R ' + parseFloat(amt || 0).toFixed(2);
            const now = new Date();

            let itemsHtml = '';
            if (sale.items && sale.items.length > 0) {
                sale.items.forEach(item => {
                    itemsHtml += `
                        <div>
                            <div class="item-name">${item.productName || 'Item'}</div>
                            <div class="item-detail">
                                <span>${item.quantity} x ${formatCurrency(item.unitPrice)}</span>
                                <span>${formatCurrency(item.totalPrice)}</span>
                            </div>
                        </div>`;
                });
            }

            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Receipt ${sale.tempSaleNumber}</title>
    <style>
        @page { margin: 0; size: 80mm auto; }
        @media print {
            body { margin: 0; }
        }
        body {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            width: 80mm;
            margin: 0 auto;
            padding: 5mm;
        }
        .center { text-align: center; }
        .bold { font-weight: bold; }
        .header { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .line { border-top: 1px dashed #000; margin: 5px 0; }
        .double-line { border-top: 2px solid #000; margin: 5px 0; }
        .row { display: flex; justify-content: space-between; }
        .item-name { margin-bottom: 2px; }
        .item-detail { padding-left: 10px; display: flex; justify-content: space-between; }
        .total-row { font-size: 14px; font-weight: bold; }
        .footer { margin-top: 10px; font-size: 10px; }
        .offline-notice { background: #fff3e0; padding: 5px; margin: 5px 0; font-size: 10px; }
    </style>
</head>
<body>
    <div class="center">
        <div class="header">CHECKOUT CHARLIE</div>
        <div class="offline-notice">** OFFLINE RECEIPT **</div>
    </div>

    <div class="double-line"></div>

    <div>
        <div class="row"><span>Receipt:</span><span>${sale.tempSaleNumber}</span></div>
        <div class="row"><span>Date:</span><span>${now.toLocaleDateString('en-ZA')} ${now.toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' })}</span></div>
    </div>

    <div class="line"></div>

    <div class="bold">
        <div class="row"><span>Item</span><span>Amount</span></div>
    </div>

    <div class="line"></div>

    ${itemsHtml}

    <div class="line"></div>

    <div class="row"><span>Subtotal:</span><span>${formatCurrency(sale.subtotal)}</span></div>
    <div class="row"><span>VAT (15%):</span><span>${formatCurrency(sale.vatAmount)}</span></div>

    <div class="total-row row"><span>TOTAL:</span><span>${formatCurrency(sale.totalAmount)}</span></div>

    <div class="line"></div>

    <div class="row"><span>Payment:</span><span>${(sale.paymentMethod || 'Cash').toUpperCase()}</span></div>

    <div class="double-line"></div>

    <div class="center footer">
        Thank you for your purchase!<br>
        Please come again<br><br>
        ** This receipt was generated offline **<br>
        Will sync when connection restored
    </div>
</body>
</html>`;
        }

        function showTab(tab, evt) {
            currentTab = tab;

            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            // Add active class to the clicked tab if event is provided
            if (evt && evt.target) {
                evt.target.classList.add('active');
            } else {
                // If no event (called programmatically), find and activate the correct tab
                const tabs = document.querySelectorAll('.nav-tab');
                tabs.forEach(t => {
                    if (t.textContent.toLowerCase().includes(tab.toLowerCase())) {
                        t.classList.add('active');
                    }
                });
            }

            // Hide all sections
            document.getElementById('tillInterface').style.display = 'none';
            document.getElementById('settingsLayout').style.display = 'none';
            document.getElementById('reportsLayout').style.display = 'none';
            document.getElementById('cashUpLayout').style.display = 'none';
            // Hide enterprise sections
            document.getElementById('dashboardLayout').style.display = 'none';
            document.getElementById('loyaltyLayout').style.display = 'none';

            // Show appropriate section
            if (tab === 'till') {
                document.getElementById('tillInterface').style.display = 'block';
                setTimeout(() => {
                    const input = document.getElementById('barcodeInput');
                    if (input) input.focus();
                }, 100);
            } else if (tab === 'settings') {
                document.getElementById('settingsLayout').style.display = 'block';
            } else if (tab === 'reports') {
                document.getElementById('reportsLayout').style.display = 'block';
                loadCurrentReport();
            } else if (tab === 'cashup') {
                document.getElementById('cashUpLayout').style.display = 'block';
                loadCashUpSession();
            } else if (tab === 'dashboard') {
                document.getElementById('dashboardLayout').style.display = 'block';
                loadDashboard();
            } else if (tab === 'loyalty') {
                document.getElementById('loyaltyLayout').style.display = 'block';
                loadLoyaltyPrograms();
            } else {
                alert(`${tab.charAt(0).toUpperCase() + tab.slice(1)} section - To be implemented`);
            }
        }

        function showSettings(section, evt) {
            document.querySelectorAll('.settings-menu-item').forEach(item => {
                item.classList.remove('active');
            });

            if (evt && evt.target) {
                evt.target.classList.add('active');
            }

            // Hide all settings sections
            document.getElementById('productsSection').style.display = 'none';
            document.getElementById('companiesSection').style.display = 'none';
            document.getElementById('usersSection').style.display = 'none';
            document.getElementById('customersSection').style.display = 'none';
            const receiptPrintersSection = document.getElementById('receipt-printersSection');
            if (receiptPrintersSection) receiptPrintersSection.style.display = 'none';
            const generalSection = document.getElementById('generalSection');
            if (generalSection) generalSection.style.display = 'none';

            if (section === 'products') {
                document.getElementById('productsSection').style.display = 'block';
            } else if (section === 'companies') {
                document.getElementById('companiesSection').style.display = 'block';
                loadCompanies();
            } else if (section === 'users') {
                document.getElementById('usersSection').style.display = 'block';
                loadCompaniesForUserFilter();
            } else if (section === 'customers') {
                document.getElementById('customersSection').style.display = 'block';
                if (typeof loadCustomers === 'function') loadCustomers();
            } else if (section === 'receipt-printers') {
                document.getElementById('receipt-printersSection').style.display = 'block';
                loadPrinters();
                loadReceiptSettings();
            } else if (section === 'general') {
                document.getElementById('generalSection').style.display = 'block';
                loadGeneralSettings();
            } else {
                alert(`${section} section - To be implemented`);
            }
        }

        async function showAddProduct() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Add Product';
            document.getElementById('productCodePrefix').value = 'PRO';
            document.getElementById('productCode').value = '';
            document.getElementById('productCode').readOnly = true;
            document.getElementById('productDescription').value = '';
            document.getElementById('productSearchable').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productBrand').value = '';
            document.getElementById('productUnit').value = 'ea';
            document.getElementById('productTaxRate').value = '15';
            document.getElementById('productCost').value = '0.00';
            document.getElementById('productPrice').value = '0.00';
            document.getElementById('productGrossProfit').value = '0.0000';
            document.getElementById('productGrossProfitPercent').value = '0.00';
            document.getElementById('productActive').checked = true;
            document.getElementById('productBarcode').value = '';
            document.getElementById('productRequiresVat').checked = true;
            document.getElementById('productTaxRate').disabled = false;
            document.getElementById('seanResponse').innerHTML = '';

            document.getElementById('productModal').style.display = 'flex';

            // Auto-generate the product code
            await generateProductCode();
        }

        async function generateProductCode() {
            const prefix = document.getElementById('productCodePrefix').value.trim().toUpperCase() || 'PRO';

            try {
                const response = await fetch(`${API_URL}/pos/products/next-code/${prefix}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('productCode').value = data.code;
                } else {
                    // Fallback: generate locally
                    document.getElementById('productCode').value = `${prefix}001`;
                }
            } catch (error) {
                console.error('Error generating product code:', error);
                // Fallback
                document.getElementById('productCode').value = `${prefix}001`;
            }
        }

        function editProduct(product) {
            editingProductId = product.id;
            document.getElementById('modalTitle').textContent = 'Edit Product';
            // Extract prefix from existing code (first 3 chars)
            const existingCode = product.product_code || '';
            document.getElementById('productCodePrefix').value = existingCode.substring(0, 3);
            document.getElementById('productCode').value = product.product_code;
            document.getElementById('productCode').readOnly = false; // Allow editing when editing product
            document.getElementById('productDescription').value = product.product_name;
            document.getElementById('productSearchable').value = product.product_name;
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productBrand').value = '';
            document.getElementById('productUnit').value = 'ea';
            document.getElementById('productTaxRate').value = '15';
            document.getElementById('productCost').value = parseFloat(product.cost_price || 0).toFixed(2);
            document.getElementById('productPrice').value = parseFloat(product.unit_price).toFixed(2);
            document.getElementById('productActive').checked = product.is_active == 1;
            document.getElementById('productBarcode').value = product.barcode || '';
            document.getElementById('productRequiresVat').checked = product.requires_vat !== 0;
            document.getElementById('productTaxRate').value = product.vat_rate || '15';
            document.getElementById('productTaxRate').disabled = product.requires_vat === 0;
            document.getElementById('seanResponse').innerHTML = '';

            // Trigger profit calculation
            const event = new Event('input');
            document.getElementById('productCost').dispatchEvent(event);

            document.getElementById('productModal').style.display = 'flex';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
            document.getElementById('codeError').style.display = 'none';
            document.getElementById('descError').style.display = 'none';
        }

        async function saveProduct() {
            const code = document.getElementById('productCode').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const barcode = document.getElementById('productBarcode').value.trim();

            // Validation
            let hasError = false;
            if (!code) {
                document.getElementById('codeError').style.display = 'block';
                hasError = true;
            } else {
                document.getElementById('codeError').style.display = 'none';
            }

            if (!description) {
                document.getElementById('descError').style.display = 'block';
                hasError = true;
            } else {
                document.getElementById('descError').style.display = 'none';
            }

            if (hasError) return;

            // Collect all product data
            const productData = {
                product_code: code,
                product_name: description,
                category: document.getElementById('productCategory').value,
                unit_price: parseFloat(document.getElementById('productPrice').value),
                cost_price: parseFloat(document.getElementById('productCost').value),
                is_active: document.getElementById('productActive').checked ? 1 : 0,
                barcode: barcode,
                requires_vat: document.getElementById('productRequiresVat').checked ? 1 : 0,
                vat_rate: parseFloat(document.getElementById('productTaxRate').value)
            };

            try {
                let response;
                if (editingProductId) {
                    // Update existing product
                    response = await fetch(`${API_URL}/pos/products/${editingProductId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(productData)
                    });
                } else {
                    // Create new product
                    response = await fetch(`${API_URL}/pos/products`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(productData)
                    });
                }

                const result = await response.json();

                if (result.success || result.product) {
                    showNotification(editingProductId ? 'Product updated successfully' : 'Product created successfully', 'success');

                    // Teach Sean AI about this product
                    if (barcode) {
                        await teachSean(barcode, productData);
                    }

                    // Reload products
                    await loadProducts();
                    closeProductModal();
                } else {
                    showNotification(result.error || 'Failed to save product', 'error');
                }
            } catch (error) {
                showNotification('Error saving product: ' + error.message, 'error');
            }
        }

        async function teachSean(barcode, productData) {
            try {
                await fetch(`${API_URL}/sean/learn/product`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        barcode: barcode,
                        product_name: productData.product_name,
                        category: productData.category,
                        unit_of_measure: productData.unit_of_measure,
                        vat_rate: productData.vat_rate,
                        requires_vat: productData.requires_vat === 1
                    })
                });
            } catch (error) {
                console.error('Error teaching Sean:', error);
            }
        }

        function exportProducts() {
            alert('Export Products - To be implemented');
        }

        function importProducts() {
            alert('Import Products - To be implemented');
        }

        // Barcode Management Functions

        function scanBarcode() {
            const barcodeInput = document.getElementById('productBarcode');
            barcodeInput.focus();
            barcodeInput.select();

            // Check if barcode exists when user enters it
            barcodeInput.addEventListener('change', async function() {
                const barcode = this.value.trim();
                if (barcode) {
                    await checkBarcodeExists(barcode);
                }
            }, { once: true });
        }

        async function checkBarcodeExists(barcode) {
            try {
                const response = await fetch(`${API_URL}/barcode/check/${barcode}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.exists && result.in_system) {
                    showNotification(`Barcode already assigned to: ${result.product.name}`, 'error');
                    document.getElementById('productBarcode').value = '';
                } else if (result.sean_knows) {
                    showNotification('Sean AI knows this barcode! Click "Ask Sean" to auto-fill details.', 'success');
                }
            } catch (error) {
                console.error('Error checking barcode:', error);
            }
        }

        async function generateBarcode() {
            try {
                const response = await fetch(`${API_URL}/barcode/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('productBarcode').value = result.barcode;
                    showNotification(`Generated barcode: ${result.barcode}`, 'success');
                } else {
                    showNotification(result.error || 'Failed to generate barcode', 'error');
                }
            } catch (error) {
                showNotification('Error generating barcode: ' + error.message, 'error');
            }
        }

        // Sean AI Functions

        async function askSean() {
            const barcode = document.getElementById('productBarcode').value.trim();
            const description = document.getElementById('productDescription').value.trim();

            if (!barcode && !description) {
                showNotification('Please enter a barcode or description first', 'error');
                return;
            }

            const seanResponseDiv = document.getElementById('seanResponse');
            seanResponseDiv.innerHTML = '<p style="color: #667eea;">ü§ñ Sean is thinking...</p>';

            try {
                const response = await fetch(`${API_URL}/sean/assist/product`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ barcode, description })
                });

                const result = await response.json();

                if (result.found || result.suggestion) {
                    const data = result.product || result.suggestion;

                    // Auto-fill form fields
                    if (data.product_name || data.name) {
                        document.getElementById('productDescription').value = data.product_name || data.name;
                        document.getElementById('productSearchable').value = data.product_name || data.name;
                    }
                    if (data.category) {
                        document.getElementById('productCategory').value = data.category;
                    }
                    if (data.unit_of_measure) {
                        document.getElementById('productUnit').value = data.unit_of_measure;
                    }
                    if (data.vat_rate !== undefined) {
                        document.getElementById('productVatRate').value = data.vat_rate;
                        document.getElementById('productRequiresVat').checked = data.requires_vat !== false;
                        document.getElementById('productVatRate').disabled = !data.requires_vat;
                    }

                    // Show Sean's confidence
                    const confidence = data.confidence || data.confidence_score || 0;
                    const confidencePercent = Math.round(confidence * 100);

                    seanResponseDiv.innerHTML = `
                        <p style="color: #4caf50; font-weight: bold;">‚úì Sean found it! (${confidencePercent}% confident)</p>
                        <p style="font-size: 12px; color: #666;">
                            ${data.category ? `Category: ${data.category}<br>` : ''}
                            ${data.unit_of_measure ? `Unit: ${data.unit_of_measure}<br>` : ''}
                            ${data.vat_rate !== undefined ? `VAT: ${data.vat_rate}%` : ''}
                        </p>
                    `;

                    showNotification('Sean auto-filled product details!', 'success');
                } else {
                    seanResponseDiv.innerHTML = `
                        <p style="color: #ff9800;">Sean doesn't recognize this yet.</p>
                        <p style="font-size: 12px; color: #666;">Fill in the details and Sean will learn for next time!</p>
                    `;
                }
            } catch (error) {
                seanResponseDiv.innerHTML = `<p style="color: #f44336;">Error: ${error.message}</p>`;
                showNotification('Error contacting Sean AI: ' + error.message, 'error');
            }
        }

        // VAT Management Functions

        function toggleVatRate() {
            const requiresVat = document.getElementById('productRequiresVat').checked;
            const vatRateSelect = document.getElementById('productTaxRate');

            vatRateSelect.disabled = !requiresVat;

            if (!requiresVat) {
                vatRateSelect.value = '0';
            } else if (vatRateSelect.value === '0') {
                vatRateSelect.value = '15';
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Reports Functions
        let currentReport = null;

        function showReport(reportType, event) {
            if (event) {
                const items = document.querySelectorAll('.settings-menu-item');
                items.forEach(item => item.classList.remove('active'));
                event.target.classList.add('active');
            }

            currentReport = reportType;
            loadCurrentReport();
        }

        async function loadCurrentReport() {
            if (!currentReport) {
                showNotification('Please select a report', 'error');
                return;
            }

            const container = document.getElementById('reportContainer');

            // Handle custom reports that don't go through /reports/ endpoint
            if (currentReport === 'forensic-audit') {
                loadForensicAuditReport(container);
                return;
            }
            if (currentReport === 'payment-methods') {
                loadPaymentMethodsReport(container);
                return;
            }
            if (currentReport === 'suspicious-activity') {
                loadSuspiciousActivityReport(container);
                return;
            }

            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            container.innerHTML = '<p style="text-align: center; color: #999;">Loading report...</p>';

            try {
                let url = `${API_URL}/reports/${currentReport}`;
                const params = [];
                if (startDate) params.push(`startDate=${startDate}`);
                if (endDate) params.push(`endDate=${endDate}`);
                if (params.length > 0) url += '?' + params.join('&');

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (response.ok) {
                    renderReport(currentReport, result);
                } else {
                    container.innerHTML = `<p style="color: #f44336;">Error: ${result.error || 'Failed to load report'}</p>`;
                }
            } catch (error) {
                console.error('Error loading report:', error);
                container.innerHTML = `<p style="color: #f44336;">Error loading report: ${error.message}</p>`;
            }
        }

        function renderReport(reportType, data) {
            const container = document.getElementById('reportContainer');

            switch (reportType) {
                case 'gross-profit':
                    renderGrossProfitReport(data, container);
                    break;
                case 'gross-profit-by-person':
                    renderGrossProfitByPersonReport(data, container);
                    break;
                case 'gross-profit-by-product':
                    renderGrossProfitByProductReport(data, container);
                    break;
                case 'daily-summary':
                    renderDailySummaryReport(data, container);
                    break;
                case 'audit-trail':
                    renderAuditTrailReport(data, container);
                    break;
                case 'vat-detail':
                    renderVatDetailReport(data, container);
                    break;
                case 'vat-summary':
                    renderVatSummaryReport(data, container);
                    break;
                case 'inventory-sync':
                    renderInventorySyncReport(data, container);
                    break;
                case 'accounting-sync':
                    renderAccountingSyncReport(data, container);
                    break;
                default:
                    container.innerHTML = '<p>Unknown report type</p>';
            }
        }

        function renderGrossProfitReport(data, container) {
            const { sales, summary } = data;
            let html = `
                <h2 style="margin-bottom: 20px;">Gross Profit Report</h2>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total Sales</div>
                        <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">R ${summary.totalSales.toFixed(2)}</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Gross Profit</div>
                        <div style="font-size: 24px; font-weight: bold; color: #f57c00;">R ${summary.totalProfit.toFixed(2)}</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Profit Margin</div>
                        <div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">${summary.profitMargin}%</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Transactions</div>
                        <div style="font-size: 24px; font-weight: bold; color: #1565c0;">${summary.transactionCount}</div>
                    </div>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Sale #</th>
                            <th>Cashier</th>
                            <th>Date</th>
                            <th>Subtotal</th>
                            <th>VAT</th>
                            <th>Total</th>
                            <th>Profit</th>
                            <th>Margin %</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sales.forEach(sale => {
                html += `
                    <tr>
                        <td>${sale.sale_number}</td>
                        <td>${sale.cashier}</td>
                        <td>${new Date(sale.created_at).toLocaleDateString()}</td>
                        <td>R ${sale.subtotal.toFixed(2)}</td>
                        <td>R ${sale.vat.toFixed(2)}</td>
                        <td>R ${sale.total_amount.toFixed(2)}</td>
                        <td>R ${(sale.gross_profit || 0).toFixed(2)}</td>
                        <td>${sale.profit_margin || 0}%</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderGrossProfitByPersonReport(data, container) {
            const { data: people, summary } = data;
            let html = `
                <h2 style="margin-bottom: 20px;">Gross Profit by Salesperson</h2>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total Sales</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalSales.toFixed(2)}</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total Profit</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalProfit.toFixed(2)}</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Avg Margin</div>
                        <div style="font-size: 24px; font-weight: bold;">${summary.profitMargin}%</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Staff Count</div>
                        <div style="font-size: 24px; font-weight: bold;">${summary.staffCount}</div>
                    </div>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Cashier</th>
                            <th>Transactions</th>
                            <th>Total Sales</th>
                            <th>Total VAT</th>
                            <th>Gross Profit</th>
                            <th>Margin %</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            people.forEach(person => {
                html += `
                    <tr>
                        <td>${person.cashier}</td>
                        <td>${person.sales_count}</td>
                        <td>R ${person.total_sales.toFixed(2)}</td>
                        <td>R ${person.total_vat.toFixed(2)}</td>
                        <td>R ${person.gross_profit.toFixed(2)}</td>
                        <td>${person.profit_margin}%</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderGrossProfitByProductReport(data, container) {
            const { products, summary } = data;
            let html = `
                <h2 style="margin-bottom: 20px;">Gross Profit by Product</h2>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total Revenue</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalRevenue.toFixed(2)}</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total Profit</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalProfit.toFixed(2)}</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Avg Margin</div>
                        <div style="font-size: 24px; font-weight: bold;">${summary.profitMargin}%</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Products</div>
                        <div style="font-size: 24px; font-weight: bold;">${summary.productCount}</div>
                    </div>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Qty Sold</th>
                            <th>Revenue</th>
                            <th>Profit</th>
                            <th>Margin %</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            products.forEach(prod => {
                html += `
                    <tr>
                        <td>${prod.product_code}</td>
                        <td>${prod.product_name}</td>
                        <td>${prod.category || '-'}</td>
                        <td>${prod.quantity_sold}</td>
                        <td>R ${prod.total_revenue.toFixed(2)}</td>
                        <td>R ${prod.gross_profit.toFixed(2)}</td>
                        <td>${prod.profit_margin}%</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderDailySummaryReport(data, container) {
            const { days, summary } = data;
            let html = `
                <h2 style="margin-bottom: 20px;">Daily Sales Summary</h2>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total Sales</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalSales.toFixed(2)}</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total VAT</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalVat.toFixed(2)}</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total Profit</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalProfit.toFixed(2)}</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Avg Daily Sales</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.avgDailySales}</div>
                    </div>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Transactions</th>
                            <th>Daily Sales</th>
                            <th>Daily VAT</th>
                            <th>Daily Profit</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            days.forEach(day => {
                html += `
                    <tr>
                        <td>${new Date(day.sale_date).toLocaleDateString()}</td>
                        <td>${day.transaction_count}</td>
                        <td>R ${day.daily_sales.toFixed(2)}</td>
                        <td>R ${day.daily_vat.toFixed(2)}</td>
                        <td>R ${day.daily_profit.toFixed(2)}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderAuditTrailReport(data, container) {
            const { sales, summary } = data;
            let html = `
                <h2 style="margin-bottom: 20px;">Sales Audit Trail</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total Transactions</div>
                        <div style="font-size: 24px; font-weight: bold;">${summary.totalTransactions}</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total Amount</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalAmount.toFixed(2)}</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Payment Methods</div>
                        <div style="font-size: 24px; font-weight: bold;">${summary.paymentMethods.join(', ')}</div>
                    </div>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Sale #</th>
                            <th>Date</th>
                            <th>Cashier</th>
                            <th>Items</th>
                            <th>Qty</th>
                            <th>Subtotal</th>
                            <th>VAT</th>
                            <th>Total</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sales.forEach(sale => {
                html += `
                    <tr>
                        <td>${sale.sale_number}</td>
                        <td>${new Date(sale.created_at).toLocaleDateString()}</td>
                        <td>${sale.cashier}</td>
                        <td>${sale.item_count}</td>
                        <td>${sale.total_quantity}</td>
                        <td>R ${sale.subtotal.toFixed(2)}</td>
                        <td>R ${sale.vat_amount.toFixed(2)}</td>
                        <td>R ${sale.total_amount.toFixed(2)}</td>
                        <td>${sale.payment_method}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderVatDetailReport(data, container) {
            const { items, summary } = data;
            let html = `
                <h2 style="margin-bottom: 20px;">VAT Report - Detail</h2>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Subtotal</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalSubtotal.toFixed(2)}</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total VAT</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalVat.toFixed(2)}</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total with VAT</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${summary.totalWithVat.toFixed(2)}</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Vatable Items</div>
                        <div style="font-size: 24px; font-weight: bold;">${summary.vatableItems}</div>
                    </div>
                    <div style="background: #fce4ec; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Exempt Items</div>
                        <div style="font-size: 24px; font-weight: bold;">${summary.exemptItems}</div>
                    </div>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Sale #</th>
                            <th>Date</th>
                            <th>Cashier</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Subtotal</th>
                            <th>VAT</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            items.forEach(item => {
                html += `
                    <tr>
                        <td>${item.sale_number}</td>
                        <td>${new Date(item.created_at).toLocaleDateString()}</td>
                        <td>${item.cashier}</td>
                        <td>${item.product_name}</td>
                        <td>${item.quantity}</td>
                        <td>R ${item.unit_price.toFixed(2)}</td>
                        <td>R ${item.subtotal.toFixed(2)}</td>
                        <td>R ${item.vat_amount.toFixed(2)}</td>
                        <td>R ${item.total_with_vat.toFixed(2)}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderVatSummaryReport(data, container) {
            const { summary, totals } = data;
            let html = `
                <h2 style="margin-bottom: 20px;">VAT Report - Summary</h2>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Taxable Amount</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${totals.totalTaxable.toFixed(2)}</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">VAT Collected</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${totals.totalVat.toFixed(2)}</div>
                    </div>
                    <div style="background: #fce4ec; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Exempt Amount</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${totals.totalExempt.toFixed(2)}</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Total Sales</div>
                        <div style="font-size: 24px; font-weight: bold;">R ${totals.totalSales.toFixed(2)}</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666;">Effective VAT Rate</div>
                        <div style="font-size: 24px; font-weight: bold;">${totals.effectiveVatRate}%</div>
                    </div>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Taxable Amount</th>
                            <th>VAT Collected</th>
                            <th>Exempt Amount</th>
                            <th>Total Sales</th>
                            <th>Transactions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            summary.forEach(row => {
                html += `
                    <tr>
                        <td>${new Date(row.report_date).toLocaleDateString()}</td>
                        <td>R ${row.taxable_amount.toFixed(2)}</td>
                        <td>R ${row.vat_collected.toFixed(2)}</td>
                        <td>R ${row.exempt_amount.toFixed(2)}</td>
                        <td>R ${row.total_sales.toFixed(2)}</td>
                        <td>${row.transaction_count}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderInventorySyncReport(data, container) {
            const { items, count, lastId } = data;
            let html = `
                <h2 style="margin-bottom: 20px;">Inventory Sync Data</h2>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>Status:</strong> Ready to sync with Inventory Management System</p>
                    <p><strong>Total Items:</strong> ${count}</p>
                    <p><strong>Last Sync ID:</strong> ${lastId || 'None'}</p>
                    <button class="btn btn-primary" onclick="syncToInventory()">üì§ Sync to Inventory System</button>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Sale #</th>
                            <th>Date</th>
                            <th>Product Code</th>
                            <th>Product Name</th>
                            <th>Quantity Sold</th>
                            <th>Unit Price</th>
                            <th>Cost Price</th>
                            <th>Cost Total</th>
                            <th>Payment Method</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            items.forEach(item => {
                html += `
                    <tr>
                        <td>${item.sale_number}</td>
                        <td>${new Date(item.created_at).toLocaleDateString()}</td>
                        <td>${item.product_code}</td>
                        <td>${item.product_name}</td>
                        <td>${item.quantity}</td>
                        <td>R ${item.unit_price.toFixed(2)}</td>
                        <td>R ${item.cost_price.toFixed(2)}</td>
                        <td>R ${item.cost_total.toFixed(2)}</td>
                        <td>${item.payment_method}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderAccountingSyncReport(data, container) {
            const { invoices, count, lastId } = data;
            let html = `
                <h2 style="margin-bottom: 20px;">Accounting Sync Data</h2>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>Status:</strong> Ready to sync with Accounting System</p>
                    <p><strong>Total Invoices:</strong> ${count}</p>
                    <p><strong>Last Sync ID:</strong> ${lastId || 'None'}</p>
                    <button class="btn btn-primary" onclick="syncToAccounting()">üì§ Sync to Accounting System</button>
                </div>
            `;

            invoices.forEach(inv => {
                html += `
                    <div style="background: white; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                            <div><strong>${inv.invoice_number}</strong></div>
                            <div>${new Date(inv.invoice_date).toLocaleDateString()}</div>
                            <div>${inv.cashier}</div>
                            <div>${inv.payment_method}</div>
                        </div>
                        <table style="width: 100%; font-size: 13px; margin-bottom: 10px;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 8px; text-align: left;">Product</th>
                                    <th style="padding: 8px; text-align: right;">Qty</th>
                                    <th style="padding: 8px; text-align: right;">Unit Price</th>
                                    <th style="padding: 8px; text-align: right;">Subtotal</th>
                                    <th style="padding: 8px; text-align: right;">VAT</th>
                                    <th style="padding: 8px; text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                inv.line_items.forEach(item => {
                    html += `
                        <tr>
                            <td style="padding: 6px;">${item.product_name}</td>
                            <td style="padding: 6px; text-align: right;">${item.quantity}</td>
                            <td style="padding: 6px; text-align: right;">R ${item.unit_price.toFixed(2)}</td>
                            <td style="padding: 6px; text-align: right;">R ${item.line_subtotal.toFixed(2)}</td>
                            <td style="padding: 6px; text-align: right;">R ${item.line_vat.toFixed(2)}</td>
                            <td style="padding: 6px; text-align: right;">R ${item.line_total.toFixed(2)}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                        <div style="display: grid; grid-template-columns: auto 1fr auto auto; gap: 15px; font-weight: bold; text-align: right;">
                            <div></div>
                            <div></div>
                            <div style="min-width: 100px;">Subtotal:</div>
                            <div style="min-width: 100px;">R ${inv.subtotal.toFixed(2)}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: auto 1fr auto auto; gap: 15px; font-weight: bold; text-align: right;">
                            <div></div>
                            <div></div>
                            <div style="min-width: 100px;">VAT:</div>
                            <div style="min-width: 100px;">R ${inv.vat_amount.toFixed(2)}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: auto 1fr auto auto; gap: 15px; font-weight: bold; text-align: right; border-top: 2px solid #667eea; padding-top: 10px;">
                            <div></div>
                            <div></div>
                            <div style="min-width: 100px;">TOTAL:</div>
                            <div style="min-width: 100px; color: #667eea;">R ${inv.total_amount.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function exportCurrentReport() {
            const container = document.getElementById('reportContainer');
            const table = container.querySelector('table');

            if (!table) {
                showNotification('No table data to export', 'error');
                return;
            }

            let csv = [];
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const csvRow = Array.from(cols).map(col => `"${col.textContent.trim()}"`).join(',');
                csv.push(csvRow);
            });

            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentReport}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('Report exported successfully', 'success');
        }

        function syncToInventory() {
            showNotification('Syncing to Inventory System... (Coming soon)', 'info');
        }

        function syncToAccounting() {
            showNotification('Syncing to Accounting System... (Coming soon)', 'info');
        }

        // Customer Management Functions
        let currentCustomerId = null;

        function showSettings(section, event) {
            if (event) {
                const items = document.querySelectorAll('.settings-menu-item');
                items.forEach(item => item.classList.remove('active'));
                event.target.classList.add('active');
            }

            const sections = document.querySelectorAll('[id$="Section"]');
            sections.forEach(s => s.style.display = 'none');

            const sectionId = section + 'Section';
            const section_element = document.getElementById(sectionId);
            if (section_element) {
                section_element.style.display = 'block';
                if (section === 'customers') {
                    loadCustomers();
                }
            }
        }

        async function loadCustomers() {
            try {
                const activeOnly = document.getElementById('activeCustomersOnly')?.checked;
                const query = activeOnly ? '?active_only=true' : '';

                const response = await fetch(`${API_URL}/customers${query}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                displayCustomers(result.customers || []);
            } catch (error) {
                console.error('Error loading customers:', error);
                showNotification('Error loading customers', 'error');
            }
        }

        function displayCustomers(customers) {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';

            document.getElementById('customerCount').textContent = `${customers.length} Customers`;

            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No customers found</td></tr>';
                return;
            }

            customers.forEach(customer => {
                const row = document.createElement('tr');
                const loyaltyPoints = customer.loyalty_points || 0;
                const tier = customer.loyalty_tier || 'bronze';
                const balance = parseFloat(customer.current_balance || 0);
                const tierColor = { bronze: '#cd7f32', silver: '#c0c0c0', gold: '#ffd700', platinum: '#e5e4e2' }[tier] || '#cd7f32';
                row.innerHTML = `
                    <td><strong>${customer.name}</strong>${customer.customer_number ? '<br><span style="font-size:11px;color:#999;">' + customer.customer_number + '</span>' : ''}</td>
                    <td>${customer.phone || customer.contact_number || '-'}</td>
                    <td>${customer.email || '-'}</td>
                    <td>${customer.customer_group || 'general'}</td>
                    <td><span style="color:${tierColor};font-weight:600;">${loyaltyPoints}</span> <span style="font-size:10px;color:#999;">${tier}</span></td>
                    <td style="color:${balance > 0 ? '#dc3545' : '#2e7d32'};font-weight:600;">R ${balance.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showCustomerDetail(${customer.id})" style="margin-right:4px;">View</button>
                        <button class="btn btn-sm btn-secondary" onclick="editCustomer(${customer.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})">Del</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddCustomer() {
            currentCustomerId = null;
            document.getElementById('customerModalTitle').textContent = 'Add Customer';
            document.getElementById('customerFirstName').value = '';
            document.getElementById('customerLastName').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerContactPerson').value = '';
            document.getElementById('customerContactNumber').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerIdNumber').value = '';
            document.getElementById('customerDOB').value = '';
            document.getElementById('customerGroup').value = 'general';
            document.getElementById('customerCreditLimit').value = '0';
            document.getElementById('customerAddress1').value = '';
            document.getElementById('customerAddress2').value = '';
            document.getElementById('customerSuburb').value = '';
            document.getElementById('customerCity').value = '';
            document.getElementById('customerProvince').value = '';
            document.getElementById('customerPostalCode').value = '';
            document.getElementById('customerTaxReference').value = '';
            document.getElementById('customerCompany').value = '';
            document.getElementById('customerType').value = 'Cash Sale Customer';
            document.getElementById('customerCustomField').value = '';
            document.getElementById('customerNotes').value = '';
            document.getElementById('customerActive').checked = true;
            document.getElementById('customerMarketingConsent').checked = false;

            document.getElementById('customerModal').style.display = 'flex';
        }

        async function editCustomer(id) {
            try {
                const response = await fetch(`${API_URL}/customers/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                const customer = result.customer;

                currentCustomerId = id;
                document.getElementById('customerModalTitle').textContent = 'Edit Customer';
                document.getElementById('customerFirstName').value = customer.first_name || '';
                document.getElementById('customerLastName').value = customer.last_name || '';
                document.getElementById('customerName').value = customer.name || '';
                document.getElementById('customerPhone').value = customer.phone || '';
                document.getElementById('customerContactPerson').value = customer.contact_person || '';
                document.getElementById('customerContactNumber').value = customer.contact_number || '';
                document.getElementById('customerEmail').value = customer.email || '';
                document.getElementById('customerIdNumber').value = customer.id_number || '';
                document.getElementById('customerDOB').value = customer.date_of_birth || '';
                document.getElementById('customerGroup').value = customer.customer_group || 'general';
                document.getElementById('customerCreditLimit').value = customer.credit_limit || 0;
                document.getElementById('customerAddress1').value = customer.address_line_1 || '';
                document.getElementById('customerAddress2').value = customer.address_line_2 || '';
                document.getElementById('customerSuburb').value = customer.suburb || '';
                document.getElementById('customerCity').value = customer.city || '';
                document.getElementById('customerProvince').value = customer.province || '';
                document.getElementById('customerPostalCode').value = customer.postal_code || '';
                document.getElementById('customerTaxReference').value = customer.tax_reference || '';
                document.getElementById('customerCompany').value = customer.company || '';
                document.getElementById('customerType').value = customer.customer_type || 'Cash Sale Customer';
                document.getElementById('customerCustomField').value = customer.custom_field || '';
                document.getElementById('customerNotes').value = customer.notes || '';
                document.getElementById('customerActive').checked = customer.is_active === 1 || customer.is_active === true;
                document.getElementById('customerMarketingConsent').checked = customer.marketing_consent === 1 || customer.marketing_consent === true;

                document.getElementById('customerModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading customer:', error);
                showNotification('Error loading customer', 'error');
            }
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').style.display = 'none';
            currentCustomerId = null;
        }

        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();

            if (!name) {
                document.getElementById('nameError').style.display = 'block';
                return;
            }

            const customerData = {
                name,
                first_name: document.getElementById('customerFirstName').value.trim(),
                last_name: document.getElementById('customerLastName').value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                contact_person: document.getElementById('customerContactPerson').value,
                contact_number: document.getElementById('customerContactNumber').value,
                email: document.getElementById('customerEmail').value,
                id_number: document.getElementById('customerIdNumber').value.trim(),
                date_of_birth: document.getElementById('customerDOB').value || null,
                customer_group: document.getElementById('customerGroup').value,
                credit_limit: parseFloat(document.getElementById('customerCreditLimit').value) || 0,
                address_line_1: document.getElementById('customerAddress1').value,
                address_line_2: document.getElementById('customerAddress2').value,
                suburb: document.getElementById('customerSuburb').value,
                city: document.getElementById('customerCity').value,
                province: document.getElementById('customerProvince').value,
                postal_code: document.getElementById('customerPostalCode').value,
                tax_reference: document.getElementById('customerTaxReference').value,
                company: document.getElementById('customerCompany').value,
                customer_type: document.getElementById('customerType').value,
                custom_field: document.getElementById('customerCustomField').value,
                notes: document.getElementById('customerNotes').value.trim(),
                is_active: document.getElementById('customerActive').checked,
                marketing_consent: document.getElementById('customerMarketingConsent').checked
            };

            try {
                const method = currentCustomerId ? 'PUT' : 'POST';
                const url = currentCustomerId ? `${API_URL}/customers/${currentCustomerId}` : `${API_URL}/customers`;

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });

                if (response.ok) {
                    showNotification(currentCustomerId ? 'Customer updated successfully' : 'Customer created successfully', 'success');
                    closeCustomerModal();
                    loadCustomers();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Error saving customer', 'error');
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                showNotification('Error saving customer', 'error');
            }
        }

        async function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer?')) {
                try {
                    const response = await fetch(`${API_URL}/customers/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        showNotification('Customer deleted successfully', 'success');
                        loadCustomers();
                    } else {
                        showNotification('Error deleting customer', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    showNotification('Error deleting customer', 'error');
                }
            }
        }

        async function searchCustomers() {
            const query = document.getElementById('customerSearch').value.trim();

            if (!query) {
                loadCustomers();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/customers/search?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                displayCustomers(result.customers || []);
            } catch (error) {
                console.error('Error searching customers:', error);
                showNotification('Error searching customers', 'error');
            }
        }

        function toggleActiveOnly() {
            loadCustomers();
        }

        function exportCustomers() {
            try {
                const tbody = document.getElementById('customersTableBody');
                const rows = tbody.querySelectorAll('tr');
                const data = [];

                const headers = ['Name', 'Contact Person', 'Contact Number', 'Email', 'Address 1', 'Address 2', 'Suburb', 'City', 'Province', 'Postal Code', 'Tax Reference', 'Company', 'Type', 'Active'];
                data.push(headers.join(','));

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 0) {
                        const rowData = [];
                        const cells_text = Array.from(cells).slice(0, -1).map(cell => `"${cell.textContent.trim()}"`);
                        data.push(cells_text.join(','));
                    }
                });

                const csv = data.join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `customers_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);

                showNotification('Customers exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting customers:', error);
                showNotification('Error exporting customers', 'error');
            }
        }

        // ========== SPLIT PAYMENT FUNCTIONS ==========

        let splitPaymentMode = false;

        function toggleSplitPayment() {
            splitPaymentMode = !splitPaymentMode;
            const section = document.getElementById('splitPaymentSection');
            const btn = document.getElementById('splitPaymentBtn');

            if (splitPaymentMode) {
                section.classList.add('active');
                btn.classList.add('selected');
                // Deselect other payment buttons
                document.querySelectorAll('.payment-btn:not(#splitPaymentBtn)').forEach(b => b.classList.remove('selected'));
                // Hide account customer section
                document.getElementById('accountCustomerSection').style.display = 'none';
                selectedAccountCustomerId = null;
                updateSplitRemaining();
            } else {
                section.classList.remove('active');
                btn.classList.remove('selected');
                // Reset all split amounts
                document.querySelectorAll('.split-amount').forEach(input => input.value = '0');
            }
        }

        function updateSplitRemaining() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) * 1.15;
            let allocated = 0;
            document.querySelectorAll('.split-amount').forEach(input => {
                allocated += parseFloat(input.value) || 0;
            });
            const remaining = total - allocated;

            document.getElementById('splitRemainingAmount').textContent = `R ${remaining.toFixed(2)}`;
            document.getElementById('splitRemainingAmount').style.color = Math.abs(remaining) <= 0.01 ? '#4caf50' : '#dc3545';
        }

        // ========== STOCK MANAGEMENT FUNCTIONS ==========

        async function loadStock() {
            try {
                const lowStockOnly = document.getElementById('lowStockOnly')?.checked || false;
                const category = document.getElementById('stockFilterCategory')?.value || '';

                let url = `${API_URL}/pos/stock?`;
                if (lowStockOnly) url += 'low_stock_only=true&';
                if (category) url += `category=${encodeURIComponent(category)}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                displayStock(result.products || []);
            } catch (error) {
                console.error('Error loading stock:', error);
                showNotification('Error loading stock data', 'error');
            }
        }

        function displayStock(stockItems) {
            const tbody = document.getElementById('stockTableBody');
            if (!tbody) return;

            tbody.innerHTML = stockItems.map(item => {
                let statusClass = 'ok';
                let statusText = 'OK';
                if (item.stock_quantity <= 0) {
                    statusClass = 'out';
                    statusText = 'Out of Stock';
                } else if (item.stock_quantity <= item.min_stock_level) {
                    statusClass = 'low';
                    statusText = 'Low Stock';
                }

                const stockValue = item.stock_quantity * (item.cost_price || 0);

                return `
                    <tr class="${statusClass === 'out' ? 'out-of-stock' : statusClass === 'low' ? 'low-stock' : ''}">
                        <td>${item.product_code}</td>
                        <td>${item.product_name}</td>
                        <td>${item.category || '-'}</td>
                        <td>${item.stock_quantity}</td>
                        <td>${item.min_stock_level}</td>
                        <td><span class="stock-badge ${statusClass}">${statusText}</span></td>
                        <td>R ${parseFloat(item.unit_price).toFixed(2)}</td>
                        <td>R ${stockValue.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showQuickAdjust(${item.id}, '${item.product_name}', ${item.stock_quantity})">Adjust</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterStock() {
            loadStock();
        }

        function showStockAdjustModal() {
            // Populate product dropdown
            const select = document.getElementById('adjustProductId');
            select.innerHTML = '<option value="">Select a product...</option>' +
                products.map(p => `<option value="${p.id}">${p.product_code} - ${p.product_name}</option>`).join('');

            document.getElementById('currentStockDisplay').textContent = '-';
            document.getElementById('adjustQuantity').value = '0';
            document.getElementById('adjustReason').value = '';
            document.getElementById('stockAdjustModal').style.display = 'flex';
        }

        function closeStockAdjust() {
            document.getElementById('stockAdjustModal').style.display = 'none';
        }

        function loadProductStock() {
            const productId = document.getElementById('adjustProductId').value;
            if (!productId) {
                document.getElementById('currentStockDisplay').textContent = '-';
                return;
            }

            const product = products.find(p => p.id == productId);
            if (product) {
                document.getElementById('currentStockDisplay').textContent = product.stock_quantity;
            }
        }

        async function submitStockAdjust() {
            const productId = document.getElementById('adjustProductId').value;
            const adjustType = document.getElementById('adjustType').value;
            const quantity = document.getElementById('adjustQuantity').value;
            const reason = document.getElementById('adjustReason').value;

            if (!productId || !quantity) {
                showNotification('Please select a product and enter quantity', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/pos/stock/adjust`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId),
                        adjustment_type: adjustType,
                        quantity: parseInt(quantity),
                        reason: reason
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`Stock adjusted: ${result.quantity_before} ‚Üí ${result.quantity_after}`, 'success');
                    closeStockAdjust();
                    loadProducts();
                    loadStock();
                } else {
                    showNotification(result.error || 'Failed to adjust stock', 'error');
                }
            } catch (error) {
                showNotification('Error adjusting stock: ' + error.message, 'error');
            }
        }

        function showQuickAdjust(productId, productName, currentStock) {
            document.getElementById('adjustProductId').value = productId;
            document.getElementById('currentStockDisplay').textContent = currentStock;
            document.getElementById('stockAdjustModal').style.display = 'flex';
        }

        function showStockTakeModal() {
            alert('Stock Take feature - Coming soon!\nThis will allow you to scan or enter counts for all products.');
        }

        // ========== SALE SEARCH FUNCTIONS ==========

        let selectedSale = null;
        let searchDebounce = null;

        function openSaleSearch() {
            document.getElementById('saleSearchModal').style.display = 'flex';
            document.getElementById('saleSearchQuery').focus();
        }

        function closeSaleSearch() {
            document.getElementById('saleSearchModal').style.display = 'none';
            document.getElementById('saleSearchResults').innerHTML = '<p style="text-align: center; color: #999;">Enter search criteria and click Search</p>';
        }

        function debounceSearchSales() {
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(searchSales, 500);
        }

        async function searchSales() {
            const query = document.getElementById('saleSearchQuery').value;
            const date = document.getElementById('saleSearchDate').value;

            if (!query && !date) {
                showNotification('Please enter search criteria', 'error');
                return;
            }

            const resultsDiv = document.getElementById('saleSearchResults');
            resultsDiv.innerHTML = '<p style="text-align: center; color: #999;">Searching...</p>';

            try {
                let url = `${API_URL}/pos/sales/search?`;
                if (query) url += `query=${encodeURIComponent(query)}&`;
                if (date) url += `date_from=${date}&date_to=${date}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (result.sales && result.sales.length > 0) {
                    resultsDiv.innerHTML = result.sales.map(sale => `
                        <div class="sale-result-card" onclick="viewSaleDetail(${sale.id})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${sale.sale_number}</strong>
                                    <div style="font-size: 12px; color: #666;">
                                        ${new Date(sale.created_at).toLocaleString()} | ${sale.cashier_name || 'Unknown'}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #667eea;">R ${parseFloat(sale.total_amount).toFixed(2)}</div>
                                    <div style="font-size: 12px;">${sale.payment_method}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultsDiv.innerHTML = '<p style="text-align: center; color: #999;">No sales found</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        async function viewSaleDetail(saleId) {
            try {
                const response = await fetch(`${API_URL}/pos/sales/${saleId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                selectedSale = result;

                const content = document.getElementById('saleDetailContent');
                content.innerHTML = `
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>Sale #:</strong> ${result.sale.sale_number}</div>
                            <div><strong>Date:</strong> ${new Date(result.sale.created_at).toLocaleString()}</div>
                            <div><strong>Cashier:</strong> ${result.sale.cashier_name}</div>
                            <div><strong>Payment:</strong> ${result.sale.payment_method}</div>
                            ${result.sale.customer_name ? `<div><strong>Customer:</strong> ${result.sale.customer_name}</div>` : ''}
                        </div>
                    </div>
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.items.map(item => `
                                <tr>
                                    <td>${item.product_name}</td>
                                    <td>${item.quantity}</td>
                                    <td>R ${parseFloat(item.unit_price).toFixed(2)}</td>
                                    <td>R ${parseFloat(item.total_price).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; text-align: right;">
                        <div>Subtotal: R ${parseFloat(result.sale.subtotal).toFixed(2)}</div>
                        <div>VAT: R ${parseFloat(result.sale.vat_amount).toFixed(2)}</div>
                        <div style="font-size: 18px; font-weight: bold; color: #667eea;">Total: R ${parseFloat(result.sale.total_amount).toFixed(2)}</div>
                    </div>
                    ${result.sale.voided_at ? `
                        <div style="margin-top:15px;background:#ffebee;padding:10px;border-radius:8px;color:#c62828;">
                            <strong>VOIDED</strong> - ${result.sale.void_reason || 'No reason given'}<br>
                            <span style="font-size:12px;">Voided at: ${new Date(result.sale.voided_at).toLocaleString('en-ZA')}</span>
                        </div>
                    ` : `
                        <div style="margin-top:15px;display:flex;gap:8px;justify-content:flex-end;">
                            <button class="btn btn-danger" onclick="voidSale(${result.sale.id}); closeSaleDetail();" style="padding:8px 15px;font-size:13px;">Void Sale</button>
                        </div>
                    `}
                `;

                closeSaleSearch();
                document.getElementById('saleDetailModal').style.display = 'flex';
            } catch (error) {
                showNotification('Error loading sale details: ' + error.message, 'error');
            }
        }

        function closeSaleDetail() {
            document.getElementById('saleDetailModal').style.display = 'none';
            selectedSale = null;
        }

        function reprintReceipt() {
            if (!selectedSale || !selectedSale.sale) return;
            printReceipt(selectedSale.sale.id);
            closeSaleDetail();
        }

        function showReturnModal() {
            if (!selectedSale) return;
            // Check if manager auth is needed
            if (userRole === 'cashier') {
                pendingAuthAction = { type: 'return', saleId: selectedSale.sale.id };
                document.getElementById('authActionDescription').textContent = 'Returns require manager authorization.';
                document.getElementById('managerAuthModal').style.display = 'flex';
            } else {
                processReturn(selectedSale.sale.id);
            }
        }

        async function processReturn(saleId, authorizedBy = null) {
            const items = selectedSale.items.map(item => ({
                product_id: item.product_id,
                quantity: item.quantity
            }));

            try {
                const response = await fetch(`${API_URL}/pos/sales/${saleId}/return`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        items: items,
                        reason: 'Customer return',
                        authorized_by_user_id: authorizedBy
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`Return processed: ${result.returnNumber} - Refund: R ${result.totalRefund.toFixed(2)}`, 'success');
                    closeSaleDetail();
                    loadProducts();
                } else {
                    showNotification(result.error || 'Failed to process return', 'error');
                }
            } catch (error) {
                showNotification('Error processing return: ' + error.message, 'error');
            }
        }

        // ========== DAILY DISCOUNT FUNCTIONS ==========

        function showDailyDiscountModal() {
            const select = document.getElementById('discountProductId');
            select.innerHTML = '<option value="">Select a product...</option>' +
                products.map(p => `<option value="${p.id}">${p.product_code} - ${p.product_name} (R ${parseFloat(p.unit_price).toFixed(2)})</option>`).join('');

            document.getElementById('originalPriceDisplay').textContent = 'R 0.00';
            document.getElementById('discountPrice').value = '';
            document.getElementById('discountReason').value = '';
            document.getElementById('discountEndDate').value = '';
            document.getElementById('dailyDiscountModal').style.display = 'flex';
        }

        function closeDailyDiscount() {
            document.getElementById('dailyDiscountModal').style.display = 'none';
        }

        function loadProductPrice() {
            const productId = document.getElementById('discountProductId').value;
            if (!productId) {
                document.getElementById('originalPriceDisplay').textContent = 'R 0.00';
                return;
            }

            const product = products.find(p => p.id == productId);
            if (product) {
                document.getElementById('originalPriceDisplay').textContent = `R ${parseFloat(product.unit_price).toFixed(2)}`;
            }
        }

        async function submitDailyDiscount() {
            const productId = document.getElementById('discountProductId').value;
            const discountPrice = document.getElementById('discountPrice').value;
            const reason = document.getElementById('discountReason').value;
            const endDate = document.getElementById('discountEndDate').value;

            if (!productId || !discountPrice) {
                showNotification('Please select a product and enter discount price', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/pos/daily-discounts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId),
                        discount_price: parseFloat(discountPrice),
                        reason: reason,
                        end_date: endDate || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`Daily discount applied: ${result.product_name} now R ${result.discount_price}`, 'success');
                    closeDailyDiscount();
                    loadProducts();
                } else {
                    showNotification(result.error || 'Failed to apply discount', 'error');
                }
            } catch (error) {
                showNotification('Error applying discount: ' + error.message, 'error');
            }
        }

        // ========== MANAGER AUTHORIZATION FUNCTIONS ==========

        let pendingAuthAction = null;

        function closeManagerAuth() {
            document.getElementById('managerAuthModal').style.display = 'none';
            document.getElementById('managerUsername').value = '';
            document.getElementById('managerPassword').value = '';
            pendingAuthAction = null;
        }

        async function verifyManagerAuth() {
            const username = document.getElementById('managerUsername').value;
            const password = document.getElementById('managerPassword').value;

            if (!username || !password) {
                showNotification('Please enter manager credentials', 'error');
                return;
            }

            try {
                // Verify manager credentials
                const response = await fetch(`${API_URL}/auth/verify-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (result.success && result.authorized) {
                    closeManagerAuth();

                    // Execute pending action
                    if (pendingAuthAction) {
                        if (pendingAuthAction.type === 'return') {
                            processReturn(pendingAuthAction.saleId, result.userId);
                        } else if (pendingAuthAction.type === 'price_override') {
                            // Handle price override
                        }
                    }
                } else {
                    showNotification('Invalid manager credentials or insufficient permissions', 'error');
                }
            } catch (error) {
                showNotification('Error verifying credentials: ' + error.message, 'error');
            }
        }

        // ========== DAILY TILL RESET FUNCTIONS ==========

        async function dailyTillReset() {
            if (!confirm('This will start a fresh day for the till.\n\nThe current session will be marked as "pending cashup" so you can complete the actual cashup later.\n\nAll sales data will be preserved.\n\nContinue?')) {
                return;
            }

            try {
                // Get current till
                const tillsResponse = await fetch(`${API_URL}/pos/tills`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const tillsResult = await tillsResponse.json();

                if (!tillsResult.tills || tillsResult.tills.length === 0) {
                    showNotification('No till found', 'error');
                    return;
                }

                const response = await fetch(`${API_URL}/pos/till/daily-reset`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        till_id: tillsResult.tills[0].id,
                        notes: 'Daily reset'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('New day started! Previous session marked for cashup. Float: R ' + result.float_amount, 'success');
                    currentSession = null;
                    document.getElementById('sessionStatus').textContent = 'No Session';
                    checkSession();
                    // Refresh pending cashups list
                    await loadPendingCashups();
                } else {
                    showNotification(result.error || 'Failed to reset till', 'error');
                }
            } catch (error) {
                showNotification('Error resetting till: ' + error.message, 'error');
            }
        }

        // ========== UPDATE CART WITH QUANTITY INPUT ==========

        function updateCartWithQtyInput() {
            const container = document.getElementById('cartItems');

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <p>Cart is empty</p>
                        <p style="font-size: 14px;">Scan or click products to add</p>
                    </div>
                `;
                document.getElementById('checkoutBtn').disabled = true;
                return;
            }

            container.innerHTML = '';

            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <div class="cart-item-header">
                        <div class="item-name">${item.name}</div>
                        <button class="item-remove" onclick="removeItem(${item.productId})">‚úï</button>
                    </div>
                    <div class="cart-item-controls">
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="updateQty(${item.productId}, -1)">-</button>
                            <input type="number" class="qty-input" value="${item.quantity}" min="1" max="${item.maxStock}"
                                   onchange="setQty(${item.productId}, this.value)" onclick="this.select()">
                            <button class="qty-btn" onclick="updateQty(${item.productId}, 1)">+</button>
                        </div>
                        <div class="item-total">R ${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `;
                container.appendChild(itemDiv);
            });

            document.getElementById('checkoutBtn').disabled = !currentSession;
            updateTotals();
        }

        function setQty(productId, newQty) {
            const item = cart.find(i => i.productId === productId);
            if (item) {
                const qty = parseInt(newQty) || 1;
                if (qty <= 0) {
                    removeItem(productId);
                } else if (qty > item.maxStock) {
                    item.quantity = item.maxStock;
                    showNotification('Maximum stock reached', 'error');
                } else {
                    item.quantity = qty;
                }
                updateCart();
            }
        }

        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const vat = subtotal * 0.15;
            const total = subtotal + vat;

            document.getElementById('subtotal').textContent = `R ${subtotal.toFixed(2)}`;
            document.getElementById('vat').textContent = `R ${vat.toFixed(2)}`;
            document.getElementById('total').textContent = `R ${total.toFixed(2)}`;
            document.getElementById('cartItemCount').textContent = `${cart.length} items`;

            // Update split payment remaining if active
            if (splitPaymentMode) {
                updateSplitRemaining();
            }
        }

        // ========== UPDATED CHECKOUT WITH SPLIT PAYMENT ==========

        async function checkoutWithFeatures() {
            if (cart.length === 0 || !currentSession) {
                showNotification('Cart is empty or no session open', 'error');
                return;
            }

            // Account payment - must select customer
            if (selectedPayment === 'ACCOUNT' && !splitPaymentMode && !selectedAccountCustomerId) {
                showNotification('Please select an account customer first', 'error');
                return;
            }

            if (splitPaymentMode) {
                // Gather all split amounts
                const payments = [];
                document.querySelectorAll('.split-amount').forEach(input => {
                    const amount = parseFloat(input.value) || 0;
                    if (amount > 0) {
                        payments.push({ method: input.dataset.method, amount });
                    }
                });

                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) * 1.15;
                const allocated = payments.reduce((sum, p) => sum + p.amount, 0);

                if (Math.abs(allocated - total) > 0.01) {
                    showNotification('Split payment amounts must equal total', 'error');
                    return;
                }

                const payload = {
                    tillSessionId: currentSession.id,
                    items: cart.map(item => ({
                        productId: item.productId,
                        quantity: item.quantity
                    })),
                    payments
                };

                try {
                    const response = await fetch(`${API_URL}/pos/sales/split-payment`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        lastSaleId = result.saleId;
                        showSaleCompleteModal(result);
                        cart = [];
                        updateCart();
                        toggleSplitPayment();
                        await loadProducts();
                    } else {
                        showNotification(result.error || 'Checkout failed', 'error');
                    }
                } catch (error) {
                    showNotification('Checkout failed: ' + error.message, 'error');
                }
            } else {
                // Regular checkout
                checkout();
            }
        }

        // ========== SHOW TAB UPDATE FOR STOCK ==========

        const originalShowTab = showTab;
        showTab = function(tab, evt) {
            // Hide stock interface
            const stockInterface = document.getElementById('stockInterface');
            if (stockInterface) stockInterface.style.display = 'none';

            if (tab === 'stock') {
                document.getElementById('tillInterface').style.display = 'none';
                document.getElementById('settingsLayout').style.display = 'none';
                document.getElementById('reportsLayout').style.display = 'none';
                document.getElementById('cashUpLayout').style.display = 'none';
                document.getElementById('dashboardLayout').style.display = 'none';
                document.getElementById('loyaltyLayout').style.display = 'none';
                stockInterface.style.display = 'block';

                // Remove active from all tabs, add to stock
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                if (evt && evt.target) evt.target.classList.add('active');

                // Populate category filter
                const categorySelect = document.getElementById('stockFilterCategory');
                if (categorySelect) {
                    categorySelect.innerHTML = '<option value="">All Categories</option>' +
                        Array.from(categories).filter(c => c !== 'all').map(c => `<option value="${c}">${c}</option>`).join('');
                }

                loadStock();
            } else {
                originalShowTab(tab, evt);
            }
        };

        // ========== ENTERPRISE TAB JAVASCRIPT ==========

        // Dashboard
        async function loadDashboard() {
            try {
                const res = await fetch(`${API_URL}/analytics/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const t = data.today || {};
                    document.getElementById('kpiTodaySales').textContent = `R ${parseFloat(t.net_sales || 0).toFixed(2)}`;
                    document.getElementById('kpiTodayTransactions').textContent = `${t.transaction_count || 0} transactions`;
                    document.getElementById('kpiGrossProfit').textContent = `R ${parseFloat(t.gross_profit || 0).toFixed(2)}`;
                    const margin = t.net_sales > 0 ? ((t.gross_profit / t.net_sales) * 100).toFixed(1) : '0';
                    document.getElementById('kpiProfitMargin').textContent = `${margin}% margin`;
                    document.getElementById('kpiAvgTransaction').textContent = `R ${parseFloat(t.avg_transaction_value || 0).toFixed(2)}`;
                    document.getElementById('kpiAvgBasket').textContent = `${parseFloat(t.avg_basket_size || 0).toFixed(1)} items avg`;
                }
            } catch (e) {
                console.log('Dashboard load error:', e);
            }

            // Load alerts
            try {
                const alertRes = await fetch(`${API_URL}/loss-prevention/alerts?status=open&limit=5`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (alertRes.ok) {
                    const alertData = await alertRes.json();
                    const alerts = alertData.alerts || [];
                    const alertsDiv = document.getElementById('dashboardAlerts');
                    if (alerts.length === 0) {
                        alertsDiv.innerHTML = '<div class="empty-state"><div class="icon">&#9989;</div><p>No active alerts</p></div>';
                    } else {
                        alertsDiv.innerHTML = alerts.map(a => `
                            <div class="alert-row ${a.severity === 'critical' ? 'critical' : 'warning'}">
                                <div>
                                    <strong>${a.alert_type}</strong>
                                    <div style="font-size:12px;color:#666;">${a.severity} - ${new Date(a.created_at).toLocaleString()}</div>
                                </div>
                                <span class="status-badge ${a.status === 'open' ? 'alert' : 'pending'}">${a.status}</span>
                            </div>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Alerts load error:', e);
            }

            // Load locations
            try {
                const locRes = await fetch(`${API_URL}/locations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (locRes.ok) {
                    const locData = await locRes.json();
                    const locations = locData.locations || [];
                    const tbody = document.getElementById('locationPerformanceBody');
                    if (locations.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:20px;">No locations configured</td></tr>';
                    } else {
                        tbody.innerHTML = locations.map(l => `
                            <tr>
                                <td><strong>${l.location_name}</strong></td>
                                <td>${l.location_type}</td>
                                <td>-</td>
                                <td>-</td>
                                <td><span class="status-badge ${l.is_active ? 'active' : 'closed'}">${l.is_active ? 'Active' : 'Inactive'}</span></td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Locations load error:', e);
            }
        }

        // Inventory
        async function loadInventoryLevels() {
            try {
                const res = await fetch(`${API_URL}/inventory?include_zero=true`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const items = data.inventory || [];
                    const tbody = document.getElementById('inventoryTableBody');
                    if (items.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;padding:20px;">No inventory records. Inventory data will populate once locations have stock.</td></tr>';
                    } else {
                        tbody.innerHTML = items.map(i => {
                            const available = (i.quantity_on_hand || 0) - (i.quantity_reserved || 0);
                            const isLow = i.reorder_point && available <= i.reorder_point;
                            return `<tr style="${isLow ? 'background:#fff3e0;' : ''}">
                                <td>${i.product_name || 'Unknown'}</td>
                                <td>${i.product_code || '-'}</td>
                                <td>${i.category || '-'}</td>
                                <td>${i.quantity_on_hand || 0}</td>
                                <td>${i.quantity_reserved || 0}</td>
                                <td>${i.quantity_in_transit || 0}</td>
                                <td><strong>${available}</strong></td>
                                <td>${i.reorder_point || '-'}</td>
                            </tr>`;
                        }).join('');
                    }
                }
            } catch (e) {
                console.log('Inventory load error:', e);
                document.getElementById('inventoryTableBody').innerHTML =
                    '<tr><td colspan="8" style="text-align:center;color:#999;padding:20px;">Inventory data will appear once stock is configured for locations</td></tr>';
            }
        }

        function showInventoryTab(tab, evt) {
            document.querySelectorAll('#inventoryLayout .sub-tab').forEach(t => t.classList.remove('active'));
            if (evt && evt.target) evt.target.classList.add('active');

            document.getElementById('invStockLevels').style.display = tab === 'stock-levels' ? 'block' : 'none';
            document.getElementById('invTransfers').style.display = tab === 'transfers' ? 'block' : 'none';
            document.getElementById('invPurchaseOrders').style.display = tab === 'purchase-orders' ? 'block' : 'none';
            document.getElementById('invSuppliers').style.display = tab === 'suppliers' ? 'block' : 'none';

            if (tab === 'transfers') loadTransfers();
            if (tab === 'purchase-orders') loadPurchaseOrders();
            if (tab === 'suppliers') loadSuppliers();
        }

        async function loadTransfers() {
            try {
                const res = await fetch(`${API_URL}/transfers`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const transfers = data.transfers || [];
                    const tbody = document.getElementById('transfersTableBody');
                    if (transfers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">No transfers yet</td></tr>';
                    } else {
                        tbody.innerHTML = transfers.map(t => `
                            <tr>
                                <td>${t.transfer_number}</td>
                                <td>${t.from_location_name || t.from_location_id}</td>
                                <td>${t.to_location_name || t.to_location_id}</td>
                                <td>${t.item_count || '-'}</td>
                                <td><span class="status-badge ${t.status === 'received' ? 'active' : 'pending'}">${t.status}</span></td>
                                <td>${new Date(t.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Transfers load error:', e);
            }
        }

        async function loadPurchaseOrders() {
            try {
                const res = await fetch(`${API_URL}/purchase-orders`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const orders = data.purchase_orders || [];
                    const tbody = document.getElementById('poTableBody');
                    if (orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">No purchase orders yet</td></tr>';
                    } else {
                        tbody.innerHTML = orders.map(po => `
                            <tr>
                                <td>${po.po_number}</td>
                                <td>${po.supplier_name || po.supplier_id}</td>
                                <td>${po.location_name || po.delivery_location_id}</td>
                                <td>R ${parseFloat(po.total_amount || 0).toFixed(2)}</td>
                                <td><span class="status-badge ${po.status === 'received' ? 'active' : 'pending'}">${po.status}</span></td>
                                <td>${po.expected_delivery_date ? new Date(po.expected_delivery_date).toLocaleDateString() : '-'}</td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('PO load error:', e);
            }
        }

        async function loadSuppliers() {
            try {
                const res = await fetch(`${API_URL}/suppliers`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const suppliers = data.suppliers || [];
                    const tbody = document.getElementById('suppliersTableBody');
                    if (suppliers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">No suppliers yet</td></tr>';
                    } else {
                        tbody.innerHTML = suppliers.map(s => `
                            <tr>
                                <td>${s.supplier_code}</td>
                                <td>${s.supplier_name}</td>
                                <td>${s.contact_name || '-'}</td>
                                <td>${s.contact_email || '-'}</td>
                                <td>${s.payment_terms || 30} days</td>
                                <td>${s.is_preferred ? '<span class="status-badge active">Preferred</span>' : '-'}</td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Suppliers load error:', e);
            }
        }

        function searchInventory() { /* placeholder for search filtering */ }
        function filterInventory() { /* placeholder for filter */ }
        function showNewTransferModal() { showNotification('Transfer creation coming soon', 'info'); }
        function showNewPOModal() { showNotification('PO creation coming soon', 'info'); }
        function showNewSupplierModal() { showNotification('Supplier creation coming soon', 'info'); }

        // Employees
        async function loadEmployees() {
            try {
                const res = await fetch(`${API_URL}/employees`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const employees = data.employees || [];
                    const tbody = document.getElementById('employeesTableBody');
                    if (employees.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;padding:20px;">No employees found</td></tr>';
                    } else {
                        tbody.innerHTML = employees.map(e => `
                            <tr>
                                <td><strong>${e.full_name}</strong></td>
                                <td>${e.employee_id || '-'}</td>
                                <td>${(e.role || '').replace(/_/g, ' ')}</td>
                                <td>${e.department || '-'}</td>
                                <td><span class="status-badge ${e.employment_status === 'active' ? 'active' : 'pending'}">${e.employment_status || 'active'}</span></td>
                                <td>${e.hire_date ? new Date(e.hire_date).toLocaleDateString() : '-'}</td>
                                <td>${e.last_login_at ? new Date(e.last_login_at).toLocaleString() : 'Never'}</td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Employees load error:', e);
            }
        }

        function showEmployeeTab(tab, evt) {
            document.querySelectorAll('#employeesLayout .sub-tab').forEach(t => t.classList.remove('active'));
            if (evt && evt.target) evt.target.classList.add('active');

            document.getElementById('empRoster').style.display = tab === 'roster' ? 'block' : 'none';
            document.getElementById('empScheduling').style.display = tab === 'scheduling' ? 'block' : 'none';
            document.getElementById('empTimeClock').style.display = tab === 'time-clock' ? 'block' : 'none';

            if (tab === 'scheduling') loadSchedule();
            if (tab === 'time-clock') loadTimeClock();
        }

        async function loadSchedule() {
            const dateInput = document.getElementById('scheduleDate');
            if (!dateInput.value) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
            try {
                const res = await fetch(`${API_URL}/scheduling/shifts?date=${dateInput.value}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const shifts = data.shifts || [];
                    const tbody = document.getElementById('scheduleTableBody');
                    if (shifts.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">No shifts scheduled for this date</td></tr>';
                    } else {
                        tbody.innerHTML = shifts.map(s => `
                            <tr>
                                <td>${s.full_name || s.user_id}</td>
                                <td>${s.shift_date}</td>
                                <td>${s.scheduled_start}</td>
                                <td>${s.scheduled_end}</td>
                                <td>${s.break_duration_minutes || 60} min</td>
                                <td><span class="status-badge ${s.status === 'completed' ? 'active' : 'pending'}">${s.status}</span></td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Schedule load error:', e);
            }
        }

        async function loadTimeClock() {
            try {
                const res = await fetch(`${API_URL}/scheduling/time/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const statusText = document.getElementById('clockStatusText');
                    const clockInBtn = document.getElementById('clockInBtn');
                    const clockOutBtn = document.getElementById('clockOutBtn');

                    if (data.clocked_in) {
                        statusText.textContent = `Clocked in since ${new Date(data.clock_in).toLocaleTimeString()}`;
                        statusText.style.color = '#4caf50';
                        clockInBtn.style.display = 'none';
                        clockOutBtn.style.display = 'inline-block';
                    } else {
                        statusText.textContent = 'Not clocked in';
                        statusText.style.color = '#666';
                        clockInBtn.style.display = 'inline-block';
                        clockOutBtn.style.display = 'none';
                    }
                }
            } catch (e) {
                console.log('Time clock status error:', e);
            }
        }

        async function clockIn() {
            try {
                const res = await fetch(`${API_URL}/scheduling/time/clock-in`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });
                if (res.ok) {
                    showNotification('Clocked in successfully', 'success');
                    loadTimeClock();
                } else {
                    const data = await res.json();
                    showNotification(data.error || 'Clock in failed', 'error');
                }
            } catch (e) {
                showNotification('Clock in failed', 'error');
            }
        }

        async function clockOut() {
            try {
                const res = await fetch(`${API_URL}/scheduling/time/clock-out`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });
                if (res.ok) {
                    showNotification('Clocked out successfully', 'success');
                    loadTimeClock();
                } else {
                    const data = await res.json();
                    showNotification(data.error || 'Clock out failed', 'error');
                }
            } catch (e) {
                showNotification('Clock out failed', 'error');
            }
        }

        function searchEmployees() { /* placeholder */ }
        function filterEmployees() { /* placeholder */ }
        function showNewEmployeeModal() { showNotification('Employee creation coming soon', 'info'); }
        function showNewShiftModal() { showNotification('Shift creation coming soon', 'info'); }

        // Loyalty
        async function loadLoyaltyPrograms() {
            try {
                const res = await fetch(`${API_URL}/loyalty/programs`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const programs = data.programs || [];
                    const tbody = document.getElementById('loyaltyProgramsBody');
                    if (programs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">No loyalty programs configured. Create one to get started.</td></tr>';
                    } else {
                        tbody.innerHTML = programs.map(p => `
                            <tr>
                                <td><strong>${p.program_name}</strong></td>
                                <td>${p.points_per_currency}</td>
                                <td>R ${parseFloat(p.points_value || 0).toFixed(2)}</td>
                                <td>${p.minimum_redemption} pts</td>
                                <td>${p.points_expiry_months ? p.points_expiry_months + ' months' : 'Never'}</td>
                                <td><span class="status-badge ${p.is_active ? 'active' : 'closed'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Loyalty programs load error:', e);
            }
        }

        function showLoyaltyTab(tab, evt) {
            document.querySelectorAll('#loyaltyLayout .sub-tab').forEach(t => t.classList.remove('active'));
            if (evt && evt.target) evt.target.classList.add('active');

            document.getElementById('loyPrograms').style.display = tab === 'programs' ? 'block' : 'none';
            document.getElementById('loyMembers').style.display = tab === 'members' ? 'block' : 'none';
            document.getElementById('loyPromotions').style.display = tab === 'promotions' ? 'block' : 'none';

            if (tab === 'promotions') loadPromotions();
        }

        async function loadPromotions() {
            try {
                const res = await fetch(`${API_URL}/promotions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const promos = data.promotions || [];
                    const tbody = document.getElementById('promotionsTableBody');
                    if (promos.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;padding:20px;">No promotions configured</td></tr>';
                    } else {
                        tbody.innerHTML = promos.map(p => {
                            const now = new Date();
                            const start = new Date(p.start_date);
                            const end = new Date(p.end_date);
                            let status = 'Active';
                            let statusClass = 'active';
                            if (now < start) { status = 'Upcoming'; statusClass = 'pending'; }
                            if (now > end) { status = 'Expired'; statusClass = 'closed'; }
                            if (!p.is_active) { status = 'Inactive'; statusClass = 'closed'; }

                            return `<tr>
                                <td><strong>${p.promotion_name}</strong></td>
                                <td>${p.promotion_code || '-'}</td>
                                <td>${p.promotion_type}</td>
                                <td>${p.discount_percentage ? p.discount_percentage + '%' : p.discount_value ? 'R ' + p.discount_value : '-'}</td>
                                <td>${start.toLocaleDateString()}</td>
                                <td>${end.toLocaleDateString()}</td>
                                <td>${p.current_usage_count || 0}${p.usage_limit ? '/' + p.usage_limit : ''}</td>
                                <td><span class="status-badge ${statusClass}">${status}</span></td>
                            </tr>`;
                        }).join('');
                    }
                }
            } catch (e) {
                console.log('Promotions load error:', e);
            }
        }

        function searchLoyaltyMembers() { /* placeholder */ }
        function showNewProgramModal() { showNotification('Program creation coming soon', 'info'); }
        function showEnrollCustomerModal() { showNotification('Customer enrollment coming soon', 'info'); }
        function showNewPromotionModal() { showNotification('Promotion creation coming soon', 'info'); }

        // ========== COMPANY & USER MANAGEMENT ==========

        let currentCompanyTab = 'locations';

        async function loadCompanies() {
            // Load main company info
            await loadMainCompanyInfo();
            // Load locations and other companies
            await loadLocations();
            await loadOtherCompanies();
        }

        async function loadMainCompanyInfo() {
            // Set immediate fallback from session data
            if (currentCompanyName) {
                document.getElementById('mainCompanyName').textContent = currentCompanyName;
            }

            try {
                const res = await fetch(`${API_URL}/auth/company-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const company = data.company || {};
                    document.getElementById('mainCompanyName').textContent = company.company_name || currentCompanyName || 'My Company';
                    document.getElementById('mainCompanyVat').textContent = company.vat_number || '-';
                    document.getElementById('mainCompanyDetails').textContent =
                        `${company.trading_name || ''} ${company.address ? '| ' + company.address : ''}`.trim() || '';
                } else {
                    // API error - use session data as fallback
                    const errorData = await res.json().catch(() => ({}));
                    console.log('Company info API error:', res.status, errorData);
                    document.getElementById('mainCompanyName').textContent = currentCompanyName || 'My Company';
                    document.getElementById('mainCompanyVat').textContent = '-';
                }
            } catch (e) {
                console.log('Error loading main company:', e);
                document.getElementById('mainCompanyName').textContent = currentCompanyName || 'My Company';
                document.getElementById('mainCompanyVat').textContent = '-';
            }
        }

        async function loadLocations() {
            try {
                const res = await fetch(`${API_URL}/auth/locations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const tbody = document.getElementById('locationsTableBody');

                if (res.ok) {
                    const data = await res.json();
                    const locations = data.locations || [];

                    if (locations.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">No locations yet. Add your first store location.</td></tr>';
                    } else {
                        tbody.innerHTML = locations.map(loc => `
                            <tr>
                                <td><strong>${loc.location_name || loc.company_name}</strong></td>
                                <td>${loc.address || '-'}</td>
                                <td>${loc.contact_phone || '-'}</td>
                                <td>${loc.user_count || 0}</td>
                                <td><span class="status-badge ${loc.is_active ? 'active' : 'closed'}">${loc.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button class="btn btn-primary" style="padding:4px 12px;font-size:12px;" onclick="switchToLocation(${loc.id})">Switch</button>
                                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;" onclick="editLocation(${loc.id})">Edit</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Error loading locations:', e);
            }
        }

        async function loadOtherCompanies() {
            try {
                const res = await fetch(`${API_URL}/auth/my-companies`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const tbody = document.getElementById('otherCompaniesTableBody');

                if (res.ok) {
                    const data = await res.json();
                    // Filter out current company and locations
                    const companies = (data.companies || []).filter(c => !c.is_location && c.id !== selectedCompanyId);

                    if (companies.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">No other companies. Register a new company to manage multiple businesses.</td></tr>';
                    } else {
                        tbody.innerHTML = companies.map(c => `
                            <tr>
                                <td><strong>${c.company_name}</strong></td>
                                <td>${c.trading_name || '-'}</td>
                                <td>${c.vat_number || '-'}</td>
                                <td>${c.location_count || 0}</td>
                                <td><span class="status-badge ${c.is_active ? 'active' : 'closed'}">${c.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button class="btn btn-primary" style="padding:4px 12px;font-size:12px;" onclick="switchToCompany(${c.id})">Switch</button>
                                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;" onclick="editCompany(${c.id})">Edit</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Error loading other companies:', e);
            }
        }

        function showCompanyTab(tab) {
            currentCompanyTab = tab;
            document.getElementById('tabLocations').className = tab === 'locations' ? 'btn' : 'btn btn-secondary';
            document.getElementById('tabLocations').style.background = tab === 'locations' ? '#667eea' : '';
            document.getElementById('tabLocations').style.color = tab === 'locations' ? 'white' : '';
            document.getElementById('tabCompanies').className = tab === 'companies' ? 'btn' : 'btn btn-secondary';
            document.getElementById('tabCompanies').style.background = tab === 'companies' ? '#667eea' : '';
            document.getElementById('tabCompanies').style.color = tab === 'companies' ? 'white' : '';

            document.getElementById('locationsList').style.display = tab === 'locations' ? 'block' : 'none';
            document.getElementById('otherCompaniesList').style.display = tab === 'companies' ? 'block' : 'none';
        }

        // Location Modal Functions
        function showAddLocationModal() {
            document.getElementById('locationModalTitle').textContent = 'Add Store Location';
            document.getElementById('locationName').value = '';
            document.getElementById('locationAddress').value = '';
            document.getElementById('locationPhone').value = '';
            document.getElementById('locationEmail').value = '';
            document.getElementById('locationModal').style.display = 'flex';
        }

        function closeLocationModal() {
            document.getElementById('locationModal').style.display = 'none';
        }

        async function saveLocation() {
            const name = document.getElementById('locationName').value.trim();
            if (!name) {
                showNotification('Location name is required', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/locations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location_name: name,
                        address: document.getElementById('locationAddress').value.trim() || null,
                        contact_phone: document.getElementById('locationPhone').value.trim() || null,
                        contact_email: document.getElementById('locationEmail').value.trim() || null
                    })
                });

                if (res.ok) {
                    showNotification('Location added successfully!', 'success');
                    closeLocationModal();
                    loadLocations();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to add location', 'error');
                }
            } catch (e) {
                showNotification('Failed to add location', 'error');
            }
        }

        function editLocation(id) {
            showNotification('Location editing coming soon', 'info');
        }

        async function switchToLocation(locationId) {
            try {
                const res = await fetch(`${API_URL}/auth/select-company`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ companyId: locationId })
                });

                if (res.ok) {
                    const data = await res.json();
                    token = data.token;
                    localStorage.setItem('token', token);
                    selectedCompanyId = locationId;
                    showNotification('Switched to location!', 'success');
                    location.reload();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to switch location', 'error');
                }
            } catch (e) {
                showNotification('Failed to switch location', 'error');
            }
        }

        async function switchToCompany(companyId) {
            try {
                const res = await fetch(`${API_URL}/auth/select-company`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ companyId: companyId })
                });

                if (res.ok) {
                    const data = await res.json();
                    token = data.token;
                    localStorage.setItem('token', token);
                    selectedCompanyId = companyId;
                    showNotification('Switched to company!', 'success');
                    location.reload();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to switch company', 'error');
                }
            } catch (e) {
                showNotification('Failed to switch company', 'error');
            }
        }

        // ========== PRODUCT STOCK MANAGEMENT (Multi-Location) ==========

        let currentStockProductId = null;

        async function showProductStockModal(productId, productName, productCode) {
            currentStockProductId = productId;
            document.getElementById('stockProductName').textContent = productName;
            document.getElementById('stockProductCode').textContent = 'Code: ' + productCode;
            document.getElementById('productStockModal').style.display = 'flex';

            await loadProductStockByLocation(productId);
        }

        function closeProductStockModal() {
            document.getElementById('productStockModal').style.display = 'none';
            currentStockProductId = null;
        }

        async function loadProductStockByLocation(productId) {
            const tbody = document.getElementById('productStockTableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;">Loading...</td></tr>';

            try {
                const res = await fetch(`${API_URL}/pos/products/${productId}/stock-by-location`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    const locations = data.locations || [];

                    if (locations.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;padding:20px;">No locations configured. Add locations in Company Management first.</td></tr>';
                    } else {
                        tbody.innerHTML = locations.map(loc => `
                            <tr data-location-id="${loc.location_id}">
                                <td><strong>${loc.location_name}</strong></td>
                                <td>
                                    <input type="number" class="stock-input" data-field="stock"
                                        value="${loc.stock_quantity || 0}" min="0"
                                        style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                                </td>
                                <td>
                                    <input type="number" class="stock-input" data-field="reorder"
                                        value="${loc.reorder_level || 10}" min="0"
                                        style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                                </td>
                                <td style="text-align:center;">
                                    <input type="checkbox" class="stock-active" ${loc.is_active ? 'checked' : ''}>
                                </td>
                            </tr>
                        `).join('');
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#c62828;padding:20px;">Failed to load stock data</td></tr>';
                }
            } catch (e) {
                console.log('Error loading product stock:', e);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#c62828;padding:20px;">Error loading stock data</td></tr>';
            }
        }

        async function saveProductStock() {
            if (!currentStockProductId) return;

            const rows = document.querySelectorAll('#productStockTableBody tr[data-location-id]');
            const stockData = [];

            rows.forEach(row => {
                const locationId = row.dataset.locationId;
                const stock = row.querySelector('input[data-field="stock"]').value;
                const reorder = row.querySelector('input[data-field="reorder"]').value;
                const isActive = row.querySelector('.stock-active').checked;

                stockData.push({
                    location_id: parseInt(locationId),
                    stock_quantity: parseInt(stock) || 0,
                    reorder_level: parseInt(reorder) || 10,
                    is_active: isActive ? 1 : 0
                });
            });

            try {
                const res = await fetch(`${API_URL}/pos/products/${currentStockProductId}/stock-by-location`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stockData })
                });

                if (res.ok) {
                    showNotification('Stock levels saved!', 'success');
                    closeProductStockModal();
                    loadProducts(); // Refresh products list
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to save stock', 'error');
                }
            } catch (e) {
                showNotification('Failed to save stock', 'error');
            }
        }

        function toggleShareAllLocations() {
            const checked = document.getElementById('stockShareAllLocations').checked;
            const checkboxes = document.querySelectorAll('#productStockTableBody .stock-active');
            checkboxes.forEach(cb => cb.checked = checked);
        }

        function showAddCompanyModal() {
            document.getElementById('companyModalTitle').textContent = 'Add Company';
            document.getElementById('companyName').value = '';
            document.getElementById('companyTradingName').value = '';
            document.getElementById('companyRegNumber').value = '';
            document.getElementById('companyVatNumber').value = '';
            document.getElementById('companyEmail').value = '';
            document.getElementById('companyPhone').value = '';
            document.getElementById('companyAddress').value = '';
            document.getElementById('companyModal').style.display = 'flex';
        }

        function closeCompanyModal() {
            document.getElementById('companyModal').style.display = 'none';
        }

        async function saveCompany() {
            const name = document.getElementById('companyName').value.trim();
            if (!name) {
                showNotification('Company name is required', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/companies/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        company_name: name,
                        trading_name: document.getElementById('companyTradingName').value.trim() || null,
                        registration_number: document.getElementById('companyRegNumber').value.trim() || null,
                        vat_number: document.getElementById('companyVatNumber').value.trim() || null,
                        contact_email: document.getElementById('companyEmail').value.trim() || null,
                        contact_phone: document.getElementById('companyPhone').value.trim() || null,
                        address: document.getElementById('companyAddress').value.trim() || null
                    })
                });

                if (res.ok) {
                    showNotification('Company created successfully! It has its own separate data.', 'success');
                    closeCompanyModal();
                    loadCompanies();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to create company', 'error');
                }
            } catch (e) {
                showNotification('Failed to create company', 'error');
            }
        }

        function editCompany(id) {
            showNotification('Company editing coming soon', 'info');
        }

        function viewCompanyUsers(companyId) {
            // Switch to Users section and pre-select the company
            showSettings('users', null);
            document.querySelectorAll('.settings-menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent === 'Users') item.classList.add('active');
            });
            loadCompaniesForUserFilter().then(() => {
                document.getElementById('userCompanyFilter').value = companyId;
                loadCompanyUsers();
            });
        }

        async function loadCompaniesForUserFilter() {
            try {
                const res = await fetch(`${API_URL}/auth/companies/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const companies = data.companies || [];
                    const select = document.getElementById('userCompanyFilter');
                    const userSelect = document.getElementById('userCompanySelect');
                    const opts = '<option value="">Select company...</option>' +
                        companies.map(c => `<option value="${c.id}">${c.company_name}${c.trading_name ? ' (' + c.trading_name + ')' : ''}</option>`).join('');
                    select.innerHTML = opts;
                    userSelect.innerHTML = opts;
                }
            } catch (e) {
                console.log('Error loading companies for filter:', e);
            }
        }

        async function loadCompanyUsers() {
            const companyId = document.getElementById('userCompanyFilter').value;
            const tbody = document.getElementById('usersTableBody');

            if (!companyId) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;padding:20px;">Select a company to view its users</td></tr>';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/companies/${companyId}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const users = data.users || [];
                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;padding:20px;">No users in this company. Add one to get started.</td></tr>';
                    } else {
                        tbody.innerHTML = users.map(u => `
                            <tr>
                                <td><strong>${u.full_name}</strong></td>
                                <td>${u.username}</td>
                                <td>${u.email || '-'}</td>
                                <td><span class="status-badge active" style="background:#e8eaf6;color:#3949ab;">${(u.role || '').replace(/_/g, ' ')}</span></td>
                                <td>${u.employee_id || '-'}</td>
                                <td><span class="status-badge ${u.is_active ? 'active' : 'closed'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>${u.last_login_at ? new Date(u.last_login_at).toLocaleString() : 'Never'}</td>
                                <td>
                                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;color:#c62828;" onclick="removeUserFromCompany(${companyId}, ${u.id}, '${u.full_name}')">Remove</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } else {
                    const err = await res.json();
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#c62828;padding:20px;">${err.error || 'Failed to load users'}</td></tr>`;
                }
            } catch (e) {
                console.log('Users load error:', e);
            }
        }

        function showAddUserModal() {
            document.getElementById('userFullName').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = '';
            document.getElementById('userEmployeeId').value = '';

            // Pre-select company if one is already selected
            const currentCompany = document.getElementById('userCompanyFilter').value;
            if (currentCompany) {
                document.getElementById('userCompanySelect').value = currentCompany;
            }

            document.getElementById('userModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        async function saveUser() {
            const companyId = document.getElementById('userCompanySelect').value;
            const fullName = document.getElementById('userFullName').value.trim();
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            if (!companyId) { showNotification('Please select a company', 'error'); return; }
            if (!fullName) { showNotification('Full name is required', 'error'); return; }
            if (!username) { showNotification('Username is required', 'error'); return; }
            if (!password || password.length < 6) { showNotification('Password must be at least 6 characters', 'error'); return; }
            if (!role) { showNotification('Please select a role', 'error'); return; }

            try {
                const res = await fetch(`${API_URL}/auth/companies/${companyId}/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        email: document.getElementById('userEmail').value.trim() || null,
                        password,
                        full_name: fullName,
                        role,
                        employee_id: document.getElementById('userEmployeeId').value.trim() || null
                    })
                });

                if (res.ok) {
                    showNotification(`User "${fullName}" created and added to company`, 'success');
                    closeUserModal();
                    // Refresh user list if viewing the same company
                    document.getElementById('userCompanyFilter').value = companyId;
                    loadCompanyUsers();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to create user', 'error');
                }
            } catch (e) {
                showNotification('Failed to create user', 'error');
            }
        }

        async function removeUserFromCompany(companyId, userId, userName) {
            if (!confirm(`Remove "${userName}" from this company? They will lose access to all company data.`)) return;

            try {
                const res = await fetch(`${API_URL}/auth/companies/${companyId}/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    showNotification(`${userName} removed from company`, 'success');
                    loadCompanyUsers();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to remove user', 'error');
                }
            } catch (e) {
                showNotification('Failed to remove user', 'error');
            }
        }

        // ========== RECEIPT PRINTERS MANAGEMENT ==========

        let editingPrinterId = null;

        async function loadPrinters() {
            try {
                const res = await fetch(`${API_URL}/receipts/printers`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const printers = data.printers || [];
                    const tbody = document.getElementById('printersTableBody');

                    if (printers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;padding:20px;">No printers configured. Add a thermal printer to enable receipt printing.</td></tr>';
                    } else {
                        tbody.innerHTML = printers.map(p => `
                            <tr>
                                <td><strong>${p.printer_name}</strong></td>
                                <td>${p.ip_address}</td>
                                <td>${p.port || 9100}</td>
                                <td>${p.paper_width || 80}mm</td>
                                <td>${p.is_default ? '<span class="status-badge active">Default</span>' : ''}</td>
                                <td><span class="status-badge ${p.is_active ? 'active' : 'closed'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;" onclick="testPrinter(${p.id})">Test</button>
                                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;" onclick="editPrinter(${p.id}, '${p.printer_name}', '${p.ip_address}', ${p.port || 9100}, ${p.paper_width || 80}, ${p.is_default ? 1 : 0})">Edit</button>
                                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;color:#c62828;" onclick="deletePrinter(${p.id})">Delete</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Error loading printers:', e);
            }
        }

        async function loadReceiptSettings() {
            try {
                const res = await fetch(`${API_URL}/receipts/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const settings = data.settings || {};
                    document.getElementById('receiptHeader').value = settings.receipt_header || '';
                    document.getElementById('receiptFooter').value = settings.receipt_footer || '';
                    document.getElementById('autoPrintReceipt').checked = settings.auto_print_receipt === 1;
                    autoPrintEnabled = settings.auto_print_receipt === 1;
                }
            } catch (e) {
                console.log('Error loading receipt settings:', e);
            }
        }

        async function saveReceiptSettings() {
            try {
                const res = await fetch(`${API_URL}/receipts/settings`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        receipt_header: document.getElementById('receiptHeader').value,
                        receipt_footer: document.getElementById('receiptFooter').value,
                        auto_print_receipt: document.getElementById('autoPrintReceipt').checked ? 1 : 0
                    })
                });

                if (res.ok) {
                    showNotification('Receipt settings saved!', 'success');
                    autoPrintEnabled = document.getElementById('autoPrintReceipt').checked;
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to save settings', 'error');
                }
            } catch (e) {
                showNotification('Failed to save settings', 'error');
            }
        }

        function showAddPrinterModal() {
            editingPrinterId = null;
            document.getElementById('printerModalTitle').textContent = 'Add Printer';
            document.getElementById('printerName').value = '';
            document.getElementById('printerIp').value = '';
            document.getElementById('printerPort').value = '9100';
            document.getElementById('printerPaperWidth').value = '80';
            document.getElementById('printerIsDefault').checked = false;
            document.getElementById('printerModal').style.display = 'flex';
        }

        function editPrinter(id, name, ip, port, paperWidth, isDefault) {
            editingPrinterId = id;
            document.getElementById('printerModalTitle').textContent = 'Edit Printer';
            document.getElementById('printerName').value = name;
            document.getElementById('printerIp').value = ip;
            document.getElementById('printerPort').value = port;
            document.getElementById('printerPaperWidth').value = paperWidth;
            document.getElementById('printerIsDefault').checked = isDefault === 1;
            document.getElementById('printerModal').style.display = 'flex';
        }

        function closePrinterModal() {
            document.getElementById('printerModal').style.display = 'none';
        }

        async function savePrinter() {
            const name = document.getElementById('printerName').value.trim();
            const ip = document.getElementById('printerIp').value.trim();
            const port = parseInt(document.getElementById('printerPort').value) || 9100;
            const paperWidth = parseInt(document.getElementById('printerPaperWidth').value) || 80;
            const isDefault = document.getElementById('printerIsDefault').checked ? 1 : 0;

            if (!name) { showNotification('Printer name is required', 'error'); return; }
            if (!ip) { showNotification('IP address is required', 'error'); return; }

            try {
                const url = editingPrinterId
                    ? `${API_URL}/receipts/printers/${editingPrinterId}`
                    : `${API_URL}/receipts/printers`;
                const method = editingPrinterId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        printer_name: name,
                        ip_address: ip,
                        port,
                        paper_width: paperWidth,
                        is_default: isDefault
                    })
                });

                if (res.ok) {
                    showNotification(editingPrinterId ? 'Printer updated!' : 'Printer added!', 'success');
                    closePrinterModal();
                    loadPrinters();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to save printer', 'error');
                }
            } catch (e) {
                showNotification('Failed to save printer', 'error');
            }
        }

        async function testPrinter(printerId) {
            showNotification('Sending test print...', 'info');
            try {
                const res = await fetch(`${API_URL}/receipts/printers/${printerId}/test`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('Test print sent successfully!', 'success');
                } else {
                    showNotification(data.error || 'Test print failed', 'error');
                }
            } catch (e) {
                showNotification('Test print failed: ' + e.message, 'error');
            }
        }

        async function deletePrinter(printerId) {
            if (!confirm('Delete this printer?')) return;

            try {
                const res = await fetch(`${API_URL}/receipts/printers/${printerId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    showNotification('Printer deleted', 'success');
                    loadPrinters();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to delete printer', 'error');
                }
            } catch (e) {
                showNotification('Failed to delete printer', 'error');
            }
        }

        async function loadGeneralSettings() {
            try {
                // Load company info
                const companyRes = await fetch(`${API_URL}/auth/company-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (companyRes.ok) {
                    const companyData = await companyRes.json();
                    const company = companyData.company || {};
                    document.getElementById('settingsCompanyName').value = company.company_name || '';
                    document.getElementById('settingsTradingName').value = company.trading_name || '';
                    document.getElementById('settingsVatNumber').value = company.vat_number || '';
                    document.getElementById('settingsRegNumber').value = company.registration_number || '';
                    document.getElementById('settingsPhone').value = company.contact_phone || '';
                    document.getElementById('settingsEmail').value = company.contact_email || '';
                    document.getElementById('settingsAddress').value = company.address || '';
                }

                // Load company settings
                const settingsRes = await fetch(`${API_URL}/pos/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (settingsRes.ok) {
                    const data = await settingsRes.json();
                    const settings = data.settings || {};
                    document.getElementById('defaultFloatAmount').value = settings.default_float_amount || 500;
                    document.getElementById('settingsProductPrefix').value = settings.product_code_prefix || 'PRO';
                    document.getElementById('settingsReceiptPrefix').value = settings.receipt_prefix || 'INV';
                    document.getElementById('settingsNextReceiptNumber').value = settings.next_receipt_number || 1;
                    document.getElementById('settingsVatRate').value = settings.vat_rate || 15;
                    document.getElementById('settingsAutoPrint').checked = settings.auto_print_receipt !== 0;
                    document.getElementById('settingsOpenDrawer').checked = settings.open_drawer_on_sale !== 0;
                    document.getElementById('settingsGroupItems').checked = settings.group_same_items !== 0;
                    document.getElementById('settingsShowImages').checked = settings.use_product_images === 1;

                    // Update auto-print flag
                    autoPrintEnabled = settings.auto_print_receipt !== 0;
                }
            } catch (e) {
                console.log('General settings load error:', e);
            }
        }

        async function saveGeneralSettings() {
            try {
                // Save company info
                const companyRes = await fetch(`${API_URL}/auth/company-info`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        company_name: document.getElementById('settingsCompanyName').value.trim(),
                        trading_name: document.getElementById('settingsTradingName').value.trim() || null,
                        vat_number: document.getElementById('settingsVatNumber').value.trim() || null,
                        registration_number: document.getElementById('settingsRegNumber').value.trim() || null,
                        contact_phone: document.getElementById('settingsPhone').value.trim() || null,
                        contact_email: document.getElementById('settingsEmail').value.trim() || null,
                        address: document.getElementById('settingsAddress').value.trim() || null
                    })
                });

                // Save company settings
                const settingsRes = await fetch(`${API_URL}/pos/settings`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        default_float_amount: parseFloat(document.getElementById('defaultFloatAmount').value) || 500,
                        product_code_prefix: document.getElementById('settingsProductPrefix').value.trim().toUpperCase() || 'PRO',
                        receipt_prefix: document.getElementById('settingsReceiptPrefix').value.trim().toUpperCase() || 'INV',
                        next_receipt_number: parseInt(document.getElementById('settingsNextReceiptNumber').value) || 1,
                        vat_rate: parseFloat(document.getElementById('settingsVatRate').value) || 15,
                        auto_print_receipt: document.getElementById('settingsAutoPrint').checked ? 1 : 0,
                        open_drawer_on_sale: document.getElementById('settingsOpenDrawer').checked ? 1 : 0,
                        group_same_items: document.getElementById('settingsGroupItems').checked ? 1 : 0,
                        use_product_images: document.getElementById('settingsShowImages').checked ? 1 : 0
                    })
                });

                if (companyRes.ok && settingsRes.ok) {
                    showNotification('All settings saved successfully!', 'success');
                    autoPrintEnabled = document.getElementById('settingsAutoPrint').checked;
                } else {
                    showNotification('Some settings may not have saved', 'error');
                }
            } catch (e) {
                showNotification('Failed to save settings: ' + e.message, 'error');
            }
        }

        // ========== REGISTRATION & SUPER ADMIN ==========

        function showRegisterForm() {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('registerBox').style.display = 'block';
        }

        function showLoginForm() {
            document.getElementById('registerBox').style.display = 'none';
            document.getElementById('loginBox').style.display = 'block';
        }

        async function registerCompany() {
            const data = {
                full_name: document.getElementById('regFullName').value.trim(),
                username: document.getElementById('regUsername').value.trim(),
                email: document.getElementById('regEmail').value.trim(),
                password: document.getElementById('regPassword').value,
                company_name: document.getElementById('regCompanyName').value.trim(),
                trading_name: document.getElementById('regTradingName').value.trim(),
                registration_number: document.getElementById('regRegNumber').value.trim(),
                vat_number: document.getElementById('regVatNumber').value.trim(),
                contact_email: document.getElementById('regContactEmail').value.trim(),
                contact_phone: document.getElementById('regContactPhone').value.trim(),
                address: document.getElementById('regAddress').value.trim()
            };

            if (!data.full_name || !data.username || !data.email || !data.password) {
                showNotification('Please fill in all required personal details', 'error');
                return;
            }
            if (!data.company_name) {
                showNotification('Company name is required', 'error');
                return;
            }
            if (data.password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/register-company`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (res.ok) {
                    alert('Registration successful!\\n\\nYour company account is now pending approval. You will be able to log in once an administrator activates your account.\\n\\nThank you for registering with Checkout Charlie!');
                    showLoginForm();
                    // Clear form
                    document.getElementById('regFullName').value = '';
                    document.getElementById('regUsername').value = '';
                    document.getElementById('regEmail').value = '';
                    document.getElementById('regPassword').value = '';
                    document.getElementById('regCompanyName').value = '';
                    document.getElementById('regTradingName').value = '';
                    document.getElementById('regRegNumber').value = '';
                    document.getElementById('regVatNumber').value = '';
                    document.getElementById('regContactEmail').value = '';
                    document.getElementById('regContactPhone').value = '';
                    document.getElementById('regAddress').value = '';
                } else {
                    showNotification(result.error || 'Registration failed', 'error');
                }
            } catch (e) {
                showNotification('Registration failed. Please try again.', 'error');
            }
        }

        // Super Admin Portal
        function showSuperAdminPortal() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('companySelectorScreen').style.display = 'none';
            document.getElementById('superAdminPortal').style.display = 'block';
            document.getElementById('adminUserName').textContent = currentUser ? currentUser.fullName : 'Admin';
            loadAdminStats();
            loadAdminCompanies();
            loadAdminUsers();
        }

        async function loadAdminStats() {
            try {
                const res = await fetch(`${API_URL}/auth/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const s = data.stats || {};
                    document.getElementById('statTotalCompanies').textContent = s.total_companies || 0;
                    document.getElementById('statActiveCompanies').textContent = s.active_companies || 0;
                    document.getElementById('statPendingCompanies').textContent = s.pending_companies || 0;
                    document.getElementById('statSuspendedCompanies').textContent = s.suspended_companies || 0;
                }
            } catch (e) {
                console.log('Stats load error:', e);
            }
        }

        async function loadAdminCompanies() {
            try {
                const res = await fetch(`${API_URL}/auth/admin/companies`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const companies = data.companies || [];
                    const tbody = document.getElementById('adminCompaniesTable');

                    if (companies.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: #94a3b8;">No companies registered yet</td></tr>';
                        return;
                    }

                    tbody.innerHTML = companies.map(c => {
                        const statusColors = {
                            'active': 'background: #22c55e; color: white;',
                            'pending': 'background: #fbbf24; color: #1a1a2e;',
                            'suspended': 'background: #ef4444; color: white;',
                            'trial': 'background: #3b82f6; color: white;'
                        };
                        const statusStyle = statusColors[c.subscription_status] || statusColors['pending'];

                        return `<tr style="border-bottom: 1px solid #1a1a2e;">
                            <td style="padding: 12px 15px;">
                                <div style="font-weight: 600;">${c.company_name}</div>
                                ${c.trading_name ? `<div style="font-size: 12px; color: #94a3b8;">${c.trading_name}</div>` : ''}
                            </td>
                            <td style="padding: 12px 15px;">${c.owner_name || '-'}</td>
                            <td style="padding: 12px 15px; font-size: 13px;">${c.contact_email || c.owner_email || '-'}</td>
                            <td style="padding: 12px 15px;">${c.user_count || 0}</td>
                            <td style="padding: 12px 15px;">${c.total_sales || 0}</td>
                            <td style="padding: 12px 15px;">
                                <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; ${statusStyle}">${(c.subscription_status || 'pending').toUpperCase()}</span>
                            </td>
                            <td style="padding: 12px 15px; font-size: 12px; color: #94a3b8;">${c.created_at ? new Date(c.created_at).toLocaleDateString() : '-'}</td>
                            <td style="padding: 12px 15px;">
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button onclick="showAdminCompanyEdit(${c.id})" style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Edit</button>
                                    ${c.subscription_status === 'active' ?
                                        `<button onclick="updateCompanyStatus(${c.id}, 'suspended')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Suspend</button>` :
                                        `<button onclick="updateCompanyStatus(${c.id}, 'active')" style="background: #22c55e; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Activate</button>`
                                    }
                                    <button onclick="deleteCompany(${c.id}, '${c.company_name.replace(/'/g, "\\'")}')" style="background: #7c3aed; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                                </div>
                            </td>
                        </tr>`;
                    }).join('');
                }
            } catch (e) {
                console.log('Companies load error:', e);
            }
        }

        async function updateCompanyStatus(companyId, status) {
            const action = status === 'active' ? 'activate' : 'suspend';
            if (!confirm(`Are you sure you want to ${action} this company?`)) return;

            try {
                const res = await fetch(`${API_URL}/auth/admin/companies/${companyId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                if (res.ok) {
                    showNotification(`Company ${status === 'active' ? 'activated' : 'suspended'} successfully`, 'success');
                    loadAdminStats();
                    loadAdminCompanies();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to update company', 'error');
                }
            } catch (e) {
                showNotification('Failed to update company status', 'error');
            }
        }

        async function deleteCompany(companyId, companyName) {
            // Double confirmation for safety
            if (!confirm(`Are you sure you want to DELETE "${companyName}"?\n\nThis will permanently remove:\n- The company\n- All users\n- All products\n- All sales history\n- All other data\n\nThis action CANNOT be undone!`)) return;

            const confirmText = prompt(`To confirm deletion, type the company name:\n${companyName}`);
            if (confirmText !== companyName) {
                showNotification('Company name did not match. Deletion cancelled.', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/admin/companies/${companyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (res.ok) {
                    showNotification(`Company "${companyName}" deleted successfully`, 'success');
                    loadAdminStats();
                    loadAdminCompanies();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to delete company', 'error');
                }
            } catch (e) {
                showNotification('Failed to delete company', 'error');
            }
        }

        async function showAdminCompanyEdit(companyId) {
            document.getElementById('adminCompanyModal').style.display = 'flex';
            document.getElementById('adminCompanyId').value = companyId;

            // Clear form
            document.getElementById('adminOwnerName').textContent = 'Loading...';
            document.getElementById('adminOwnerUsername').textContent = '-';
            document.getElementById('adminOwnerEmail').textContent = '-';
            document.getElementById('adminOwnerPhone').textContent = '-';

            try {
                const res = await fetch(`${API_URL}/auth/admin/companies/${companyId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    const c = data.company;
                    const owner = data.owner;
                    const stats = data.stats;

                    // Owner info
                    document.getElementById('adminOwnerName').textContent = owner?.full_name || '-';
                    document.getElementById('adminOwnerUsername').textContent = owner?.username || '-';
                    document.getElementById('adminOwnerEmail').textContent = owner?.email || '-';
                    document.getElementById('adminOwnerPhone').textContent = owner?.phone || '-';

                    // Company details
                    document.getElementById('adminCompanyName').value = c.company_name || '';
                    document.getElementById('adminTradingName').value = c.trading_name || '';
                    document.getElementById('adminVatNumber').value = c.vat_number || '';
                    document.getElementById('adminRegNumber').value = c.registration_number || '';
                    document.getElementById('adminContactEmail').value = c.contact_email || '';
                    document.getElementById('adminContactPhone').value = c.contact_phone || '';
                    document.getElementById('adminAddress').value = c.address || '';
                    document.getElementById('adminSubStatus').value = c.subscription_status || 'pending';

                    // Stats
                    document.getElementById('adminStatUsers').textContent = stats?.user_count || 0;
                    document.getElementById('adminStatProducts').textContent = stats?.product_count || 0;
                    document.getElementById('adminStatSales').textContent = stats?.sale_count || 0;
                    document.getElementById('adminStatCreated').textContent = c.created_at ? new Date(c.created_at).toLocaleDateString() : '-';
                    document.getElementById('adminStatApproved').textContent = c.approved_at ? new Date(c.approved_at).toLocaleDateString() : 'Not yet';
                } else {
                    showNotification('Failed to load company details', 'error');
                    closeAdminCompanyModal();
                }
            } catch (e) {
                showNotification('Failed to load company details', 'error');
                closeAdminCompanyModal();
            }
        }

        function closeAdminCompanyModal() {
            document.getElementById('adminCompanyModal').style.display = 'none';
        }

        async function saveAdminCompany() {
            const companyId = document.getElementById('adminCompanyId').value;
            const data = {
                company_name: document.getElementById('adminCompanyName').value.trim(),
                trading_name: document.getElementById('adminTradingName').value.trim(),
                vat_number: document.getElementById('adminVatNumber').value.trim(),
                registration_number: document.getElementById('adminRegNumber').value.trim(),
                contact_email: document.getElementById('adminContactEmail').value.trim(),
                contact_phone: document.getElementById('adminContactPhone').value.trim(),
                address: document.getElementById('adminAddress').value.trim(),
                subscription_status: document.getElementById('adminSubStatus').value
            };

            if (!data.company_name) {
                showNotification('Company name is required', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/admin/companies/${companyId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showNotification('Company updated successfully', 'success');
                    closeAdminCompanyModal();
                    loadAdminCompanies();
                    loadAdminStats();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to update company', 'error');
                }
            } catch (e) {
                showNotification('Failed to update company', 'error');
            }
        }

        // ========== ADMIN USER MANAGEMENT ==========

        async function loadAdminUsers() {
            try {
                const res = await fetch(`${API_URL}/auth/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const users = data.users || [];
                    const tbody = document.getElementById('adminUsersTable');

                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #94a3b8;">No users found</td></tr>';
                        return;
                    }

                    tbody.innerHTML = users.map(u => {
                        const isOrphaned = !u.company_count || u.company_count === 0;
                        const rowStyle = isOrphaned ? 'background: rgba(239, 68, 68, 0.1);' : '';
                        return `<tr style="border-bottom: 1px solid #1a1a2e; ${rowStyle}">
                            <td style="padding: 12px 15px;">
                                <div style="font-weight: 600;">${u.full_name || u.username}</div>
                                <div style="font-size: 12px; color: #94a3b8;">@${u.username}</div>
                            </td>
                            <td style="padding: 12px 15px; font-size: 13px;">${u.email || '-'}</td>
                            <td style="padding: 12px 15px;">
                                ${isOrphaned ? '<span style="color: #ef4444;">None (orphaned)</span>' : `${u.company_count} company(s)`}
                            </td>
                            <td style="padding: 12px 15px;">
                                ${u.is_super_admin ? '<span style="color: #fbbf24;">Super Admin</span>' : u.user_type || 'user'}
                            </td>
                            <td style="padding: 12px 15px; font-size: 12px; color: #94a3b8;">${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
                            <td style="padding: 12px 15px;">
                                ${u.is_super_admin ? '' : `<button onclick="deleteAdminUser(${u.id}, '${(u.username || '').replace(/'/g, "\\'")}')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>`}
                            </td>
                        </tr>`;
                    }).join('');
                }
            } catch (e) {
                console.log('Users load error:', e);
            }
        }

        async function deleteAdminUser(userId, username) {
            if (!confirm(`Delete user "${username}"?\n\nThis will remove the user and all their company access.`)) return;

            try {
                const res = await fetch(`${API_URL}/auth/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    showNotification(`User "${username}" deleted`, 'success');
                    loadAdminUsers();
                    loadAdminStats();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to delete user', 'error');
                }
            } catch (e) {
                showNotification('Failed to delete user', 'error');
            }
        }

        async function cleanOrphanedUsers() {
            if (!confirm('Delete all orphaned users?\n\nThis will remove users who have no company access.')) return;

            try {
                const res = await fetch(`${API_URL}/auth/admin/users/cleanup-orphaned`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    showNotification(`Cleaned ${data.deleted || 0} orphaned users`, 'success');
                    loadAdminUsers();
                } else {
                    const err = await res.json();
                    showNotification(err.error || 'Failed to clean users', 'error');
                }
            } catch (e) {
                showNotification('Failed to clean orphaned users', 'error');
            }
        }

        function logoutAdmin() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            localStorage.removeItem('isSuperAdmin');
            document.getElementById('superAdminPortal').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            showLoginForm();
        }

        // ========== SWITCH STORE (Multi-company) ==========

        async function showSwitchStoreModal() {
            // Load user's accessible companies
            try {
                const res = await fetch(`${API_URL}/auth/companies`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const companies = data.companies || [];

                    if (companies.length <= 1) {
                        showNotification('You only have access to one company', 'info');
                        return;
                    }

                    // Create and show modal
                    let modal = document.getElementById('switchStoreModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'switchStoreModal';
                        modal.className = 'modal-overlay';
                        modal.innerHTML = `
                            <div class="modal" style="max-width: 450px;">
                                <div class="modal-header">
                                    <h2>Switch Store / Company</h2>
                                    <button class="close-btn" onclick="closeSwitchStoreModal()">&times;</button>
                                </div>
                                <div class="modal-body" style="padding: 20px;" id="switchStoreList"></div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }

                    const listDiv = document.getElementById('switchStoreList');
                    listDiv.innerHTML = companies.map(c => `
                        <div onclick="switchToCompany(${c.id})" style="padding: 15px; border: 2px solid ${c.id === currentCompanyId ? '#667eea' : '#e0e0e0'}; border-radius: 8px; margin-bottom: 10px; cursor: pointer; background: ${c.id === currentCompanyId ? '#f5f7ff' : 'white'};">
                            <div style="font-weight: 600; color: #333;">${c.company_name}</div>
                            ${c.trading_name ? `<div style="font-size: 13px; color: #666;">${c.trading_name}</div>` : ''}
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">Role: ${(c.role || 'user').replace(/_/g, ' ')}</div>
                            ${c.id === currentCompanyId ? '<div style="color: #667eea; font-size: 12px; margin-top: 5px;">‚úì Currently selected</div>' : ''}
                        </div>
                    `).join('');

                    modal.style.display = 'flex';
                }
            } catch (e) {
                showNotification('Failed to load companies', 'error');
            }
        }

        function closeSwitchStoreModal() {
            const modal = document.getElementById('switchStoreModal');
            if (modal) modal.style.display = 'none';
        }

        async function switchToCompany(companyId) {
            if (companyId === currentCompanyId) {
                closeSwitchStoreModal();
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/select-company`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ companyId })
                });

                const result = await res.json();

                if (res.ok) {
                    token = result.token;
                    localStorage.setItem('token', token);
                    currentCompanyId = result.company.id;
                    currentCompanyName = result.company.company_name;
                    userRole = result.role;
                    userPermissions = result.permissions || {};

                    closeSwitchStoreModal();
                    showNotification(`Switched to ${currentCompanyName}`, 'success');

                    // Reload data for new company
                    loadProducts();
                    updateSessionDisplay();
                } else {
                    showNotification(result.error || result.message || 'Failed to switch company', 'error');
                }
            } catch (e) {
                showNotification('Failed to switch company', 'error');
            }
        }

        let currentCompanyId = null;
        let currentCompanyName = null;

        // ========== RECEIPT DELIVERY FUNCTIONS ==========

        let receiptDeliveryMethod = null;

        async function deliverReceipt(saleId, method) {
            if (method === 'print') {
                printReceipt(saleId);
                return;
            }
            try {
                const res = await fetch(`${API_URL}/receipts/deliver/${saleId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ methods: [method] })
                });
                const result = await res.json();
                if (res.ok) {
                    showNotification(`Receipt ${method} delivery initiated`, 'success');
                } else {
                    showNotification(result.error || 'Delivery failed', 'error');
                }
            } catch (e) {
                showNotification('Receipt delivery failed', 'error');
            }
        }

        function showEmailReceiptInput(saleId) {
            receiptDeliveryMethod = 'email';
            const inputDiv = document.getElementById('receiptDeliveryInput');
            inputDiv.style.display = 'block';
            document.getElementById('receiptDeliveryValue').placeholder = 'Enter email address...';
            document.getElementById('receiptDeliveryValue').type = 'email';
            document.getElementById('receiptDeliveryValue').value = '';
            inputDiv.dataset.saleId = saleId;
        }

        function showSmsReceiptInput(saleId) {
            receiptDeliveryMethod = 'sms';
            const inputDiv = document.getElementById('receiptDeliveryInput');
            inputDiv.style.display = 'block';
            document.getElementById('receiptDeliveryValue').placeholder = 'Enter phone number (e.g. 0821234567)...';
            document.getElementById('receiptDeliveryValue').type = 'tel';
            document.getElementById('receiptDeliveryValue').value = '';
            inputDiv.dataset.saleId = saleId;
        }

        function showWhatsAppReceiptInput(saleId) {
            receiptDeliveryMethod = 'whatsapp';
            const inputDiv = document.getElementById('receiptDeliveryInput');
            inputDiv.style.display = 'block';
            document.getElementById('receiptDeliveryValue').placeholder = 'Enter WhatsApp number...';
            document.getElementById('receiptDeliveryValue').type = 'tel';
            document.getElementById('receiptDeliveryValue').value = '';
            inputDiv.dataset.saleId = saleId;
        }

        async function sendReceiptDelivery(saleId) {
            const value = document.getElementById('receiptDeliveryValue').value.trim();
            if (!value) {
                showNotification('Please enter a valid destination', 'error');
                return;
            }

            const statusDiv = document.getElementById('receiptDeliveryStatus');
            statusDiv.innerHTML = '<span style="color:#667eea;">Sending...</span>';

            try {
                const body = { methods: [receiptDeliveryMethod] };
                if (receiptDeliveryMethod === 'email') body.email = value;
                if (receiptDeliveryMethod === 'sms') body.phone = value;
                if (receiptDeliveryMethod === 'whatsapp') body.phone = value;

                const res = await fetch(`${API_URL}/receipts/deliver/${saleId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const result = await res.json();
                if (res.ok) {
                    statusDiv.innerHTML = '<span style="color:#10b981;">&#10003; Receipt sent successfully!</span>';
                    document.getElementById('receiptDeliveryInput').style.display = 'none';
                } else {
                    statusDiv.innerHTML = `<span style="color:#dc3545;">Failed: ${result.error || 'Unknown error'}</span>`;
                }
            } catch (e) {
                statusDiv.innerHTML = '<span style="color:#dc3545;">Network error - could not send receipt</span>';
            }
        }

        // ========== FORENSIC AUDIT LOG VIEWER ==========

        async function loadForensicAuditReport(container) {
            container.innerHTML = `
                <h2 style="margin-bottom:15px;">Forensic Audit Log</h2>
                <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;align-items:end;">
                    <div>
                        <label style="font-size:12px;color:#666;display:block;">Action Type</label>
                        <select id="auditActionFilter" style="padding:8px;border:1px solid #ddd;border-radius:4px;">
                            <option value="">All Actions</option>
                            <option value="CREATE">Create</option>
                            <option value="UPDATE">Update</option>
                            <option value="DELETE">Delete</option>
                            <option value="VOID">Void</option>
                            <option value="LOGIN">Login</option>
                            <option value="RETURN">Return</option>
                            <option value="STOCK_ADJUST">Stock Adjust</option>
                            <option value="PRICE_OVERRIDE">Price Override</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:12px;color:#666;display:block;">Entity Type</label>
                        <select id="auditEntityFilter" style="padding:8px;border:1px solid #ddd;border-radius:4px;">
                            <option value="">All Entities</option>
                            <option value="sale">Sale</option>
                            <option value="product">Product</option>
                            <option value="customer">Customer</option>
                            <option value="user">User</option>
                            <option value="session">Session</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:12px;color:#666;display:block;">User</label>
                        <input type="text" id="auditUserFilter" placeholder="Username..." style="padding:8px;border:1px solid #ddd;border-radius:4px;">
                    </div>
                    <button class="btn btn-primary" onclick="fetchForensicAudit()" style="padding:8px 15px;">Filter</button>
                </div>
                <div id="forensicAuditResults" style="max-height:60vh;overflow-y:auto;">
                    <div style="text-align:center;padding:40px;color:#999;">Click Filter to load audit entries</div>
                </div>
            `;
        }

        async function fetchForensicAudit() {
            const actionType = document.getElementById('auditActionFilter').value;
            const entityType = document.getElementById('auditEntityFilter').value;
            const username = document.getElementById('auditUserFilter').value.trim();
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            let url = `${API_URL}/audit/forensic?limit=100`;
            if (actionType) url += `&action_type=${actionType}`;
            if (entityType) url += `&entity_type=${entityType}`;
            if (username) url += `&username=${encodeURIComponent(username)}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;

            const container = document.getElementById('forensicAuditResults');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#667eea;">Loading...</div>';

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const entries = data.entries || [];

                if (entries.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">No audit entries found for the selected filters</div>';
                    return;
                }

                container.innerHTML = `
                    <div style="margin-bottom:10px;font-size:13px;color:#666;">${entries.length} entries found</div>
                    <table class="products-table" style="font-size:13px;">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Entity</th>
                                <th>Details</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${entries.map(e => {
                                const details = typeof e.details === 'string' ? e.details : JSON.stringify(e.details || {});
                                const shortDetails = details.length > 80 ? details.substring(0, 80) + '...' : details;
                                const actionColor = {
                                    'CREATE': '#10b981', 'UPDATE': '#667eea', 'DELETE': '#dc3545',
                                    'VOID': '#dc3545', 'LOGIN': '#ff9800', 'RETURN': '#ff9800',
                                    'STOCK_ADJUST': '#9c27b0', 'PRICE_OVERRIDE': '#e91e63'
                                }[e.action_type] || '#666';
                                return `<tr>
                                    <td style="white-space:nowrap;">${new Date(e.created_at).toLocaleString('en-ZA')}</td>
                                    <td>${e.username || 'System'}</td>
                                    <td><span style="background:${actionColor};color:white;padding:2px 8px;border-radius:10px;font-size:11px;">${e.action_type}</span></td>
                                    <td>${e.entity_type || '-'}${e.entity_id ? ' #' + e.entity_id : ''}</td>
                                    <td title="${details.replace(/"/g, '&quot;')}" style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${shortDetails}</td>
                                    <td style="font-size:11px;color:#999;">${e.ip_address || '-'}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (e) {
                container.innerHTML = '<div style="color:#dc3545;padding:20px;text-align:center;">Error loading audit data</div>';
            }
        }

        // ========== PAYMENT METHODS REPORT ==========

        async function loadPaymentMethodsReport(container) {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            let url = `${API_URL}/pos/reports/payment-methods?`;
            if (startDate) url += `start_date=${startDate}&`;
            if (endDate) url += `end_date=${endDate}`;

            container.innerHTML = '<div style="text-align:center;padding:40px;color:#667eea;">Loading payment data...</div>';

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const methods = data.methods || [];

                if (methods.length === 0) {
                    container.innerHTML = '<h2>Payment Methods Report</h2><div style="text-align:center;padding:40px;color:#999;">No payment data for selected period</div>';
                    return;
                }

                const totalAmount = methods.reduce((sum, m) => sum + parseFloat(m.total_amount || 0), 0);
                const totalCount = methods.reduce((sum, m) => sum + parseInt(m.count || 0), 0);

                container.innerHTML = `
                    <h2 style="margin-bottom:20px;">Payment Methods Report</h2>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px;">
                        <div style="background:#f0f4ff;padding:15px;border-radius:8px;text-align:center;">
                            <div style="font-size:24px;font-weight:bold;color:#667eea;">R ${totalAmount.toFixed(2)}</div>
                            <div style="font-size:12px;color:#666;">Total Collected</div>
                        </div>
                        <div style="background:#e8f5e9;padding:15px;border-radius:8px;text-align:center;">
                            <div style="font-size:24px;font-weight:bold;color:#2e7d32;">${totalCount}</div>
                            <div style="font-size:12px;color:#666;">Total Payments</div>
                        </div>
                    </div>
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Payment Method</th>
                                <th style="text-align:right;">Count</th>
                                <th style="text-align:right;">Total Amount</th>
                                <th style="text-align:right;">% of Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${methods.map(m => {
                                const pct = totalAmount > 0 ? ((parseFloat(m.total_amount) / totalAmount) * 100).toFixed(1) : '0';
                                return `<tr>
                                    <td><strong>${m.payment_method}</strong></td>
                                    <td style="text-align:right;">${m.count}</td>
                                    <td style="text-align:right;">R ${parseFloat(m.total_amount).toFixed(2)}</td>
                                    <td style="text-align:right;">
                                        <div style="display:flex;align-items:center;justify-content:flex-end;gap:8px;">
                                            <div style="width:80px;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden;">
                                                <div style="width:${pct}%;height:100%;background:#667eea;border-radius:4px;"></div>
                                            </div>
                                            ${pct}%
                                        </div>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (e) {
                container.innerHTML = '<h2>Payment Methods Report</h2><div style="color:#dc3545;padding:20px;">Error loading payment data</div>';
            }
        }

        // ========== SUSPICIOUS ACTIVITY REPORT ==========

        async function loadSuspiciousActivityReport(container) {
            container.innerHTML = '<div style="text-align:center;padding:40px;color:#667eea;">Analyzing activity patterns...</div>';

            try {
                const res = await fetch(`${API_URL}/audit/suspicious-activity`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const alerts = data.alerts || [];

                container.innerHTML = `
                    <h2 style="margin-bottom:20px;">Suspicious Activity Monitor</h2>
                    ${alerts.length === 0 ? `
                        <div style="text-align:center;padding:40px;">
                            <div style="font-size:48px;margin-bottom:10px;">&#9989;</div>
                            <div style="font-size:18px;font-weight:600;color:#2e7d32;">No Suspicious Activity Detected</div>
                            <div style="color:#666;margin-top:5px;">All activity patterns appear normal for the last 24 hours</div>
                        </div>
                    ` : `
                        <div style="margin-bottom:15px;padding:10px;background:#ffebee;border-radius:8px;border-left:4px solid #dc3545;">
                            <strong style="color:#c62828;">${alerts.length} Alert${alerts.length > 1 ? 's' : ''} Detected</strong>
                        </div>
                        ${alerts.map(alert => `
                            <div style="background:white;border:1px solid ${alert.severity === 'high' ? '#dc3545' : '#ff9800'};border-radius:8px;padding:15px;margin-bottom:10px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                    <strong style="color:${alert.severity === 'high' ? '#c62828' : '#e65100'};">${alert.alert_type || alert.type}</strong>
                                    <span class="status-badge ${alert.severity === 'high' ? 'alert' : 'pending'}">${alert.severity || 'medium'}</span>
                                </div>
                                <div style="font-size:13px;color:#666;">${alert.description || alert.details || ''}</div>
                                ${alert.username ? `<div style="font-size:12px;color:#999;margin-top:5px;">User: ${alert.username}</div>` : ''}
                                ${alert.count ? `<div style="font-size:12px;color:#999;margin-top:3px;">Occurrences: ${alert.count}</div>` : ''}
                            </div>
                        `).join('')}
                    `}
                `;
            } catch (e) {
                container.innerHTML = '<h2>Suspicious Activity</h2><div style="color:#dc3545;padding:20px;">Error loading suspicious activity data</div>';
            }
        }

        // ========== ENHANCED CUSTOMER MANAGEMENT ==========

        async function showCustomerDetail(customerId) {
            try {
                const res = await fetch(`${API_URL}/customers/${customerId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const c = data.customer;

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'customerDetailModal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal" style="max-width:700px;max-height:85vh;overflow-y:auto;">
                        <div class="modal-header" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;">
                            <h2 style="margin:0;">${c.name}</h2>
                            <button class="close-btn" onclick="document.getElementById('customerDetailModal').remove()" style="color:white;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding:20px;">
                            <!-- Customer Info Bar -->
                            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px;">
                                <div style="background:#f0f4ff;padding:12px;border-radius:8px;text-align:center;">
                                    <div style="font-size:20px;font-weight:bold;color:#667eea;">${c.loyalty_points || 0}</div>
                                    <div style="font-size:11px;color:#666;">Loyalty Points</div>
                                </div>
                                <div style="background:#e8f5e9;padding:12px;border-radius:8px;text-align:center;">
                                    <div style="font-size:14px;font-weight:bold;color:#2e7d32;text-transform:capitalize;">${c.loyalty_tier || 'bronze'}</div>
                                    <div style="font-size:11px;color:#666;">Tier</div>
                                </div>
                                <div style="background:#fff3e0;padding:12px;border-radius:8px;text-align:center;">
                                    <div style="font-size:20px;font-weight:bold;color:#e65100;">R ${parseFloat(c.current_balance || 0).toFixed(2)}</div>
                                    <div style="font-size:11px;color:#666;">Account Balance</div>
                                </div>
                                <div style="background:#f3e5f5;padding:12px;border-radius:8px;text-align:center;">
                                    <div style="font-size:20px;font-weight:bold;color:#6a1b9a;">R ${parseFloat(c.credit_limit || 0).toFixed(2)}</div>
                                    <div style="font-size:11px;color:#666;">Credit Limit</div>
                                </div>
                            </div>

                            <!-- Sub Tabs -->
                            <div style="display:flex;gap:5px;margin-bottom:15px;border-bottom:2px solid #e0e0e0;padding-bottom:0;">
                                <button class="nav-tab active" onclick="showCustomerSubTab('info', this)" style="font-size:13px;padding:8px 15px;">Info</button>
                                <button class="nav-tab" onclick="showCustomerSubTab('loyalty', this)" style="font-size:13px;padding:8px 15px;">Loyalty</button>
                                <button class="nav-tab" onclick="showCustomerSubTab('account', this)" style="font-size:13px;padding:8px 15px;">Account</button>
                                <button class="nav-tab" onclick="showCustomerSubTab('history', this)" style="font-size:13px;padding:8px 15px;">Sales</button>
                            </div>

                            <!-- Info Tab -->
                            <div id="custDetailInfo" class="cust-detail-tab">
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13px;">
                                    <div><strong>Customer #:</strong> ${c.customer_number || '-'}</div>
                                    <div><strong>Phone:</strong> ${c.phone || c.contact_number || '-'}</div>
                                    <div><strong>Email:</strong> ${c.email || '-'}</div>
                                    <div><strong>ID Number:</strong> ${c.id_number || '-'}</div>
                                    <div><strong>Group:</strong> ${c.customer_group || 'general'}</div>
                                    <div><strong>Type:</strong> ${c.customer_type || '-'}</div>
                                    <div><strong>DOB:</strong> ${c.date_of_birth || '-'}</div>
                                    <div><strong>Marketing:</strong> ${c.marketing_consent ? 'Yes' : 'No'}</div>
                                    ${c.notes ? `<div style="grid-column:span 2;"><strong>Notes:</strong> ${c.notes}</div>` : ''}
                                </div>
                            </div>

                            <!-- Loyalty Tab -->
                            <div id="custDetailLoyalty" class="cust-detail-tab" style="display:none;">
                                <div style="display:flex;gap:10px;margin-bottom:15px;">
                                    <button class="btn btn-primary" onclick="earnLoyaltyPoints(${c.id})" style="padding:8px 15px;font-size:13px;">+ Earn Points</button>
                                    <button class="btn btn-secondary" onclick="redeemLoyaltyPoints(${c.id})" style="padding:8px 15px;font-size:13px;">Redeem Points</button>
                                </div>
                                <div id="loyaltyHistoryList">Loading loyalty history...</div>
                            </div>

                            <!-- Account Tab -->
                            <div id="custDetailAccount" class="cust-detail-tab" style="display:none;">
                                <div style="display:flex;gap:10px;margin-bottom:15px;">
                                    <button class="btn btn-primary" onclick="recordAccountPayment(${c.id})" style="padding:8px 15px;font-size:13px;">Record Payment</button>
                                </div>
                                <div id="accountHistoryList">Loading account history...</div>
                            </div>

                            <!-- Sales History Tab -->
                            <div id="custDetailHistory" class="cust-detail-tab" style="display:none;">
                                <div id="customerSalesHistory">Loading recent sales...</div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Load loyalty history
                loadCustomerLoyaltyHistory(customerId);
                loadCustomerAccountHistory(customerId);
                loadCustomerSalesHistory(customerId, data.recentSales);

            } catch (e) {
                showNotification('Error loading customer details', 'error');
            }
        }

        function showCustomerSubTab(tab, btnEl) {
            document.querySelectorAll('#customerDetailModal .cust-detail-tab').forEach(el => el.style.display = 'none');
            document.querySelectorAll('#customerDetailModal .nav-tab').forEach(el => el.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');
            const tabMap = { info: 'custDetailInfo', loyalty: 'custDetailLoyalty', account: 'custDetailAccount', history: 'custDetailHistory' };
            document.getElementById(tabMap[tab]).style.display = 'block';
        }

        async function loadCustomerLoyaltyHistory(customerId) {
            try {
                const res = await fetch(`${API_URL}/customers/${customerId}/loyalty`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const container = document.getElementById('loyaltyHistoryList');
                const txns = data.transactions || [];

                container.innerHTML = `
                    <div style="margin-bottom:10px;font-weight:600;">Balance: ${data.loyalty_points || 0} points | Tier: ${data.loyalty_tier || 'bronze'}</div>
                    ${txns.length === 0 ? '<div style="color:#999;padding:10px;">No loyalty transactions yet</div>' : `
                    <table class="products-table" style="font-size:12px;">
                        <thead><tr><th>Date</th><th>Type</th><th>Points</th><th>Reference</th></tr></thead>
                        <tbody>
                            ${txns.map(t => `<tr>
                                <td>${new Date(t.created_at).toLocaleString('en-ZA')}</td>
                                <td><span style="color:${t.transaction_type === 'earn' ? '#10b981' : '#dc3545'};">${t.transaction_type}</span></td>
                                <td style="font-weight:600;color:${t.points > 0 ? '#10b981' : '#dc3545'};">${t.points > 0 ? '+' : ''}${t.points}</td>
                                <td style="color:#666;">${t.reference || '-'}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`}
                `;
            } catch (e) {
                document.getElementById('loyaltyHistoryList').innerHTML = '<div style="color:#dc3545;">Error loading loyalty data</div>';
            }
        }

        async function loadCustomerAccountHistory(customerId) {
            try {
                const res = await fetch(`${API_URL}/customers/${customerId}/account`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const container = document.getElementById('accountHistoryList');
                const txns = data.transactions || [];

                container.innerHTML = `
                    <div style="margin-bottom:10px;font-weight:600;">Balance: R ${parseFloat(data.current_balance || 0).toFixed(2)} | Limit: R ${parseFloat(data.credit_limit || 0).toFixed(2)}</div>
                    ${txns.length === 0 ? '<div style="color:#999;padding:10px;">No account transactions yet</div>' : `
                    <table class="products-table" style="font-size:12px;">
                        <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Balance</th><th>Reference</th></tr></thead>
                        <tbody>
                            ${txns.map(t => `<tr>
                                <td>${new Date(t.created_at).toLocaleString('en-ZA')}</td>
                                <td>${t.transaction_type}</td>
                                <td style="font-weight:600;color:${t.transaction_type === 'payment' ? '#10b981' : '#dc3545'};">R ${parseFloat(t.amount || 0).toFixed(2)}</td>
                                <td>R ${parseFloat(t.balance_after || 0).toFixed(2)}</td>
                                <td style="color:#666;">${t.reference || '-'}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`}
                `;
            } catch (e) {
                document.getElementById('accountHistoryList').innerHTML = '<div style="color:#dc3545;">Error loading account data</div>';
            }
        }

        function loadCustomerSalesHistory(customerId, recentSales) {
            const container = document.getElementById('customerSalesHistory');
            const sales = recentSales || [];
            if (sales.length === 0) {
                container.innerHTML = '<div style="color:#999;padding:10px;">No recent sales found</div>';
                return;
            }
            container.innerHTML = `
                <table class="products-table" style="font-size:12px;">
                    <thead><tr><th>Date</th><th>Sale #</th><th>Total</th><th>Payment</th></tr></thead>
                    <tbody>
                        ${sales.map(s => `<tr>
                            <td>${new Date(s.sale_date || s.created_at).toLocaleString('en-ZA')}</td>
                            <td>${s.sale_number || '#' + s.id}</td>
                            <td style="font-weight:600;">R ${parseFloat(s.total_amount || 0).toFixed(2)}</td>
                            <td>${s.payment_method || '-'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            `;
        }

        async function earnLoyaltyPoints(customerId) {
            const amount = prompt('Enter sale amount to earn points (1 point per R10):');
            if (!amount || isNaN(amount)) return;

            try {
                const res = await fetch(`${API_URL}/customers/${customerId}/loyalty/earn`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sale_amount: parseFloat(amount), reference: 'Manual earn' })
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(`${data.points_earned} points earned! New balance: ${data.new_balance}`, 'success');
                    loadCustomerLoyaltyHistory(customerId);
                } else {
                    showNotification(data.error || 'Failed to earn points', 'error');
                }
            } catch (e) {
                showNotification('Error earning points', 'error');
            }
        }

        async function redeemLoyaltyPoints(customerId) {
            const points = prompt('Enter points to redeem (100 points = R10):');
            if (!points || isNaN(points)) return;

            try {
                const res = await fetch(`${API_URL}/customers/${customerId}/loyalty/redeem`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ points: parseInt(points), reference: 'Manual redeem' })
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(`${data.points_redeemed} points redeemed! Discount: R ${data.discount_amount}`, 'success');
                    loadCustomerLoyaltyHistory(customerId);
                } else {
                    showNotification(data.error || 'Failed to redeem points', 'error');
                }
            } catch (e) {
                showNotification('Error redeeming points', 'error');
            }
        }

        async function recordAccountPayment(customerId) {
            const amount = prompt('Enter payment amount (R):');
            if (!amount || isNaN(amount)) return;

            try {
                const res = await fetch(`${API_URL}/customers/${customerId}/account/payment`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseFloat(amount), reference: 'Counter payment', payment_method: 'CASH' })
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(`Payment of R ${parseFloat(amount).toFixed(2)} recorded! New balance: R ${data.new_balance}`, 'success');
                    loadCustomerAccountHistory(customerId);
                } else {
                    showNotification(data.error || 'Failed to record payment', 'error');
                }
            } catch (e) {
                showNotification('Error recording payment', 'error');
            }
        }

        // ========== VOID SALE FUNCTION ==========

        async function voidSale(saleId) {
            const reason = prompt('Enter reason for voiding this sale:');
            if (!reason || !reason.trim()) {
                showNotification('Void reason is required', 'error');
                return;
            }

            if (!confirm('Are you sure you want to void this sale? Stock will be restored.')) return;

            try {
                const res = await fetch(`${API_URL}/pos/sales/${saleId}/void`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason.trim() })
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification('Sale voided successfully. Stock has been restored.', 'success');
                    // Refresh current view
                    if (typeof loadProducts === 'function') loadProducts();
                } else {
                    showNotification(data.error || 'Failed to void sale', 'error');
                }
            } catch (e) {
                showNotification('Error voiding sale', 'error');
            }
        }
    </script>
</body>
</html>
